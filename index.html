<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TEAM BRO - ë³¸ì‚¬ ERP</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap');
        
        /* ë¼ì´íŠ¸ëª¨ë“œ - í´ë¦° í™”ì´íŠ¸ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f8fa;
            --bg-tertiary: #eceef2;
            --bg-card: #ffffff;
            --border: #e5e8eb;
            --border-hover: #d1d5db;
            --text-primary: #191f28;
            --text-secondary: #4e5968;
            --text-muted: #8b95a1;
            --accent: #3182f6;
            --accent-hover: #1b64da;
            --accent-light: #e8f3ff;
            --success: #00c073;
            --success-light: #e8faf3;
            --warning: #f59e0b;
            --warning-light: #fef3e2;
            --danger: #f04452;
            --danger-light: #ffeeef;
            --sidebar-bg: #ffffff;
            --header-bg: rgba(255, 255, 255, 0.95);
        }
        
        /* ë‹¤í¬ëª¨ë“œ - í´ë¦° ë‹¤í¬ */
        [data-theme="dark"] {
            --bg-primary: #17171c;
            --bg-secondary: #1f1f25;
            --bg-tertiary: #2b2b33;
            --bg-card: #1f1f25;
            --border: #33333d;
            --border-hover: #45454f;
            --text-primary: #ececef;
            --text-secondary: #9999a1;
            --text-muted: #6b6b73;
            --accent: #4a9fff;
            --accent-hover: #6bb3ff;
            --accent-light: rgba(74, 159, 255, 0.12);
            --success: #00d885;
            --success-light: rgba(0, 216, 133, 0.12);
            --warning: #ffb84d;
            --warning-light: rgba(255, 184, 77, 0.12);
            --danger: #ff6b6b;
            --danger-light: rgba(255, 107, 107, 0.12);
            --sidebar-bg: #17171c;
            --header-bg: rgba(23, 23, 28, 0.95);
        }
        
        * { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            box-sizing: border-box;
        }
        
        body { 
            background: var(--bg-secondary); 
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            transition: background 0.2s, color 0.2s;
        }
        
        /* ì¹´ë“œ - ì‹¬í”Œ */
        .glass-card { 
            background: var(--bg-card);
            border: 1px solid var(--border); 
            border-radius: 12px;
            transition: all 0.15s ease;
        }
        .glass-card:hover { 
            border-color: var(--border-hover);
        }
        
        .gradient-text {
            color: var(--accent);
            font-weight: 700;
        }
        
        .hidden { display: none; }
        
        /* ë°ì´í„° í…Œì´ë¸” */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { 
            background: var(--bg-secondary); 
            padding: 12px 16px; 
            text-align: left; 
            font-size: 13px; 
            font-weight: 600; 
            color: var(--text-muted); 
            border-bottom: 1px solid var(--border);
        }
        .data-table td { 
            padding: 14px 16px; 
            border-bottom: 1px solid var(--border); 
            font-size: 14px; 
            color: var(--text-primary);
            font-weight: 500;
        }
        .data-table tr { transition: background 0.1s; }
        .data-table tr:hover { background: var(--bg-secondary); }
        .data-table tr:last-child td { border-bottom: none; }
        
        /* ì¸í’‹ í•„ë“œ */
        .input-field { 
            background: var(--bg-primary); 
            border: 1px solid var(--border); 
            color: var(--text-primary); 
            padding: 12px 16px; 
            border-radius: 10px; 
            width: 100%; 
            transition: all 0.15s;
            font-size: 15px;
            font-weight: 500;
        }
        .input-field:focus { 
            outline: none; 
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        .input-field::placeholder { color: var(--text-muted); }
        
        /* ë²„íŠ¼ */
        .btn-primary { 
            background: var(--accent);
            color: white; 
            font-weight: 600; 
            padding: 12px 24px; 
            border-radius: 10px; 
            cursor: pointer; 
            border: none;
            transition: all 0.15s;
            font-size: 14px;
        }
        .btn-primary:hover { 
            background: var(--accent-hover);
        }
        
        .btn-secondary { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            color: var(--text-primary); 
            padding: 12px 24px; 
            border-radius: 10px; 
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-secondary:hover { 
            background: var(--bg-tertiary);
        }
        
        .btn-danger { 
            background: var(--danger);
            border: none; 
            color: white; 
            padding: 12px 24px; 
            border-radius: 10px; 
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 600;
        }
        .btn-danger:hover { 
            opacity: 0.9;
        }
        
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(4px);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
            padding: 20px;
        }
        .modal-content { 
            background: var(--bg-card); 
            border: 1px solid var(--border);
            border-radius: 16px; 
            padding: 28px; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            animation: modalIn 0.2s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.97); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* ë°°ì§€ */
        .badge { 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .badge-active { background: var(--success-light); color: var(--success); }
        .badge-inactive { background: var(--bg-tertiary); color: var(--text-muted); }
        .badge-pending { background: var(--warning-light); color: #d97706; }
        .badge-biz { background: var(--accent-light); color: var(--accent); }
        .badge-info { background: var(--accent-light); color: var(--accent); }
        .badge-error { background: var(--danger-light); color: var(--danger); }
        .badge-nonbiz { background: #fff4e6; color: #e67700; }
        .badge-success { background: var(--success-light); color: var(--success); }
        
        [data-theme="dark"] .badge-pending { color: var(--warning); }
        [data-theme="dark"] .badge-info { background: var(--accent-light); color: var(--accent); }
        [data-theme="dark"] .badge-nonbiz { background: rgba(230, 119, 0, 0.12); color: #ffa94d; }
        
        /* í† ìŠ¤íŠ¸ */
        .toast { 
            position: fixed; 
            top: 24px; 
            right: 24px; 
            padding: 14px 20px; 
            border-radius: 10px; 
            z-index: 200;
            font-weight: 600;
            font-size: 14px;
            animation: toastIn 0.25s ease;
        }
        .toast-success { background: var(--success); color: white; }
        .toast-error { background: var(--danger); color: white; }
        .toast-info { background: var(--accent); color: white; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) { 
            .sidebar { display: none !important; } 
            .mobile-nav { display: flex !important; }
            
            /* ë©”ì¸ ì»¨í…ì¸  íŒ¨ë”© ì¡°ì • */
            main { padding: 16px !important; padding-top: 80px !important; padding-bottom: 80px !important; }
            
            /* í—¤ë” ì¡°ì • */
            header { left: 0 !important; }
            
            /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            h2 { font-size: 1.25rem !important; }
            h3 { font-size: 1rem !important; }
            
            /* ì¹´ë“œ/í†µê³„ ë°•ìŠ¤ */
            .glass-card { padding: 12px !important; }
            .glass-card .text-2xl { font-size: 1.1rem !important; }
            .glass-card .text-xl { font-size: 1rem !important; }
            .glass-card .text-xs { font-size: 10px !important; }
            
            /* í…Œì´ë¸” ëª¨ë°”ì¼ */
            .data-table { font-size: 11px !important; }
            .data-table th, .data-table td { padding: 8px 6px !important; white-space: nowrap; }
            .overflow-x-auto { margin: 0 -12px; padding: 0 12px; }
            
            /* ë²„íŠ¼ */
            .btn-sm { padding: 6px 10px !important; font-size: 11px !important; }
            .btn-primary, .btn-secondary { padding: 10px 16px !important; }
            
            /* ì…ë ¥ í•„ë“œ */
            .input-field { padding: 10px 12px !important; font-size: 14px !important; }
            
            /* ëª¨ë‹¬ */
            .modal-content { margin: 10px !important; max-height: 90vh !important; overflow-y: auto !important; }
            
            /* ê·¸ë¦¬ë“œ ê°„ê²© */
            .gap-4 { gap: 12px !important; }
            .gap-6 { gap: 16px !important; }
            .mb-6 { margin-bottom: 16px !important; }
            .mb-8 { margin-bottom: 20px !important; }
            
            /* ê·¸ë£¹ì‚¬ í˜„í™© ì¹´ë“œ */
            .border-l-4 { border-left-width: 3px !important; }
            
            /* ë¹„ë°€ ê³µê°„ íƒ­ */
            .secret-tab-content .data-table { font-size: 10px !important; }
            
            /* í•„í„° ì˜ì—­ */
            .flex-wrap { gap: 8px !important; }
            select.input-field { min-width: 100px !important; }
        }
        
        /* ì•„ì£¼ ì‘ì€ í™”ë©´ (375px ì´í•˜) */
        @media (max-width: 375px) {
            main { padding: 10px !important; }
            .glass-card { padding: 10px !important; }
            .data-table { font-size: 10px !important; }
            .data-table th, .data-table td { padding: 6px 4px !important; }
            h2 { font-size: 1.1rem !important; }
        }
        
        /* ì‚¬ì´ë“œë°” */
        .menu-group { margin-bottom: 4px; }
        .menu-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            padding: 16px 16px 8px 16px;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 16px;
            font-size: 14px;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.1s;
            text-align: left;
            background: transparent;
            border: none;
            cursor: pointer;
            margin: 2px 8px;
            font-weight: 500;
        }
        .sidebar-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .sidebar-item.active {
            background: var(--accent-light);
            color: var(--accent);
            font-weight: 600;
        }
        .sidebar-item .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }
        .sidebar-item .sidebar-icon {
            font-size: 18px;
        }
        
        /* ë‹¤í¬ëª¨ë“œ í† ê¸€ */
        .theme-toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        .theme-toggle::after {
            content: 'â˜€ï¸';
            position: absolute;
            top: 2px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--bg-card);
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .theme-toggle {
            background: var(--accent);
            border-color: var(--accent);
        }
        [data-theme="dark"] .theme-toggle::after {
            content: 'ğŸŒ™';
            left: 23px;
        }
        
        .glow-blue, .glow-blue, .glow-cyan {
            box-shadow: none;
        }
        
        /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        .text-gray-400, .text-gray-500, .text-zinc-400, .text-zinc-500 { 
            color: var(--text-muted) !important; 
        }
        .text-gray-900, .text-zinc-900, .text-white {
            color: var(--text-primary) !important;
        }
        
        /* í¬ì¸íŠ¸ ì»¬ëŸ¬ */
        .text-blue-400 { color: var(--accent) !important; }
        .text-blue-400 { color: var(--accent) !important; }
        .text-green-400 { color: var(--success) !important; }
        .text-red-400 { color: var(--danger) !important; }
        .text-yellow-400 { color: var(--warning) !important; }
        .text-orange-400 { color: #f97316 !important; }
        .text-pink-400 { color: #ec4899 !important; }
        .text-cyan-400 { color: #06b6d4 !important; }
        
        [data-theme="dark"] .text-blue-400 { color: #4a9fff !important; }
        [data-theme="dark"] .text-blue-400 { color: #4a9fff !important; }
        [data-theme="dark"] .text-green-400 { color: #00d885 !important; }
        [data-theme="dark"] .text-red-400 { color: #ff6b6b !important; }
        [data-theme="dark"] .text-orange-400 { color: #fb923c !important; }
        
        /* ìˆ«ì í¬ê¸° */
        .text-xl { font-size: 1.25rem !important; font-weight: 700 !important; }
        .text-2xl { font-size: 1.5rem !important; font-weight: 700 !important; }
        .text-3xl { font-size: 2rem !important; font-weight: 700 !important; }
        
        /* ë°°ê²½ìƒ‰ */
        .bg-white { background: var(--bg-card) !important; }
        .bg-gray-50, .bg-gray-100 { background: var(--bg-secondary) !important; }
        
        /* íƒ€ì´í‹€ */
        h2, h3 { 
            color: var(--text-primary); 
            font-weight: 700;
        }
        h2 { font-size: 1.375rem; }
        h3 { font-size: 1rem; }
    </style>
</head>
<body class="min-h-screen">
    <div id="toast-container"></div>

    <!-- ë¡œë”© -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex items-center justify-center" style="background: var(--bg-secondary)">
        <div class="text-center">
            <h1 class="text-3xl font-bold mb-5" style="color: var(--text-primary)">TEAM BRO</h1>
            <div class="flex items-center justify-center gap-1.5">
                <div class="w-2 h-2 rounded-full animate-pulse" style="background: var(--accent)"></div>
                <div class="w-2 h-2 rounded-full animate-pulse" style="background: var(--accent); animation-delay: 0.1s"></div>
                <div class="w-2 h-2 rounded-full animate-pulse" style="background: var(--accent); animation-delay: 0.2s"></div>
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginPage" class="hidden relative z-10 min-h-screen flex items-center justify-center px-4" style="background: var(--bg-secondary)">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-14 h-14 mx-auto mb-4 rounded-xl flex items-center justify-center font-bold text-white text-lg" style="background: var(--accent);">TB</div>
                <h1 class="text-2xl font-bold mb-1" style="color: var(--text-primary)">TEAM BRO</h1>
                <p class="text-sm" style="color: var(--text-muted)">ê·¸ë£¹ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            <div class="glass-card p-7">
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1.5" style="color: var(--text-secondary)">ì•„ì´ë””</label>
                        <input type="text" id="loginUsername" class="input-field" required placeholder="ì•„ì´ë”” ì…ë ¥">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1.5" style="color: var(--text-secondary)">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" class="input-field" required placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                    <div id="loginError" class="hidden p-3 rounded-lg text-sm font-medium" style="background: var(--danger-light); color: var(--danger)"></div>
                    <button type="submit" class="w-full btn-primary py-3 text-sm mt-2">ë¡œê·¸ì¸</button>
                </form>
            </div>
            <p class="text-center text-xs mt-6" style="color: var(--text-muted)">Â© 2025 TEAM BRO</p>
        </div>
    </div>

    <!-- ì‹œìŠ¤í…œ ì„ íƒ í™”ë©´ -->
    <div id="systemSelectPage" class="hidden relative z-10 min-h-screen flex items-center justify-center px-4" style="background: var(--bg-secondary)">
        <div class="w-full max-w-2xl">
            <div class="text-center mb-8">
                <div class="w-14 h-14 mx-auto mb-4 rounded-xl flex items-center justify-center font-bold text-white text-lg" style="background: var(--accent);">TB</div>
                <h1 class="text-2xl font-bold mb-1" style="color: var(--text-primary)">ì‹œìŠ¤í…œ ì„ íƒ</h1>
                <p class="text-sm" style="color: var(--text-muted)">ì ‘ì†í•  ì‹œìŠ¤í…œì„ ì„ íƒí•˜ì„¸ìš”</p>
                <p class="text-xs mt-2" style="color: var(--text-muted)">ë¡œê·¸ì¸: <span id="selectPageUser" class="text-blue-400"></span></p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- íŒ€ë¸Œë¡œ HQ -->
                <div id="selectHQ" class="glass-card p-6 text-center cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all" onclick="enterSystem('hq')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">ğŸ¢</div>
                    <h3 class="font-bold text-lg mb-2" style="color: var(--text-primary)">íŒ€ë¸Œë¡œ HQ</h3>
                    <p class="text-xs mb-3" style="color: var(--text-muted)">ë³¸ì‚¬ í†µí•© ê´€ë¦¬</p>
                    <span class="badge badge-info text-xs">ADMIN / MANAGER</span>
                </div>
                
                <!-- ë¸Œë¡œì»´í¼ë‹ˆ -->
                <div id="selectBC" class="glass-card p-6 text-center cursor-pointer hover:ring-2 hover:ring-emerald-500 transition-all" onclick="enterSystem('brocompany')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #10b981, #059669);">ğŸš€</div>
                    <h3 class="font-bold text-lg mb-2" style="color: var(--text-primary)">ë¸Œë¡œì»´í¼ë‹ˆ</h3>
                    <p class="text-xs mb-3" style="color: var(--text-muted)">ë°°ë‹¬ëŒ€í–‰ ì •ì‚°</p>
                    <span class="badge badge-active text-xs">ì „ì²´ ì ‘ê·¼</span>
                </div>
                
                <!-- ë¸Œë¡œëª¨í„°ìŠ¤ -->
                <div id="selectBM" class="glass-card p-6 text-center cursor-pointer hover:ring-2 hover:ring-amber-500 transition-all" onclick="enterSystem('bromotors')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #f59e0b, #d97706);">ğŸï¸</div>
                    <h3 class="font-bold text-lg mb-2" style="color: var(--text-primary)">ë¸Œë¡œëª¨í„°ìŠ¤</h3>
                    <p class="text-xs mb-3" style="color: var(--text-muted)">ì˜¤í† ë°”ì´ ë Œíƒˆ/ë¦¬ìŠ¤</p>
                    <span class="badge badge-active text-xs">ì „ì²´ ì ‘ê·¼</span>
                </div>
            </div>
            <div class="text-center">
                <button onclick="handleLogout()" class="text-sm text-gray-400 hover:text-white">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ -->
    <div id="mainSystem" class="hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar fixed left-0 top-0 h-screen border-r hidden md:block" style="width: 260px; background: var(--sidebar-bg); border-color: var(--border); overflow-y:auto; z-index: 50;">
            <!-- ë¡œê³  -->
            <div class="p-5 border-b" style="border-color: var(--border)">
                <div class="flex items-center gap-3 cursor-pointer" onclick="showTab('dashboard')">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center font-bold text-white text-sm" style="background: var(--accent);">TB</div>
                    <span class="text-lg font-bold" style="color: var(--text-primary)">TeamBro</span>
                </div>
            </div>
            
            <nav class="p-4 space-y-6">
                <!-- ëŒ€ì‹œë³´ë“œ -->
                <div>
                    <button onclick="showTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full">
                        <span class="sidebar-icon">ğŸ“Š</span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </button>
                </div>

                <!-- ê¸°ì´ˆì •ë³´ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ‘¥ ê¸°ì´ˆì •ë³´</div>
                    <button onclick="showTab('riders')" id="nav-riders" class="sidebar-item w-full"><span class="dot"></span>ë¼ì´ë” ê´€ë¦¬</button>
                    <button onclick="showTab('partners')" id="nav-partners" class="sidebar-item w-full"><span class="dot"></span>í˜‘ë ¥ì‚¬ ê´€ë¦¬</button>
                    <button onclick="showTab('sales')" id="nav-sales" class="sidebar-item w-full"><span class="dot"></span>ì˜ì—…ì ê´€ë¦¬</button>
                    <button onclick="showTab('entities')" id="nav-entities" class="sidebar-item w-full"><span class="dot"></span>ë²•ì¸ ê´€ë¦¬</button>
                </div>

                <!-- ì •ì‚°ê´€ë¦¬ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ’° ì •ì‚°ê´€ë¦¬</div>
                    <button onclick="showTab('sett-dashboard')" id="nav-sett-dashboard" class="sidebar-item w-full"><span class="dot"></span>ì •ì‚° í˜„í™©</button>
                    <button onclick="showTab('platform')" id="nav-platform" class="sidebar-item w-full"><span class="dot"></span>í”Œë«í¼ì •ì‚°ì…ê¸ˆ</button>
                    <button onclick="showTab('sett-advance')" id="nav-sett-advance" class="sidebar-item w-full"><span class="dot"></span>ì„ ì •ì‚° ì§€ê¸‰</button>
                    <button onclick="showTab('weekly-payout')" id="nav-weekly-payout" class="sidebar-item w-full"><span class="dot"></span>ì£¼ì •ì‚° ì§€ê¸‰</button>
                    <button onclick="showTab('reconcile')" id="nav-reconcile" class="sidebar-item w-full"><span class="dot"></span>ëŒ€ì‚¬ ê´€ë¦¬</button>
                </div>

                <!-- ì¬ë¬´ê´€ë¦¬ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ’µ ì¬ë¬´ê´€ë¦¬</div>
                    <button onclick="showTab('bank')" id="nav-bank" class="sidebar-item w-full"><span class="dot"></span>í˜„ê¸ˆì¶œë‚©ì¥</button>
                    <button onclick="showTab('accounting')" id="nav-accounting" class="sidebar-item w-full"><span class="dot"></span>ë§¤ì…ë§¤ì¶œì¥</button>
                    <button onclick="showTab('taxinvoice')" id="nav-taxinvoice" class="sidebar-item w-full"><span class="dot"></span>ì„¸ê¸ˆê³„ì‚°ì„œ</button>
                    <button onclick="showTab('ledger')" id="nav-ledger" class="sidebar-item w-full"><span class="dot"></span>ì´ê³„ì •ì›ì¥</button>
                    <button onclick="showTab('journal')" id="nav-journal" class="sidebar-item w-full"><span class="dot"></span>ë¶„ê°œì¥</button>
                </div>

                <!-- ì¹´ë“œ/ìì‚° -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ’³ ì¹´ë“œ/ìì‚°</div>
                    <button onclick="showTab('cards')" id="nav-cards" class="sidebar-item w-full"><span class="dot"></span>ë²•ì¸ì¹´ë“œ ê´€ë¦¬</button>
                    <button onclick="showTab('card-usage')" id="nav-card-usage" class="sidebar-item w-full"><span class="dot"></span>ì¹´ë“œ ì‚¬ìš©ë‚´ì—­</button>
                </div>

                <!-- ì¸ì‚¬ê´€ë¦¬ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ§‘â€ğŸ’¼ ì¸ì‚¬ê´€ë¦¬</div>
                    <button onclick="showTab('employees')" id="nav-employees" class="sidebar-item w-full"><span class="dot"></span>ì§ì› ê´€ë¦¬</button>
                    <button onclick="showTab('payroll')" id="nav-payroll" class="sidebar-item w-full"><span class="dot"></span>ê¸‰ì—¬ ê´€ë¦¬</button>
                    <button onclick="showTab('contracts')" id="nav-contracts" class="sidebar-item w-full"><span class="dot"></span>ê·¼ë¡œê³„ì•½</button>
                </div>

                <!-- ë¬¸ì„œ/ì„¸ë¬´ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ“‹ ë¬¸ì„œ/ì„¸ë¬´</div>
                    <button onclick="showTab('tax')" id="nav-tax" class="sidebar-item w-full"><span class="dot"></span>ì„¸ë¬´ ê´€ë¦¬</button>
                    <button onclick="showTab('docs')" id="nav-docs" class="sidebar-item w-full"><span class="dot"></span>ë¬¸ì„œ ê´€ë¦¬</button>
                    <button onclick="showTab('excel')" id="nav-excel" class="sidebar-item w-full"><span class="dot"></span>ì—…ë¡œë“œ ì–‘ì‹</button>
                </div>

                <!-- ì‹œìŠ¤í…œ -->
                <div class="menu-group">
                    <div class="menu-title">âš™ï¸ ì‹œìŠ¤í…œ</div>
                    <button onclick="showTab('users')" id="nav-users" class="sidebar-item w-full"><span class="dot"></span>ì‚¬ìš©ì ê´€ë¦¬</button>
                    <button onclick="showTab('logs')" id="nav-logs" class="sidebar-item w-full"><span class="dot"></span>ê°ì‚¬ ë¡œê·¸</button>
                    <button onclick="showTab('settings')" id="nav-settings" class="sidebar-item w-full"><span class="dot"></span>ì‹œìŠ¤í…œ ì„¤ì •</button>
                </div>
            </nav>
            

        </aside>

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="fixed top-0 right-0 z-40 border-b" style="left: 260px; background: var(--header-bg); backdrop-filter: blur(12px); border-color: var(--border);">
            <div class="px-6 py-3.5 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="toggleMobileMenu()" class="text-xl md:hidden" style="color: var(--text-secondary)">â˜°</button>
                    <h2 id="pageTitle" class="text-lg font-bold" style="color: var(--text-primary)">ëŒ€ì‹œë³´ë“œ</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="theme-toggle" onclick="toggleTheme()" title="ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ"></div>
                    <!-- ë¹„ë°€ ê³µê°„ ë²„íŠ¼ (ì‘ì€ ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
                    <span onclick="openSecretAccess()" class="cursor-pointer opacity-30 hover:opacity-100 transition-opacity text-xs" title=" ">â€¢</span>
                    <span id="headerUserName" class="text-sm font-medium hidden md:inline" style="color: var(--text-secondary)">ê´€ë¦¬ì</span>
                    <button onclick="logout()" class="text-sm font-medium" style="color: var(--text-muted)">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <!-- ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ (í•˜ë‹¨ ê³ ì •) -->
        <div class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-zinc-900/95 backdrop-blur-lg border-t border-white/5 z-40 safe-area-bottom">
            <button onclick="showTab('dashboard')" id="mob-dashboard" class="flex-1 py-2 text-center text-[10px] text-zinc-500 hover:text-blue-400 transition-colors">ğŸ“Š<br>ëŒ€ì‹œë³´ë“œ</button>
            <button onclick="showTab('riders')" id="mob-riders" class="flex-1 py-2 text-center text-[10px] text-zinc-500 hover:text-blue-400 transition-colors">ğŸï¸<br>ë¼ì´ë”</button>
            <button onclick="showTab('partners')" id="mob-partners" class="flex-1 py-2 text-center text-[10px] text-zinc-500 hover:text-blue-400 transition-colors">ğŸ¤<br>í˜‘ë ¥ì‚¬</button>
            <button onclick="showTab('bank')" id="mob-bank" class="flex-1 py-2 text-center text-[10px] text-zinc-500 hover:text-blue-400 transition-colors">ğŸ’°<br>ì¶œë‚©ì¥</button>
            <button onclick="toggleMobileFullMenu()" id="mob-more" class="flex-1 py-2 text-center text-[10px] text-zinc-500 hover:text-blue-400 transition-colors">â˜°<br>ë”ë³´ê¸°</button>
        </div>
        
        <!-- ëª¨ë°”ì¼ ì „ì²´ ë©”ë‰´ (ìŠ¬ë¼ì´ë“œì—…) -->
        <div id="mobileFullMenu" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/70" onclick="toggleMobileFullMenu()"></div>
            <div class="absolute bottom-0 left-0 right-0 bg-zinc-900 rounded-t-3xl p-6 max-h-[80vh] overflow-y-auto">
                <div class="w-12 h-1 bg-zinc-700 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-white mb-4">ì „ì²´ ë©”ë‰´</h3>
                
                <div class="grid grid-cols-4 gap-3 mb-6">
                    <button onclick="showTab('dashboard');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ“Š</div><div class="text-[10px] text-gray-400">ëŒ€ì‹œë³´ë“œ</div>
                    </button>
                    <button onclick="showTab('riders');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸï¸</div><div class="text-[10px] text-gray-400">ë¼ì´ë”</div>
                    </button>
                    <button onclick="showTab('partners');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ¤</div><div class="text-[10px] text-gray-400">í˜‘ë ¥ì‚¬</div>
                    </button>
                    <button onclick="showTab('sales');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ’¼</div><div class="text-[10px] text-gray-400">ì˜ì—…ì</div>
                    </button>
                    <button onclick="showTab('entities');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ¢</div><div class="text-[10px] text-gray-400">ë²•ì¸</div>
                    </button>
                    <button onclick="showTab('bank');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ’°</div><div class="text-[10px] text-gray-400">ì¶œë‚©ì¥</div>
                    </button>
                    <button onclick="showTab('accounting');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ“’</div><div class="text-[10px] text-gray-400">ë§¤ì…ë§¤ì¶œ</div>
                    </button>
                    <button onclick="showTab('taxinvoice');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ§¾</div><div class="text-[10px] text-gray-400">ì„¸ê¸ˆê³„ì‚°</div>
                    </button>
                    <button onclick="showTab('employees');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ‘¥</div><div class="text-[10px] text-gray-400">ì§ì›</div>
                    </button>
                    <button onclick="showTab('cards');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">ğŸ’³</div><div class="text-[10px] text-gray-400">ë²•ì¸ì¹´ë“œ</div>
                    </button>
                    <button onclick="showTab('users');toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-800 text-center">
                        <div class="text-2xl mb-1">âš™ï¸</div><div class="text-[10px] text-gray-400">ì‚¬ìš©ì</div>
                    </button>
                    <button onclick="toggleMobileFullMenu()" class="p-3 rounded-xl bg-zinc-700 text-center">
                        <div class="text-2xl mb-1">âœ•</div><div class="text-[10px] text-gray-400">ë‹«ê¸°</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="pt-24 p-8 pb-24 md:pb-8 min-h-screen" style="margin-left: 0;" id="mainContent">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="tab-dashboard" class="tab-content">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">ëŒ€ì‹œë³´ë“œ</h2>
                    <p class="text-zinc-500 text-sm">íŒ€ë¸Œë¡œ ê·¸ë£¹ í†µí•© í˜„í™©</p>
                </div>
                
                <!-- ê¸°ë³¸ í†µê³„ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass-card p-5 cursor-pointer" onclick="showTab('riders')">
                        <div class="text-zinc-500 text-xs mb-2">ë¼ì´ë”</div>
                        <div class="text-2xl font-bold text-white" id="stat-riders">0ëª…</div>
                    </div>
                    <div class="glass-card p-5 cursor-pointer" onclick="showTab('partners')">
                        <div class="text-zinc-500 text-xs mb-2">í˜‘ë ¥ì‚¬</div>
                        <div class="text-2xl font-bold text-white" id="stat-partners">0ê°œ</div>
                    </div>
                    <div class="glass-card p-5 cursor-pointer" onclick="showTab('sales')">
                        <div class="text-zinc-500 text-xs mb-2">ì˜ì—…ì</div>
                        <div class="text-2xl font-bold text-white" id="stat-sales">0ëª…</div>
                    </div>
                    <div class="glass-card p-5">
                        <div class="text-zinc-500 text-xs mb-2">ì´ë²ˆë‹¬ ìˆ˜ìˆ˜ë£Œ</div>
                        <div class="text-2xl font-bold text-emerald-400">â‚©0</div>
                    </div>
                </div>
                
                <!-- ê·¸ë£¹ì‚¬ í˜„í™© -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-white mb-4">ğŸ¢ ê·¸ë£¹ì‚¬ í˜„í™©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- ë¸Œë¡œëª¨í„°ìŠ¤ -->
                        <div class="glass-card p-5 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-blue-400">ë¸Œë¡œëª¨í„°ìŠ¤</h4>
                                <span class="badge badge-active">ìš´ì˜ì¤‘</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ë²ˆë‹¬ ìˆ˜ê¸ˆ</span><span class="text-white font-medium" id="bc-revenue">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ë²ˆë‹¬ ì •ì‚°</span><span class="text-amber-400" id="bc-settlement">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ)</span><span class="text-emerald-400 font-medium" id="bc-profit">â‚©0</span></div>
                            </div>
                            <a href="https://gaebbeulli-create.github.io/teambro-erp/" target="_blank" class="block mt-4 text-center text-xs text-blue-400 hover:text-blue-300 transition-colors">ERP ë°”ë¡œê°€ê¸° â†’</a>
                        </div>
                        
                        <!-- ë¦¬ìŠ¤&ë Œíƒˆ -->
                        <div class="glass-card p-5 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-blue-400">ë¦¬ìŠ¤&ë Œíƒˆ</h4>
                                <span class="badge badge-active">ìš´ì˜ì¤‘</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ë²ˆë‹¬ ë Œíƒˆìˆ˜ìµ</span><span class="text-white font-medium" id="bm-revenue">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ë¯¸ìˆ˜ê¸ˆ</span><span class="text-red-400" id="bm-arrears">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ìˆœìˆ˜ìµ</span><span class="text-emerald-400 font-medium" id="bm-profit">â‚©0</span></div>
                            </div>
                            <a href="https://gaebbeulli-create.github.io/bromotors/" target="_blank" class="block mt-4 text-center text-xs text-blue-400 hover:text-blue-300 transition-colors">ERP ë°”ë¡œê°€ê¸° â†’</a>
                        </div>
                        
                        <!-- ê·¸ë£¹ í•©ê³„ -->
                        <div class="glass-card p-5 border-l-4 border-emerald-500">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-emerald-400">ê·¸ë£¹ í•©ê³„</h4>
                                <span class="text-xs text-zinc-500">ì´ë²ˆë‹¬</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ ë§¤ì¶œ</span><span class="text-white font-medium" id="group-revenue">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ ìˆ˜ìµ</span><span class="text-emerald-400 font-medium" id="group-profit">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ìê¸ˆ ì”ì•¡</span><span class="text-amber-400 font-medium" id="group-balance">â‚©0</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ìê¸ˆ ì§‘í–‰/íšŒìˆ˜ -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white">ğŸ’° ìê¸ˆ ì§‘í–‰/íšŒìˆ˜</h3>
                        <button onclick="openFundModal()" class="btn-primary btn-sm">+ ìê¸ˆ ë“±ë¡</button>
                    </div>
                    
                    <!-- ìê¸ˆ í†µê³„ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ì´ ì§‘í–‰</div>
                            <div class="text-xl font-bold text-red-400" id="fund-total-out">â‚©0</div>
                        </div>
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ì´ íšŒìˆ˜</div>
                            <div class="text-xl font-bold text-emerald-400" id="fund-total-in">â‚©0</div>
                        </div>
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ë¯¸íšŒìˆ˜ ì”ì•¡</div>
                            <div class="text-xl font-bold text-amber-400" id="fund-outstanding">â‚©0</div>
                        </div>
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ì´ë²ˆë‹¬ ìˆœì´ë™</div>
                            <div class="text-xl font-bold text-blue-400" id="fund-monthly-net">â‚©0</div>
                        </div>
                    </div>
                    
                    <!-- ìê¸ˆ ë‚´ì—­ í…Œì´ë¸” -->
                    <div class="glass-card overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>ì¼ì</th><th>ìíšŒì‚¬</th><th>êµ¬ë¶„</th><th>ê¸ˆì•¡</th><th>ìš©ë„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="fundTableBody"><tr><td colspan="7" class="text-center py-8 text-zinc-500">ìê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ë¼ì´ë” ê´€ë¦¬ -->
                <div id="tab-riders" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸï¸ ë¼ì´ë” ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('rider')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('riderExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('rider')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openRiderModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <button onclick="deleteAllRiders()" class="btn-danger btn-sm" id="deleteAllRidersBtn" style="display:none">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
                            <input type="file" id="riderExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('rider', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-blue-400" onclick="filterRiderList('')"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="rider-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-green-400" onclick="filterRiderList('ê³„ì•½ì¤‘')"><div class="text-gray-400 text-xs">ê³„ì•½ì¤‘</div><div class="text-xl font-bold text-green-400" id="rider-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-gray-400" onclick="filterRiderList('ê³„ì•½ì¢…ë£Œ')"><div class="text-gray-400 text-xs">ê³„ì•½ì¢…ë£Œ</div><div class="text-xl font-bold text-gray-400" id="rider-inactive">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-red-400" onclick="filterRiderList('nossn')"><div class="text-gray-400 text-xs">ì£¼ë¯¼ë²ˆí˜¸ ë¯¸ë“±ë¡</div><div class="text-xl font-bold text-red-400" id="rider-nossn">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="riderStatusFilter" class="input-field" style="width:120px" onchange="renderTable('rider')"><option value="">ì „ì²´ ìƒíƒœ</option><option value="ê³„ì•½ì¤‘">ê³„ì•½ì¤‘</option><option value="ê³„ì•½ì¢…ë£Œ">ê³„ì•½ì¢…ë£Œ</option></select>
                            <select id="riderPartnerFilter" class="input-field" style="width:150px" onchange="renderTable('rider')"><option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option></select>
                            <select id="riderSsnFilter" class="input-field" style="width:140px" onchange="renderTable('rider')"><option value="">ì£¼ë¯¼ë²ˆí˜¸ ì „ì²´</option><option value="has">ì£¼ë¯¼ë²ˆí˜¸ ìˆìŒ</option><option value="none">ì£¼ë¯¼ë²ˆí˜¸ ì—†ìŒ</option></select>
                            <input type="text" id="riderSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê²€ìƒ‰..." onkeyup="renderTable('rider')">
                            <button onclick="exportFilteredRiders()" class="btn-secondary btn-sm">ğŸ“Š í•„í„° ë‹¤ìš´</button>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì´ë¦„</th><th>ì£¼ë¯¼ë²ˆí˜¸</th><th>í˜‘ë ¥ì‚¬</th><th>ë°°ë¯¼ID</th><th>ì¿ íŒ¡ID</th><th>ì„¸ê¸ˆì²˜ë¦¬</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="riderTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- í˜‘ë ¥ì‚¬ ê´€ë¦¬ -->
                <div id="tab-partners" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ¤ í˜‘ë ¥ì‚¬ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('partner')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('partnerExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('partner')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openPartnerModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="partnerExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('partner', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-blue-400" onclick="filterPartnerList('')"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="partner-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-blue-400" onclick="filterPartnerList('biz')"><div class="text-gray-400 text-xs">ì‚¬ì—…ì</div><div class="text-xl font-bold text-blue-400" id="partner-biz">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-orange-400" onclick="filterPartnerList('non_biz')"><div class="text-gray-400 text-xs">ë¹„ì‚¬ì—…ì</div><div class="text-xl font-bold text-orange-400" id="partner-nonbiz">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer hover:ring-2 hover:ring-green-400" onclick="filterPartnerList('hasRider')"><div class="text-gray-400 text-xs">ì†Œì† ë¼ì´ë”</div><div class="text-xl font-bold text-green-400" id="partner-riders">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="partnerTypeFilter" class="input-field" style="width:120px" onchange="renderTable('partner')"><option value="">ì „ì²´ êµ¬ë¶„</option><option value="biz">ì‚¬ì—…ì</option><option value="non_biz">ë¹„ì‚¬ì—…ì</option></select>
                            <select id="partnerRiderFilter" class="input-field" style="width:150px" onchange="renderTable('partner')"><option value="">ë¼ì´ë” ì „ì²´</option><option value="has">ë¼ì´ë” ìˆìŒ</option><option value="none">ë¼ì´ë” ì—†ìŒ</option></select>
                            <input type="text" id="partnerSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê²€ìƒ‰ (í˜‘ë ¥ì‚¬ëª…, ì½”ë“œ, ëŒ€í‘œì)..." onkeyup="renderTable('partner')">
                            <button onclick="exportFilteredPartners()" class="btn-secondary btn-sm">ğŸ“Š í•„í„° ë‹¤ìš´</button>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>í˜‘ë ¥ì‚¬ëª…</th><th>ì½”ë“œ</th><th>êµ¬ë¶„</th><th>ë°°ë‹¬ê¶Œì—­</th><th>ëŒ€í‘œì</th><th>ì—°ë½ì²˜</th><th>ë¼ì´ë”ìˆ˜</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="partnerTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì˜ì—…ì ê´€ë¦¬ -->
                <div id="tab-sales" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’¼ ì˜ì—…ì ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('sales')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('salesExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('sales')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openSalesModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="salesExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('sales', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="sales-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê°œì¸</div><div class="text-xl font-bold text-blue-400" id="sales-ind">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê°œì¸ì‚¬ì—…ì</div><div class="text-xl font-bold text-blue-400" id="sales-sole">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë²•ì¸</div><div class="text-xl font-bold text-pink-400" id="sales-corp">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="salesStatusFilter" class="input-field" style="width:100px" onchange="renderTable('sales')"><option value="">ì „ì²´</option><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select>
                            <select id="salesTypeFilter" class="input-field" style="width:120px" onchange="renderTable('sales')"><option value="">ì „ì²´ìœ í˜•</option><option value="individual">ê°œì¸</option><option value="sole_prop">ê°œì¸ì‚¬ì—…ì</option><option value="corporation">ë²•ì¸</option></select>
                            <input type="text" id="salesSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê²€ìƒ‰..." onkeyup="renderTable('sales')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì½”ë“œ</th><th>ì´ë¦„</th><th>ìœ í˜•</th><th>ì—°ë½ì²˜</th><th>ì§€ê¸‰ì£¼ê¸°</th><th>ì›ì²œì§•ìˆ˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="salesTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì ê´€ë¦¬ -->
                <div id="tab-users" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬ (í†µí•©)</h2>
                        <button onclick="openUserModal()" class="btn-primary btn-sm">+ ì‚¬ìš©ì ë“±ë¡</button>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">íŒ€ë¸Œë¡œ HQ, ë¸Œë¡œì»´í¼ë‹ˆ, ë¸Œë¡œëª¨í„°ìŠ¤ ë“± ëª¨ë“  ì‹œìŠ¤í…œì˜ ì‚¬ìš©ìë¥¼ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="userSystemFilter" class="input-field" style="width:150px" onchange="renderUserTable()">
                                <option value="">ì „ì²´ ì‹œìŠ¤í…œ</option>
                                <option value="hq">íŒ€ë¸Œë¡œ HQ</option>
                                <option value="brocompany">ë¸Œë¡œì»´í¼ë‹ˆ</option>
                                <option value="bromotors">ë¸Œë¡œëª¨í„°ìŠ¤</option>
                            </select>
                            <select id="userRoleFilter" class="input-field" style="width:120px" onchange="renderUserTable()">
                                <option value="">ì „ì²´ ê¶Œí•œ</option>
                                <option value="ADMIN">ê´€ë¦¬ì</option>
                                <option value="MANAGER">ë§¤ë‹ˆì €</option>
                                <option value="STAFF">ì§ì›</option>
                            </select>
                            <input type="text" id="userSearch" class="input-field flex-1" style="min-width:150px" placeholder="ì´ë¦„/ì•„ì´ë”” ê²€ìƒ‰..." onkeyup="renderUserTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì†Œì†</th><th>ê¶Œí•œ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="userTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ë²•ì¸ ê´€ë¦¬ -->
                <div id="tab-entities" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ¢ ë²•ì¸ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openEntityModal()" class="btn-primary btn-sm">+ ë²•ì¸ ë“±ë¡</button>
                        </div>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´ ë²•ì¸</div><div class="text-xl font-bold text-blue-400" id="entity-total">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">í™œì„±</div><div class="text-xl font-bold text-green-400" id="entity-active">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¹„í™œì„±</div><div class="text-xl font-bold text-gray-400" id="entity-inactive">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì²¨ë¶€ì„œë¥˜</div><div class="text-xl font-bold text-blue-400" id="entity-docs">0ê°œ</div></div>
                    </div>
                    
                    <!-- ë²•ì¸ ì¹´ë“œ ëª©ë¡ -->
                    <div id="entityCardList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-card rounded-xl p-8 text-center col-span-full"><p class="text-gray-500">ë“±ë¡ëœ ë²•ì¸ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
                    </div>
                </div>

                <!-- ì •ì‚° ê´€ë¦¬ -->
                <div id="tab-settlement" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’° ì •ì‚° ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('settlement')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('settlementExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('settlement')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openSettlementModal()" class="btn-primary btn-sm">+ ì •ì‚° ë“±ë¡</button>
                            <input type="file" id="settlementExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('settlement', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="sett-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('pending')"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="sett-pending">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('confirmed')"><div class="text-gray-400 text-xs">í™•ì •</div><div class="text-xl font-bold text-blue-400" id="sett-confirmed">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('paid')"><div class="text-gray-400 text-xs">ì§€ê¸‰ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="sett-paid">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì •ì‚°ê¸ˆ</div><div class="text-xl font-bold text-blue-400" id="sett-amount">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="settWeekFilter" class="input-field" style="width:130px" onchange="renderTable('settlement')"><option value="">ì „ì²´ ì£¼ì°¨</option></select>
                            <select id="settStatusFilter" class="input-field" style="width:100px" onchange="renderTable('settlement')"><option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="confirmed">í™•ì •</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select>
                            <select id="settPartnerFilter" class="input-field" style="width:150px" onchange="renderTable('settlement')"><option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option></select>
                            <input type="text" id="settSearch" class="input-field flex-1" style="min-width:150px" placeholder="ë¼ì´ë” ê²€ìƒ‰..." onkeyup="renderTable('settlement')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>ê·¼ë¬´ê¸°ê°„</th><th>ë¼ì´ë”</th><th>í˜‘ë ¥ì‚¬</th><th>ì´ìˆ˜ì…</th><th>ê³µì œ</th><th>ì„ ì •ì‚°</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="settlementTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì§€ê¸‰ ê´€ë¦¬ (ì§ì› ê¸‰ì—¬) -->
                <div id="tab-payout" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ‘¥ ì¸ì‚¬ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openEmployeeModal()" class="btn-secondary btn-sm">+ ì§ì› ë“±ë¡</button>
                            <button onclick="openPayrollModal()" class="btn-primary btn-sm">+ ê¸‰ì—¬ ë“±ë¡</button>
                        </div>
                    </div>
                    
                    <!-- ì§ì› ëª©ë¡ -->
                    <h3 class="text-lg font-bold mb-3 text-blue-400">ğŸ‘¤ ì§ì› ëª©ë¡</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="emp-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì •ê·œì§</div><div class="text-xl font-bold text-blue-400" id="emp-regular">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³„ì•½ì§</div><div class="text-xl font-bold text-yellow-400" id="emp-contract">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">4ëŒ€ë³´í—˜</div><div class="text-xl font-bold text-green-400" id="emp-insured">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>êµ¬ë¶„</th><th>ë¶€ì„œ</th><th>ê¸°ë³¸ê¸‰</th><th>4ëŒ€ë³´í—˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="employeeTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                    
                    <!-- ê¸‰ì—¬ ë‚´ì—­ -->
                    <h3 class="text-lg font-bold mb-3 text-blue-400">ğŸ’° ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì§€ê¸‰</div><div class="text-xl font-bold text-blue-400" id="pay-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="pay-gross">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê³µì œì•¡</div><div class="text-xl font-bold text-red-400" id="pay-deduct">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‹¤ì§€ê¸‰ í•©ê³„</div><div class="text-xl font-bold text-green-400" id="pay-net">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>ì§€ê¸‰ì›”</th><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ìˆ˜ë‹¹</th><th>ì´ì§€ê¸‰</th><th>ê³µì œ</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="payrollTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                    
                    <!-- ê·¼ë¡œê³„ì•½ì„œ ì—…ë¡œë“œ -->
                    <h3 class="text-lg font-bold mb-3 text-orange-400">ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ ê´€ë¦¬</h3>
                    <div class="glass-card rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4">
                            <select id="contractEmpSelect" class="input-field" style="width:200px">
                                <option value="">ì§ì› ì„ íƒ</option>
                            </select>
                            <label class="btn-secondary btn-sm cursor-pointer">
                                ğŸ“ íŒŒì¼ ì„ íƒ
                                <input type="file" id="contractFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="hidden" onchange="handleContractUpload(this)">
                            </label>
                            <span id="contractFileName" class="text-gray-400 text-sm">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                            <button onclick="uploadContract()" class="btn-primary btn-sm">ì—…ë¡œë“œ</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">* PDF, ì´ë¯¸ì§€(JPG, PNG), Word íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥</div>
                        <div class="glass-card rounded-lg overflow-hidden">
                            <table class="data-table"><thead><tr><th>ì§ì›</th><th>íŒŒì¼ëª…</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="contractTableBody"><tr><td colspan="4" class="text-center py-4 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- ì„¸ë¬´ ê´€ë¦¬ -->
                <div id="tab-tax" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“‹ ì„¸ë¬´ ì„œë¥˜ ë³´ê´€í•¨</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openTaxUploadModal()" class="btn-primary btn-sm">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                        </div>
                    </div>
                    
                    <!-- ì„¤ëª… ë°°ë„ˆ -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-blue-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“</span>
                            <div>
                                <p class="text-blue-400 font-bold">ì„¸ë¬´ì„œë¥˜ í´ë¼ìš°ë“œ ë³´ê´€í•¨</p>
                                <p class="text-gray-400 text-sm">ì„¸ë¬´ì„œì—ì„œ ë°›ì€ ì›ì²œì„¸ ì‹ ê³ ì„œ, ì§€ê¸‰ëª…ì„¸ì„œ ë“± ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•˜ê³  ë³´ê´€í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
                    <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                        <button onclick="filterTaxDocs('all')" id="taxDocTab-all" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-blue-500/20 text-blue-400">ì „ì²´</button>
                        <button onclick="filterTaxDocs('withholding')" id="taxDocTab-withholding" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì›ì²œì„¸ ì‹ ê³ </button>
                        <button onclick="filterTaxDocs('statement')" id="taxDocTab-statement" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì§€ê¸‰ëª…ì„¸ì„œ</button>
                        <button onclick="filterTaxDocs('other')" id="taxDocTab-other" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ê¸°íƒ€ ì„œë¥˜</button>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´ íŒŒì¼</div><div class="text-xl font-bold text-blue-400" id="taxdoc-total">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì›ì²œì„¸ ì‹ ê³ </div><div class="text-xl font-bold text-blue-400" id="taxdoc-withholding">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§€ê¸‰ëª…ì„¸ì„œ</div><div class="text-xl font-bold text-blue-400" id="taxdoc-statement">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê¸°íƒ€ ì„œë¥˜</div><div class="text-xl font-bold text-yellow-400" id="taxdoc-other">0ê°œ</div></div>
                    </div>
                    
                    <!-- ê²€ìƒ‰/í•„í„° -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="taxDocSearch" class="input-field flex-1" style="min-width:200px" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." onkeyup="renderTaxDocTable()">
                            <input type="month" id="taxDocMonth" class="input-field" style="width:150px" onchange="renderTaxDocTable()">
                        </div>
                    </div>
                    
                    <!-- íŒŒì¼ ëª©ë¡ -->
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>íŒŒì¼ëª…</th><th>ì„œë¥˜ì¼ì</th><th>ì„¤ëª…</th><th>í¬ê¸°</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="taxDocTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ë¬¸ì„œ ê´€ë¦¬ (ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨) -->
                <div id="tab-docs" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“ ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openDocUploadModal()" class="btn-primary btn-sm">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                        </div>
                    </div>
                    
                    <!-- ì„¤ëª… ë°°ë„ˆ -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-blue-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ¢</span>
                            <div>
                                <p class="text-blue-400 font-bold">ë²•ì¸ì„œë¥˜ í´ë¼ìš°ë“œ ë³´ê´€í•¨</p>
                                <p class="text-gray-400 text-sm">ì‚¬ì—…ìë“±ë¡ì¦, ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸, ê³„ì•½ì„œ ë“± ì¤‘ìš” ë²•ì¸ì„œë¥˜ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
                    <div class="flex gap-2 mb-4 border-b border-white/10 pb-2 flex-wrap">
                        <button onclick="filterCorpDocs('all')" id="corpDocTab-all" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-blue-500/20 text-blue-400">ì „ì²´</button>
                        <button onclick="filterCorpDocs('business')" id="corpDocTab-business" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì‚¬ì—…ìë“±ë¡ì¦</button>
                        <button onclick="filterCorpDocs('corporate')" id="corpDocTab-corporate" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸</button>
                        <button onclick="filterCorpDocs('contract')" id="corpDocTab-contract" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ê³„ì•½ì„œ</button>
                        <button onclick="filterCorpDocs('license')" id="corpDocTab-license" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì¸í—ˆê°€ì„œë¥˜</button>
                        <button onclick="filterCorpDocs('other')" id="corpDocTab-other" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ê¸°íƒ€</button>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="corpdoc-total">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ì—…ìë“±ë¡</div><div class="text-xl font-bold text-blue-400" id="corpdoc-business">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë“±ê¸°ë¶€ë“±ë³¸</div><div class="text-xl font-bold text-blue-400" id="corpdoc-corporate">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³„ì•½ì„œ</div><div class="text-xl font-bold text-yellow-400" id="corpdoc-contract">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì¸í—ˆê°€</div><div class="text-xl font-bold text-green-400" id="corpdoc-license">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê¸°íƒ€</div><div class="text-xl font-bold text-gray-400" id="corpdoc-other">0ê°œ</div></div>
                    </div>
                    
                    <!-- ê²€ìƒ‰/í•„í„° -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="corpDocSearch" class="input-field flex-1" style="min-width:200px" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." onkeyup="renderCorpDocTable()">
                            <select id="corpDocEntity" class="input-field" style="width:150px" onchange="renderCorpDocTable()"><option value="">ì „ì²´ ë²•ì¸</option></select>
                        </div>
                    </div>
                    
                    <!-- íŒŒì¼ ëª©ë¡ -->
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>íŒŒì¼ëª…</th><th>ë²•ì¸/ëŒ€ìƒ</th><th>ì„¤ëª…</th><th>í¬ê¸°</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="corpDocTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì—‘ì…€ ê´€ë¦¬ -->
                <div id="tab-excel" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“Š ì—‘ì…€ ê´€ë¦¬</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">ğŸï¸</div><div><h4 class="font-bold">ë¼ì´ë” í…œí”Œë¦¿</h4><p class="text-xs text-gray-400">ì¼ê´„ ì—…ë¡œë“œìš©</p></div></div>
                            <button onclick="downloadTemplate('rider')" class="btn-secondary btn-sm w-full">ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">ğŸ¤</div><div><h4 class="font-bold">í˜‘ë ¥ì‚¬ í…œí”Œë¦¿</h4><p class="text-xs text-gray-400">ì¼ê´„ ì—…ë¡œë“œìš©</p></div></div>
                            <button onclick="downloadTemplate('partner')" class="btn-secondary btn-sm w-full">ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">ğŸ’¼</div><div><h4 class="font-bold">ì˜ì—…ì í…œí”Œë¦¿</h4><p class="text-xs text-gray-400">ì¼ê´„ ì—…ë¡œë“œìš©</p></div></div>
                            <button onclick="downloadTemplate('sales')" class="btn-secondary btn-sm w-full">ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                </div>

                <!-- ì¹´ë“œ ê´€ë¦¬ -->
                <div id="tab-cards" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’³ ì¹´ë“œ ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openCardModal()" class="btn-primary btn-sm">+ ì¹´ë“œ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="card-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ìš©ì¤‘</div><div class="text-xl font-bold text-green-400" id="card-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì¼ì‹œì¤‘ì§€</div><div class="text-xl font-bold text-yellow-400" id="card-suspended">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì‚¬ìš©ì•¡</div><div class="text-xl font-bold text-blue-400" id="card-monthly">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>ì¹´ë“œë³„ì¹­</th><th>ì¹´ë“œë²ˆí˜¸</th><th>ì¹´ë“œì‚¬</th><th>ë‹´ë‹¹ì</th><th>ì¼í•œë„</th><th>ì›”í•œë„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="cardTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                    <h3 class="text-lg font-bold mb-4">ğŸ“‹ ìµœê·¼ ì‚¬ìš©ë‚´ì—­</h3>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì‹œ</th><th>ì¹´ë“œ</th><th>ê°€ë§¹ì </th><th>ê¸ˆì•¡</th><th>ì¦ë¹™</th><th>íšŒê³„</th></tr></thead>
                        <tbody id="cardTransTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì •ì‚° í˜„í™© ëŒ€ì‹œë³´ë“œ -->
                <div id="tab-sett-dashboard" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“Š ì •ì‚° í˜„í™©</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">í”Œë«í¼ ë°›ì„ê¸ˆì•¡</div>
                            <div class="text-2xl font-bold text-blue-400" id="sett-dash-platform">â‚©0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">ì„ ì •ì‚° ì§€ê¸‰ì•¡</div>
                            <div class="text-2xl font-bold text-red-400" id="sett-dash-advance">â‚©0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">ì°¨ì•¡ (ìˆ˜ìµ)</div>
                            <div class="text-2xl font-bold text-blue-400" id="sett-dash-profit">â‚©0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">ëŒ€ì‚¬ ë¯¸ì™„ë£Œ</div>
                            <div class="text-2xl font-bold text-yellow-400" id="sett-dash-pending">0ê±´</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="font-bold mb-4 text-blue-400">ğŸ“¥ ìµœê·¼ í”Œë«í¼ ì •ì‚°</h3>
                            <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>í”Œë«í¼</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                            <tbody id="settDashPlatformTable"><tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="font-bold mb-4 text-red-400">ğŸ“¤ ìµœê·¼ ì„ ì •ì‚° ì§€ê¸‰</h3>
                            <table class="data-table"><thead><tr><th>ì¼ì</th><th>í˜‘ë ¥ì‚¬</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                            <tbody id="settDashAdvanceTable"><tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- í”Œë«í¼ ì •ì‚° -->
                <div id="tab-platform" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“¥ í”Œë«í¼ì •ì‚°ì…ê¸ˆ</h2>
                        <button onclick="openPlatformModal()" class="btn-primary btn-sm">+ ì •ì‚° ë“±ë¡</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="plat-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê±´ìˆ˜</div><div class="text-xl font-bold text-yellow-400" id="plat-count-stat">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³µê¸‰ê°€ í•©ê³„</div><div class="text-xl font-bold text-green-400" id="plat-supply-stat">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê¸ˆì•¡</div><div class="text-xl font-bold text-blue-400" id="plat-amount">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>í”Œë«í¼</th><th>ì…‹íŠ¸ê¸°ê°„</th><th>ì™„ë£Œê±´ìˆ˜</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ê²°ì œì…ê¸ˆì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="platformTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì„ ì •ì‚° ì§€ê¸‰ -->
                <div id="tab-sett-advance" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“¤ ì„ ì •ì‚° ì§€ê¸‰ (í•˜ìœ„ë²•ì¸)</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="syncFromPlatformSettlement()" class="btn-secondary btn-sm">ğŸ”„ í”Œë«í¼ì •ì‚° ì—°ë™</button>
                            <button onclick="downloadSettAdvanceTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('settAdvanceExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportSettAdvanceExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openSettAdvanceModal()" class="btn-primary btn-sm">+ ì§€ê¸‰ ë“±ë¡</button>
                            <input type="file" id="settAdvanceExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadSettAdvanceExcel(this)">
                        </div>
                    </div>
                    
                    <!-- ì„¤ëª… ë°°ë„ˆ -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-yellow-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ’¡</span>
                            <div>
                                <p class="text-yellow-400 font-bold">ì„ ì •ì‚°ì´ë€?</p>
                                <p class="text-gray-400 text-sm">í”Œë«í¼(ë°°ë¯¼/ì¿ íŒ¡) ì •ì‚°ê¸ˆ ì…ê¸ˆ ì „, íŒ€ë¸Œë¡œê°€ í•˜ìœ„ë²•ì¸(í˜‘ë ¥ì‚¬)ì—ê²Œ ë¨¼ì € ìµì¼ ì •ì‚°í•´ì£¼ëŠ” ê²ƒ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="settadv-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="settadv-pending">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§€ê¸‰ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="settadv-transferred">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-red-400" id="settadv-amount">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ</div><div class="text-xl font-bold text-blue-400" id="settadv-fee-income">â‚©0</div></div>
                    </div>
                    
                    <!-- í•„í„° -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="settAdvMonthFilter" class="input-field" style="width:150px" onchange="renderSettAdvanceTable()">
                            <select id="settAdvPartnerFilter" class="input-field" style="width:150px" onchange="renderSettAdvanceTable()"><option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option></select>
                            <select id="settAdvStatusFilter" class="input-field" style="width:100px" onchange="renderSettAdvanceTable()"><option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="transferred">ì™„ë£Œ</option></select>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì§€ê¸‰ì¼</th><th>í˜‘ë ¥ì‚¬(í•˜ìœ„ë²•ì¸)</th><th>ì£¼ì°¨</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="settAdvanceTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ëŒ€ì‚¬ê´€ë¦¬ -->
                <div id="tab-reconcile" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ”„ ëŒ€ì‚¬ê´€ë¦¬ (ë§¤ì¹­)</h2>
                        <div class="flex gap-2">
                            <button onclick="autoReconcile()" class="btn-secondary btn-sm">âš¡ ìë™ ëŒ€ì‚¬</button>
                            <button onclick="openReconcileModal()" class="btn-primary btn-sm">+ ìˆ˜ë™ ëŒ€ì‚¬</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="rec-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="rec-pending">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="rec-matched">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¶ˆì¼ì¹˜</div><div class="text-xl font-bold text-red-400" id="rec-issue">0ê±´</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>í˜‘ë ¥ì‚¬</th><th>í”Œë«í¼ê¸ˆì•¡</th><th>ì„ ì •ì‚°ê¸ˆì•¡</th><th>ì°¨ì•¡</th><th>ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="reconcileTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì£¼ì •ì‚° ì§€ê¸‰ -->
                <div id="tab-weekly-payout" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“† ì£¼ì •ì‚° ì§€ê¸‰</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadWeeklyPayoutTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('weeklyPayoutExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportWeeklyPayoutExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openWeeklyPayoutModal()" class="btn-primary btn-sm">+ ì£¼ì •ì‚° ë“±ë¡</button>
                            <input type="file" id="weeklyPayoutExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadWeeklyPayoutExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="weekly-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="weekly-pending">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§€ê¸‰ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="weekly-paid">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="weekly-amount">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="weeklyWeekFilter" class="input-field" style="width:130px" placeholder="ì£¼ì°¨ (2025-W03)">
                            <select id="weeklyStatusFilter" class="input-field" style="width:100px" onchange="renderWeeklyPayoutTable()"><option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select>
                            <input type="text" id="weeklySearch" class="input-field flex-1" style="min-width:150px" placeholder="ë¼ì´ë”/í˜‘ë ¥ì‚¬ ê²€ìƒ‰..." onkeyup="renderWeeklyPayoutTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>ë¼ì´ë”</th><th>í˜‘ë ¥ì‚¬</th><th>ë°°ë‹¬ê±´ìˆ˜</th><th>ë°°ë‹¬ìˆ˜ìµ</th><th>ê³µì œì•¡</th><th>ì‹¤ì§€ê¸‰ì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="weeklyPayoutTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- í˜„ê¸ˆì¶œë‚©ì¥ -->
                <div id="tab-bank" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“’ í˜„ê¸ˆì¶œë‚©ì¥</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadCashbookTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('bankExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportCashbookExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openCashbookModal()" class="btn-primary btn-sm">+ ê±°ë˜ ë“±ë¡</button>
                            <input type="file" id="bankExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadBankExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì…ê¸ˆ</div><div class="text-xl font-bold text-blue-400" id="bank-deposit">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì¶œê¸ˆ</div><div class="text-xl font-bold text-red-400" id="bank-withdrawal">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">í˜„ì¬ ì”ì•¡</div><div class="text-xl font-bold text-blue-400" id="bank-balance">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê±°ë˜ê±´ìˆ˜</div><div class="text-xl font-bold text-blue-400" id="bank-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì—°ê²°</div><div class="text-xl font-bold text-yellow-400" id="bank-unlinked">0ê±´</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2 items-center">
                            <input type="month" id="cashbookMonth" class="input-field" style="width:150px" onchange="renderCashbookTable()">
                            <select id="cashbookType" class="input-field" style="width:100px" onchange="renderCashbookTable()">
                                <option value="">ì „ì²´</option>
                                <option value="deposit">ì…ê¸ˆ</option>
                                <option value="withdrawal">ì¶œê¸ˆ</option>
                            </select>
                            <select id="cashbookLink" class="input-field" style="width:120px" onchange="renderCashbookTable()">
                                <option value="">ì—°ê²°ìƒíƒœ</option>
                                <option value="linked">ì—°ê²°ë¨</option>
                                <option value="unlinked">ë¯¸ì—°ê²°</option>
                            </select>
                            <input type="text" id="cashbookSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê±°ë˜ì²˜/ì ìš” ê²€ìƒ‰..." onkeyup="renderCashbookTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì</th><th>êµ¬ë¶„</th><th>ê±°ë˜ì²˜</th><th>ì…ê¸ˆ</th><th>ì¶œê¸ˆ</th><th>ì”ì•¡</th><th>ì ìš”</th><th>ì—°ê²°</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="bankTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬ -->
                <div id="tab-taxinvoice" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('taxinvoice')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('taxInvoiceExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportTaxInvoiceExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="syncTaxToSalesPurchase()" class="btn-secondary btn-sm">ğŸ”„ ë§¤ì…ë§¤ì¶œ ì—°ë™</button>
                            <button onclick="openTaxInvoiceModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="taxInvoiceExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadTaxInvoiceExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì… ê±´ìˆ˜</div><div class="text-xl font-bold text-red-400" id="inv-purchase">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì… ê¸ˆì•¡</div><div class="text-xl font-bold text-red-400" id="inv-purchase-amt">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì¶œ ê±´ìˆ˜</div><div class="text-xl font-bold text-blue-400" id="inv-sales">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì¶œ ê¸ˆì•¡</div><div class="text-xl font-bold text-blue-400" id="inv-sales-amt">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì—°ë™</div><div class="text-xl font-bold text-yellow-400" id="inv-unsynced">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="invTypeFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">ì „ì²´</option><option value="purchase">ë§¤ì…</option><option value="sales">ë§¤ì¶œ</option></select>
                            <select id="invStatusFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">ì „ì²´</option><option value="unpaid">ë¯¸ì§€ê¸‰</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select>
                            <select id="invSyncFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">ì—°ë™ìƒíƒœ</option><option value="synced">ì—°ë™ë¨</option><option value="unsynced">ë¯¸ì—°ë™</option></select>
                            <input type="month" id="invMonthFilter" class="input-field" style="width:150px" onchange="renderTaxInvoiceTable()">
                            <input type="text" id="invSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê±°ë˜ì²˜ ê²€ìƒ‰..." onkeyup="renderTaxInvoiceTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ìœ í˜•</th><th>ë°œí–‰ì¼</th><th>ê±°ë˜ì²˜</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ì§€ê¸‰ìƒíƒœ</th><th>ì—°ë™</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="taxInvoiceTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- íšŒê³„ ê´€ë¦¬ -->
                <div id="tab-accounting" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“Š íšŒê³„ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="showAccSubTab('salesPurchase')" class="btn-primary btn-sm" id="btn-salesPurchase">ğŸ“‹ ë§¤ì…ë§¤ì¶œ</button>
                            <button onclick="showAccSubTab('ledger')" class="btn-secondary btn-sm" id="btn-ledger">ğŸ“š ì´ê³„ì •ì›ì¥</button>
                            <button onclick="showAccSubTab('journal')" class="btn-secondary btn-sm" id="btn-journal">ğŸ“’ ë¶„ê°œì¥</button>
                        </div>
                    </div>
                    
                    <!-- ìš”ì•½ ëŒ€ì‹œë³´ë“œ -->
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ë§¤ì¶œ</div><div class="text-xl font-bold text-blue-400" id="acc-sales">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ë§¤ì…</div><div class="text-xl font-bold text-red-400" id="acc-purchase">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì¶œ ë¶€ê°€ì„¸</div><div class="text-xl font-bold text-blue-300" id="acc-sales-vat">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì… ë¶€ê°€ì„¸</div><div class="text-xl font-bold text-red-300" id="acc-purchase-vat">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë‚©ë¶€ ë¶€ê°€ì„¸</div><div class="text-xl font-bold text-yellow-400" id="acc-vat-pay">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìˆœì´ìµ</div><div class="text-xl font-bold text-blue-400" id="acc-profit">â‚©0</div></div>
                    </div>
                    
                    <!-- ë§¤ì…ë§¤ì¶œì¥ -->
                    <div id="accSubTab-salesPurchase">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">ğŸ“‹ ë§¤ì…ë§¤ì¶œì¥</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadSalesPurchaseTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                                <button onclick="document.getElementById('salesPurchaseExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                                <button onclick="exportSalesPurchaseExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                                <button onclick="syncFromSettlements()" class="btn-secondary btn-sm">ğŸ”„ ì •ì‚° ì—°ë™</button>
                                <button onclick="openSalesPurchaseModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                                <input type="file" id="salesPurchaseExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadSalesPurchaseExcel(this)">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="spMonthFilter" class="input-field" style="width:150px" onchange="renderSalesPurchaseTable()">
                                <select id="spTypeFilter" class="input-field" style="width:100px" onchange="renderSalesPurchaseTable()">
                                    <option value="">ì „ì²´</option>
                                    <option value="sales">ë§¤ì¶œ</option>
                                    <option value="purchase">ë§¤ì…</option>
                                </select>
                                <select id="spTaxFilter" class="input-field" style="width:120px" onchange="renderSalesPurchaseTable()">
                                    <option value="">ì„¸ê¸ˆê³„ì‚°ì„œ</option>
                                    <option value="issued">ë°œí–‰</option>
                                    <option value="received">ìˆ˜ì·¨</option>
                                    <option value="pending">ë¯¸ë°œí–‰</option>
                                </select>
                                <input type="text" id="spSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê±°ë˜ì²˜/í’ˆëª© ê²€ìƒ‰..." onkeyup="renderSalesPurchaseTable()">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden mb-6">
                            <table class="data-table"><thead><tr><th>ì¼ì</th><th>êµ¬ë¶„</th><th>ê±°ë˜ì²˜</th><th>í’ˆëª©</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ì„¸ê¸ˆê³„ì‚°ì„œ</th><th>ì—°ê²°</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="salesPurchaseTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                        </div>
                    </div>
                    
                    <!-- ë¶„ê°œì¥ -->
                    <div id="accSubTab-journal" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">ğŸ“’ ë¶„ê°œì¥</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadTemplate('journal')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                                <button onclick="document.getElementById('journalExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                                <button onclick="exportJournalExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                                <button onclick="openJournalModal()" class="btn-primary btn-sm">+ ë¶„ê°œ ë“±ë¡</button>
                                <input type="file" id="journalExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadJournalExcel(this)">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="accMonthFilter" class="input-field" style="width:150px" onchange="renderJournalTable()">
                                <select id="accStatusFilter" class="input-field" style="width:100px" onchange="renderJournalTable()"><option value="">ì „ì²´</option><option value="created">ìƒì„±</option><option value="confirmed">í™•ì •</option></select>
                                <select id="accAccountFilter" class="input-field" style="width:150px" onchange="renderJournalTable()">
                                    <option value="">ì „ì²´ ê³„ì •</option>
                                    <optgroup label="ìì‚°">
                                        <option value="101">í˜„ê¸ˆ</option>
                                        <option value="102">ë³´í†µì˜ˆê¸ˆ</option>
                                        <option value="108">ë§¤ì¶œì±„ê¶Œ</option>
                                        <option value="120">ì¬ê³ ìì‚°</option>
                                    </optgroup>
                                    <optgroup label="ë¶€ì±„">
                                        <option value="201">ë§¤ì…ì±„ë¬´</option>
                                        <option value="210">ë¯¸ì§€ê¸‰ê¸ˆ</option>
                                        <option value="220">ì˜ˆìˆ˜ê¸ˆ</option>
                                    </optgroup>
                                    <optgroup label="ìˆ˜ìµ">
                                        <option value="401">ë§¤ì¶œ</option>
                                        <option value="402">ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</option>
                                    </optgroup>
                                    <optgroup label="ë¹„ìš©">
                                        <option value="501">ê¸‰ì—¬</option>
                                        <option value="502">ì„ì°¨ë£Œ</option>
                                        <option value="503">í†µì‹ ë¹„</option>
                                        <option value="504">ì†Œëª¨í’ˆë¹„</option>
                                        <option value="510">ì°¨ëŸ‰ìœ ì§€ë¹„</option>
                                    </optgroup>
                                </select>
                                <input type="text" id="accSearch" class="input-field flex-1" style="min-width:150px" placeholder="ì ìš” ê²€ìƒ‰..." onkeyup="renderJournalTable()">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden">
                            <table class="data-table"><thead><tr><th>ì¼ì</th><th>ë¶„ê°œë²ˆí˜¸</th><th>ì°¨ë³€ê³„ì •</th><th>ì°¨ë³€ê¸ˆì•¡</th><th>ëŒ€ë³€ê³„ì •</th><th>ëŒ€ë³€ê¸ˆì•¡</th><th>ì ìš”</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="journalTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                        </div>
                    </div>
                    
                    <!-- ì´ê³„ì •ì›ì¥ -->
                    <div id="accSubTab-ledger" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">ğŸ“š ì´ê³„ì •ì›ì¥</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="exportLedgerExcel()" class="btn-secondary btn-sm">ğŸ“Š ì—‘ì…€ ë‹¤ìš´</button>
                                <button onclick="renderLedgerTable()" class="btn-secondary btn-sm">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="ledgerMonthFilter" class="input-field" style="width:150px" onchange="renderLedgerTable()">
                                <select id="ledgerCategoryFilter" class="input-field" style="width:120px" onchange="renderLedgerTable()">
                                    <option value="">ì „ì²´ ë¶„ë¥˜</option>
                                    <option value="asset">ìì‚°</option>
                                    <option value="liability">ë¶€ì±„</option>
                                    <option value="equity">ìë³¸</option>
                                    <option value="revenue">ìˆ˜ìµ</option>
                                    <option value="expense">ë¹„ìš©</option>
                                </select>
                            </div>
                        </div>
                        <!-- ê³„ì •ê³¼ëª©ë³„ ìš”ì•½ ì¹´ë“œ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-blue-400">
                                <div class="text-gray-400 text-xs">ìì‚° ì´ê³„</div>
                                <div class="text-xl font-bold text-blue-400" id="ledger-asset">â‚©0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-red-400">
                                <div class="text-gray-400 text-xs">ë¶€ì±„ ì´ê³„</div>
                                <div class="text-xl font-bold text-red-400" id="ledger-liability">â‚©0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-green-400">
                                <div class="text-gray-400 text-xs">ìˆ˜ìµ ì´ê³„</div>
                                <div class="text-xl font-bold text-green-400" id="ledger-revenue">â‚©0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-orange-400">
                                <div class="text-gray-400 text-xs">ë¹„ìš© ì´ê³„</div>
                                <div class="text-xl font-bold text-orange-400" id="ledger-expense">â‚©0</div>
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden">
                            <table class="data-table"><thead><tr><th>ê³„ì •ì½”ë“œ</th><th>ê³„ì •ê³¼ëª©</th><th>ë¶„ë¥˜</th><th>ì°¨ë³€ í•©ê³„</th><th>ëŒ€ë³€ í•©ê³„</th><th>ì”ì•¡</th><th>ê±°ë˜ê±´ìˆ˜</th></tr></thead>
                            <tbody id="ledgerTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- ì´ê³„ì •ì›ì¥ (ë…ë¦½íƒ­) -->
                <div id="tab-ledger" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“š ì´ê³„ì •ì›ì¥</h2>
                        <div class="flex gap-2">
                            <button onclick="exportLedgerExcel()" class="btn-secondary btn-sm">ğŸ“Š ì—‘ì…€ ë‹¤ìš´</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-blue-400"><div class="text-gray-400 text-xs">ìì‚° ì´ê³„</div><div class="text-xl font-bold text-blue-400" id="ledger2-asset">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-red-400"><div class="text-gray-400 text-xs">ë¶€ì±„ ì´ê³„</div><div class="text-xl font-bold text-red-400" id="ledger2-liability">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-green-400"><div class="text-gray-400 text-xs">ìˆ˜ìµ ì´ê³„</div><div class="text-xl font-bold text-green-400" id="ledger2-revenue">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-orange-400"><div class="text-gray-400 text-xs">ë¹„ìš© ì´ê³„</div><div class="text-xl font-bold text-orange-400" id="ledger2-expense">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="ledger2MonthFilter" class="input-field" style="width:150px" onchange="renderLedgerTable2()">
                            <select id="ledger2CategoryFilter" class="input-field" style="width:120px" onchange="renderLedgerTable2()">
                                <option value="">ì „ì²´ ë¶„ë¥˜</option>
                                <option value="asset">ìì‚°</option>
                                <option value="liability">ë¶€ì±„</option>
                                <option value="revenue">ìˆ˜ìµ</option>
                                <option value="expense">ë¹„ìš©</option>
                            </select>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ê³„ì •ì½”ë“œ</th><th>ê³„ì •ê³¼ëª©</th><th>ë¶„ë¥˜</th><th>ì°¨ë³€ í•©ê³„</th><th>ëŒ€ë³€ í•©ê³„</th><th>ì”ì•¡</th><th>ê±°ë˜ê±´ìˆ˜</th></tr></thead>
                        <tbody id="ledger2TableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ë¶„ê°œì¥ (ë…ë¦½íƒ­) -->
                <div id="tab-journal" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“’ ë¶„ê°œì¥</h2>
                        <div class="flex gap-2">
                            <button onclick="downloadTemplate('journal')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('journalExcelInput2').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportJournalExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="openJournalModal()" class="btn-primary btn-sm">+ ë¶„ê°œ ë“±ë¡</button>
                            <input type="file" id="journalExcelInput2" accept=".xlsx,.xls" class="hidden" onchange="uploadJournalExcel(this)">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="journal2MonthFilter" class="input-field" style="width:150px" onchange="renderJournalTable2()">
                            <select id="journal2StatusFilter" class="input-field" style="width:100px" onchange="renderJournalTable2()"><option value="">ì „ì²´</option><option value="created">ìƒì„±</option><option value="confirmed">í™•ì •</option></select>
                            <input type="text" id="journal2Search" class="input-field flex-1" style="min-width:150px" placeholder="ì ìš” ê²€ìƒ‰..." onkeyup="renderJournalTable2()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì</th><th>ë¶„ê°œë²ˆí˜¸</th><th>ì°¨ë³€ê³„ì •</th><th>ì°¨ë³€ê¸ˆì•¡</th><th>ëŒ€ë³€ê³„ì •</th><th>ëŒ€ë³€ê¸ˆì•¡</th><th>ì ìš”</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="journal2TableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì¹´ë“œ ì‚¬ìš©ë‚´ì—­ -->
                <div id="tab-card-usage" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’³ ì¹´ë“œ ì‚¬ìš©ë‚´ì—­</h2>
                        <div class="flex gap-2">
                            <button onclick="exportCardTransExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="openCardTransModal()" class="btn-primary btn-sm">+ ì‚¬ìš©ë‚´ì—­ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì‚¬ìš©</div><div class="text-xl font-bold text-red-400" id="card-usage-monthly">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ìš©ê±´ìˆ˜</div><div class="text-xl font-bold text-blue-400" id="card-usage-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì¦ë¹™</div><div class="text-xl font-bold text-yellow-400" id="card-usage-noreceipt">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì²˜ë¦¬</div><div class="text-xl font-bold text-orange-400" id="card-usage-pending">0ê±´</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì‹œ</th><th>ì¹´ë“œ</th><th>ê°€ë§¹ì </th><th>ê¸ˆì•¡</th><th>ì¦ë¹™</th><th>íšŒê³„ì²˜ë¦¬</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="cardUsageTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì§ì› ê´€ë¦¬ -->
                <div id="tab-employees" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ‘¤ ì§ì› ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openEmployeeModal()" class="btn-primary btn-sm">+ ì§ì› ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-blue-400" id="emp2-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì •ê·œì§</div><div class="text-xl font-bold text-blue-400" id="emp2-regular">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³„ì•½ì§</div><div class="text-xl font-bold text-yellow-400" id="emp2-contract">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">4ëŒ€ë³´í—˜</div><div class="text-xl font-bold text-green-400" id="emp2-insured">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>êµ¬ë¶„</th><th>ë¶€ì„œ</th><th>ê¸°ë³¸ê¸‰</th><th>4ëŒ€ë³´í—˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="employees2TableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ê¸‰ì—¬ ê´€ë¦¬ -->
                <div id="tab-payroll" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openPayrollModal()" class="btn-primary btn-sm">+ ê¸‰ì—¬ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì§€ê¸‰</div><div class="text-xl font-bold text-blue-400" id="pay2-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="pay2-gross">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê³µì œì•¡</div><div class="text-xl font-bold text-red-400" id="pay2-deduct">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‹¤ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="pay2-net">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì§€ê¸‰ì›”</th><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ìˆ˜ë‹¹</th><th>ê³µì œ</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="payroll2TableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ê·¼ë¡œê³„ì•½ -->
                <div id="tab-contracts" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“ ê·¼ë¡œê³„ì•½ ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openContractModal()" class="btn-primary btn-sm">+ ê³„ì•½ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´ ê³„ì•½</div><div class="text-xl font-bold text-blue-400" id="contract-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìœ íš¨ ê³„ì•½</div><div class="text-xl font-bold text-green-400" id="contract-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§Œë£Œ ì˜ˆì •</div><div class="text-xl font-bold text-yellow-400" id="contract-expiring">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§Œë£Œë¨</div><div class="text-xl font-bold text-red-400" id="contract-expired">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì§ì›</th><th>ê³„ì•½ìœ í˜•</th><th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th><th>ê¸°ë³¸ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="contracts2TableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ê°ì‚¬ ë¡œê·¸ -->
                <div id="tab-logs" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“œ ê°ì‚¬ ë¡œê·¸</h2>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="logTableFilter" class="input-field" style="width:150px" onchange="renderAuditLogs()"><option value="">ì „ì²´ í…Œì´ë¸”</option><option value="corporate_cards">ë²•ì¸ì¹´ë“œ</option><option value="card_transactions">ì¹´ë“œì‚¬ìš©</option><option value="hq_tax_invoices">ì„¸ê¸ˆê³„ì‚°ì„œ</option><option value="accounting_journals">íšŒê³„ë¶„ê°œ</option></select>
                            <select id="logActionFilter" class="input-field" style="width:100px" onchange="renderAuditLogs()"><option value="">ì „ì²´</option><option value="INSERT">ë“±ë¡</option><option value="UPDATE">ìˆ˜ì •</option><option value="DELETE">ì‚­ì œ</option></select>
                            <input type="date" id="logDateFilter" class="input-field" style="width:150px" onchange="renderAuditLogs()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì‹œ</th><th>í…Œì´ë¸”</th><th>ì•¡ì…˜</th><th>ë ˆì½”ë“œID</th><th>ë³€ê²½ì</th><th>ìƒì„¸</th></tr></thead>
                        <tbody id="auditLogTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
                <div id="tab-settings" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2>
                    <div class="glass-card rounded-xl p-8 text-center"><div class="text-4xl mb-4">âš™ï¸</div><p class="text-gray-400">ì‹œìŠ¤í…œ ì„¤ì • ê¸°ëŠ¥ ì¤€ë¹„ì¤‘</p></div>
                </div>

                <!-- ğŸ” ë¹„ë°€ ê³µê°„ -->
                <div id="tab-secret" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-400">ğŸ” Secret Space</h2>
                        <button onclick="lockSecretSpace()" class="btn-secondary btn-sm">ğŸ”’ ì ê·¸ê¸°</button>
                    </div>
                    
                    <!-- ë¹„ë°€ ë©”ë‰´ íƒ­ -->
                    <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                        <button onclick="showSecretTab('cashbook')" id="secret-tab-cashbook" class="px-4 py-2 rounded-lg font-bold text-sm bg-purple-500/20 text-purple-400 border border-purple-500/50">ğŸ’° ê¸ˆì „ì¶œë‚©ë¶€</button>
                        <button onclick="showSecretTab('ilsu')" id="secret-tab-ilsu" class="px-4 py-2 rounded-lg font-bold text-sm bg-zinc-800 text-gray-400 hover:bg-purple-500/10">ğŸ“… ì¼ìˆ˜ì¥ë¶€</button>
                        <button onclick="showSecretTab('loan')" id="secret-tab-loan" class="px-4 py-2 rounded-lg font-bold text-sm bg-zinc-800 text-gray-400 hover:bg-purple-500/10">ğŸ¦ ëŒ€ì¶œì¥ë¶€</button>
                        <button onclick="showSecretTab('vault')" id="secret-tab-vault" class="px-4 py-2 rounded-lg font-bold text-sm bg-zinc-800 text-gray-400 hover:bg-purple-500/10">ğŸ”‘ ë¹„ë°€ê¸ˆê³ </button>
                        <button onclick="showSecretTab('bigdata')" id="secret-tab-bigdata" class="px-4 py-2 rounded-lg font-bold text-sm bg-zinc-800 text-gray-400 hover:bg-purple-500/10">ğŸ“Š My BigData</button>
                    </div>
                    
                    <!-- ğŸ’° ê¸ˆì „ì¶œë‚©ë¶€ -->
                    <div id="secret-content-cashbook" class="secret-tab-content">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ìˆ˜ì…</div><div class="text-xl font-bold text-green-400" id="scb-income">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ì¶œ</div><div class="text-xl font-bold text-red-400" id="scb-expense">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì”ì•¡</div><div class="text-xl font-bold text-purple-400" id="scb-balance">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬</div><div class="text-xl font-bold text-blue-400" id="scb-month">â‚©0</div></div>
                        </div>
                        <div class="glass-card rounded-xl p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-purple-400">ğŸ’° ê¸ˆì „ì¶œë‚©ë¶€</h3>
                                <button onclick="openSecretCashbookModal()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ ë‚´ì—­ ì¶”ê°€</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="data-table"><thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ë‚´ìš©</th><th>ê¸ˆì•¡</th><th>ì”ì•¡</th><th>ê´€ë¦¬</th></tr></thead>
                                <tbody id="secretCashbookBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ“… ì¼ìˆ˜ì¥ë¶€ -->
                    <div id="secret-content-ilsu" class="secret-tab-content hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì›ê¸ˆ</div><div class="text-xl font-bold text-blue-400" id="ilsu-principal">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë°›ì„ ì´ì</div><div class="text-xl font-bold text-green-400" id="ilsu-interest">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">íšŒìˆ˜ì™„ë£Œ</div><div class="text-xl font-bold text-purple-400" id="ilsu-collected">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§„í–‰ì¤‘</div><div class="text-xl font-bold text-yellow-400" id="ilsu-active">0ê±´</div></div>
                        </div>
                        <div class="glass-card rounded-xl p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-purple-400">ğŸ“… ì¼ìˆ˜ì¥ë¶€ (ì¼ì¼ ìƒí™˜)</h3>
                                <button onclick="openIlsuModal()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ ì¼ìˆ˜ ë“±ë¡</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="data-table"><thead><tr><th>ì´ë¦„</th><th>ì›ê¸ˆ</th><th>ì¼ì´ì</th><th>ì‹œì‘ì¼</th><th>ê¸°ê°„</th><th>íšŒìˆ˜ì•¡</th><th>ì”ì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                                <tbody id="ilsuTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ¦ ëŒ€ì¶œì¥ë¶€ -->
                    <div id="secret-content-loan" class="secret-tab-content hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ëŒ€ì¶œê¸ˆ</div><div class="text-xl font-bold text-blue-400" id="loan-total">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë°›ì„ ì´ì</div><div class="text-xl font-bold text-green-400" id="loan-interest">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìƒí™˜ì™„ë£Œ</div><div class="text-xl font-bold text-purple-400" id="loan-paid">â‚©0</div></div>
                            <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§„í–‰ì¤‘</div><div class="text-xl font-bold text-yellow-400" id="loan-active">0ê±´</div></div>
                        </div>
                        <div class="glass-card rounded-xl p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-purple-400">ğŸ¦ ëŒ€ì¶œì¥ë¶€</h3>
                                <button onclick="openLoanModal()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ ëŒ€ì¶œ ë“±ë¡</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="data-table"><thead><tr><th>ì´ë¦„</th><th>ëŒ€ì¶œê¸ˆ</th><th>ì´ìœ¨(%)</th><th>ëŒ€ì¶œì¼</th><th>ë§Œê¸°ì¼</th><th>ìƒí™˜ì•¡</th><th>ì”ì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                                <tbody id="loanTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ”‘ ë¹„ë°€ê¸ˆê³  -->
                    <div id="secret-content-vault" class="secret-tab-content hidden">
                        <div class="glass-card rounded-xl p-5 border border-purple-500/30">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-purple-400">ğŸ”‘ ë¹„ë°€ê¸ˆê³ </h3>
                                <button onclick="addSecretVault()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ í•­ëª© ì¶”ê°€</button>
                            </div>
                            <p class="text-xs text-gray-500 mb-4">ê³„ì •, ë¹„ë°€ë²ˆí˜¸, ì¤‘ìš” ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•©ë‹ˆë‹¤.</p>
                            <div id="secretVaultList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <p class="text-gray-500 text-sm text-center py-4 col-span-full">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ“Š My BigData -->
                    <div id="secret-content-bigdata" class="secret-tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- ë©”ëª¨ -->
                            <div class="glass-card rounded-xl p-5">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-purple-400">ğŸ“ ë¹„ë°€ ë©”ëª¨</h3>
                                    <button onclick="addSecretMemo()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ ë©”ëª¨</button>
                                </div>
                                <div id="secretMemoList" class="space-y-3 max-h-80 overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-4">ì €ì¥ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                            
                            <!-- í• ì¼ -->
                            <div class="glass-card rounded-xl p-5">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-purple-400">âœ… ë¹„ë°€ í• ì¼</h3>
                                    <button onclick="addSecretTodo()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ í• ì¼</button>
                                </div>
                                <div id="secretTodoList" class="space-y-2 max-h-80 overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                            
                            <!-- ì—°ë½ì²˜ -->
                            <div class="glass-card rounded-xl p-5">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-purple-400">ğŸ“ ë¹„ë°€ ì—°ë½ì²˜</h3>
                                    <button onclick="addSecretContact()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ ì—°ë½ì²˜</button>
                                </div>
                                <div id="secretContactList" class="space-y-2 max-h-80 overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-4">ì €ì¥ëœ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                            
                            <!-- ì¼ì • -->
                            <div class="glass-card rounded-xl p-5">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-purple-400">ğŸ“† ë¹„ë°€ ì¼ì •</h3>
                                    <button onclick="addSecretSchedule()" class="btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">+ ì¼ì •</button>
                                </div>
                                <div id="secretScheduleList" class="space-y-2 max-h-80 overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ë¼ì´ë” ëª¨ë‹¬ -->
    <div id="riderModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between items-center mb-4"><h3 id="riderModalTitle" class="text-xl font-bold text-blue-400">ğŸï¸ ë¼ì´ë” ë“±ë¡</h3><button onclick="closeModal('riderModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="riderForm" onsubmit="submitForm('rider',event)" class="space-y-4">
                <input type="hidden" id="rider-id">
                
                <!-- ë¼ì´ë” ê¸°ë³¸ì •ë³´ -->
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary)">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary)">ğŸ“‹ ë¼ì´ë” ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-blue-400 mb-1">ë¼ì´ë”ì´ë¦„ <span class="text-red-400">*</span></label><input type="text" id="rider-name" class="input-field" required></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ì£¼ë¯¼ë²ˆí˜¸</label><input type="text" id="rider-ssn" class="input-field" placeholder="000000-0000000" maxlength="14" oninput="formatSSN(this)"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì—°ë½ì²˜</label><input type="tel" id="rider-phone" class="input-field" placeholder="010-0000-0000" maxlength="13" oninput="formatPhone(this)"></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ì„¸ê¸ˆì²˜ë¦¬</label><select id="rider-tax-type" class="input-field"><option value="">ì„ íƒ</option><option value="ì›ì²œì§•ìˆ˜">ì›ì²œì§•ìˆ˜</option><option value="ê³¼ì„¸ì§€ì¶œ">ê³¼ì„¸ì§€ì¶œ</option></select></div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm text-blue-400 mb-1">ì£¼ì†Œ</label><input type="text" id="rider-address" class="input-field" placeholder="ì£¼ì†Œ ì…ë ¥">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì†Œì†í˜‘ë ¥ì‚¬</label><select id="rider-partner" class="input-field"><option value="">ì„ íƒì•ˆí•¨</option></select></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ë°°ë¯¼ ID</label><input type="text" id="rider-baemin-id" class="input-field" placeholder="ë°°ë¯¼ ë¼ì´ë” ID"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì¿ íŒ¡ ID</label><input type="text" id="rider-coupang-id" class="input-field" placeholder="ì¿ íŒ¡ ë¼ì´ë” ID"></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="rider-status" class="input-field"><option value="ê³„ì•½ì¤‘">ê³„ì•½ì¤‘</option><option value="ê³„ì•½ì¢…ë£Œ">ê³„ì•½ì¢…ë£Œ</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì˜ˆê¸ˆì£¼</label><input type="text" id="rider-account-holder" class="input-field"></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="rider-account-no" class="input-field"></div>
                    </div>
                </div>
                
                <!-- ì²¨ë¶€íŒŒì¼ -->
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary)">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary)">ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-sm w-28" style="color: var(--text-secondary)">ê·¼ë¡œê³„ì•½ì„œ</label>
                            <input type="file" id="rider-file-contract" class="input-field text-sm flex-1" accept=".pdf,.jpg,.jpeg,.png" onchange="showFileSelected(this, 'rider-file-contract-status')">
                            <span id="rider-file-contract-status" class="text-xs text-green-400 hidden">âœ“ ì„ íƒë¨</span>
                            <a id="rider-file-contract-link" href="#" target="_blank" class="text-xs text-blue-400 hidden">ğŸ“¥ ë³´ê¸°</a>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm w-28" style="color: var(--text-secondary)">ì‹ ë¶„ì¦</label>
                            <input type="file" id="rider-file-id" class="input-field text-sm flex-1" accept=".pdf,.jpg,.jpeg,.png" onchange="showFileSelected(this, 'rider-file-id-status')">
                            <span id="rider-file-id-status" class="text-xs text-green-400 hidden">âœ“ ì„ íƒë¨</span>
                            <a id="rider-file-id-link" href="#" target="_blank" class="text-xs text-blue-400 hidden">ğŸ“¥ ë³´ê¸°</a>
                        </div>
                    </div>
                </div>
                
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="rider-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('riderModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í˜‘ë ¥ì‚¬ ëª¨ë‹¬ -->
    <div id="partnerModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4"><h3 id="partnerModalTitle" class="text-xl font-bold text-blue-400">ğŸ¤ í˜‘ë ¥ì‚¬ ë“±ë¡</h3><button onclick="closeModal('partnerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="partnerForm" onsubmit="submitForm('partner',event)" class="space-y-4">
                <input type="hidden" id="partner-id">
                
                <!-- í˜‘ë ¥ì‚¬ ê¸°ë³¸ì •ë³´ -->
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary)">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary)">ğŸ“‹ í˜‘ë ¥ì‚¬ ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-blue-400 mb-1">í˜‘ë ¥ì‚¬ëª… *</label><input type="text" id="partner-name" class="input-field" required></div>
                        <div><label class="block text-sm text-blue-400 mb-1">í˜‘ë ¥ì‚¬ì½”ë“œ *</label><input type="text" id="partner-code" class="input-field" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">êµ¬ë¶„</label><select id="partner-type" class="input-field" onchange="toggleBizFields()"><option value="non_biz">ë¹„ì‚¬ì—…ì</option><option value="biz">ì‚¬ì—…ì</option></select></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ë°°ë‹¬ê¶Œì—­</label><input type="text" id="partner-region" class="input-field" placeholder="ì˜ˆ: ê°•ë‚¨, ì„œì´ˆ, ì†¡íŒŒ"></div>
                    </div>
                    <div id="partnerBizFields" class="hidden grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="partner-bizno" class="input-field" placeholder="000-00-00000" maxlength="12" oninput="formatBizNo(this)"></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ì—…ì¢…</label><input type="text" id="partner-biztype" class="input-field"></div>
                    </div>
                    <div class="mt-3"><label class="block text-sm text-blue-400 mb-1">ì£¼ì†Œ</label><input type="text" id="partner-address" class="input-field"></div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì€í–‰</label><select id="partner-bank" class="input-field"><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option></select></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="partner-accountno" class="input-field"></div>
                    </div>
                </div>
                
                <!-- ìš´ì˜ì ì •ë³´ -->
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary)">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary)">ğŸ‘¤ ìš´ì˜ì ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-blue-400 mb-1">ìš´ì˜ì ì´ë¦„</label><input type="text" id="partner-rep" class="input-field"></div>
                        <div><label class="block text-sm text-blue-400 mb-1">ìš´ì˜ì ì£¼ë¯¼ë²ˆí˜¸</label><input type="text" id="partner-rep-ssn" class="input-field" placeholder="000000-0000000" maxlength="14" oninput="formatSSN(this)"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-blue-400 mb-1">ì—°ë½ì²˜</label><input type="tel" id="partner-phone" class="input-field" placeholder="010-0000-0000" maxlength="13" oninput="formatPhone(this)"></div>
                        <div></div>
                    </div>
                </div>
                
                <!-- ì²¨ë¶€íŒŒì¼ -->
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary)">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--text-primary)">ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <label class="text-sm w-28" style="color: var(--text-secondary)">ì‚¬ì—…ìë“±ë¡ì¦</label>
                            <input type="file" id="partner-file-bizreg" class="input-field text-sm flex-1" accept=".pdf,.jpg,.jpeg,.png" onchange="showFileSelected(this, 'partner-file-bizreg-status')">
                            <span id="partner-file-bizreg-status" class="text-xs text-green-400 hidden">âœ“ ì„ íƒë¨</span>
                            <a id="partner-file-bizreg-link" href="#" target="_blank" class="text-xs text-blue-400 hidden">ğŸ“¥ ë³´ê¸°</a>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm w-28" style="color: var(--text-secondary)">ì‚¬ì—…ì£¼ ì‹ ë¶„ì¦</label>
                            <input type="file" id="partner-file-id" class="input-field text-sm flex-1" accept=".pdf,.jpg,.jpeg,.png" onchange="showFileSelected(this, 'partner-file-id-status')">
                            <span id="partner-file-id-status" class="text-xs text-green-400 hidden">âœ“ ì„ íƒë¨</span>
                            <a id="partner-file-id-link" href="#" target="_blank" class="text-xs text-blue-400 hidden">ğŸ“¥ ë³´ê¸°</a>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="text-sm w-28" style="color: var(--text-secondary)">í˜‘ë ¥ì‚¬ ê³„ì•½ì„œ</label>
                            <input type="file" id="partner-file-contract" class="input-field text-sm flex-1" accept=".pdf,.jpg,.jpeg,.png" onchange="showFileSelected(this, 'partner-file-contract-status')">
                            <span id="partner-file-contract-status" class="text-xs text-green-400 hidden">âœ“ ì„ íƒë¨</span>
                            <a id="partner-file-contract-link" href="#" target="_blank" class="text-xs text-blue-400 hidden">ğŸ“¥ ë³´ê¸°</a>
                        </div>
                    </div>
                </div>
                
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="partner-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('partnerModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì˜ì—…ì ëª¨ë‹¬ -->
    <div id="salesModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px">
            <div class="flex justify-between items-center mb-4"><h3 id="salesModalTitle" class="text-xl font-bold text-blue-400">ğŸ’¼ ì˜ì—…ì ë“±ë¡</h3><button onclick="closeModal('salesModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="salesForm" onsubmit="submitForm('sales',event)" class="space-y-4">
                <input type="hidden" id="sales-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì˜ì—…ìì½”ë“œ *</label><input type="text" id="sales-code" class="input-field" placeholder="SB-0001" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìœ í˜• *</label><select id="sales-type" class="input-field" required onchange="toggleSalesBizFields()"><option value="individual">ê°œì¸</option><option value="sole_prop">ê°œì¸ì‚¬ì—…ì</option><option value="corporation">ë²•ì¸</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì´ë¦„ *</label><input type="text" id="sales-name" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì—°ë½ì²˜</label><input type="tel" id="sales-phone" class="input-field" placeholder="010-0000-0000" maxlength="13" oninput="formatPhone(this)"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì´ë©”ì¼</label><input type="email" id="sales-email" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ì—­</label><input type="text" id="sales-region" class="input-field"></div>
                </div>
                <div id="salesBizFields" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="sales-bizno" class="input-field" placeholder="000-00-00000" maxlength="12" oninput="formatBizNo(this)"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="sales-repname" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì£¼ì†Œ</label><input type="text" id="sales-address" class="input-field"></div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì€í–‰</label><select id="sales-bank" class="input-field"><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option><option value="KAKAO">ì¹´ì¹´ì˜¤</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì˜ˆê¸ˆì£¼</label><input type="text" id="sales-bank-holder" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="sales-bank-account" class="input-field"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ì£¼ê¸°</label><select id="sales-payout-cycle" class="input-field"><option value="monthly">ì›”</option><option value="weekly">ì£¼</option><option value="per_case">ê±´ë³„</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì›ì²œì§•ìˆ˜ìœ¨</label><select id="sales-withholding-rate" class="input-field"><option value="0.033">3.3%</option><option value="0.088">8.8%</option><option value="0">ì—†ìŒ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="sales-status" class="input-field"><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="sales-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('salesModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í˜‘ë ¥ì‚¬ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="partnerDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-400">ğŸ¤ í˜‘ë ¥ì‚¬ ìƒì„¸ì •ë³´</h3>
                <button onclick="closeModal('partnerDetailModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="partnerDetailContent" class="space-y-4">
                <!-- ë‚´ìš© ë™ì  ìƒì„± -->
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('partnerDetailModal')" class="flex-1 btn-secondary">ë‹«ê¸°</button>
                <button id="partnerDetailEditBtn" class="flex-1 btn-primary">ìˆ˜ì •</button>
            </div>
        </div>
    </div>

    <!-- ë¼ì´ë” ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="riderDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-400">ğŸï¸ ë¼ì´ë” ìƒì„¸ì •ë³´</h3>
                <button onclick="closeModal('riderDetailModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="riderDetailContent" class="space-y-4">
                <!-- ë‚´ìš© ë™ì  ìƒì„± -->
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('riderDetailModal')" class="flex-1 btn-secondary">ë‹«ê¸°</button>
                <button id="riderDetailEditBtn" class="flex-1 btn-primary">ìˆ˜ì •</button>
                <button id="riderDetailDeleteBtn" class="flex-1 btn-danger hidden">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ëª¨ë‹¬ -->
    <div id="userModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 id="userModalTitle" class="text-xl font-bold text-blue-400">ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡</h3><button onclick="closeModal('userModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="userForm" onsubmit="submitUser(event)" class="space-y-4">
                <input type="hidden" id="user-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì´ë¦„ *</label><input type="text" id="user-name" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì•„ì´ë”” *</label><input type="text" id="user-username" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="user-password" class="input-field" placeholder="ìˆ˜ì • ì‹œ ë¹ˆì¹¸ì´ë©´ ìœ ì§€"></div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì†Œì† ì‹œìŠ¤í…œ</label><select id="user-system" class="input-field"><option value="hq">íŒ€ë¸Œë¡œ HQ</option><option value="brocompany">ë¸Œë¡œì»´í¼ë‹ˆ</option><option value="bromotors">ë¸Œë¡œëª¨í„°ìŠ¤</option><option value="all">ì „ì²´</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ê¶Œí•œ</label><select id="user-role" class="input-field"><option value="VIEWER">ë·°ì–´</option><option value="STAFF">ì§ì›</option><option value="MANAGER">ë§¤ë‹ˆì €</option><option value="ADMIN">ê´€ë¦¬ì</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="user-status" class="input-field"><option value="true">í™œì„±</option><option value="false">ë¹„í™œì„±</option></select></div>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('userModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì •ì‚° ëª¨ë‹¬ -->
    <div id="settlementModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:900px">
            <div class="flex justify-between items-center mb-4"><h3 id="settlementModalTitle" class="text-xl font-bold text-blue-400">ğŸ’° ì •ì‚° ë“±ë¡</h3><button onclick="closeModal('settlementModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="settlementForm" onsubmit="submitSettlement(event)" class="space-y-4">
                <input type="hidden" id="sett-id">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="sett-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ê·¼ë¬´ì‹œì‘(ìˆ˜)</label><input type="date" id="sett-start" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ê·¼ë¬´ì¢…ë£Œ(í™”)</label><input type="date" id="sett-end" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ì˜ˆì •ì¼(ê¸ˆ)</label><input type="date" id="sett-paydate" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ë¼ì´ë” *</label><select id="sett-rider" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">í˜‘ë ¥ì‚¬</label><select id="sett-partner" class="input-field"><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">í”Œë«í¼</label><select id="sett-platform" class="input-field"><option value="">ì„ íƒ</option><option value="baemin">ë°°ë¯¼</option><option value="coupang">ì¿ íŒ¡ì´ì¸ </option><option value="yogiyo">ìš”ê¸°ìš”</option></select></div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ’µ ìˆ˜ì… í•­ëª©</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë°°ë‹¬ë£Œ</label><input type="number" id="sett-delivery" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¯¸ì…˜ë¹„</label><input type="number" id="sett-mission" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì¶”ê°€ì§€ê¸‰</label><input type="number" id="sett-extra" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í˜ì´ë°±</label><input type="number" id="sett-payback" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì¸ì„¼í‹°ë¸Œ</label><input type="number" id="sett-incentive" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">íŒ</label><input type="number" id="sett-tip" class="input-field" value="0" onchange="calcSettlement()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-red-400 font-bold mb-3">ğŸ“‰ ê³µì œ í•­ëª©</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë³´í—˜ë£Œ</label><input type="number" id="sett-insurance" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì¥ë¹„ëŒ€ì—¬ë£Œ</label><input type="number" id="sett-rental" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">íŒ¨ë„í‹°</label><input type="number" id="sett-penalty" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸°íƒ€ê³µì œ</label><input type="number" id="sett-other" class="input-field" value="0" onchange="calcSettlement()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-blue-400 font-bold mb-3">âš¡ ì„ ì •ì‚°</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì„ ì •ì‚° ê¸ˆì•¡</label><input type="number" id="sett-advance" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ìƒíƒœ</label><select id="sett-status" class="input-field"><option value="pending">ëŒ€ê¸°</option><option value="confirmed">í™•ì •</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì´ ìˆ˜ì…</div><div class="text-lg font-bold text-blue-400" id="calc-gross">â‚©0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì´ ê³µì œ</div><div class="text-lg font-bold text-red-400" id="calc-deduct">â‚©0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì„ ì •ì‚°</div><div class="text-lg font-bold text-blue-400" id="calc-advance">â‚©0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì‹¤ì§€ê¸‰ì•¡</div><div class="text-lg font-bold text-green-400" id="calc-net">â‚©0</div></div>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="sett-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('settlementModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì¹´ë“œ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="cardModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="cardModalTitle" class="text-xl font-bold text-blue-400">ğŸ’³ ì¹´ë“œ ë“±ë¡</h3><button onclick="closeModal('cardModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="cardForm" onsubmit="submitCard(event)" class="space-y-4">
                <input type="hidden" id="card-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¹´ë“œë³„ì¹­ *</label><input type="text" id="card-alias" class="input-field" placeholder="ìš´ì˜ë¹„ì¹´ë“œ" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì†Œì†ë²•ì¸</label><input type="text" id="card-company" class="input-field" placeholder="íŒ€ë¸Œë¡œ"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¹´ë“œì‚¬ *</label><select id="card-company-name" class="input-field" required><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option><option value="BC">BC</option><option value="SAMSUNG">ì‚¼ì„±</option><option value="LOTTE">ë¡¯ë°</option><option value="HYUNDAI">í˜„ëŒ€</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì¹´ë“œë²ˆí˜¸ (ë§ˆìŠ¤í‚¹)</label><input type="text" id="card-number" class="input-field" placeholder="1234-****-****-5678"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì—°ê²°í†µì¥</label><input type="text" id="card-bank" class="input-field" placeholder="ìš°ë¦¬ì€í–‰ 1002-xxx"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìœ íš¨ê¸°ê°„</label><input type="date" id="card-valid" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì‚¬ìš©ë¶€ì„œ</label><input type="text" id="card-dept" class="input-field" placeholder="ê²½ì˜ì§€ì›íŒ€"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì‹¤ì‚¬ìš©ì</label><input type="text" id="card-user" class="input-field" placeholder="í™ê¸¸ë™"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ’° í•œë„ ì„¤ì •</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì¼ í•œë„</label><input type="number" id="card-daily" class="input-field" value="0"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì›” í•œë„</label><input type="number" id="card-monthly" class="input-field" value="0"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <label class="flex items-center gap-2"><input type="checkbox" id="card-online" checked> <span class="text-sm">ì˜¨ë¼ì¸ ê²°ì œ í—ˆìš©</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="card-overseas"> <span class="text-sm">í•´ì™¸ ê²°ì œ í—ˆìš©</span></label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ë°œê¸‰ì¼</label><input type="date" id="card-issued" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="card-status" class="input-field"><option value="active">ì‚¬ìš©ì¤‘</option><option value="suspended">ì¼ì‹œì¤‘ì§€</option><option value="terminated">í•´ì§€</option></select></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="card-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('cardModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì¹´ë“œ ì‚¬ìš©ë‚´ì—­ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="cardTransModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ’³ ì‚¬ìš©ë‚´ì—­ ë“±ë¡</h3><button onclick="closeModal('cardTransModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="cardTransForm" onsubmit="submitCardTrans(event)" class="space-y-4">
                <input type="hidden" id="cardtrans-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì‚¬ìš©ì¼ì‹œ *</label><input type="datetime-local" id="cardtrans-date" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì¹´ë“œ *</label><select id="cardtrans-card" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ê°€ë§¹ì ëª… *</label><input type="text" id="cardtrans-merchant" class="input-field" required placeholder="ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì "></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ê¸ˆì•¡ *</label><input type="number" id="cardtrans-amount" class="input-field" required placeholder="0"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì—…ì¢…</label><input type="text" id="cardtrans-category" class="input-field" placeholder="ìŒì‹ì , ì£¼ìœ ì†Œ ë“±"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìŠ¹ì¸ë²ˆí˜¸</label><input type="text" id="cardtrans-approval" class="input-field" placeholder="12345678"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¦ë¹™ ìƒíƒœ</label>
                        <select id="cardtrans-evidence" class="input-field">
                            <option value="pending">ë¯¸ì œì¶œ</option>
                            <option value="submitted">ì œì¶œ</option>
                            <option value="approved">ìŠ¹ì¸</option>
                        </select>
                    </div>
                    <div><label class="block text-sm text-blue-400 mb-1">íšŒê³„ ì²˜ë¦¬</label>
                        <select id="cardtrans-accounting" class="input-field">
                            <option value="pending">ë¯¸ì²˜ë¦¬</option>
                            <option value="journalized">ë¶„ê°œì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="cardtrans-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('cardTransModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í”Œë«í¼ ì •ì‚° ëª¨ë‹¬ -->
    <div id="platformModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ“¥ í”Œë«í¼ ì •ì‚° ë“±ë¡</h3><button onclick="closeModal('platformModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="platformForm" onsubmit="submitPlatform(event)" class="space-y-4">
                <input type="hidden" id="plat-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">í”Œë«í¼ *</label><select id="plat-platform" class="input-field" required><option value="">ì„ íƒ</option><option value="baemin">ë°°ë¯¼</option><option value="coupang">ì¿ íŒ¡ì´ì¸ </option><option value="yogiyo">ìš”ê¸°ìš”</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="plat-week" class="input-field" placeholder="2025-W03" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì…‹íŠ¸ì‹œì‘</label><input type="date" id="plat-start" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì…‹íŠ¸ì¢…ë£Œ</label><input type="date" id="plat-end" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ê²°ì œì…ê¸ˆì¼</label><input type="date" id="plat-expected" class="input-field"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì´ ì™„ë£Œê±´ìˆ˜</label><input type="number" id="plat-count" class="input-field" value="0"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡</label><input type="number" id="plat-supply" class="input-field" value="0" onchange="calcPlatformVat()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="plat-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="plat-total-amt" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="plat-memo" class="input-field" rows="4"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('platformModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì„ ì •ì‚° ì§€ê¸‰ ëª¨ë‹¬ -->
    <div id="settAdvanceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-red-400">ğŸ“¤ ì„ ì •ì‚° ì§€ê¸‰ ë“±ë¡</h3><button onclick="closeModal('settAdvanceModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="settAdvanceForm" onsubmit="submitSettAdvance(event)" class="space-y-4">
                <input type="hidden" id="settadv-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">í˜‘ë ¥ì‚¬ *</label><select id="settadv-partner" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ì¼ *</label><input type="date" id="settadv-date" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì •ì‚°ì£¼ì°¨</label><input type="text" id="settadv-week" class="input-field" placeholder="2025-W03"></div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡</label><input type="number" id="settadv-supply" class="input-field" value="0" onchange="calcSettAdvanceTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="settadv-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="settadv-total-amt" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-yellow-400 font-bold mb-3">ğŸ’¸ ìˆ˜ìˆ˜ë£Œ</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label><input type="number" id="settadv-fee-rate" class="input-field" value="0" step="0.01" onchange="calcSettAdvanceTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡</label><input type="number" id="settadv-fee" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì‹¤ì§€ê¸‰ì•¡</label><input type="number" id="settadv-net" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="settadv-status" class="input-field"><option value="pending">ëŒ€ê¸°</option><option value="transferred">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="settadv-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('settAdvanceModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì„¸ë¬´ì„œë¥˜ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="taxUploadModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ“¤ ì„¸ë¬´ì„œë¥˜ ì—…ë¡œë“œ</h3><button onclick="closeModal('taxUploadModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="taxUploadForm" onsubmit="submitTaxUpload(event)" class="space-y-4">
                <div><label class="block text-sm text-blue-400 mb-1">ì¹´í…Œê³ ë¦¬ *</label>
                    <select id="taxdoc-category" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="withholding">ì›ì²œì„¸ ì‹ ê³ </option>
                        <option value="statement">ì§€ê¸‰ëª…ì„¸ì„œ</option>
                        <option value="other">ê¸°íƒ€ ì„œë¥˜</option>
                    </select>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì„œë¥˜ì¼ì</label>
                    <input type="date" id="taxdoc-date" class="input-field">
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">íŒŒì¼ ì„ íƒ * (ìµœëŒ€ 10ê°œ)</label>
                    <input type="file" id="taxdoc-file" class="input-field" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.doc,.docx" multiple required onchange="checkFileLimit(this)">
                    <p class="text-gray-500 text-xs mt-1">PDF, ì´ë¯¸ì§€, ì—‘ì…€, ì›Œë“œ íŒŒì¼ ì§€ì› | í•œ ë²ˆì— ìµœëŒ€ 10ê°œ</p>
                    <div id="selectedFileList" class="mt-2 text-sm text-gray-400"></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì„¤ëª…</label>
                    <input type="text" id="taxdoc-desc" class="input-field" placeholder="2025ë…„ 1ì›” ì›ì²œì„¸ ì‹ ê³ ì„œ">
                </div>
                <div id="uploadProgress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="uploadProgressBar" class="bg-blue-400 h-2 rounded-full transition-all" style="width:0%"></div>
                    </div>
                    <p id="uploadProgressText" class="text-center text-sm text-gray-400 mt-1">ì—…ë¡œë“œ ì¤‘... (0/0)</p>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('taxUploadModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì—…ë¡œë“œ</button></div>
            </form>
        </div>
    </div>

    <!-- ë²•ì¸ì„œë¥˜ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="docUploadModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ“¤ ë²•ì¸ì„œë¥˜ ì—…ë¡œë“œ</h3><button onclick="closeModal('docUploadModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="docUploadForm" onsubmit="submitDocUpload(event)" class="space-y-4">
                <div><label class="block text-sm text-blue-400 mb-1">ì¹´í…Œê³ ë¦¬ *</label>
                    <select id="corpdoc-category" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="business">ì‚¬ì—…ìë“±ë¡ì¦</option>
                        <option value="corporate">ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸</option>
                        <option value="contract">ê³„ì•½ì„œ</option>
                        <option value="license">ì¸í—ˆê°€ì„œë¥˜</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë²•ì¸/ëŒ€ìƒ</label>
                    <input type="text" id="corpdoc-entity" class="input-field" placeholder="íŒ€ë¸Œë¡œ, ë¸Œë¡œëª¨í„°ìŠ¤ ë“±">
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">íŒŒì¼ ì„ íƒ * (ìµœëŒ€ 10ê°œ)</label>
                    <input type="file" id="corpdoc-file" class="input-field" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.doc,.docx" multiple required onchange="checkDocFileLimit(this)">
                    <p class="text-gray-500 text-xs mt-1">PDF, ì´ë¯¸ì§€, ì—‘ì…€, ì›Œë“œ íŒŒì¼ ì§€ì› | í•œ ë²ˆì— ìµœëŒ€ 10ê°œ</p>
                    <div id="selectedDocFileList" class="mt-2 text-sm text-gray-400"></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì„¤ëª…</label>
                    <input type="text" id="corpdoc-desc" class="input-field" placeholder="2025ë…„ ê°±ì‹  ì‚¬ì—…ìë“±ë¡ì¦">
                </div>
                <div id="docUploadProgress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="docUploadProgressBar" class="bg-blue-400 h-2 rounded-full transition-all" style="width:0%"></div>
                    </div>
                    <p id="docUploadProgressText" class="text-center text-sm text-gray-400 mt-1">ì—…ë¡œë“œ ì¤‘... (0/0)</p>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('docUploadModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì—…ë¡œë“œ</button></div>
            </form>
        </div>
    </div>

    <!-- ë²•ì¸ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="entityModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4"><h3 id="entityModalTitle" class="text-xl font-bold text-blue-400">ğŸ¢ ë²•ì¸ ë“±ë¡</h3><button onclick="closeModal('entityModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="entityForm" onsubmit="submitEntity(event)" class="space-y-4">
                <input type="hidden" id="entity-id">
                
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="border-b border-white/10 pb-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë²•ì¸ëª… *</label><input type="text" id="entity-name" class="input-field" required placeholder="(ì£¼)íŒ€ë¸Œë¡œì„œìš¸"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ìƒíƒœ</label><select id="entity-status" class="input-field"><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input type="text" id="entity-bizno" class="input-field" placeholder="000-00-00000" maxlength="12" oninput="formatBizNo(this)"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë²•ì¸ë“±ë¡ë²ˆí˜¸</label><input type="text" id="entity-corpno" class="input-field" placeholder="000000-0000000"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ì—…íƒœ</label><input type="text" id="entity-biztype" class="input-field" placeholder="ì„œë¹„ìŠ¤ì—…"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì—…ì¢…</label><input type="text" id="entity-bizcategory" class="input-field" placeholder="ë°°ë‹¬ëŒ€í–‰"></div>
                    </div>
                    <div class="mt-3"><label class="block text-sm text-gray-400 mb-1">ì‚¬ì—…ì¥ ì£¼ì†Œ</label><input type="text" id="entity-address" class="input-field" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..."></div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œ ì „í™”</label><input type="text" id="entity-phone" class="input-field" placeholder="02-0000-0000" maxlength="13" oninput="formatPhone(this)"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì„¤ë¦½ì¼</label><input type="date" id="entity-founddate" class="input-field"></div>
                    </div>
                </div>
                
                <!-- ëŒ€í‘œì ì •ë³´ -->
                <div class="border-b border-white/10 pb-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ‘¤ ëŒ€í‘œì ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="entity-ceoname" class="input-field" placeholder="í™ê¸¸ë™"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì—°ë½ì²˜</label><input type="text" id="entity-ceophone" class="input-field" placeholder="010-0000-0000" maxlength="13" oninput="formatPhone(this)"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì£¼ë¯¼ë²ˆí˜¸</label><input type="text" id="entity-ceoresidentno" class="input-field" placeholder="000000-0000000" maxlength="14" oninput="formatSSN(this)"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì´ë©”ì¼</label><input type="email" id="entity-ceoemail" class="input-field" placeholder="ceo@example.com"></div>
                    </div>
                    <div class="mt-3"><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì£¼ì†Œ</label><input type="text" id="entity-ceoaddress" class="input-field" placeholder="ì„œìš¸ì‹œ..."></div>
                </div>
                
                <!-- ë©”ëª¨ -->
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="entity-memo" class="input-field" rows="2" placeholder="ê¸°íƒ€ ì°¸ê³ ì‚¬í•­"></textarea></div>
                
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('entityModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ë²•ì¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="entityDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ¢ <span id="entityDetailName">ë²•ì¸ëª…</span></h3><button onclick="closeModal('entityDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            
            <!-- íƒ­ -->
            <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                <button onclick="showEntityDetailTab('info')" id="entityDetailTab-info" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-blue-500/20 text-blue-400">ê¸°ë³¸ì •ë³´</button>
                <button onclick="showEntityDetailTab('docs')" id="entityDetailTab-docs" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì²¨ë¶€ì„œë¥˜</button>
            </div>
            
            <!-- ê¸°ë³¸ì •ë³´ íƒ­ -->
            <div id="entityDetailContent-info">
                <div id="entityDetailInfo" class="space-y-4"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="editCurrentEntity()" class="btn-secondary">âœï¸ ìˆ˜ì •</button>
                    <button onclick="deleteCurrentEntity()" class="btn-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            </div>
            
            <!-- ì²¨ë¶€ì„œë¥˜ íƒ­ -->
            <div id="entityDetailContent-docs" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-400 text-sm">ì´ ë²•ì¸ì— ì—°ê²°ëœ ì„œë¥˜</p>
                    <button onclick="openEntityDocUpload()" class="btn-primary btn-sm">ğŸ“¤ ì„œë¥˜ ì²¨ë¶€</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table"><thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>íŒŒì¼ëª…</th><th>í¬ê¸°</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody id="entityDocTableBody"><tr><td colspan="5" class="text-center py-8 text-gray-500">ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- ìê¸ˆ ì§‘í–‰/íšŒìˆ˜ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="fundModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ’° ìê¸ˆ ë“±ë¡</h3><button onclick="closeModal('fundModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="fundForm" onsubmit="submitFund(event)" class="space-y-4">
                <input type="hidden" id="fund-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¼ì *</label><input type="date" id="fund-date" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">êµ¬ë¶„ *</label>
                        <select id="fund-type" class="input-field" required>
                            <option value="">ì„ íƒ</option>
                            <option value="out">ì§‘í–‰ (ì¶œê¸ˆ)</option>
                            <option value="in">íšŒìˆ˜ (ì…ê¸ˆ)</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ìíšŒì‚¬ *</label>
                    <select id="fund-subsidiary" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="brocompany">ë¸Œë¡œì»´í¼ë‹ˆ</option>
                        <option value="bromotors">ë¸Œë¡œëª¨í„°ìŠ¤</option>
                    </select>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ê¸ˆì•¡ *</label><input type="number" id="fund-amount" class="input-field" required placeholder="0"></div>
                <div><label class="block text-sm text-blue-400 mb-1">ìš©ë„/ë‚´ìš©</label><input type="text" id="fund-purpose" class="input-field" placeholder="ìš´ì˜ìê¸ˆ, ìˆ˜ìµê¸ˆ íšŒìˆ˜ ë“±"></div>
                <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label>
                    <select id="fund-status" class="input-field">
                        <option value="completed">ì™„ë£Œ</option>
                        <option value="pending">ëŒ€ê¸°</option>
                        <option value="cancelled">ì·¨ì†Œ</option>
                    </select>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="fund-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('fundModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í˜„ê¸ˆì¶œë‚©ì¥ ëª¨ë‹¬ -->
    <div id="bankModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ“’ ê±°ë˜ ë“±ë¡</h3><button onclick="closeModal('bankModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="bankForm" onsubmit="submitCashbook(event)" class="space-y-4">
                <input type="hidden" id="bank-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¼ì *</label><input type="date" id="bank-date" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">êµ¬ë¶„ *</label><select id="bank-type" class="input-field" required onchange="toggleCashbookLink()"><option value="deposit">ì…ê¸ˆ</option><option value="withdrawal">ì¶œê¸ˆ</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ê±°ë˜ì²˜</label><input type="text" id="bank-counterparty" class="input-field" placeholder="ë°°ë¯¼, í˜‘ë ¥ì‚¬A ë“±"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ê¸ˆì•¡ *</label><input type="number" id="bank-amount" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì ìš”</label><input type="text" id="bank-desc" class="input-field" placeholder="W03 ì •ì‚°ê¸ˆ, ì„ ì •ì‚° ì§€ê¸‰ ë“±"></div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ”— ì—°ê²° (ì„ íƒ)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ìœ í˜•</label>
                            <select id="bank-link-type" class="input-field" onchange="loadLinkOptions()">
                                <option value="">ì—°ê²°ì•ˆí•¨</option>
                                <option value="platform">í”Œë«í¼ ì •ì‚°</option>
                                <option value="advance">ì„ ì •ì‚° ì§€ê¸‰</option>
                                <option value="weekly">ì£¼ì •ì‚° ì§€ê¸‰</option>
                            </select>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ëŒ€ìƒ</label>
                            <select id="bank-link-id" class="input-field"><option value="">ì„ íƒ</option></select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="bank-memo2" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('bankModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ë§¤ì…ë§¤ì¶œì¥ ëª¨ë‹¬ -->
    <div id="salesPurchaseModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ“‹ ë§¤ì…ë§¤ì¶œ ë“±ë¡</h3><button onclick="closeModal('salesPurchaseModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="salesPurchaseForm" onsubmit="submitSalesPurchase(event)" class="space-y-4">
                <input type="hidden" id="sp-id">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¼ì *</label><input type="date" id="sp-date" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">êµ¬ë¶„ *</label>
                        <select id="sp-type" class="input-field" required onchange="toggleSPType()">
                            <option value="sales">ë§¤ì¶œ</option>
                            <option value="purchase">ë§¤ì…</option>
                        </select>
                    </div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì„¸ê¸ˆê³„ì‚°ì„œ</label>
                        <select id="sp-tax-status" class="input-field">
                            <option value="pending">ë¯¸ë°œí–‰</option>
                            <option value="issued">ë°œí–‰</option>
                            <option value="received">ìˆ˜ì·¨</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ê±°ë˜ì²˜ *</label><input type="text" id="sp-counterparty" class="input-field" placeholder="ë°°ë¯¼, í˜‘ë ¥ì‚¬A ë“±" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">í’ˆëª©</label><input type="text" id="sp-item" class="input-field" placeholder="W03 ì •ì‚°ê¸ˆ, ìš©ì—­ë¹„ ë“±"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="flex gap-4 mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="sp-vat-type" value="auto" checked onchange="toggleVatMode()">
                            <span class="text-sm text-gray-300">ë¶€ê°€ì„¸ ìë™ (10%)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="sp-vat-type" value="manual" onchange="toggleVatMode()">
                            <span class="text-sm text-gray-300">ì§ì ‘ ì…ë ¥</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="sp-vat-type" value="none" onchange="toggleVatMode()">
                            <span class="text-sm text-gray-300">ë¶€ê°€ì„¸ ì—†ìŒ</span>
                        </label>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡ *</label><input type="number" id="sp-supply" class="input-field" value="0" required oninput="calcSPTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸</label><input type="number" id="sp-vat" class="input-field" value="0" readonly style="background: var(--bg-tertiary);"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="sp-total" class="input-field font-bold" value="0" readonly style="background: var(--bg-tertiary); color: var(--accent);"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ”— ì—°ê²° (ì„ íƒ)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ìœ í˜•</label>
                            <select id="sp-link-type" class="input-field" onchange="loadSPLinkOptions()">
                                <option value="">ì—°ê²°ì•ˆí•¨</option>
                                <option value="platform">í”Œë«í¼ ì •ì‚°</option>
                                <option value="advance">ì„ ì •ì‚° ì§€ê¸‰</option>
                            </select>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ëŒ€ìƒ</label>
                            <select id="sp-link-id" class="input-field"><option value="">ì„ íƒ</option></select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="sp-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('salesPurchaseModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ëŒ€ì‚¬ê´€ë¦¬ ëª¨ë‹¬ (ìˆ˜ë™ ëŒ€ì‚¬) -->
    <div id="reconcileModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4">
                <h3 id="reconcileModalTitle" class="text-xl font-bold text-blue-400">ğŸ”„ ìˆ˜ë™ ëŒ€ì‚¬ ë“±ë¡</h3>
                <button onclick="closeModal('reconcileModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <form id="reconcileForm" onsubmit="submitReconcile(event)" class="space-y-4">
                <input type="hidden" id="rec-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="rec-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">í˜‘ë ¥ì‚¬</label><select id="rec-partner" class="input-field"><option value="">ì„ íƒ</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">í”Œë«í¼ ì…ê¸ˆì•¡</label><input type="number" id="rec-platform" class="input-field" value="0" onchange="calcReconcile()"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì„ ì •ì‚° ì§€ê¸‰ì•¡</label><input type="number" id="rec-advance" class="input-field" value="0" onchange="calcReconcile()"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì°¨ì•¡</label><input type="number" id="rec-diff" class="input-field" readonly></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</label><input type="number" id="rec-fee" class="input-field" value="0"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label>
                        <select id="rec-status" class="input-field">
                            <option value="pending">ëŒ€ê¸°</option>
                            <option value="matched">ì™„ë£Œ</option>
                            <option value="issue">ë¶ˆì¼ì¹˜</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="rec-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('reconcileModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìë™ ëŒ€ì‚¬ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="autoReconcileModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:900px; max-height:80vh; overflow-y:auto;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-400">âš¡ ìë™ ëŒ€ì‚¬ ê²°ê³¼</h3>
                <button onclick="closeModal('autoReconcileModal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="autoReconcileResult" class="space-y-4">
                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
            <div class="flex gap-2 mt-4">
                <button type="button" onclick="closeModal('autoReconcileModal')" class="flex-1 btn-secondary">ë‹«ê¸°</button>
                <button type="button" onclick="saveAutoReconcile()" class="flex-1 btn-primary">ì „ì²´ ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="weeklyPayoutModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-blue-400">ğŸ“† ì£¼ì •ì‚° ì§€ê¸‰ ë“±ë¡</h3><button onclick="closeModal('weeklyPayoutModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="weeklyPayoutForm" onsubmit="submitWeeklyPayout(event)" class="space-y-4">
                <input type="hidden" id="weekly-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="weekly-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ì¼ *</label><input type="date" id="weekly-date" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ë¼ì´ë” *</label><select id="weekly-rider" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">í˜‘ë ¥ì‚¬</label><select id="weekly-partner" class="input-field"><option value="">ì„ íƒ</option></select></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ“Š ë°°ë‹¬ ì‹¤ì </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë°°ë‹¬ê±´ìˆ˜</label><input type="number" id="weekly-count" class="input-field" value="0"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë°°ë‹¬ìˆ˜ìµ</label><input type="number" id="weekly-revenue" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-red-400 font-bold mb-3">ğŸ’¸ ê³µì œ í•­ëª©</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ìˆ˜ìˆ˜ë£Œ</label><input type="number" id="weekly-fee" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë³´í—˜ë£Œ</label><input type="number" id="weekly-insurance" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸°íƒ€ê³µì œ</label><input type="number" id="weekly-other" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ì´ ê³µì œì•¡</label><input type="number" id="weekly-deduction" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì‹¤ì§€ê¸‰ì•¡</label><input type="number" id="weekly-net" class="input-field font-bold text-blue-400" value="0" readonly></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="weekly-status" class="input-field"><option value="pending">ëŒ€ê¸°</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ê³„ì¢Œ</label><input type="text" id="weekly-account" class="input-field" placeholder="ì€í–‰ ê³„ì¢Œë²ˆí˜¸"></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="weekly-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('weeklyPayoutModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì„¸ê¸ˆê³„ì‚°ì„œ ëª¨ë‹¬ -->
    <div id="taxInvoiceModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="taxInvoiceModalTitle" class="text-xl font-bold text-blue-400">ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ë“±ë¡</h3><button onclick="closeModal('taxInvoiceModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="taxInvoiceForm" onsubmit="submitTaxInvoice(event)" class="space-y-4">
                <input type="hidden" id="inv-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ìœ í˜• *</label><select id="inv-type" class="input-field" required><option value="purchase">ë§¤ì…</option><option value="sales">ë§¤ì¶œ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ë°œí–‰ì¼ *</label><input type="date" id="inv-date" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ê±°ë˜ì²˜ëª… *</label><input type="text" id="inv-vendor" class="input-field" required placeholder="ê±°ë˜ì²˜ëª…"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="inv-bizno" class="input-field" placeholder="000-00-00000" maxlength="12" oninput="formatBizNo(this)"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="inv-ceo" class="input-field"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡</label><input type="number" id="inv-supply" class="input-field" value="0" onchange="calcTaxInvoice()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="inv-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="inv-total" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ìƒíƒœ</label><select id="inv-status" class="input-field"><option value="unpaid">ë¯¸ì§€ê¸‰</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì§€ê¸‰ì¼</label><input type="date" id="inv-paiddate" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">í’ˆëª©</label><input type="text" id="inv-item" class="input-field" placeholder="í’ˆëª©/ì„œë¹„ìŠ¤ëª…"></div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="inv-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('taxInvoiceModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ë¶„ê°œ ëª¨ë‹¬ -->
    <div id="journalModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4"><h3 id="journalModalTitle" class="text-xl font-bold text-blue-400">ğŸ“Š ë¶„ê°œ ë“±ë¡</h3><button onclick="closeModal('journalModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="journalForm" onsubmit="submitJournal(event)" class="space-y-4">
                <input type="hidden" id="jnl-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì¼ì *</label><input type="date" id="jnl-date" class="input-field" required></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ë¶„ê°œë²ˆí˜¸</label><input type="text" id="jnl-number" class="input-field" placeholder="ìë™ìƒì„±" readonly></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ“¥ ì°¨ë³€ (Debit)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³„ì •ê³¼ëª©</label><select id="jnl-debit-account" class="input-field">
                            <option value="">ì„ íƒ</option>
                            <optgroup label="ìì‚°"><option value="101-í˜„ê¸ˆ">í˜„ê¸ˆ</option><option value="102-ë³´í†µì˜ˆê¸ˆ">ë³´í†µì˜ˆê¸ˆ</option><option value="108-ë§¤ì¶œì±„ê¶Œ">ë§¤ì¶œì±„ê¶Œ</option><option value="120-ì¬ê³ ìì‚°">ì¬ê³ ìì‚°</option></optgroup>
                            <optgroup label="ë¹„ìš©"><option value="501-ê¸‰ì—¬">ê¸‰ì—¬</option><option value="502-ì„ì°¨ë£Œ">ì„ì°¨ë£Œ</option><option value="503-í†µì‹ ë¹„">í†µì‹ ë¹„</option><option value="504-ì†Œëª¨í’ˆë¹„">ì†Œëª¨í’ˆë¹„</option><option value="510-ì°¨ëŸ‰ìœ ì§€ë¹„">ì°¨ëŸ‰ìœ ì§€ë¹„</option></optgroup>
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸ˆì•¡</label><input type="number" id="jnl-debit-amount" class="input-field" value="0"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-red-400 font-bold mb-3">ğŸ“¤ ëŒ€ë³€ (Credit)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³„ì •ê³¼ëª©</label><select id="jnl-credit-account" class="input-field">
                            <option value="">ì„ íƒ</option>
                            <optgroup label="ë¶€ì±„"><option value="201-ë§¤ì…ì±„ë¬´">ë§¤ì…ì±„ë¬´</option><option value="210-ë¯¸ì§€ê¸‰ê¸ˆ">ë¯¸ì§€ê¸‰ê¸ˆ</option><option value="220-ì˜ˆìˆ˜ê¸ˆ">ì˜ˆìˆ˜ê¸ˆ</option></optgroup>
                            <optgroup label="ìì‚°"><option value="101-í˜„ê¸ˆ">í˜„ê¸ˆ</option><option value="102-ë³´í†µì˜ˆê¸ˆ">ë³´í†µì˜ˆê¸ˆ</option></optgroup>
                            <optgroup label="ìˆ˜ìµ"><option value="401-ë§¤ì¶œ">ë§¤ì¶œ</option><option value="402-ìˆ˜ìˆ˜ë£Œìˆ˜ìµ">ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</option></optgroup>
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸ˆì•¡</label><input type="number" id="jnl-credit-amount" class="input-field" value="0"></div>
                    </div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ì ìš” *</label><input type="text" id="jnl-desc" class="input-field" placeholder="ê±°ë˜ ë‚´ìš©" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="jnl-status" class="input-field"><option value="created">ìƒì„±</option><option value="confirmed">í™•ì •</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì¦ë¹™</label><input type="text" id="jnl-evidence" class="input-field" placeholder="ì˜ìˆ˜ì¦ë²ˆí˜¸ ë“±"></div>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="jnl-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('journalModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì§ì› ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="employeeModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="employeeModalTitle" class="text-xl font-bold text-blue-400">ğŸ‘¤ ì§ì› ë“±ë¡</h3><button onclick="closeModal('employeeModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="employeeForm" onsubmit="submitEmployee(event)" class="space-y-4">
                <input type="hidden" id="emp-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì‚¬ë²ˆ</label><input type="text" id="emp-no" class="input-field" placeholder="EMP-001"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì´ë¦„ *</label><input type="text" id="emp-name" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ê³ ìš©í˜•íƒœ</label><select id="emp-type" class="input-field"><option value="regular">ì •ê·œì§</option><option value="contract">ê³„ì•½ì§</option><option value="parttime">íŒŒíŠ¸íƒ€ì„</option></select></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ë¶€ì„œ</label><input type="text" id="emp-dept" class="input-field" placeholder="ê²½ì˜ì§€ì›íŒ€"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì§ê¸‰</label><input type="text" id="emp-position" class="input-field" placeholder="ëŒ€ë¦¬"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì…ì‚¬ì¼</label><input type="date" id="emp-joindate" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ì—°ë½ì²˜</label><input type="text" id="emp-phone" class="input-field" placeholder="010-0000-0000"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ì´ë©”ì¼</label><input type="email" id="emp-email" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-blue-400 mb-1">ê¸°ë³¸ê¸‰</label><input type="number" id="emp-salary" class="input-field" value="0"></div>
                    <div><label class="block text-sm text-blue-400 mb-1">ìƒíƒœ</label><select id="emp-status" class="input-field"><option value="active">ì¬ì§</option><option value="inactive">í‡´ì§</option></select></div>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2"><input type="checkbox" id="emp-insurance" class="w-4 h-4"> 4ëŒ€ë³´í—˜ ê°€ì…</label>
                </div>
                <div><label class="block text-sm text-blue-400 mb-1">ë©”ëª¨</label><textarea id="emp-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('employeeModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

<script>
const SUPABASE_URL = 'https://jizaefuhiikpkcxolibc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppemFlZnVoaWlrcGtjeG9saWJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDM3MDIsImV4cCI6MjA4MzY3OTcwMn0.WXFNYvSl1n9pp0yZpD8ndNZdEHvL53wtDzrJz9Y_ssg';

// í…Œë§ˆ ê´€ë¦¬
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
}

function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
}

// í˜ì´ì§€ ë¡œë“œì‹œ í…Œë§ˆ ì´ˆê¸°í™”
initTheme();

let currentUser = null;
let riderList = [], partnerList = [], salesList = [], userList = [], settlementList = [];
let cardList = [], cardTransList = [], taxInvoiceList = [], journalList = [], auditLogList = [];
let employeeList = [], payrollList = [];
let platformList = [], advanceTransferList = [], reconcileList = [], bankList = [], weeklyPayoutList = [];
let salesPurchaseList = [];

async function supabaseCall(table, method, body = null, query = '') {
    try {
        const options = { method, headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': method === 'POST' ? 'return=representation' : '' } };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + query, options);
        if (!res.ok) {
            const errText = await res.text();
            console.error('API Error:', res.status, errText);
            throw new Error('API Error: ' + res.status + ' - ' + errText);
        }
        const text = await res.text();
        return text ? JSON.parse(text) : null;
    } catch (e) { console.error('Supabase Error:', e); return null; }
}

// íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
async function uploadFileToStorage(file, folder, filename) {
    try {
        const ext = file.name.split('.').pop();
        const path = folder + '/' + filename + '_' + Date.now() + '.' + ext;
        const res = await fetch(SUPABASE_URL + '/storage/v1/object/documents/' + path, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY,
                'Content-Type': file.type
            },
            body: file
        });
        if (!res.ok) {
            const err = await res.text();
            console.error('Storage Error:', err);
            return null;
        }
        // Public URL ë°˜í™˜
        return SUPABASE_URL + '/storage/v1/object/public/documents/' + path;
    } catch (e) {
        console.error('Upload Error:', e);
        return null;
    }
}

function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.textContent = msg;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ì£¼ë¯¼ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
function toggleSSN(el) {
    const full = el.getAttribute('data-full');
    const masked = el.getAttribute('data-masked');
    if (el.textContent === masked) {
        el.textContent = full;
        el.style.color = 'var(--accent)';
    } else {
        el.textContent = masked;
        el.style.color = '';
    }
}

// ì£¼ë¯¼ë²ˆí˜¸ í•˜ì´í”ˆ ìë™ ì…ë ¥ (000000-0000000)
function formatSSN(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value.length > 6) {
        value = value.substring(0, 6) + '-' + value.substring(6, 13);
    }
    input.value = value;
}

// ì „í™”ë²ˆí˜¸ í•˜ì´í”ˆ ìë™ ì…ë ¥ (010-0000-0000 ë˜ëŠ” 02-0000-0000)
function formatPhone(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value.startsWith('02')) {
        if (value.length > 2 && value.length <= 6) {
            value = value.substring(0, 2) + '-' + value.substring(2);
        } else if (value.length > 6) {
            value = value.substring(0, 2) + '-' + value.substring(2, 6) + '-' + value.substring(6, 10);
        }
    } else {
        if (value.length > 3 && value.length <= 7) {
            value = value.substring(0, 3) + '-' + value.substring(3);
        } else if (value.length > 7) {
            value = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
        }
    }
    input.value = value;
}

// ì‚¬ì—…ìë²ˆí˜¸ í•˜ì´í”ˆ ìë™ ì…ë ¥ (000-00-00000)
function formatBizNo(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value.length > 3 && value.length <= 5) {
        value = value.substring(0, 3) + '-' + value.substring(3);
    } else if (value.length > 5) {
        value = value.substring(0, 3) + '-' + value.substring(3, 5) + '-' + value.substring(5, 10);
    }
    input.value = value;
}

// íŒŒì¼ ì„ íƒ ì‹œ ìƒíƒœ í‘œì‹œ
function showFileSelected(input, statusId) {
    const status = document.getElementById(statusId);
    if (input.files && input.files[0]) {
        status.classList.remove('hidden');
        status.textContent = 'âœ“ ' + input.files[0].name.substring(0, 15) + (input.files[0].name.length > 15 ? '...' : '');
    } else {
        status.classList.add('hidden');
    }
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function toggleMenu(menu) {
    const el = document.getElementById('menu-' + menu);
    const arrow = document.getElementById('arrow-' + menu);
    if (el.classList.contains('hidden')) {
        el.classList.remove('hidden');
        arrow.textContent = 'â–¼';
    } else {
        el.classList.add('hidden');
        arrow.textContent = 'â–¶';
    }
}

let sidebarOpen = true;
function toggleSidebar() {
    const sidebar = document.getElementById('sidebarMenu');
    if (sidebarOpen) {
        sidebar.style.display = 'none';
        sidebarOpen = false;
    } else {
        sidebar.style.display = 'block';
        sidebarOpen = true;
    }
}

// ëª¨ë°”ì¼ ì „ì²´ ë©”ë‰´ í† ê¸€
function toggleMobileFullMenu() {
    const menu = document.getElementById('mobileFullMenu');
    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    } else {
        menu.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

// ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ í™œì„±í™” í‘œì‹œ
function updateMobileNav(tab) {
    document.querySelectorAll('.mobile-nav button').forEach(btn => {
        btn.classList.remove('text-blue-400');
        btn.classList.add('text-zinc-500');
    });
    const mobBtn = document.getElementById('mob-' + tab);
    if (mobBtn) {
        mobBtn.classList.remove('text-zinc-500');
        mobBtn.classList.add('text-blue-400');
    }
}

function showTab(tab) {
    console.log('showTab called:', tab);
    
    // í˜„ì¬ íƒ­ ìƒíƒœ ì €ì¥
    sessionStorage.setItem('teambro_current_tab', tab);
    
    // ëª¨ë°”ì¼ ë„¤ë¹„ í™œì„±í™”
    updateMobileNav(tab);
    
    // ì‚¬ì´ë“œë°” ì•„ì´í…œ active ì²˜ë¦¬
    document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('nav-' + tab);
    if (btn) btn.classList.add('active');
    
    // íƒ­ ì»¨í…ì¸  ì „í™˜
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    const tabEl = document.getElementById('tab-' + tab);
    console.log('tabEl found:', tabEl);
    if (tabEl) {
        tabEl.classList.remove('hidden');
        console.log('hidden removed, classes:', tabEl.className);
    }
    
    // í˜ì´ì§€ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
    const titles = {
        'dashboard': 'ëŒ€ì‹œë³´ë“œ', 'riders': 'ë¼ì´ë” ê´€ë¦¬', 'partners': 'í˜‘ë ¥ì‚¬ ê´€ë¦¬', 
        'sales': 'ì˜ì—…ì ê´€ë¦¬', 'entities': 'ë²•ì¸ ê´€ë¦¬', 'sett-dashboard': 'ì •ì‚° í˜„í™©',
        'platform': 'í”Œë«í¼ì •ì‚°ì…ê¸ˆ', 'sett-advance': 'ì„ ì •ì‚° ì§€ê¸‰', 'weekly-payout': 'ì£¼ì •ì‚° ì§€ê¸‰',
        'reconcile': 'ëŒ€ì‚¬ ê´€ë¦¬', 'bank': 'í˜„ê¸ˆì¶œë‚©ì¥', 'accounting': 'ë§¤ì…ë§¤ì¶œì¥',
        'taxinvoice': 'ì„¸ê¸ˆê³„ì‚°ì„œ', 'ledger': 'ì´ê³„ì •ì›ì¥', 'journal': 'ë¶„ê°œì¥',
        'cards': 'ë²•ì¸ì¹´ë“œ ê´€ë¦¬', 'card-usage': 'ì¹´ë“œ ì‚¬ìš©ë‚´ì—­', 'employees': 'ì§ì› ê´€ë¦¬',
        'payroll': 'ê¸‰ì—¬ ê´€ë¦¬', 'contracts': 'ê·¼ë¡œê³„ì•½', 'tax': 'ì„¸ë¬´ì„œë¥˜ ë³´ê´€í•¨',
        'docs': 'ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨', 'excel': 'ì—…ë¡œë“œ ì–‘ì‹', 'users': 'ì‚¬ìš©ì ê´€ë¦¬',
        'logs': 'ê°ì‚¬ ë¡œê·¸', 'settings': 'ì‹œìŠ¤í…œ ì„¤ì •'
    };
    const titleEl = document.getElementById('pageTitle');
    if (titleEl) titleEl.textContent = titles[tab] || tab;
    
    // ê¸°ì´ˆì •ë³´
    if (tab === 'dashboard') loadDashboard();
    if (tab === 'riders') { 
        loadStats('rider'); 
        renderTable('rider'); 
        loadPartnerOptions(); 
        // ë§ˆìŠ¤í„° ê¶Œí•œë§Œ ì „ì²´ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        const deleteAllBtn = document.getElementById('deleteAllRidersBtn');
        if (deleteAllBtn) {
            deleteAllBtn.style.display = (currentUser && currentUser.role === 'ADMIN') ? 'inline-block' : 'none';
        }
    }
    if (tab === 'partners') { loadStats('partner'); renderTable('partner'); }
    if (tab === 'sales') { loadStats('sales'); renderTable('sales'); }
    if (tab === 'entities') { loadEntities(); }
    
    // ì •ì‚°ê´€ë¦¬
    if (tab === 'sett-dashboard') loadSettlementDashboard();
    if (tab === 'platform') renderPlatformTable();
    if (tab === 'sett-advance') { renderSettAdvanceTable(); loadSettAdvancePartnerOptions(); }
    if (tab === 'weekly-payout') { renderWeeklyPayoutTable(); loadWeeklyPayoutOptions(); }
    if (tab === 'reconcile') renderReconcileTable();
    
    // ì¬ë¬´ê´€ë¦¬
    if (tab === 'bank') renderCashbookTable();
    if (tab === 'accounting') { renderSalesPurchaseTable(); }
    if (tab === 'taxinvoice') renderTaxInvoiceTable();
    if (tab === 'ledger') renderLedgerTable();
    if (tab === 'journal') renderJournalTable2();
    
    // ì¹´ë“œ/ìì‚°
    if (tab === 'cards') renderCardTable();
    if (tab === 'card-usage') renderCardTransTable();
    
    // ì¸ì‚¬ê´€ë¦¬
    if (tab === 'employees') renderEmployeeTable();
    if (tab === 'payroll') renderPayrollTable();
    if (tab === 'contracts') { loadContractEmpOptions(); renderContractTable(); }
    
    // ë¬¸ì„œ/ì„¸ë¬´
    if (tab === 'tax') { loadTaxDocuments(); }
    if (tab === 'docs') { loadCorpDocuments(); }
    
    // ì‹œìŠ¤í…œ
    if (tab === 'users') renderUserTable();
    if (tab === 'logs') { try { renderAuditLogs(); } catch(e) { console.log('audit logs error', e); } }
    if (tab === 'settings') { /* ì„¤ì • í˜ì´ì§€ */ }
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const users = await supabaseCall('hq_users', 'GET', null, '?username=eq.' + encodeURIComponent(username));
    if (users && users.length > 0 && users[0].password_hash === password && users[0].is_active) {
        currentUser = users[0];
        // localStorageì— í†µí•© ì„¸ì…˜ ì €ì¥ (ëª¨ë“  ERPì—ì„œ ê³µìœ )
        const session = { 
            userId: currentUser.id, 
            username: currentUser.username,
            name: currentUser.name,
            role: currentUser.role,
            timestamp: Date.now() 
        };
        localStorage.setItem('teambro_unified_session', JSON.stringify(session));
        
        // ì‹œìŠ¤í…œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
        document.getElementById('loginPage').classList.add('hidden');
        showSystemSelectPage();
        showToast(currentUser.name + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!');
    } else {
        document.getElementById('loginError').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        document.getElementById('loginError').classList.remove('hidden');
    }
}

// ì‹œìŠ¤í…œ ì„ íƒ í™”ë©´ í‘œì‹œ
function showSystemSelectPage() {
    document.getElementById('selectPageUser').textContent = currentUser.name + ' (' + currentUser.role + ')';
    
    // ê¶Œí•œì— ë”°ë¼ ì ‘ê·¼ ê°€ëŠ¥ ì‹œìŠ¤í…œ í‘œì‹œ
    const hqCard = document.getElementById('selectHQ');
    const bcCard = document.getElementById('selectBC');
    const bmCard = document.getElementById('selectBM');
    const canAccessHQ = currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER';
    
    if (canAccessHQ) {
        hqCard.classList.remove('opacity-50', 'cursor-not-allowed');
        hqCard.classList.add('cursor-pointer');
        hqCard.onclick = () => enterSystem('hq');
    } else {
        hqCard.classList.add('opacity-50', 'cursor-not-allowed');
        hqCard.classList.remove('cursor-pointer');
        hqCard.onclick = () => showToast('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ (ADMIN/MANAGERë§Œ ê°€ëŠ¥)', 'error');
    }
    
    // ë¸Œë¡œì»´í¼ë‹ˆ/ë¸Œë¡œëª¨í„°ìŠ¤ onclick ì„¤ì •
    bcCard.onclick = () => enterSystem('brocompany');
    bmCard.onclick = () => enterSystem('bromotors');
    
    document.getElementById('systemSelectPage').classList.remove('hidden');
}

// ì‹œìŠ¤í…œ ì§„ì…
async function enterSystem(system) {
    if (system === 'hq') {
        // íŒ€ë¸Œë¡œ HQ ì§„ì… - ê¶Œí•œ ì²´í¬
        if (currentUser.role !== 'ADMIN' && currentUser.role !== 'MANAGER') {
            showToast('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }
        document.getElementById('systemSelectPage').classList.add('hidden');
        await loadAllData();
        document.getElementById('mainSystem').classList.remove('hidden');
        if (window.innerWidth >= 768) {
            document.getElementById('mainContent').style.marginLeft = '260px';
        }
        document.getElementById('headerUserName').textContent = currentUser.name;
        
        // ì €ì¥ëœ íƒ­ ë³µì› ë˜ëŠ” ëŒ€ì‹œë³´ë“œ
        const savedTab = sessionStorage.getItem('teambro_current_tab');
        if (savedTab) {
            showTab(savedTab);
        } else {
            loadDashboard();
        }
    } else if (system === 'brocompany' || system === 'bromotors') {
        // URL íŒŒë¼ë¯¸í„°ë¡œ ì„¸ì…˜ ì „ë‹¬ (ë‹¤ë¥¸ ë„ë©”ì¸ì´ë¼ localStorage ê³µìœ  ì•ˆë¨)
        // í•œê¸€ ì¸ì½”ë”©ì„ ìœ„í•´ encodeURIComponent í›„ btoa
        const sessionData = btoa(encodeURIComponent(JSON.stringify({
            userId: currentUser.id,
            username: currentUser.username,
            name: currentUser.name,
            role: currentUser.role,
            timestamp: Date.now()
        })));
        window.location.href = 'https://gaebbeulli-create.github.io/teambro-erp/?session=' + sessionData;
    }
}

function handleLogout() {
    localStorage.removeItem('teambro_unified_session');
    currentUser = null;
    document.getElementById('systemSelectPage').classList.add('hidden');
    document.getElementById('mainSystem').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
}

function logout() {
    handleLogout();
}

async function restoreSession() {
    const data = localStorage.getItem('teambro_unified_session');
    if (!data) return false;
    try {
        const session = JSON.parse(data);
        if (Date.now() - session.timestamp > 86400000) {
            localStorage.removeItem('teambro_unified_session');
            return false;
        }
        const users = await supabaseCall('hq_users', 'GET', null, '?id=eq.' + session.userId);
        if (!users || !users.length || !users[0].is_active) return false;
        currentUser = users[0];
        
        // ì €ì¥ëœ íƒ­ì´ ìˆìœ¼ë©´ ë°”ë¡œ HQë¡œ ì§„ì…
        const savedTab = sessionStorage.getItem('teambro_current_tab');
        if (savedTab && (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER')) {
            await loadAllData();
            document.getElementById('mainSystem').classList.remove('hidden');
            if (window.innerWidth >= 768) {
                document.getElementById('mainContent').style.marginLeft = '260px';
            }
            document.getElementById('headerUserName').textContent = currentUser.name;
            showTab(savedTab);
        } else {
            // íƒ­ ì €ì¥ ì—†ìœ¼ë©´ ì‹œìŠ¤í…œ ì„ íƒ í™”ë©´ìœ¼ë¡œ
            showSystemSelectPage();
        }
        return true;
    } catch (e) { return false; }
}

// ëŒ€ìš©ëŸ‰ ë°ì´í„° í˜ì´ì§€ë„¤ì´ì…˜ ë¡œë“œ (1000ê±´ ì œí•œ ìš°íšŒ)
async function loadAllPaginated(table, orderBy = 'created_at.desc') {
    let allData = [];
    let offset = 0;
    const limit = 1000;
    
    while (true) {
        const data = await supabaseCall(table, 'GET', null, `?order=${orderBy}&limit=${limit}&offset=${offset}`);
        if (!data || data.length === 0) break;
        allData = allData.concat(data);
        if (data.length < limit) break; // ë§ˆì§€ë§‰ í˜ì´ì§€
        offset += limit;
    }
    return allData;
}

async function loadAllData() {
    showToast('ğŸ“Š ë°ì´í„° ë¡œë”© ì¤‘...', 'info');
    
    // ë¼ì´ë”ëŠ” í˜ì´ì§€ë„¤ì´ì…˜ìœ¼ë¡œ ì „ì²´ ë¡œë“œ (100ë§Œê±´ ëŒ€ì‘)
    const ridersPromise = loadAllPaginated('riders', 'created_at.desc');
    
    const [p, s, u, st, cd, ct, ti, jn, emp, pay, plat, advt, recon, bnk, wkly, sp] = await Promise.all([
        supabaseCall('partners', 'GET', null, '?order=created_at.desc&limit=1000'),
        supabaseCall('sales_reps', 'GET', null, '?order=created_at.desc&limit=1000'),
        supabaseCall('hq_users', 'GET', null, '?order=id.asc'),
        supabaseCall('settlements', 'GET', null, '?order=created_at.desc&limit=2000'),
        supabaseCall('corporate_cards', 'GET', null, '?order=created_at.desc'),
        supabaseCall('card_transactions', 'GET', null, '?order=transaction_date.desc&limit=500'),
        supabaseCall('hq_tax_invoices', 'GET', null, '?order=invoice_date.desc&limit=1000'),
        supabaseCall('accounting_journals', 'GET', null, '?order=journal_date.desc&limit=1000'),
        supabaseCall('employees', 'GET', null, '?order=created_at.desc&limit=500'),
        supabaseCall('payrolls', 'GET', null, '?order=pay_year.desc,pay_month.desc&limit=1000'),
        supabaseCall('platform_settlements', 'GET', null, '?order=created_at.desc&limit=1000'),
        supabaseCall('advance_transfers', 'GET', null, '?order=created_at.desc&limit=1000'),
        supabaseCall('settlement_reconciliation', 'GET', null, '?order=created_at.desc&limit=1000'),
        supabaseCall('bank_transactions', 'GET', null, '?order=transaction_date.desc&limit=1000'),
        supabaseCall('weekly_payouts', 'GET', null, '?order=created_at.desc&limit=1000'),
        supabaseCall('sales_purchases', 'GET', null, '?order=transaction_date.desc&limit=1000')
    ]);
    
    riderList = await ridersPromise || [];
    partnerList = p || [];
    salesList = s || [];
    userList = u || [];
    settlementList = st || [];
    cardList = cd || [];
    cardTransList = ct || [];
    taxInvoiceList = ti || [];
    journalList = jn || [];
    employeeList = emp || [];
    platformList = plat || [];
    advanceTransferList = advt || [];
    reconcileList = recon || [];
    bankList = bnk || [];
    weeklyPayoutList = wkly || [];
    payrollList = pay || [];
    salesPurchaseList = sp || [];
    
    showToast('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ (ë¼ì´ë” ' + riderList.length + 'ëª…)', 'success');
}

function loadDashboard() {
    document.getElementById('stat-riders').textContent = riderList.length + 'ëª…';
    document.getElementById('stat-partners').textContent = partnerList.length + 'ê°œ';
    document.getElementById('stat-sales').textContent = salesList.length + 'ëª…';
    
    // ìê¸ˆ ë°ì´í„° ë¡œë“œ
    loadFunds();
    
    // ê·¸ë£¹ì‚¬ í˜„í™© ë¡œë“œ
    updateSubsidiaryStats();
}

function loadStats(type) {
    if (type === 'rider') {
        document.getElementById('rider-total').textContent = riderList.length;
        document.getElementById('rider-active').textContent = riderList.filter(r => r.status === 'ê³„ì•½ì¤‘' || !r.status).length;
        document.getElementById('rider-inactive').textContent = riderList.filter(r => r.status === 'ê³„ì•½ì¢…ë£Œ').length;
        // ì£¼ë¯¼ë²ˆí˜¸ ë¯¸ë“±ë¡: ê³„ì•½ì¤‘ì¸ ë¼ì´ë” ì¤‘ ì£¼ë¯¼ë²ˆí˜¸ ìˆ«ìê°€ 6ìë¦¬ ë¯¸ë§Œì¸ ê²½ìš°
        document.getElementById('rider-nossn').textContent = riderList.filter(r => {
            const isActive = r.status === 'ê³„ì•½ì¤‘' || !r.status;
            if (!isActive) return false;
            if (!r.resident_number) return true;
            const digits = r.resident_number.replace(/[^0-9]/g, '');
            return digits.length < 6;
        }).length;
    } else if (type === 'partner') {
        document.getElementById('partner-total').textContent = partnerList.length;
        document.getElementById('partner-biz').textContent = partnerList.filter(p => p.type === 'biz').length;
        document.getElementById('partner-nonbiz').textContent = partnerList.filter(p => p.type !== 'biz').length;
        document.getElementById('partner-riders').textContent = riderList.filter(r => r.partner_id).length;
    } else if (type === 'sales') {
        document.getElementById('sales-total').textContent = salesList.length;
        document.getElementById('sales-ind').textContent = salesList.filter(s => s.sales_type === 'individual').length;
        document.getElementById('sales-sole').textContent = salesList.filter(s => s.sales_type === 'sole_prop').length;
        document.getElementById('sales-corp').textContent = salesList.filter(s => s.sales_type === 'corporation').length;
    } else if (type === 'settlement') {
        document.getElementById('sett-total').textContent = settlementList.length;
        document.getElementById('sett-pending').textContent = settlementList.filter(s => s.status === 'pending').length;
        document.getElementById('sett-confirmed').textContent = settlementList.filter(s => s.status === 'confirmed').length;
        document.getElementById('sett-paid').textContent = settlementList.filter(s => s.status === 'paid').length;
        const total = settlementList.reduce((sum, s) => sum + parseFloat(s.gross_amount || 0), 0);
        document.getElementById('sett-amount').textContent = 'â‚©' + total.toLocaleString();
    }
}

function renderTable(type) {
    if (type === 'rider') {
        const sf = document.getElementById('riderStatusFilter').value;
        const pf = document.getElementById('riderPartnerFilter').value;
        const ssnf = document.getElementById('riderSsnFilter').value;
        const q = (document.getElementById('riderSearch').value || '').toLowerCase();
        let list = riderList;
        if (sf) list = list.filter(r => r.status === sf);
        if (pf) list = list.filter(r => r.partner_id == pf);
        // ì£¼ë¯¼ë²ˆí˜¸ í•„í„°: ìˆ«ì 6ìë¦¬ ì´ìƒì´ë©´ "ìˆìŒ"
        if (ssnf === 'has') list = list.filter(r => r.resident_number && r.resident_number.replace(/[^0-9]/g, '').length >= 6);
        if (ssnf === 'none') list = list.filter(r => !r.resident_number || r.resident_number.replace(/[^0-9]/g, '').length < 6);
        if (q) list = list.filter(r => (r.name||'').toLowerCase().includes(q) || (r.phone||'').includes(q));
        
        // í•„í„°ëœ ëª©ë¡ ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
        window.filteredRiderList = list;
        
        const tbody = document.getElementById('riderTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        tbody.innerHTML = list.map(r => {
            const p = partnerList.find(x => x.id == r.partner_id);
            // ì£¼ë¯¼ë²ˆí˜¸ í‘œì‹œ: ìˆ«ì 6ìë¦¬ ë¯¸ë§Œì´ë©´ "-" í‘œì‹œ
            const hasValidSSN = r.resident_number && r.resident_number.replace(/[^0-9]/g, '').length >= 6;
            const ssnFull = hasValidSSN ? r.resident_number : '-';
            const ssnMasked = hasValidSSN ? r.resident_number.substring(0, 8) + '******' : '-';
            const statusBadge = r.status === 'ê³„ì•½ì¢…ë£Œ' ? 'badge-inactive">ê³„ì•½ì¢…ë£Œ' : 'badge-active">ê³„ì•½ì¤‘';
            const deleteBtn = currentUser && currentUser.role === 'ADMIN' ? '<button onclick="deleteRider(' + r.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button>' : '';
            return '<tr><td class="font-bold text-blue-400 cursor-pointer hover:underline" onclick="showRiderDetail(' + r.id + ')">' + r.name + '</td><td class="ssn-cell cursor-pointer" onclick="toggleSSN(this)" data-full="' + ssnFull + '" data-masked="' + ssnMasked + '" title="í´ë¦­í•˜ë©´ ë³´ê¸°/ìˆ¨ê¸°ê¸°">' + ssnMasked + '</td><td>' + (p?p.name:'-') + '</td><td>' + (r.baemin_id||'-') + '</td><td>' + (r.coupang_id||'-') + '</td><td>' + (r.tax_type||'-') + '</td><td><span class="badge ' + statusBadge + '</span></td><td><button onclick="editItem(\'rider\',' + r.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button>' + deleteBtn + '</td></tr>';
        }).join('');
    } else if (type === 'partner') {
        const tf = document.getElementById('partnerTypeFilter')?.value || '';
        const rf = document.getElementById('partnerRiderFilter')?.value || '';
        const q = (document.getElementById('partnerSearch')?.value || '').toLowerCase();
        let list = partnerList;
        if (tf) list = list.filter(p => p.type === tf);
        if (rf === 'has') list = list.filter(p => riderList.some(r => r.partner_id == p.id));
        if (rf === 'none') list = list.filter(p => !riderList.some(r => r.partner_id == p.id));
        if (q) list = list.filter(p => (p.name||'').toLowerCase().includes(q) || (p.code||'').toLowerCase().includes(q) || (p.rep_name||'').toLowerCase().includes(q));
        
        // í•„í„°ëœ ëª©ë¡ ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
        window.filteredPartnerList = list;
        
        const tbody = document.getElementById('partnerTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        tbody.innerHTML = list.map(p => {
            const cnt = riderList.filter(r => r.partner_id == p.id).length;
            return '<tr><td class="font-bold text-blue-400 cursor-pointer hover:underline" onclick="showPartnerDetail(' + p.id + ')">' + p.name + '</td><td>' + (p.code||'-') + '</td><td><span class="badge ' + (p.type==='biz'?'badge-biz">ì‚¬ì—…ì':'badge-nonbiz">ë¹„ì‚¬ì—…ì') + '</span></td><td>' + (p.region||'-') + '</td><td>' + (p.rep_name||'-') + '</td><td>' + (p.phone||'-') + '</td><td>' + cnt + 'ëª…</td><td><button onclick="editItem(\'partner\',' + p.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deletePartner(' + p.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>';
        }).join('');
    } else if (type === 'sales') {
        const sf = document.getElementById('salesStatusFilter').value;
        const tf = document.getElementById('salesTypeFilter').value;
        const q = (document.getElementById('salesSearch').value || '').toLowerCase();
        let list = salesList;
        if (sf) list = list.filter(s => s.status === sf);
        if (tf) list = list.filter(s => s.sales_type === tf);
        if (q) list = list.filter(s => (s.name||'').toLowerCase().includes(q) || (s.sales_code||'').toLowerCase().includes(q));
        const tbody = document.getElementById('salesTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        const types = { individual: 'ê°œì¸', sole_prop: 'ê°œì¸ì‚¬ì—…ì', corporation: 'ë²•ì¸' };
        const cycles = { monthly: 'ì›”', weekly: 'ì£¼', per_case: 'ê±´ë³„' };
        tbody.innerHTML = list.map(s => '<tr><td class="font-bold text-blue-400">' + (s.sales_code||'-') + '</td><td>' + s.name + '</td><td><span class="badge badge-biz">' + (types[s.sales_type]||s.sales_type) + '</span></td><td>' + (s.phone||'-') + '</td><td>' + (cycles[s.payout_cycle]||'-') + '</td><td>' + (s.withholding_rate?(parseFloat(s.withholding_rate)*100).toFixed(1)+'%':'-') + '</td><td><span class="badge ' + (s.status==='active'?'badge-active">í™œì„±':'badge-inactive">ë¹„í™œì„±') + '</span></td><td><button onclick="editItem(\'sales\',' + s.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
    } else if (type === 'settlement') {
        const wf = document.getElementById('settWeekFilter').value;
        const sf = document.getElementById('settStatusFilter').value;
        const pf = document.getElementById('settPartnerFilter').value;
        const q = (document.getElementById('settSearch').value || '').toLowerCase();
        let list = settlementList;
        if (wf) list = list.filter(s => s.settlement_week === wf);
        if (sf) list = list.filter(s => s.status === sf);
        if (pf) list = list.filter(s => s.partner_id == pf);
        if (q) { const rids = riderList.filter(r => (r.name||'').toLowerCase().includes(q)).map(r => r.id); list = list.filter(s => rids.includes(s.rider_id)); }
        const tbody = document.getElementById('settlementTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        const statuses = { pending: 'ëŒ€ê¸°', confirmed: 'í™•ì •', paid: 'ì§€ê¸‰ì™„ë£Œ' };
        const statusClass = { pending: 'badge-pending', confirmed: 'badge-biz', paid: 'badge-active' };
        tbody.innerHTML = list.map(s => {
            const r = riderList.find(x => x.id == s.rider_id);
            const p = partnerList.find(x => x.id == s.partner_id);
            return '<tr><td class="font-bold text-blue-400">' + (s.settlement_week||'-') + '</td><td class="text-xs">' + (s.work_start_date||'') + '<br>~' + (s.work_end_date||'') + '</td><td>' + (r?r.name:'-') + '</td><td>' + (p?p.name:'-') + '</td><td class="text-right">â‚©' + parseInt(s.gross_amount||0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(s.deduction_amount||0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(s.advance_amount||0).toLocaleString() + '</td><td class="text-right font-bold text-green-400">â‚©' + parseInt(s.net_amount||0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[s.status]||'badge-inactive') + '">' + (statuses[s.status]||s.status) + '</span></td><td><button onclick="editSettlement(' + s.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
        }).join('');
    }
}

function filterList(type, status) {
    if (type === 'rider') { document.getElementById('riderStatusFilter').value = status; renderTable('rider'); }
}

// í˜‘ë ¥ì‚¬ í•„í„° ì ìš©
function filterPartnerList(filter) {
    document.getElementById('partnerTypeFilter').value = '';
    document.getElementById('partnerRiderFilter').value = '';
    document.getElementById('partnerSearch').value = '';
    
    if (filter === 'biz') {
        document.getElementById('partnerTypeFilter').value = 'biz';
    } else if (filter === 'non_biz') {
        document.getElementById('partnerTypeFilter').value = 'non_biz';
    } else if (filter === 'hasRider') {
        document.getElementById('partnerRiderFilter').value = 'has';
    }
    
    renderTable('partner');
    showToast(filter ? 'í•„í„° ì ìš©ë¨' : 'ì „ì²´ ëª©ë¡', 'info');
}

// í•„í„°ëœ í˜‘ë ¥ì‚¬ ëª©ë¡ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function exportFilteredPartners() {
    const list = window.filteredPartnerList || partnerList;
    if (!list.length) {
        showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„° ì—†ìŒ', 'error');
        return;
    }
    
    const data = list.map(p => {
        const riderCnt = riderList.filter(r => r.partner_id == p.id).length;
        return {
            'í˜‘ë ¥ì‚¬ëª…': p.name || '',
            'í˜‘ë ¥ì‚¬ì½”ë“œ': p.code || '',
            'êµ¬ë¶„': p.type === 'biz' ? 'ì‚¬ì—…ì' : 'ë¹„ì‚¬ì—…ì',
            'ë°°ë‹¬ê¶Œì—­': p.region || '',
            'ëŒ€í‘œì': p.rep_name || '',
            'ëŒ€í‘œìì£¼ë¯¼ë²ˆí˜¸': p.rep_ssn || '',
            'ì—°ë½ì²˜': p.phone || '',
            'ì‚¬ì—…ìë²ˆí˜¸': p.biz_no || '',
            'ì—…ì¢…': p.biz_type || '',
            'ì£¼ì†Œ': p.address || '',
            'ì€í–‰': p.bank || '',
            'ê³„ì¢Œë²ˆí˜¸': p.account_no || '',
            'ì†Œì†ë¼ì´ë”ìˆ˜': riderCnt,
            'ë©”ëª¨': p.memo || ''
        };
    });
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'í˜‘ë ¥ì‚¬ëª©ë¡');
    
    const tf = document.getElementById('partnerTypeFilter').value;
    const rf = document.getElementById('partnerRiderFilter').value;
    let filename = 'í˜‘ë ¥ì‚¬ëª©ë¡';
    if (tf === 'biz') filename += '_ì‚¬ì—…ì';
    if (tf === 'non_biz') filename += '_ë¹„ì‚¬ì—…ì';
    if (rf === 'has') filename += '_ë¼ì´ë”ìˆìŒ';
    if (rf === 'none') filename += '_ë¼ì´ë”ì—†ìŒ';
    filename += '_' + new Date().toISOString().slice(0,10) + '.xlsx';
    
    XLSX.writeFile(wb, filename);
    showToast(list.length + 'ê±´ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

function loadPartnerOptions() {
    const opt = '<option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    document.getElementById('riderPartnerFilter').innerHTML = opt;
    document.getElementById('rider-partner').innerHTML = '<option value="">ì„ íƒì•ˆí•¨</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

function toggleBizFields() { document.getElementById('partnerBizFields').classList.toggle('hidden', document.getElementById('partner-type').value !== 'biz'); }
function toggleSalesBizFields() { document.getElementById('salesBizFields').classList.toggle('hidden', document.getElementById('sales-type').value === 'individual'); }

function openRiderModal() { document.getElementById('riderModalTitle').textContent = 'ğŸï¸ ë¼ì´ë” ë“±ë¡'; document.getElementById('riderForm').reset(); document.getElementById('rider-id').value = ''; openModal('riderModal'); }

// ë¼ì´ë” í•„í„° ì ìš©
function filterRiderList(filter) {
    // í•„í„° ì´ˆê¸°í™”
    document.getElementById('riderStatusFilter').value = '';
    document.getElementById('riderPartnerFilter').value = '';
    document.getElementById('riderSsnFilter').value = '';
    document.getElementById('riderSearch').value = '';
    
    if (filter === 'ê³„ì•½ì¤‘') {
        document.getElementById('riderStatusFilter').value = 'ê³„ì•½ì¤‘';
    } else if (filter === 'ê³„ì•½ì¢…ë£Œ') {
        document.getElementById('riderStatusFilter').value = 'ê³„ì•½ì¢…ë£Œ';
    } else if (filter === 'nossn') {
        document.getElementById('riderSsnFilter').value = 'none';
    }
    // filter === '' ì´ë©´ ì „ì²´ (í•„í„° ì—†ìŒ)
    
    renderTable('rider');
    showToast(filter ? 'í•„í„° ì ìš©ë¨' : 'ì „ì²´ ëª©ë¡', 'info');
}

// í•„í„°ëœ ë¼ì´ë” ëª©ë¡ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function exportFilteredRiders() {
    const list = window.filteredRiderList || riderList;
    if (!list.length) {
        showToast('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„° ì—†ìŒ', 'error');
        return;
    }
    
    const data = list.map(r => {
        const p = partnerList.find(x => x.id == r.partner_id);
        return {
            'ë¼ì´ë”ì´ë¦„': r.name || '',
            'ì£¼ë¯¼ë²ˆí˜¸': r.resident_number || '',
            'ì—°ë½ì²˜': r.phone || '',
            'ì£¼ì†Œ': r.address || '',
            'ì†Œì†í˜‘ë ¥ì‚¬': p ? p.name : '',
            'ë°°ë¯¼ID': r.baemin_id || '',
            'ì¿ íŒ¡ID': r.coupang_id || '',
            'ì˜ˆê¸ˆì£¼': r.account_holder || '',
            'ê³„ì¢Œë²ˆí˜¸': r.account_no || '',
            'ì„¸ê¸ˆì²˜ë¦¬': r.tax_type || '',
            'ìƒíƒœ': r.status || 'ê³„ì•½ì¤‘',
            'ë©”ëª¨': r.memo || ''
        };
    });
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ë¼ì´ë”ëª©ë¡');
    
    // í•„í„° ìƒíƒœë¡œ íŒŒì¼ëª… ìƒì„±
    const sf = document.getElementById('riderStatusFilter').value;
    const ssnf = document.getElementById('riderSsnFilter').value;
    let filename = 'ë¼ì´ë”ëª©ë¡';
    if (sf) filename += '_' + sf;
    if (ssnf === 'none') filename += '_ì£¼ë¯¼ë²ˆí˜¸ë¯¸ë“±ë¡';
    if (ssnf === 'has') filename += '_ì£¼ë¯¼ë²ˆí˜¸ë“±ë¡';
    filename += '_' + new Date().toISOString().slice(0,10) + '.xlsx';
    
    XLSX.writeFile(wb, filename);
    showToast(list.length + 'ê±´ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}
function openPartnerModal() { document.getElementById('partnerModalTitle').textContent = 'ğŸ¤ í˜‘ë ¥ì‚¬ ë“±ë¡'; document.getElementById('partnerForm').reset(); document.getElementById('partner-id').value = ''; document.getElementById('partnerBizFields').classList.add('hidden'); openModal('partnerModal'); }
function openSalesModal() { document.getElementById('salesModalTitle').textContent = 'ğŸ’¼ ì˜ì—…ì ë“±ë¡'; document.getElementById('salesForm').reset(); document.getElementById('sales-id').value = ''; document.getElementById('salesBizFields').classList.add('hidden'); openModal('salesModal'); }

function editItem(type, id) {
    if (type === 'rider') {
        const r = riderList.find(x => x.id === id); if (!r) return;
        document.getElementById('riderModalTitle').textContent = 'ğŸï¸ ë¼ì´ë” ìˆ˜ì •';
        document.getElementById('rider-id').value = r.id;
        document.getElementById('rider-name').value = r.name || '';
        document.getElementById('rider-ssn').value = r.resident_number || '';
        document.getElementById('rider-phone').value = r.phone || '';
        document.getElementById('rider-address').value = r.address || '';
        document.getElementById('rider-partner').value = r.partner_id || '';
        document.getElementById('rider-baemin-id').value = r.baemin_id || '';
        document.getElementById('rider-coupang-id').value = r.coupang_id || '';
        document.getElementById('rider-account-holder').value = r.account_holder || '';
        document.getElementById('rider-account-no').value = r.account_no || '';
        document.getElementById('rider-tax-type').value = r.tax_type || '';
        document.getElementById('rider-status').value = r.status || 'ê³„ì•½ì¤‘';
        document.getElementById('rider-memo').value = r.memo || '';
        // íŒŒì¼ ë§í¬ í‘œì‹œ
        document.getElementById('rider-file-contract-status').classList.add('hidden');
        document.getElementById('rider-file-id-status').classList.add('hidden');
        const contractLink = document.getElementById('rider-file-contract-link');
        const idLink = document.getElementById('rider-file-id-link');
        if (r.file_contract) { contractLink.href = r.file_contract; contractLink.classList.remove('hidden'); } else { contractLink.classList.add('hidden'); }
        if (r.file_id) { idLink.href = r.file_id; idLink.classList.remove('hidden'); } else { idLink.classList.add('hidden'); }
        openModal('riderModal');
    } else if (type === 'partner') {
        const p = partnerList.find(x => x.id === id); if (!p) return;
        document.getElementById('partnerModalTitle').textContent = 'ğŸ¤ í˜‘ë ¥ì‚¬ ìˆ˜ì •';
        document.getElementById('partner-id').value = p.id;
        document.getElementById('partner-name').value = p.name || '';
        document.getElementById('partner-code').value = p.code || '';
        document.getElementById('partner-type').value = p.type || 'non_biz';
        document.getElementById('partner-region').value = p.region || '';
        document.getElementById('partner-rep').value = p.rep_name || '';
        document.getElementById('partner-rep-ssn').value = p.rep_ssn || '';
        document.getElementById('partner-phone').value = p.phone || '';
        document.getElementById('partner-bizno').value = p.biz_no || '';
        document.getElementById('partner-biztype').value = p.biz_type || '';
        document.getElementById('partner-address').value = p.address || '';
        document.getElementById('partner-bank').value = p.bank || '';
        document.getElementById('partner-accountno').value = p.account_no || '';
        document.getElementById('partner-memo').value = p.memo || '';
        // íŒŒì¼ ë§í¬ í‘œì‹œ
        document.getElementById('partner-file-bizreg-status').classList.add('hidden');
        document.getElementById('partner-file-id-status').classList.add('hidden');
        document.getElementById('partner-file-contract-status').classList.add('hidden');
        const bizregLink = document.getElementById('partner-file-bizreg-link');
        const idLink = document.getElementById('partner-file-id-link');
        const contractLink = document.getElementById('partner-file-contract-link');
        if (p.file_bizreg) { bizregLink.href = p.file_bizreg; bizregLink.classList.remove('hidden'); } else { bizregLink.classList.add('hidden'); }
        if (p.file_id) { idLink.href = p.file_id; idLink.classList.remove('hidden'); } else { idLink.classList.add('hidden'); }
        if (p.file_contract) { contractLink.href = p.file_contract; contractLink.classList.remove('hidden'); } else { contractLink.classList.add('hidden'); }
        toggleBizFields();
        openModal('partnerModal');
    } else if (type === 'sales') {
        const s = salesList.find(x => x.id === id); if (!s) return;
        document.getElementById('salesModalTitle').textContent = 'ğŸ’¼ ì˜ì—…ì ìˆ˜ì •';
        document.getElementById('sales-id').value = s.id;
        document.getElementById('sales-code').value = s.sales_code || '';
        document.getElementById('sales-type').value = s.sales_type || 'individual';
        document.getElementById('sales-name').value = s.name || '';
        document.getElementById('sales-phone').value = s.phone || '';
        document.getElementById('sales-email').value = s.email || '';
        document.getElementById('sales-region').value = s.region || '';
        document.getElementById('sales-bizno').value = s.biz_no || '';
        document.getElementById('sales-repname').value = s.rep_name || '';
        document.getElementById('sales-address').value = s.address || '';
        document.getElementById('sales-bank').value = s.bank_name || '';
        document.getElementById('sales-bank-holder').value = s.bank_holder || '';
        document.getElementById('sales-bank-account').value = s.bank_account || '';
        document.getElementById('sales-payout-cycle').value = s.payout_cycle || 'monthly';
        document.getElementById('sales-withholding-rate').value = s.withholding_rate || '0.033';
        document.getElementById('sales-status').value = s.status || 'active';
        document.getElementById('sales-memo').value = s.memo || '';
        toggleSalesBizFields();
        openModal('salesModal');
    }
}

// í˜‘ë ¥ì‚¬ ìƒì„¸ë³´ê¸°
function showPartnerDetail(id) {
    const p = partnerList.find(x => x.id === id);
    if (!p) return;
    
    const linkedRiders = riderList.filter(r => r.partner_id == id);
    const banks = { KB: 'êµ­ë¯¼', SHINHAN: 'ì‹ í•œ', WOORI: 'ìš°ë¦¬', HANA: 'í•˜ë‚˜', NH: 'ë†í˜‘' };
    
    let html = `
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ“‹ í˜‘ë ¥ì‚¬ ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-400">í˜‘ë ¥ì‚¬ëª…:</span> <span class="font-bold">${p.name || '-'}</span></div>
                <div><span class="text-gray-400">í˜‘ë ¥ì‚¬ì½”ë“œ:</span> <span class="font-bold text-blue-400">${p.code || '-'}</span></div>
                <div><span class="text-gray-400">êµ¬ë¶„:</span> <span class="badge ${p.type === 'biz' ? 'badge-biz">ì‚¬ì—…ì' : 'badge-nonbiz">ë¹„ì‚¬ì—…ì'}</span></div>
                <div><span class="text-gray-400">ë°°ë‹¬ê¶Œì—­:</span> ${p.region || '-'}</div>
                <div><span class="text-gray-400">ì‚¬ì—…ìë²ˆí˜¸:</span> ${p.biz_no || '-'}</div>
                <div><span class="text-gray-400">ì—…ì¢…:</span> ${p.biz_type || '-'}</div>
                <div class="col-span-2"><span class="text-gray-400">ì£¼ì†Œ:</span> ${p.address || '-'}</div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ‘¤ ìš´ì˜ì ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-400">ìš´ì˜ì ì´ë¦„:</span> <span class="font-bold">${p.rep_name || '-'}</span></div>
                <div><span class="text-gray-400">ìš´ì˜ì ì£¼ë¯¼ë²ˆí˜¸:</span> ${p.rep_ssn ? p.rep_ssn.substring(0, 8) + '******' : '-'}</div>
                <div><span class="text-gray-400">ì—°ë½ì²˜:</span> ${p.phone || '-'}</div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ’° ê³„ì¢Œ ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-400">ì€í–‰:</span> ${banks[p.bank] || p.bank || '-'}</div>
                <div><span class="text-gray-400">ê³„ì¢Œë²ˆí˜¸:</span> ${p.account_no || '-'}</div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
            <div class="grid grid-cols-3 gap-3 text-sm">
                <div>${p.file_bizreg ? '<a href="' + p.file_bizreg + '" target="_blank" class="text-blue-400 hover:underline">ğŸ“„ ì‚¬ì—…ìë“±ë¡ì¦</a>' : '<span class="text-gray-500">ì‚¬ì—…ìë“±ë¡ì¦ ì—†ìŒ</span>'}</div>
                <div>${p.file_id ? '<a href="' + p.file_id + '" target="_blank" class="text-blue-400 hover:underline">ğŸªª ì‹ ë¶„ì¦</a>' : '<span class="text-gray-500">ì‹ ë¶„ì¦ ì—†ìŒ</span>'}</div>
                <div>${p.file_contract ? '<a href="' + p.file_contract + '" target="_blank" class="text-blue-400 hover:underline">ğŸ“ ê³„ì•½ì„œ</a>' : '<span class="text-gray-500">ê³„ì•½ì„œ ì—†ìŒ</span>'}</div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸï¸ ì†Œì† ë¼ì´ë” (${linkedRiders.length}ëª…)</h4>
            ${linkedRiders.length > 0 ? 
                '<div class="flex flex-wrap gap-2">' + linkedRiders.map(r => '<span class="badge badge-active">' + r.name + '</span>').join('') + '</div>' : 
                '<div class="text-gray-500 text-sm">ì†Œì† ë¼ì´ë” ì—†ìŒ</div>'
            }
        </div>
        
        ${p.memo ? `
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ“ ë©”ëª¨</h4>
            <div class="text-sm">${p.memo}</div>
        </div>` : ''}
    `;
    
    document.getElementById('partnerDetailContent').innerHTML = html;
    document.getElementById('partnerDetailEditBtn').onclick = () => { closeModal('partnerDetailModal'); editItem('partner', id); };
    openModal('partnerDetailModal');
}

// ë¼ì´ë” ìƒì„¸ë³´ê¸°
function showRiderDetail(id) {
    const r = riderList.find(x => x.id === id);
    if (!r) return;
    
    const p = partnerList.find(x => x.id == r.partner_id);
    const banks = { KB: 'êµ­ë¯¼', SHINHAN: 'ì‹ í•œ', WOORI: 'ìš°ë¦¬', HANA: 'í•˜ë‚˜', NH: 'ë†í˜‘', IBK: 'ê¸°ì—…', KAKAO: 'ì¹´ì¹´ì˜¤', TOSS: 'í† ìŠ¤' };
    
    let html = `
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-400">ì´ë¦„:</span> <span class="font-bold">${r.name || '-'}</span></div>
                <div><span class="text-gray-400">ìƒíƒœ:</span> <span class="badge ${r.status === 'ê³„ì•½ì¢…ë£Œ' ? 'badge-inactive">ê³„ì•½ì¢…ë£Œ' : 'badge-active">ê³„ì•½ì¤‘'}</span></div>
                <div><span class="text-gray-400">ì£¼ë¯¼ë²ˆí˜¸:</span> ${r.resident_number ? r.resident_number.substring(0, 8) + '******' : '-'}</div>
                <div><span class="text-gray-400">ì—°ë½ì²˜:</span> ${r.phone || '-'}</div>
                <div><span class="text-gray-400">ì†Œì† í˜‘ë ¥ì‚¬:</span> <span class="font-bold text-blue-400">${p ? p.name : '-'}</span></div>
                <div><span class="text-gray-400">ê³¼ì„¸ìœ í˜•:</span> ${r.tax_type || '-'}</div>
                <div class="col-span-2"><span class="text-gray-400">ì£¼ì†Œ:</span> ${r.address || '-'}</div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸš€ í”Œë«í¼ ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-400">ë°°ë¯¼ ID:</span> <span class="font-bold">${r.baemin_id || '-'}</span></div>
                <div><span class="text-gray-400">ì¿ íŒ¡ ID:</span> <span class="font-bold">${r.coupang_id || '-'}</span></div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ’° ê³„ì¢Œ ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><span class="text-gray-400">ì€í–‰:</span> ${banks[r.bank] || r.bank || '-'}</div>
                <div><span class="text-gray-400">ê³„ì¢Œë²ˆí˜¸:</span> ${r.account_no || '-'}</div>
                <div><span class="text-gray-400">ì˜ˆê¸ˆì£¼:</span> ${r.account_holder || r.name || '-'}</div>
            </div>
        </div>
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ“ ì²¨ë¶€íŒŒì¼</h4>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div>${r.file_contract ? '<a href="' + r.file_contract + '" target="_blank" class="text-blue-400 hover:underline">ğŸ“ ê³„ì•½ì„œ</a>' : '<span class="text-gray-500">ê³„ì•½ì„œ ì—†ìŒ</span>'}</div>
                <div>${r.file_id ? '<a href="' + r.file_id + '" target="_blank" class="text-blue-400 hover:underline">ğŸªª ì‹ ë¶„ì¦</a>' : '<span class="text-gray-500">ì‹ ë¶„ì¦ ì—†ìŒ</span>'}</div>
            </div>
        </div>
        
        ${r.memo ? `
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-blue-400">ğŸ“ ë©”ëª¨</h4>
            <div class="text-sm">${r.memo}</div>
        </div>` : ''}
        
        <div class="p-4 rounded-lg" style="background: var(--bg-secondary)">
            <h4 class="text-sm font-bold mb-3 text-gray-400">â±ï¸ ë“±ë¡ ì •ë³´</h4>
            <div class="text-sm text-gray-500">
                ë“±ë¡ì¼: ${r.created_at ? new Date(r.created_at).toLocaleDateString('ko-KR') : '-'}
            </div>
        </div>
    `;
    
    document.getElementById('riderDetailContent').innerHTML = html;
    document.getElementById('riderDetailEditBtn').onclick = () => { closeModal('riderDetailModal'); editItem('rider', id); };
    
    // ë§ˆìŠ¤í„° ê¶Œí•œë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
    const deleteBtn = document.getElementById('riderDetailDeleteBtn');
    if (currentUser && currentUser.role === 'ADMIN') {
        deleteBtn.classList.remove('hidden');
        deleteBtn.onclick = () => { closeModal('riderDetailModal'); deleteRider(id); };
    } else {
        deleteBtn.classList.add('hidden');
    }
    
    openModal('riderDetailModal');
}

// ë¼ì´ë” ì‚­ì œ (ë§ˆìŠ¤í„° ê¶Œí•œë§Œ)
async function deleteRider(id) {
    if (!currentUser || currentUser.role !== 'ADMIN') {
        showToast('ìµœê³ ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    const r = riderList.find(x => x.id === id);
    if (!r) return;
    
    if (!confirm('ë¼ì´ë” "' + r.name + '"ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    
    try {
        const result = await supabaseCall('riders', 'DELETE', null, '?id=eq.' + id);
        if (result !== false) {
            showToast('ë¼ì´ë” ì‚­ì œ ì™„ë£Œ');
            await loadAllData();
            loadStats('rider');
            renderTable('rider');
            loadDashboard();
        }
    } catch (err) {
        console.error(err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

// ë¼ì´ë” ì „ì²´ ì‚­ì œ (ìµœê³ ê´€ë¦¬ìë§Œ)
async function deleteAllRiders() {
    if (!currentUser || currentUser.role !== 'ADMIN') {
        showToast('ìµœê³ ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    if (riderList.length === 0) {
        showToast('ì‚­ì œí•  ë¼ì´ë”ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    const confirmText = 'ë¼ì´ë” ' + riderList.length + 'ëª… ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\ní™•ì¸í•˜ë ¤ë©´ "ì „ì²´ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”:';
    const input = prompt(confirmText);
    
    if (input !== 'ì „ì²´ì‚­ì œ') {
        showToast('ì „ì²´ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    try {
        showToast('ì‚­ì œ ì¤‘...', 'info');
        
        // ëª¨ë“  ë¼ì´ë” ì‚­ì œ
        const result = await supabaseCall('riders', 'DELETE', null, '?id=neq.0');
        
        if (result !== false) {
            showToast('ë¼ì´ë” ì „ì²´ ì‚­ì œ ì™„ë£Œ');
            await loadAllData();
            loadStats('rider');
            renderTable('rider');
            loadDashboard();
        }
    } catch (err) {
        console.error(err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

async function deletePartner(id) {
    const p = partnerList.find(x => x.id === id);
    if (!p) return;
    
    // ì†Œì† ë¼ì´ë” í™•ì¸
    const linkedRiders = riderList.filter(r => r.partner_id == id);
    
    let confirmMsg = 'í˜‘ë ¥ì‚¬ "' + p.name + '"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    if (linkedRiders.length > 0) {
        confirmMsg += '\n\nâš ï¸ ì£¼ì˜: ì†Œì† ë¼ì´ë” ' + linkedRiders.length + 'ëª…ì´ ìˆìŠµë‹ˆë‹¤.\nì‚­ì œ ì‹œ í•´ë‹¹ ë¼ì´ë”ë“¤ì˜ í˜‘ë ¥ì‚¬ ì—°ê²°ì´ í•´ì œë©ë‹ˆë‹¤.';
    }
    
    if (!confirm(confirmMsg)) return;
    
    try {
        // ì†Œì† ë¼ì´ë”ì˜ partner_idë¥¼ nullë¡œ ì—…ë°ì´íŠ¸
        if (linkedRiders.length > 0) {
            for (const rider of linkedRiders) {
                await supabaseCall('riders', 'PATCH', { partner_id: null }, '?id=eq.' + rider.id);
            }
        }
        
        // í˜‘ë ¥ì‚¬ ì‚­ì œ
        const result = await supabaseCall('partners', 'DELETE', null, '?id=eq.' + id);
        if (result !== false) {
            showToast('í˜‘ë ¥ì‚¬ ì‚­ì œ ì™„ë£Œ');
            await loadAllData();
            loadStats('partner');
            renderTable('partner');
            loadPartnerOptions();
            loadDashboard();
        }
    } catch (err) {
        console.error(err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

async function submitForm(type, e) {
    e.preventDefault();
    let id, data, table, list;
    if (type === 'rider') {
        id = document.getElementById('rider-id').value;
        const ssn = document.getElementById('rider-ssn').value || null;
        data = { 
            name: document.getElementById('rider-name').value, 
            resident_number: ssn, 
            phone: document.getElementById('rider-phone').value || null,
            address: document.getElementById('rider-address').value || null,
            partner_id: document.getElementById('rider-partner').value || null, 
            baemin_id: document.getElementById('rider-baemin-id').value || null,
            coupang_id: document.getElementById('rider-coupang-id').value || null,
            account_holder: document.getElementById('rider-account-holder').value || null, 
            account_no: document.getElementById('rider-account-no').value || null, 
            tax_type: document.getElementById('rider-tax-type').value || null, 
            status: document.getElementById('rider-status').value, 
            memo: document.getElementById('rider-memo').value || null 
        };
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        const contractFile = document.getElementById('rider-file-contract').files[0];
        const idFile = document.getElementById('rider-file-id').files[0];
        if (contractFile) {
            const url = await uploadFileToStorage(contractFile, 'riders', 'contract_' + (data.name || 'rider'));
            if (url) data.file_contract = url;
        }
        if (idFile) {
            const url = await uploadFileToStorage(idFile, 'riders', 'id_' + (data.name || 'rider'));
            if (url) data.file_id = url;
        }
        table = 'riders'; list = riderList;
    } else if (type === 'partner') {
        id = document.getElementById('partner-id').value;
        data = { name: document.getElementById('partner-name').value, code: document.getElementById('partner-code').value, type: document.getElementById('partner-type').value, region: document.getElementById('partner-region').value || null, rep_name: document.getElementById('partner-rep').value || null, rep_ssn: document.getElementById('partner-rep-ssn').value || null, phone: document.getElementById('partner-phone').value || null, biz_no: document.getElementById('partner-bizno').value || null, biz_type: document.getElementById('partner-biztype').value || null, address: document.getElementById('partner-address').value || null, bank: document.getElementById('partner-bank').value || null, account_no: document.getElementById('partner-accountno').value || null, memo: document.getElementById('partner-memo').value || null };
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        const bizregFile = document.getElementById('partner-file-bizreg').files[0];
        const idFile = document.getElementById('partner-file-id').files[0];
        const contractFile = document.getElementById('partner-file-contract').files[0];
        if (bizregFile) {
            const url = await uploadFileToStorage(bizregFile, 'partners', 'bizreg_' + (data.code || 'partner'));
            if (url) data.file_bizreg = url;
        }
        if (idFile) {
            const url = await uploadFileToStorage(idFile, 'partners', 'id_' + (data.code || 'partner'));
            if (url) data.file_id = url;
        }
        if (contractFile) {
            const url = await uploadFileToStorage(contractFile, 'partners', 'contract_' + (data.code || 'partner'));
            if (url) data.file_contract = url;
        }
        table = 'partners'; list = partnerList;
    } else if (type === 'sales') {
        id = document.getElementById('sales-id').value;
        data = { sales_code: document.getElementById('sales-code').value, sales_type: document.getElementById('sales-type').value, name: document.getElementById('sales-name').value, phone: document.getElementById('sales-phone').value || null, email: document.getElementById('sales-email').value || null, region: document.getElementById('sales-region').value || null, biz_no: document.getElementById('sales-bizno').value || null, rep_name: document.getElementById('sales-repname').value || null, address: document.getElementById('sales-address').value || null, bank_name: document.getElementById('sales-bank').value || null, bank_holder: document.getElementById('sales-bank-holder').value || null, bank_account: document.getElementById('sales-bank-account').value || null, payout_cycle: document.getElementById('sales-payout-cycle').value, withholding_rate: parseFloat(document.getElementById('sales-withholding-rate').value), withholding_enabled: true, status: document.getElementById('sales-status').value, memo: document.getElementById('sales-memo').value || null };
        table = 'sales_reps'; list = salesList;
    }
    try {
        if (id) {
            await supabaseCall(table, 'PATCH', data, '?id=eq.' + id);
            const idx = list.findIndex(x => x.id == id);
            if (idx >= 0) list[idx] = { ...list[idx], ...data };
            showToast('ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall(table, 'POST', data);
            if (r && r[0]) list.unshift(r[0]);
            showToast('ë“±ë¡ ì™„ë£Œ');
        }
        closeModal(type + 'Modal');
        loadStats(type); renderTable(type); loadDashboard();
        if (type === 'partner') loadPartnerOptions();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì •ì‚° ê´€ë¦¬
function loadSettlementFilters() {
    const weeks = [...new Set(settlementList.map(s => s.settlement_week))].sort().reverse();
    document.getElementById('settWeekFilter').innerHTML = '<option value="">ì „ì²´ ì£¼ì°¨</option>' + weeks.map(w => '<option value="' + w + '">' + w + '</option>').join('');
    document.getElementById('settPartnerFilter').innerHTML = '<option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    document.getElementById('sett-rider').innerHTML = '<option value="">ì„ íƒ</option>' + riderList.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    document.getElementById('sett-partner').innerHTML = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

function filterSettlement(status) { document.getElementById('settStatusFilter').value = status; renderTable('settlement'); }

function openSettlementModal() {
    document.getElementById('settlementModalTitle').textContent = 'ğŸ’° ì •ì‚° ë“±ë¡';
    document.getElementById('settlementForm').reset();
    document.getElementById('sett-id').value = '';
    loadSettlementFilters();
    calcSettlement();
    openModal('settlementModal');
}

function editSettlement(id) {
    const s = settlementList.find(x => x.id === id); if (!s) return;
    document.getElementById('settlementModalTitle').textContent = 'ğŸ’° ì •ì‚° ìˆ˜ì •';
    document.getElementById('sett-id').value = s.id;
    document.getElementById('sett-week').value = s.settlement_week || '';
    document.getElementById('sett-start').value = s.work_start_date || '';
    document.getElementById('sett-end').value = s.work_end_date || '';
    document.getElementById('sett-paydate').value = s.payment_date || '';
    document.getElementById('sett-rider').value = s.rider_id || '';
    document.getElementById('sett-partner').value = s.partner_id || '';
    document.getElementById('sett-platform').value = s.platform || '';
    document.getElementById('sett-delivery').value = s.delivery_fee || 0;
    document.getElementById('sett-mission').value = s.mission_fee || 0;
    document.getElementById('sett-extra').value = s.extra_pay || 0;
    document.getElementById('sett-payback').value = s.payback || 0;
    document.getElementById('sett-incentive').value = s.incentive || 0;
    document.getElementById('sett-tip').value = s.tip || 0;
    document.getElementById('sett-insurance').value = s.insurance_fee || 0;
    document.getElementById('sett-rental').value = s.rental_fee || 0;
    document.getElementById('sett-penalty').value = s.penalty || 0;
    document.getElementById('sett-other').value = s.other_deduction || 0;
    document.getElementById('sett-advance').value = s.advance_amount || 0;
    document.getElementById('sett-status').value = s.status || 'pending';
    document.getElementById('sett-memo').value = s.memo || '';
    loadSettlementFilters();
    calcSettlement();
    openModal('settlementModal');
}

function calcSettlement() {
    const gross = parseFloat(document.getElementById('sett-delivery').value||0) + parseFloat(document.getElementById('sett-mission').value||0) + parseFloat(document.getElementById('sett-extra').value||0) + parseFloat(document.getElementById('sett-payback').value||0) + parseFloat(document.getElementById('sett-incentive').value||0) + parseFloat(document.getElementById('sett-tip').value||0);
    const deduct = parseFloat(document.getElementById('sett-insurance').value||0) + parseFloat(document.getElementById('sett-rental').value||0) + parseFloat(document.getElementById('sett-penalty').value||0) + parseFloat(document.getElementById('sett-other').value||0);
    const advance = parseFloat(document.getElementById('sett-advance').value||0);
    const net = gross - deduct - advance;
    document.getElementById('calc-gross').textContent = 'â‚©' + gross.toLocaleString();
    document.getElementById('calc-deduct').textContent = 'â‚©' + deduct.toLocaleString();
    document.getElementById('calc-advance').textContent = 'â‚©' + advance.toLocaleString();
    document.getElementById('calc-net').textContent = 'â‚©' + net.toLocaleString();
}

async function submitSettlement(e) {
    e.preventDefault();
    const id = document.getElementById('sett-id').value;
    const gross = parseFloat(document.getElementById('sett-delivery').value||0) + parseFloat(document.getElementById('sett-mission').value||0) + parseFloat(document.getElementById('sett-extra').value||0) + parseFloat(document.getElementById('sett-payback').value||0) + parseFloat(document.getElementById('sett-incentive').value||0) + parseFloat(document.getElementById('sett-tip').value||0);
    const deduct = parseFloat(document.getElementById('sett-insurance').value||0) + parseFloat(document.getElementById('sett-rental').value||0) + parseFloat(document.getElementById('sett-penalty').value||0) + parseFloat(document.getElementById('sett-other').value||0);
    const advance = parseFloat(document.getElementById('sett-advance').value||0);
    const data = {
        settlement_week: document.getElementById('sett-week').value,
        work_start_date: document.getElementById('sett-start').value || null,
        work_end_date: document.getElementById('sett-end').value || null,
        payment_date: document.getElementById('sett-paydate').value || null,
        rider_id: document.getElementById('sett-rider').value || null,
        partner_id: document.getElementById('sett-partner').value || null,
        platform: document.getElementById('sett-platform').value || null,
        delivery_fee: document.getElementById('sett-delivery').value || 0,
        mission_fee: document.getElementById('sett-mission').value || 0,
        extra_pay: document.getElementById('sett-extra').value || 0,
        payback: document.getElementById('sett-payback').value || 0,
        incentive: document.getElementById('sett-incentive').value || 0,
        tip: document.getElementById('sett-tip').value || 0,
        insurance_fee: document.getElementById('sett-insurance').value || 0,
        rental_fee: document.getElementById('sett-rental').value || 0,
        penalty: document.getElementById('sett-penalty').value || 0,
        other_deduction: document.getElementById('sett-other').value || 0,
        gross_amount: gross,
        deduction_amount: deduct,
        advance_amount: advance,
        net_amount: gross - deduct - advance,
        status: document.getElementById('sett-status').value,
        memo: document.getElementById('sett-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('settlements', 'PATCH', data, '?id=eq.' + id);
            const idx = settlementList.findIndex(x => x.id == id);
            if (idx >= 0) settlementList[idx] = { ...settlementList[idx], ...data };
            showToast('ì •ì‚° ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('settlements', 'POST', data);
            if (r && r[0]) settlementList.unshift(r[0]);
            showToast('ì •ì‚° ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('settlementModal');
        loadStats('settlement');
        renderTable('settlement');
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì‚¬ìš©ì ê´€ë¦¬
function renderUserTable() {
    const systemFilter = document.getElementById('userSystemFilter')?.value || '';
    const roleFilter = document.getElementById('userRoleFilter')?.value || '';
    const searchFilter = (document.getElementById('userSearch')?.value || '').toLowerCase();
    
    let filtered = userList.filter(u => {
        if (systemFilter && u.system_type !== systemFilter && u.system_type !== 'all') return false;
        if (roleFilter && u.role !== roleFilter) return false;
        if (searchFilter && !(u.name || '').toLowerCase().includes(searchFilter) && !(u.username || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    const tbody = document.getElementById('userTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const systemNames = { hq: 'íŒ€ë¸Œë¡œ HQ', brocompany: 'ë¸Œë¡œì»´í¼ë‹ˆ', bromotors: 'ë¸Œë¡œëª¨í„°ìŠ¤', all: 'ì „ì²´' };
    const roleClass = { ADMIN: 'badge-error', MANAGER: 'badge-info', STAFF: 'badge-active', VIEWER: 'badge-pending' };
    
    tbody.innerHTML = filtered.map(u => '<tr><td class="font-bold">' + u.name + '</td><td>' + u.username + '</td><td><span class="badge badge-info">' + (systemNames[u.system_type] || 'íŒ€ë¸Œë¡œ HQ') + '</span></td><td><span class="badge ' + (roleClass[u.role] || 'badge-inactive') + '">' + u.role + '</span></td><td><span class="badge ' + (u.is_active?'badge-active">í™œì„±':'badge-inactive">ë¹„í™œì„±') + '</span></td><td><button onclick="editUser(' + u.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteUser(' + u.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>').join('');
}

function openUserModal() { 
    document.getElementById('userModalTitle').textContent = 'ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡'; 
    document.getElementById('userForm').reset(); 
    document.getElementById('user-id').value = ''; 
    document.getElementById('user-system').value = 'hq';
    openModal('userModal'); 
}

function editUser(id) {
    const u = userList.find(x => x.id === id); if (!u) return;
    document.getElementById('userModalTitle').textContent = 'ğŸ‘¤ ì‚¬ìš©ì ìˆ˜ì •';
    document.getElementById('user-id').value = u.id;
    document.getElementById('user-name').value = u.name || '';
    document.getElementById('user-username').value = u.username || '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-system').value = u.system_type || 'hq';
    document.getElementById('user-role').value = u.role || 'STAFF';
    document.getElementById('user-status').value = u.is_active ? 'true' : 'false';
    openModal('userModal');
}

async function submitUser(e) {
    e.preventDefault();
    const id = document.getElementById('user-id').value;
    const data = { 
        name: document.getElementById('user-name').value, 
        username: document.getElementById('user-username').value, 
        system_type: document.getElementById('user-system').value,
        role: document.getElementById('user-role').value, 
        is_active: document.getElementById('user-status').value === 'true' 
    };
    const pw = document.getElementById('user-password').value;
    if (pw) data.password_hash = pw;
    try {
        if (id) {
            await supabaseCall('hq_users', 'PATCH', data, '?id=eq.' + id);
            const idx = userList.findIndex(x => x.id == id);
            if (idx >= 0) userList[idx] = { ...userList[idx], ...data };
            showToast('ì‚¬ìš©ì ìˆ˜ì • ì™„ë£Œ');
        } else {
            if (!pw) { showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
            const r = await supabaseCall('hq_users', 'POST', data);
            if (r && r[0]) userList.push(r[0]);
            showToast('ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('userModal');
        renderUserTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì‚¬ìš©ì ì‚­ì œ
async function deleteUser(id) {
    if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('hq_users', 'DELETE', null, '?id=eq.' + id);
        userList = userList.filter(u => u.id !== id);
        showToast('ì‚¬ìš©ì ì‚­ì œ ì™„ë£Œ');
        renderUserTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

// ì—‘ì…€ ê¸°ëŠ¥
const TEMPLATES = {
    rider: { filename: 'ë¼ì´ë”_ì–‘ì‹.xlsx', headers: ['ë¼ì´ë”ì´ë¦„*','ì£¼ë¯¼ë²ˆí˜¸','ì†Œì†í˜‘ë ¥ì‚¬','ë°°ë¯¼ID','ì¿ íŒ¡ID','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì„¸ê¸ˆì²˜ë¦¬(ì›ì²œì§•ìˆ˜/ê³¼ì„¸ì§€ì¶œ)','ìƒíƒœ(ê³„ì•½ì¤‘/ê³„ì•½ì¢…ë£Œ)','ë©”ëª¨'], fields: ['name','resident_number','partner_code','baemin_id','coupang_id','account_holder','account_no','tax_type','status','memo'], sample: ['í™ê¸¸ë™','900101-1234567','DP123','baemin123','coupang456','í™ê¸¸ë™','1234567890','ì›ì²œì§•ìˆ˜','ê³„ì•½ì¤‘','ë©”ëª¨'] },
    partner: { filename: 'í˜‘ë ¥ì‚¬_ì–‘ì‹.xlsx', headers: ['í˜‘ë ¥ì‚¬ëª…*','í˜‘ë ¥ì‚¬ì½”ë“œ*','êµ¬ë¶„(biz/non_biz)','ë°°ë‹¬ê¶Œì—­','ìš´ì˜ìì´ë¦„','ìš´ì˜ìì£¼ë¯¼ë²ˆí˜¸','ì—°ë½ì²˜','ì‚¬ì—…ìë²ˆí˜¸','ì—…ì¢…','ì£¼ì†Œ','ì€í–‰','ê³„ì¢Œë²ˆí˜¸','ë©”ëª¨'], fields: ['name','code','type','region','rep_name','rep_ssn','phone','biz_no','biz_type','address','bank','account_no','memo'], sample: ['ë°°ë¯¼íŒ€ë¸Œë¡œ','DP123','biz','ê°•ë‚¨,ì„œì´ˆ','ê¹€ìš´ì˜','850101-1234567','02-1234-5678','123-45-67890','ìš´ì†¡ì—…','ì„œìš¸','KB','1234567890','ë©”ëª¨'] },
    sales: { filename: 'ì˜ì—…ì_ì–‘ì‹.xlsx', headers: ['ì˜ì—…ìì½”ë“œ*','ì´ë¦„*','ìœ í˜•','ì—°ë½ì²˜','ì´ë©”ì¼','ì§€ì—­','ì£¼ì†Œ','ì‚¬ì—…ìë²ˆí˜¸','ëŒ€í‘œìëª…','ì€í–‰','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì›ì²œì§•ìˆ˜ìœ¨','ì§€ê¸‰ì£¼ê¸°','ìƒíƒœ','ë©”ëª¨'], fields: ['sales_code','name','sales_type','phone','email','region','address','biz_no','rep_name','bank_name','bank_holder','bank_account','withholding_rate','payout_cycle','status','memo'], sample: ['SB-0001','ê¹€ì˜ì—…','individual','010-1234-5678','sales@test.com','ì„œìš¸','ì„œìš¸ì‹œ','','','KB','ê¹€ì˜ì—…','1234567890','0.033','monthly','active','ë©”ëª¨'] },
    taxinvoice: { filename: 'ì„¸ê¸ˆê³„ì‚°ì„œ_ì–‘ì‹.xlsx', headers: ['ìœ í˜•(ë§¤ì…/ë§¤ì¶œ)*','ë°œí–‰ì¼*','ê±°ë˜ì²˜*','ì‚¬ì—…ìë²ˆí˜¸','ëŒ€í‘œì','ê³µê¸‰ê°€ì•¡*','ë¶€ê°€ì„¸','í•©ê³„','ì§€ê¸‰ìƒíƒœ','í’ˆëª©','ë©”ëª¨'], sample: ['ë§¤ì…','2025-01-15','(ì£¼)í…ŒìŠ¤íŠ¸','123-45-67890','ê¹€ëŒ€í‘œ','1000000','100000','1100000','ë¯¸ì§€ê¸‰','ë¬¼í’ˆëŒ€','ë©”ëª¨'] },
    journal: { filename: 'ë¶„ê°œì¥_ì–‘ì‹.xlsx', headers: ['ì¼ì*','ë¶„ê°œë²ˆí˜¸','ì°¨ë³€ê³„ì •','ì°¨ë³€ê¸ˆì•¡*','ëŒ€ë³€ê³„ì •','ëŒ€ë³€ê¸ˆì•¡*','ì ìš”*','ìƒíƒœ','ë©”ëª¨'], sample: ['2025-01-15','JNL-001','102-ë³´í†µì˜ˆê¸ˆ','1000000','401-ë§¤ì¶œ','1000000','ë§¤ì¶œëŒ€ê¸ˆ ì…ê¸ˆ','ìƒì„±','ë©”ëª¨'] }
};

function downloadTemplate(type) {
    const tpl = TEMPLATES[type];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([tpl.headers, tpl.sample]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, tpl.filename);
    showToast('ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'info');
}

function exportToExcel(type) {
    let data, filename, headers;
    if (type === 'rider') {
        headers = ['ë¼ì´ë”ì´ë¦„','ì£¼ë¯¼ë²ˆí˜¸','ì†Œì†í˜‘ë ¥ì‚¬','ë°°ë¯¼ID','ì¿ íŒ¡ID','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì„¸ê¸ˆì²˜ë¦¬','ìƒíƒœ','ë©”ëª¨'];
        data = riderList.map(r => { const p = partnerList.find(x => x.id == r.partner_id); return [r.name, r.resident_number||'', p?p.name:'', r.baemin_id||'', r.coupang_id||'', r.account_holder||'', r.account_no||'', r.tax_type||'', r.status||'', r.memo||'']; });
        filename = 'ë¼ì´ë”ëª©ë¡.xlsx';
    } else if (type === 'partner') {
        headers = ['í˜‘ë ¥ì‚¬ëª…','ì½”ë“œ','êµ¬ë¶„','ë°°ë‹¬ê¶Œì—­','ìš´ì˜ìì´ë¦„','ìš´ì˜ìì£¼ë¯¼ë²ˆí˜¸','ì—°ë½ì²˜','ì‚¬ì—…ìë²ˆí˜¸','ì—…ì¢…','ì£¼ì†Œ','ì€í–‰','ê³„ì¢Œë²ˆí˜¸','ë©”ëª¨'];
        data = partnerList.map(p => [p.name, p.code, p.type, p.region||'', p.rep_name||'', p.rep_ssn||'', p.phone||'', p.biz_no||'', p.biz_type||'', p.address||'', p.bank||'', p.account_no||'', p.memo||'']);
        filename = 'í˜‘ë ¥ì‚¬ëª©ë¡.xlsx';
    } else if (type === 'sales') {
        headers = ['ì½”ë“œ','ì´ë¦„','ìœ í˜•','ì—°ë½ì²˜','ì´ë©”ì¼','ì§€ì—­','ì£¼ì†Œ','ì€í–‰','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì›ì²œì§•ìˆ˜ìœ¨','ì§€ê¸‰ì£¼ê¸°','ìƒíƒœ','ë©”ëª¨'];
        data = salesList.map(s => [s.sales_code, s.name, s.sales_type, s.phone, s.email, s.region, s.address, s.bank_name, s.bank_holder, s.bank_account, s.withholding_rate, s.payout_cycle, s.status, s.memo]);
        filename = 'ì˜ì—…ìëª©ë¡.xlsx';
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename);
    showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'info');
}

async function uploadExcel(type, input) {
    const file = input.files[0];
    if (!file) return;
    
    // ì—…ë¡œë“œ ì‹œì‘ í‘œì‹œ
    const typeName = type === 'rider' ? 'ë¼ì´ë”' : type === 'partner' ? 'í˜‘ë ¥ì‚¬' : 'ì˜ì—…ì';
    showToast('ğŸ“¤ ' + typeName + ' ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì¤‘...', 'info');
    
    // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•´ ìµœì‹  ë°ì´í„° ì „ì²´ ë¡œë“œ (í˜ì´ì§€ë„¤ì´ì…˜)
    let existingData = [];
    if (type === 'rider') {
        existingData = await loadAllPaginated('riders', 'created_at.desc');
        riderList = existingData; // ì „ì—­ ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸
    } else if (type === 'partner') {
        existingData = await loadAllPaginated('partners', 'created_at.desc');
        partnerList = existingData;
    } else if (type === 'sales') {
        existingData = await loadAllPaginated('sales_reps', 'created_at.desc');
        salesList = existingData;
    }
    
    showToast('ğŸ“¤ ' + typeName + ' ë°ì´í„° ë¶„ì„ ì¤‘... (ê¸°ì¡´ ' + existingData.length + 'ê±´)', 'info');
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (rows.length < 2) { showToast('ë°ì´í„° ì—†ìŒ', 'error'); return; }
            const tpl = TEMPLATES[type];
            let count = 0;
            let duplicateCount = 0;
            const totalRows = rows.length - 1;
            
            // ì¤‘ë³µ ì²´í¬ìš© Set ìƒì„± (ì „ì²´ ë°ì´í„° ê¸°ë°˜)
            const existingNames = new Set(existingData.map(d => d.name?.trim().toLowerCase()));
            const existingPhones = new Set(existingData.map(d => d.phone?.replace(/[^0-9]/g, '')));
            const existingSSNs = new Set(existingData.map(d => d.resident_number?.replace(/[^0-9]/g, '')));
            const existingBizNos = new Set(existingData.map(d => d.business_number?.replace(/[^0-9]/g, '')));
            const existingSalesCodes = new Set(existingData.map(d => d.sales_code?.trim().toLowerCase()));
            
            // ì—…ë¡œë“œí•  ë°ì´í„° ëª¨ìœ¼ê¸°
            const toInsert = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                const data = {};
                tpl.fields.forEach((f, idx) => {
                    if (row[idx] !== undefined && row[idx] !== '') {
                        if (f === 'partner_code') {
                            const p = partnerList.find(x => x.code === row[idx]);
                            if (p) data['partner_id'] = p.id;
                        } else if (f === 'withholding_rate') {
                            data[f] = parseFloat(row[idx]) || 0.033;
                        } else if (f === 'resident_number') {
                            // ì£¼ë¯¼ë²ˆí˜¸ ìë™ í¬ë§·íŒ… (ìˆ«ìë§Œ ìˆìœ¼ë©´ í•˜ì´í”ˆ ì¶”ê°€)
                            let ssn = String(row[idx]).replace(/[^0-9]/g, '');
                            if (ssn.length === 13) {
                                ssn = ssn.substring(0, 6) + '-' + ssn.substring(6);
                            }
                            data[f] = ssn;
                        } else {
                            data[f] = row[idx];
                        }
                    }
                });
                if (!data.name && !data.sales_code) continue;
                
                // ì¤‘ë³µ ì²´í¬
                let isDuplicate = false;
                const name = data.name?.trim().toLowerCase();
                const phone = data.phone?.replace(/[^0-9]/g, '');
                const ssn = data.resident_number?.replace(/[^0-9]/g, '');
                const bizNo = data.business_number?.replace(/[^0-9]/g, '');
                const salesCode = data.sales_code?.trim().toLowerCase();
                
                if (type === 'rider') {
                    if (ssn && existingSSNs.has(ssn)) isDuplicate = true;
                } else if (type === 'partner') {
                    if (bizNo && existingBizNos.has(bizNo)) isDuplicate = true;
                    if (name && existingNames.has(name)) isDuplicate = true;
                } else if (type === 'sales') {
                    if (salesCode && existingSalesCodes.has(salesCode)) isDuplicate = true;
                    if (phone && existingPhones.has(phone)) isDuplicate = true;
                }
                
                if (isDuplicate) {
                    duplicateCount++;
                    continue;
                }
                
                if (type === 'sales') data.withholding_enabled = true;
                toInsert.push(data);
                
                // Setì— ì¶”ê°€ (ê°™ì€ íŒŒì¼ ë‚´ ì¤‘ë³µ ë°©ì§€)
                if (name) existingNames.add(name);
                if (phone) existingPhones.add(phone);
                if (ssn) existingSSNs.add(ssn);
                if (bizNo) existingBizNos.add(bizNo);
                if (salesCode) existingSalesCodes.add(salesCode);
            }
            
            // Batch Insert (500ê±´ì”©)
            const table = type === 'rider' ? 'riders' : type === 'partner' ? 'partners' : 'sales_reps';
            const BATCH_SIZE = 500;
            const totalBatches = Math.ceil(toInsert.length / BATCH_SIZE);
            
            showToast('ğŸ“¤ ì´ ' + toInsert.length + 'ê±´ ì—…ë¡œë“œ ì‹œì‘... (ì¤‘ë³µ ' + duplicateCount + 'ê±´ ì œì™¸)', 'info');
            
            for (let b = 0; b < totalBatches; b++) {
                const batch = toInsert.slice(b * BATCH_SIZE, (b + 1) * BATCH_SIZE);
                showToast('ğŸ“¤ ì—…ë¡œë“œ ì¤‘... ' + ((b + 1) * BATCH_SIZE > toInsert.length ? toInsert.length : (b + 1) * BATCH_SIZE) + '/' + toInsert.length + ' (' + Math.round((b + 1) / totalBatches * 100) + '%)', 'info');
                
                const result = await supabaseCall(table, 'POST', batch);
                if (result) {
                    count += Array.isArray(result) ? result.length : 1;
                }
                
                // ê³¼ë¶€í•˜ ë°©ì§€ - ë°°ì¹˜ ì‚¬ì´ ì ì‹œ ëŒ€ê¸°
                if (b < totalBatches - 1) {
                    await new Promise(r => setTimeout(r, 100));
                }
            }
            
            if (duplicateCount > 0) {
                showToast('âœ… ' + count + 'ê±´ ë“±ë¡ ì™„ë£Œ! (' + duplicateCount + 'ê±´ ì¤‘ë³µ ì œì™¸)', 'success');
            } else {
                showToast('âœ… ' + count + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ!', 'success');
            }
            await loadAllData();
            loadStats(type); renderTable(type); loadDashboard();
            if (type === 'partner') loadPartnerOptions();
        } catch (err) { console.error(err); showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error'); }
    };
    reader.readAsBinaryString(file);
    input.value = '';
}

document.addEventListener('DOMContentLoaded', async () => {
    const restored = await restoreSession();
    document.getElementById('loadingScreen').classList.add('hidden');
    if (!restored) document.getElementById('loginPage').classList.remove('hidden');
});

// ==================== ë²•ì¸ì¹´ë“œ ê´€ë¦¬ ====================
function renderCardTable() {
    document.getElementById('card-total').textContent = cardList.length;
    document.getElementById('card-active').textContent = cardList.filter(c => c.status === 'active').length;
    document.getElementById('card-suspended').textContent = cardList.filter(c => c.status === 'suspended').length;
    const monthly = cardTransList.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    document.getElementById('card-monthly').textContent = 'â‚©' + monthly.toLocaleString();
    
    const tbody = document.getElementById('cardTableBody');
    if (!cardList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const statuses = { active: 'ì‚¬ìš©ì¤‘', suspended: 'ì¼ì‹œì¤‘ì§€', terminated: 'í•´ì§€' };
    const statusClass = { active: 'badge-active', suspended: 'badge-pending', terminated: 'badge-inactive' };
    tbody.innerHTML = cardList.map(c => '<tr><td class="font-bold">' + (c.card_alias || '-') + '</td><td>' + (c.card_number_masked || '-') + '</td><td>' + (c.card_company || '-') + '</td><td>' + (c.primary_user || '-') + '</td><td class="text-right">â‚©' + parseInt(c.daily_limit || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(c.monthly_limit || 0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[c.status] || 'badge-inactive') + '">' + (statuses[c.status] || c.status) + '</span></td><td><button onclick="editCard(' + c.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function renderCardTransTable() {
    // í†µê³„ ì—…ë°ì´íŠ¸
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthlyUsage = cardTransList.filter(t => t.transaction_date?.startsWith(thisMonth)).reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    const noReceipt = cardTransList.filter(t => t.evidence_status === 'pending').length;
    const pending = cardTransList.filter(t => t.accounting_status === 'pending').length;
    
    const monthlyEl = document.getElementById('card-usage-monthly');
    const countEl = document.getElementById('card-usage-count');
    const noReceiptEl = document.getElementById('card-usage-noreceipt');
    const pendingEl = document.getElementById('card-usage-pending');
    
    if (monthlyEl) monthlyEl.textContent = 'â‚©' + monthlyUsage.toLocaleString();
    if (countEl) countEl.textContent = cardTransList.length + 'ê±´';
    if (noReceiptEl) noReceiptEl.textContent = noReceipt + 'ê±´';
    if (pendingEl) pendingEl.textContent = pending + 'ê±´';
    
    const tbody = document.getElementById('cardUsageTableBody');
    if (!tbody) return;
    
    if (!cardTransList.length) { 
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; 
        return; 
    }
    
    const evidenceStatus = { pending: 'ë¯¸ì œì¶œ', submitted: 'ì œì¶œ', approved: 'ìŠ¹ì¸' };
    const accStatus = { pending: 'ë¯¸ì²˜ë¦¬', journalized: 'ì™„ë£Œ' };
    
    tbody.innerHTML = cardTransList.map(t => {
        const card = cardList.find(c => c.id == t.card_id);
        return '<tr>' +
            '<td>' + (t.transaction_date || '-') + '</td>' +
            '<td>' + (card ? card.card_alias : '-') + '</td>' +
            '<td>' + (t.merchant_name || '-') + '</td>' +
            '<td class="text-right font-bold">â‚©' + parseInt(t.amount || 0).toLocaleString() + '</td>' +
            '<td><span class="badge ' + (t.evidence_status === 'approved' ? 'badge-active' : 'badge-pending') + '">' + (evidenceStatus[t.evidence_status] || 'ë¯¸ì œì¶œ') + '</span></td>' +
            '<td><span class="badge ' + (t.accounting_status === 'journalized' ? 'badge-active' : 'badge-pending') + '">' + (accStatus[t.accounting_status] || 'ë¯¸ì²˜ë¦¬') + '</span></td>' +
            '<td><button onclick="editCardTrans(' + t.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteCardTrans(' + t.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td>' +
            '</tr>';
    }).join('');
}

function openCardTransModal() {
    document.getElementById('cardTransForm').reset();
    document.getElementById('cardtrans-id').value = '';
    document.getElementById('cardtrans-date').value = new Date().toISOString().slice(0, 16);
    
    // ì¹´ë“œ ì˜µì…˜ ë¡œë“œ
    const select = document.getElementById('cardtrans-card');
    select.innerHTML = '<option value="">ì„ íƒ</option>' + cardList.map(c => '<option value="' + c.id + '">' + (c.card_alias || c.card_number_masked) + '</option>').join('');
    
    openModal('cardTransModal');
}

function editCardTrans(id) {
    const t = cardTransList.find(x => x.id === id);
    if (!t) return;
    
    document.getElementById('cardtrans-id').value = t.id;
    document.getElementById('cardtrans-date').value = t.transaction_date ? t.transaction_date.replace(' ', 'T').slice(0, 16) : '';
    
    const select = document.getElementById('cardtrans-card');
    select.innerHTML = '<option value="">ì„ íƒ</option>' + cardList.map(c => '<option value="' + c.id + '">' + (c.card_alias || c.card_number_masked) + '</option>').join('');
    select.value = t.card_id || '';
    
    document.getElementById('cardtrans-merchant').value = t.merchant_name || '';
    document.getElementById('cardtrans-amount').value = t.amount || '';
    document.getElementById('cardtrans-category').value = t.category || '';
    document.getElementById('cardtrans-approval').value = t.approval_number || '';
    document.getElementById('cardtrans-evidence').value = t.evidence_status || 'pending';
    document.getElementById('cardtrans-accounting').value = t.accounting_status || 'pending';
    document.getElementById('cardtrans-memo').value = t.memo || '';
    
    openModal('cardTransModal');
}

async function submitCardTrans(e) {
    e.preventDefault();
    const id = document.getElementById('cardtrans-id').value;
    const data = {
        transaction_date: document.getElementById('cardtrans-date').value.replace('T', ' '),
        card_id: parseInt(document.getElementById('cardtrans-card').value) || null,
        merchant_name: document.getElementById('cardtrans-merchant').value,
        amount: parseFloat(document.getElementById('cardtrans-amount').value) || 0,
        category: document.getElementById('cardtrans-category').value || null,
        approval_number: document.getElementById('cardtrans-approval').value || null,
        evidence_status: document.getElementById('cardtrans-evidence').value,
        accounting_status: document.getElementById('cardtrans-accounting').value,
        memo: document.getElementById('cardtrans-memo').value || null
    };
    
    let result;
    if (id) {
        result = await supabaseCall('card_transactions', 'PATCH', data, '?id=eq.' + id);
        if (result) {
            const idx = cardTransList.findIndex(t => t.id == id);
            if (idx >= 0) cardTransList[idx] = { ...cardTransList[idx], ...data };
            showToast('ì‚¬ìš©ë‚´ì—­ ìˆ˜ì • ì™„ë£Œ');
        }
    } else {
        result = await supabaseCall('card_transactions', 'POST', data);
        if (result && result[0]) {
            cardTransList.unshift(result[0]);
            showToast('ì‚¬ìš©ë‚´ì—­ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    closeModal('cardTransModal');
    renderCardTransTable();
}

async function deleteCardTrans(id) {
    if (!confirm('ì´ ì‚¬ìš©ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await supabaseCall('card_transactions', 'DELETE', null, '?id=eq.' + id);
    cardTransList = cardTransList.filter(t => t.id !== id);
    
    showToast('ì‚¬ìš©ë‚´ì—­ ì‚­ì œ ì™„ë£Œ');
    renderCardTransTable();
}

function openCardModal() {
    document.getElementById('cardModalTitle').textContent = 'ğŸ’³ ì¹´ë“œ ë“±ë¡';
    document.getElementById('cardForm').reset();
    document.getElementById('card-id').value = '';
    openModal('cardModal');
}

function editCard(id) {
    const c = cardList.find(x => x.id === id); if (!c) return;
    document.getElementById('cardModalTitle').textContent = 'ğŸ’³ ì¹´ë“œ ìˆ˜ì •';
    document.getElementById('card-id').value = c.id;
    document.getElementById('card-alias').value = c.card_alias || '';
    document.getElementById('card-company').value = c.company_name || '';
    document.getElementById('card-company-name').value = c.card_company || '';
    document.getElementById('card-number').value = c.card_number_masked || '';
    document.getElementById('card-bank').value = c.linked_bank_account || '';
    document.getElementById('card-valid').value = c.valid_until || '';
    document.getElementById('card-dept').value = c.department || '';
    document.getElementById('card-user').value = c.primary_user || '';
    document.getElementById('card-daily').value = c.daily_limit || 0;
    document.getElementById('card-monthly').value = c.monthly_limit || 0;
    document.getElementById('card-online').checked = c.allow_online !== false;
    document.getElementById('card-overseas').checked = c.allow_overseas === true;
    document.getElementById('card-issued').value = c.issued_at || '';
    document.getElementById('card-status').value = c.status || 'active';
    document.getElementById('card-memo').value = c.memo || '';
    openModal('cardModal');
}

async function submitCard(e) {
    e.preventDefault();
    const id = document.getElementById('card-id').value;
    const data = {
        card_alias: document.getElementById('card-alias').value,
        company_name: document.getElementById('card-company').value || null,
        card_company: document.getElementById('card-company-name').value,
        card_number_masked: document.getElementById('card-number').value || null,
        linked_bank_account: document.getElementById('card-bank').value || null,
        valid_until: document.getElementById('card-valid').value || null,
        department: document.getElementById('card-dept').value || null,
        primary_user: document.getElementById('card-user').value || null,
        daily_limit: parseFloat(document.getElementById('card-daily').value) || 0,
        monthly_limit: parseFloat(document.getElementById('card-monthly').value) || 0,
        allow_online: document.getElementById('card-online').checked,
        allow_overseas: document.getElementById('card-overseas').checked,
        issued_at: document.getElementById('card-issued').value || null,
        status: document.getElementById('card-status').value,
        memo: document.getElementById('card-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('corporate_cards', 'PATCH', data, '?id=eq.' + id);
            const idx = cardList.findIndex(x => x.id == id);
            if (idx >= 0) cardList[idx] = { ...cardList[idx], ...data };
            showToast('ì¹´ë“œ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('corporate_cards', 'POST', data);
            if (r && r[0]) cardList.unshift(r[0]);
            showToast('ì¹´ë“œ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('cardModal');
        renderCardTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ==================== ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬ ====================
function renderTaxInvoiceTable() {
    const purchases = taxInvoiceList.filter(t => t.invoice_type === 'purchase');
    const sales = taxInvoiceList.filter(t => t.invoice_type === 'sales');
    const unsynced = taxInvoiceList.filter(t => !t.synced_to_ledger);
    
    document.getElementById('inv-purchase').textContent = purchases.length;
    document.getElementById('inv-purchase-amt').textContent = 'â‚©' + purchases.reduce((s, t) => s + parseFloat(t.total_amount || 0), 0).toLocaleString();
    document.getElementById('inv-sales').textContent = sales.length;
    document.getElementById('inv-sales-amt').textContent = 'â‚©' + sales.reduce((s, t) => s + parseFloat(t.total_amount || 0), 0).toLocaleString();
    document.getElementById('inv-unsynced').textContent = unsynced.length;
    
    const typeFilter = document.getElementById('invTypeFilter').value;
    const statusFilter = document.getElementById('invStatusFilter').value;
    const syncFilter = document.getElementById('invSyncFilter')?.value || '';
    const search = (document.getElementById('invSearch').value || '').toLowerCase();
    let list = taxInvoiceList;
    if (typeFilter) list = list.filter(t => t.invoice_type === typeFilter);
    if (statusFilter) list = list.filter(t => t.payment_status === statusFilter);
    if (syncFilter === 'synced') list = list.filter(t => t.synced_to_ledger);
    if (syncFilter === 'unsynced') list = list.filter(t => !t.synced_to_ledger);
    if (search) list = list.filter(t => (t.partner_name || '').toLowerCase().includes(search));
    
    const tbody = document.getElementById('taxInvoiceTableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const types = { purchase: 'ë§¤ì…', sales: 'ë§¤ì¶œ' };
    const payStatus = { unpaid: 'ë¯¸ì§€ê¸‰', paid: 'ì§€ê¸‰ì™„ë£Œ' };
    tbody.innerHTML = list.map(t => {
        const syncBadge = t.synced_to_ledger ? '<span class="badge badge-active text-xs">ì—°ë™</span>' : '<span class="badge badge-pending text-xs">ë¯¸ì—°ë™</span>';
        return '<tr><td><span class="badge ' + (t.invoice_type === 'purchase' ? 'badge-error' : 'badge-info') + '">' + (types[t.invoice_type] || t.invoice_type) + '</span></td><td>' + t.invoice_date + '</td><td class="font-bold">' + (t.partner_name || '-') + '</td><td class="text-right">â‚©' + parseInt(t.supply_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(t.vat_amount || 0).toLocaleString() + '</td><td class="text-right font-bold">â‚©' + parseInt(t.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.payment_status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (payStatus[t.payment_status] || 'ë¯¸ì§€ê¸‰') + '</span></td><td>' + syncBadge + '</td><td><button onclick="editTaxInvoice(' + t.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteTaxInvoice(' + t.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>';
    }).join('');
}

function openTaxInvoiceModal() {
    document.getElementById('taxInvoiceModalTitle').textContent = 'ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ë“±ë¡';
    document.getElementById('taxInvoiceForm').reset();
    document.getElementById('inv-id').value = '';
    document.getElementById('inv-date').value = new Date().toISOString().split('T')[0];
    openModal('taxInvoiceModal');
}

function editTaxInvoice(id) {
    const t = taxInvoiceList.find(x => x.id === id); if (!t) return;
    document.getElementById('taxInvoiceModalTitle').textContent = 'ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì •';
    document.getElementById('inv-id').value = t.id;
    document.getElementById('inv-type').value = t.invoice_type || 'purchase';
    document.getElementById('inv-date').value = t.invoice_date || '';
    document.getElementById('inv-vendor').value = t.partner_name || '';
    document.getElementById('inv-bizno').value = t.biz_no || '';
    document.getElementById('inv-ceo').value = t.ceo_name || '';
    document.getElementById('inv-supply').value = t.supply_amount || 0;
    document.getElementById('inv-vat').value = t.vat_amount || 0;
    document.getElementById('inv-total').value = t.total_amount || 0;
    document.getElementById('inv-status').value = t.payment_status || 'unpaid';
    document.getElementById('inv-paiddate').value = t.paid_date || '';
    document.getElementById('inv-item').value = t.item_name || '';
    document.getElementById('inv-memo').value = t.memo || '';
    openModal('taxInvoiceModal');
}

function calcTaxInvoice() {
    const supply = parseFloat(document.getElementById('inv-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('inv-vat').value = vat;
    document.getElementById('inv-total').value = supply + vat;
}

async function submitTaxInvoice(e) {
    e.preventDefault();
    const id = document.getElementById('inv-id').value;
    const data = {
        invoice_type: document.getElementById('inv-type').value,
        invoice_date: document.getElementById('inv-date').value,
        partner_name: document.getElementById('inv-vendor').value,
        biz_no: document.getElementById('inv-bizno').value || null,
        ceo_name: document.getElementById('inv-ceo').value || null,
        supply_amount: parseFloat(document.getElementById('inv-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('inv-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('inv-total').value) || 0,
        payment_status: document.getElementById('inv-status').value,
        paid_date: document.getElementById('inv-paiddate').value || null,
        item_name: document.getElementById('inv-item').value || null,
        memo: document.getElementById('inv-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('hq_tax_invoices', 'PATCH', data, '?id=eq.' + id);
            const idx = taxInvoiceList.findIndex(x => x.id == id);
            if (idx >= 0) taxInvoiceList[idx] = { ...taxInvoiceList[idx], ...data };
            showToast('ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('hq_tax_invoices', 'POST', data);
            if (r && r[0]) taxInvoiceList.unshift(r[0]);
            showToast('ì„¸ê¸ˆê³„ì‚°ì„œ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('taxInvoiceModal');
        renderTaxInvoiceTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì„¸ê¸ˆê³„ì‚°ì„œ ì‚­ì œ
async function deleteTaxInvoice(id) {
    if (!confirm('ì´ ì„¸ê¸ˆê³„ì‚°ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('hq_tax_invoices', 'DELETE', null, '?id=eq.' + id);
        taxInvoiceList = taxInvoiceList.filter(t => t.id !== id);
        showToast('ì„¸ê¸ˆê³„ì‚°ì„œ ì‚­ì œ ì™„ë£Œ');
        renderTaxInvoiceTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

// ì„¸ê¸ˆê³„ì‚°ì„œ ì—‘ì…€
function exportTaxInvoiceExcel() {
    const headers = ['ìœ í˜•','ë°œí–‰ì¼','ê±°ë˜ì²˜','ì‚¬ì—…ìë²ˆí˜¸','ëŒ€í‘œì','ê³µê¸‰ê°€ì•¡','ë¶€ê°€ì„¸','í•©ê³„','ì§€ê¸‰ìƒíƒœ','í’ˆëª©','ë©”ëª¨'];
    const data = taxInvoiceList.map(t => [t.invoice_type === 'purchase' ? 'ë§¤ì…' : 'ë§¤ì¶œ', t.invoice_date, t.partner_name, t.biz_no, t.ceo_name, t.supply_amount, t.vat_amount, t.total_amount, t.payment_status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ë¯¸ì§€ê¸‰', t.item_name, t.memo]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'ì„¸ê¸ˆê³„ì‚°ì„œ');
    XLSX.writeFile(wb, 'ì„¸ê¸ˆê³„ì‚°ì„œëª©ë¡.xlsx');
    showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

async function uploadTaxInvoiceExcel(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (rows.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
            let count = 0, errorCount = 0;
            for (let i = 1; i < rows.length; i++) {
                const r = rows[i]; if (!r[2]) continue;
                const data = {
                    invoice_type: (r[0] || '').includes('ë§¤ì…') ? 'purchase' : 'sales',
                    invoice_date: r[1] ? String(r[1]).substring(0, 10) : new Date().toISOString().split('T')[0],
                    partner_name: r[2],
                    biz_no: r[3] || null,
                    ceo_name: r[4] || null,
                    supply_amount: parseFloat(r[5]) || 0,
                    vat_amount: parseFloat(r[6]) || 0,
                    total_amount: parseFloat(r[7]) || (parseFloat(r[5]) || 0) + (parseFloat(r[6]) || 0),
                    payment_status: (r[8] || '').includes('ì™„ë£Œ') ? 'paid' : 'unpaid',
                    item_name: r[9] || null,
                    memo: r[10] || null
                };
                console.log('ì—…ë¡œë“œ ë°ì´í„°:', data);
                const res = await supabaseCall('hq_tax_invoices', 'POST', data);
                if (res && res[0]) { taxInvoiceList.unshift(res[0]); count++; }
                else { errorCount++; console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', r); }
            }
            if (count > 0) showToast(count + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
            if (errorCount > 0) showToast(errorCount + 'ê±´ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)', 'error');
            renderTaxInvoiceTable();
        } catch (err) {
            console.error('ì—‘ì…€ íŒŒì‹± ì—ëŸ¬:', err);
            showToast('ì—‘ì…€ íŒŒì¼ ì˜¤ë¥˜: ' + err.message, 'error');
        }
    };
    reader.readAsBinaryString(input.files[0]);
    input.value = '';
}

// ==================== íšŒê³„ ê´€ë¦¬ ====================
function renderJournalTable() {
    document.getElementById('acc-count').textContent = journalList.length + 'ê±´';
    document.getElementById('acc-debit').textContent = 'â‚©' + journalList.reduce((s, j) => s + parseFloat(j.debit_amount || 0), 0).toLocaleString();
    document.getElementById('acc-credit').textContent = 'â‚©' + journalList.reduce((s, j) => s + parseFloat(j.credit_amount || 0), 0).toLocaleString();
    document.getElementById('acc-pending').textContent = journalList.filter(j => j.status === 'created').length + 'ê±´';
    
    const tbody = document.getElementById('journalTableBody');
    if (!journalList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const statuses = { created: 'ìƒì„±', confirmed: 'í™•ì •', cancelled: 'ì·¨ì†Œ' };
    const statusClass = { created: 'badge-pending', confirmed: 'badge-active', cancelled: 'badge-inactive' };
    tbody.innerHTML = journalList.map(j => '<tr><td>' + j.journal_date + '</td><td class="font-bold text-blue-400">' + (j.journal_no || '-') + '</td><td>' + (j.debit_account || '-') + '</td><td class="text-right text-blue-400">â‚©' + parseInt(j.debit_amount || 0).toLocaleString() + '</td><td>' + (j.credit_account || '-') + '</td><td class="text-right text-red-400">â‚©' + parseInt(j.credit_amount || 0).toLocaleString() + '</td><td class="text-xs">' + (j.description || '-') + '</td><td><span class="badge ' + (statusClass[j.status] || 'badge-pending') + '">' + (statuses[j.status] || j.status) + '</span></td><td><button onclick="editJournal(' + j.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteJournal(' + j.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>').join('');
}

function openJournalModal() {
    document.getElementById('journalModalTitle').textContent = 'ğŸ“Š ë¶„ê°œ ë“±ë¡';
    document.getElementById('journalForm').reset();
    document.getElementById('jnl-id').value = '';
    document.getElementById('jnl-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('jnl-number').value = 'JNL-' + Date.now();
    openModal('journalModal');
}

function editJournal(id) {
    const j = journalList.find(x => x.id === id); if (!j) return;
    document.getElementById('journalModalTitle').textContent = 'ğŸ“Š ë¶„ê°œ ìˆ˜ì •';
    document.getElementById('jnl-id').value = j.id;
    document.getElementById('jnl-date').value = j.journal_date || '';
    document.getElementById('jnl-number').value = j.journal_no || '';
    document.getElementById('jnl-debit-account').value = j.debit_account || '';
    document.getElementById('jnl-debit-amount').value = j.debit_amount || 0;
    document.getElementById('jnl-credit-account').value = j.credit_account || '';
    document.getElementById('jnl-credit-amount').value = j.credit_amount || 0;
    document.getElementById('jnl-desc').value = j.description || '';
    document.getElementById('jnl-status').value = j.status || 'created';
    document.getElementById('jnl-evidence').value = j.evidence_no || '';
    document.getElementById('jnl-memo').value = j.memo || '';
    openModal('journalModal');
}

async function submitJournal(e) {
    e.preventDefault();
    const id = document.getElementById('jnl-id').value;
    const data = {
        journal_date: document.getElementById('jnl-date').value,
        journal_no: document.getElementById('jnl-number').value,
        debit_account: document.getElementById('jnl-debit-account').value,
        debit_amount: parseFloat(document.getElementById('jnl-debit-amount').value) || 0,
        credit_account: document.getElementById('jnl-credit-account').value,
        credit_amount: parseFloat(document.getElementById('jnl-credit-amount').value) || 0,
        description: document.getElementById('jnl-desc').value,
        status: document.getElementById('jnl-status').value,
        evidence_no: document.getElementById('jnl-evidence').value || null,
        memo: document.getElementById('jnl-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('accounting_journals', 'PATCH', data, '?id=eq.' + id);
            const idx = journalList.findIndex(x => x.id == id);
            if (idx >= 0) journalList[idx] = { ...journalList[idx], ...data };
            showToast('ë¶„ê°œ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('accounting_journals', 'POST', data);
            if (r && r[0]) journalList.unshift(r[0]);
            showToast('ë¶„ê°œ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('journalModal');
        renderJournalTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ë¶„ê°œ ì‚­ì œ
async function deleteJournal(id) {
    if (!confirm('ì´ ë¶„ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('accounting_journals', 'DELETE', null, '?id=eq.' + id);
        journalList = journalList.filter(j => j.id !== id);
        showToast('ë¶„ê°œ ì‚­ì œ ì™„ë£Œ');
        renderJournalTable();
        renderJournalTable2();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

// ë¶„ê°œ ì—‘ì…€
function exportJournalExcel() {
    const headers = ['ì¼ì','ë¶„ê°œë²ˆí˜¸','ì°¨ë³€ê³„ì •','ì°¨ë³€ê¸ˆì•¡','ëŒ€ë³€ê³„ì •','ëŒ€ë³€ê¸ˆì•¡','ì ìš”','ìƒíƒœ','ë©”ëª¨'];
    const data = journalList.map(j => [j.journal_date, j.journal_no, j.debit_account, j.debit_amount, j.credit_account, j.credit_amount, j.description, j.status === 'confirmed' ? 'í™•ì •' : 'ìƒì„±', j.memo]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'ë¶„ê°œì¥');
    XLSX.writeFile(wb, 'ë¶„ê°œì¥.xlsx');
    showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

async function uploadJournalExcel(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (rows.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let count = 0;
        for (let i = 1; i < rows.length; i++) {
            const r = rows[i]; if (!r[0]) continue;
            const data = {
                journal_date: r[0],
                journal_no: r[1] || 'JNL-' + Date.now() + i,
                debit_account: r[2] || '',
                debit_amount: parseFloat(r[3]) || 0,
                credit_account: r[4] || '',
                credit_amount: parseFloat(r[5]) || 0,
                description: r[6] || '',
                status: r[7] === 'í™•ì •' ? 'confirmed' : 'created',
                memo: r[8] || null
            };
            const res = await supabaseCall('accounting_journals', 'POST', data);
            if (res && res[0]) { journalList.unshift(res[0]); count++; }
        }
        showToast(count + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderJournalTable();
    };
    reader.readAsBinaryString(input.files[0]);
    input.value = '';
}

// ==================== ê°ì‚¬ ë¡œê·¸ ====================
async function renderAuditLogs() {
    const logs = await supabaseCall('audit_logs', 'GET', null, '?order=changed_at.desc&limit=50');
    auditLogList = logs || [];
    const tbody = document.getElementById('auditLogTableBody');
    if (!auditLogList.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const actions = { INSERT: 'ë“±ë¡', UPDATE: 'ìˆ˜ì •', DELETE: 'ì‚­ì œ' };
    const actionClass = { INSERT: 'badge-active', UPDATE: 'badge-pending', DELETE: 'badge-error' };
    tbody.innerHTML = auditLogList.map(l => '<tr><td class="text-xs">' + (l.changed_at || '').substring(0, 19) + '</td><td>' + (l.table_name || '-') + '</td><td><span class="badge ' + (actionClass[l.action_type] || 'badge-info') + '">' + (actions[l.action_type] || l.action_type) + '</span></td><td>' + l.record_id + '</td><td>' + (l.changed_by || '-') + '</td><td><button onclick="viewAuditDetail(' + l.id + ')" class="btn-secondary btn-sm">ìƒì„¸</button></td></tr>').join('');
}

function viewAuditDetail(id) { showToast('ê°ì‚¬ ë¡œê·¸ ìƒì„¸ ë³´ê¸° ì¤€ë¹„ì¤‘', 'info'); }

// ==================== ì§€ê¸‰ ê´€ë¦¬ (ì§ì›/ê¸‰ì—¬) ====================
function renderEmployeeTable() {
    document.getElementById('emp-total').textContent = employeeList.length;
    document.getElementById('emp-regular').textContent = employeeList.filter(e => e.emp_type === 'regular').length;
    document.getElementById('emp-contract').textContent = employeeList.filter(e => e.emp_type === 'contract').length;
    document.getElementById('emp-insured').textContent = employeeList.filter(e => e.insurance_enabled).length;
    
    const tbody = document.getElementById('employeeTableBody');
    if (!employeeList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const types = { regular: 'ì •ê·œì§', contract: 'ê³„ì•½ì§' };
    const typeClass = { regular: 'badge-info', contract: 'badge-pending' };
    tbody.innerHTML = employeeList.map(e => '<tr><td class="font-bold text-blue-400">' + (e.emp_code || '-') + '</td><td>' + e.name + '</td><td><span class="badge ' + (typeClass[e.emp_type] || 'badge-info') + '">' + (types[e.emp_type] || e.emp_type) + '</span></td><td>' + (e.department || '-') + '</td><td class="text-right">â‚©' + parseInt(e.base_salary || 0).toLocaleString() + '</td><td>' + (e.insurance_enabled ? '<span class="text-green-400">âœ“</span>' : '<span class="text-gray-500">-</span>') + '</td><td><span class="badge ' + (e.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (e.status === 'active' ? 'ì¬ì§' : 'í‡´ì‚¬') + '</span></td><td><button onclick="editEmployee(' + e.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function renderPayrollTable() {
    const thisMonth = new Date().getMonth() + 1;
    const thisYear = new Date().getFullYear();
    const thisMonthPayrolls = payrollList.filter(p => p.pay_year == thisYear && p.pay_month == thisMonth);
    
    document.getElementById('pay-count').textContent = thisMonthPayrolls.length + 'ê±´';
    document.getElementById('pay-gross').textContent = 'â‚©' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.gross_pay || 0), 0).toLocaleString();
    document.getElementById('pay-deduct').textContent = 'â‚©' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.total_deduction || 0), 0).toLocaleString();
    document.getElementById('pay-net').textContent = 'â‚©' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.net_pay || 0), 0).toLocaleString();
    
    const tbody = document.getElementById('payrollTableBody');
    if (!payrollList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = payrollList.map(p => {
        const emp = employeeList.find(e => e.id == p.employee_id);
        const allowance = parseFloat(p.overtime_pay || 0) + parseFloat(p.bonus || 0) + parseFloat(p.meal_allowance || 0) + parseFloat(p.transport_allowance || 0) + parseFloat(p.other_allowance || 0);
        return '<tr><td class="font-bold">' + p.pay_year + 'ë…„ ' + p.pay_month + 'ì›”</td><td>' + (emp ? emp.name : '-') + '</td><td class="text-right">â‚©' + parseInt(p.base_salary || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(allowance).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(p.gross_pay || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(p.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-green-400">â‚©' + parseInt(p.net_pay || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (p.status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editPayroll(' + p.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

function openEmployeeModal() {
    document.getElementById('employeeModalTitle').textContent = 'ğŸ‘¤ ì§ì› ë“±ë¡';
    document.getElementById('employeeForm').reset();
    document.getElementById('emp-id').value = '';
    document.getElementById('emp-no').value = 'EMP-' + Date.now().toString().slice(-6);
    openModal('employeeModal');
}

function editEmployee(id) {
    const e = employeeList.find(x => x.id === id);
    if (!e) return;
    document.getElementById('employeeModalTitle').textContent = 'ğŸ‘¤ ì§ì› ìˆ˜ì •';
    document.getElementById('emp-id').value = e.id;
    document.getElementById('emp-no').value = e.employee_no || '';
    document.getElementById('emp-name').value = e.name || '';
    document.getElementById('emp-type').value = e.employee_type || 'regular';
    document.getElementById('emp-dept').value = e.department || '';
    document.getElementById('emp-position').value = e.position || '';
    document.getElementById('emp-joindate').value = e.join_date || '';
    document.getElementById('emp-phone').value = e.phone || '';
    document.getElementById('emp-email').value = e.email || '';
    document.getElementById('emp-salary').value = e.base_salary || 0;
    document.getElementById('emp-status').value = e.status || 'active';
    document.getElementById('emp-insurance').checked = e.has_insurance || false;
    document.getElementById('emp-memo').value = e.memo || '';
    openModal('employeeModal');
}

async function submitEmployee(e) {
    e.preventDefault();
    const id = document.getElementById('emp-id').value;
    const data = {
        employee_no: document.getElementById('emp-no').value,
        name: document.getElementById('emp-name').value,
        employee_type: document.getElementById('emp-type').value,
        department: document.getElementById('emp-dept').value || null,
        position: document.getElementById('emp-position').value || null,
        join_date: document.getElementById('emp-joindate').value || null,
        phone: document.getElementById('emp-phone').value || null,
        email: document.getElementById('emp-email').value || null,
        base_salary: parseFloat(document.getElementById('emp-salary').value) || 0,
        status: document.getElementById('emp-status').value,
        has_insurance: document.getElementById('emp-insurance').checked,
        memo: document.getElementById('emp-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('employees', 'PATCH', data, '?id=eq.' + id);
            const idx = employeeList.findIndex(x => x.id == id);
            if (idx >= 0) employeeList[idx] = { ...employeeList[idx], ...data };
            showToast('ì§ì› ì •ë³´ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('employees', 'POST', data);
            if (r && r[0]) employeeList.unshift(r[0]);
            showToast('ì§ì› ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('employeeModal');
        renderEmployeeTable2();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

async function deleteEmployee(id) {
    if (!confirm('ì´ ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('employees', 'DELETE', null, '?id=eq.' + id);
        employeeList = employeeList.filter(e => e.id !== id);
        showToast('ì§ì› ì‚­ì œ ì™„ë£Œ');
        renderEmployeeTable2();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}
function openPayrollModal() { showToast('ê¸‰ì—¬ ë“±ë¡ ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }
function editPayroll(id) { showToast('ê¸‰ì—¬ ìˆ˜ì • ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }

async function deletePayroll(id) {
    if (!confirm('ì´ ê¸‰ì—¬ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('payrolls', 'DELETE', null, '?id=eq.' + id);
        payrollList = payrollList.filter(p => p.id !== id);
        showToast('ê¸‰ì—¬ ë‚´ì—­ ì‚­ì œ ì™„ë£Œ');
        renderPayrollTable2();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

// ê·¼ë¡œê³„ì•½ì„œ ì—…ë¡œë“œ
let selectedContractFile = null;

function loadContractEmpOptions() {
    const sel = document.getElementById('contractEmpSelect');
    sel.innerHTML = '<option value="">ì§ì› ì„ íƒ</option>' + employeeList.map(e => '<option value="' + e.id + '">' + e.name + ' (' + (e.emp_code || '-') + ')</option>').join('');
}

function handleContractUpload(input) {
    if (input.files && input.files[0]) {
        selectedContractFile = input.files[0];
        document.getElementById('contractFileName').textContent = selectedContractFile.name;
    }
}

async function uploadContract() {
    const empId = document.getElementById('contractEmpSelect').value;
    if (!empId) { showToast('ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
    if (!selectedContractFile) { showToast('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
    
    // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•´ì„œ ì €ì¥ (ê°„ë‹¨í•œ ë°©ë²•)
    const reader = new FileReader();
    reader.onload = async (e) => {
        const emp = employeeList.find(x => x.id == empId);
        const contract = {
            employee_id: parseInt(empId),
            employee_name: emp ? emp.name : '',
            file_name: selectedContractFile.name,
            file_size: selectedContractFile.size,
            file_type: selectedContractFile.type,
            file_data: e.target.result,
            uploaded_at: new Date().toISOString()
        };
        
        // localStorageì— ì €ì¥ (ì„ì‹œ)
        let contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
        contracts.push(contract);
        localStorage.setItem('employee_contracts', JSON.stringify(contracts));
        
        showToast('ì—…ë¡œë“œ ì™„ë£Œ');
        selectedContractFile = null;
        document.getElementById('contractFileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
        document.getElementById('contractFileInput').value = '';
        renderContractTable();
    };
    reader.readAsDataURL(selectedContractFile);
}

function renderContractTable() {
    const contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    const tbody = document.getElementById('contractTableBody');
    if (!contracts.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = contracts.map((c, idx) => '<tr><td>' + (c.employee_name || '-') + '</td><td class="text-blue-400">' + c.file_name + '</td><td>' + (c.uploaded_at || '').substring(0, 10) + '</td><td><button onclick="downloadContract(' + idx + ')" class="btn-secondary btn-sm mr-1">ë‹¤ìš´</button><button onclick="deleteContract(' + idx + ')" class="btn-sm" style="background:rgba(239,68,68,0.2);color:#EF4444;border:1px solid rgba(239,68,68,0.3);border-radius:8px">ì‚­ì œ</button></td></tr>').join('');
}

function downloadContract(idx) {
    const contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    const c = contracts[idx];
    if (!c) return;
    const link = document.createElement('a');
    link.href = c.file_data;
    link.download = c.file_name;
    link.click();
}

function deleteContract(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    let contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    contracts.splice(idx, 1);
    localStorage.setItem('employee_contracts', JSON.stringify(contracts));
    showToast('ì‚­ì œ ì™„ë£Œ');
    renderContractTable();
}

// ==================== ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ====================
function loadSettlementDashboard() {
    const platTotal = platformList.reduce((s, p) => s + parseFloat(p.total_amount || 0), 0);
    const advTotal = advanceTransferList.reduce((s, a) => s + parseFloat(a.total_amount || 0), 0);
    document.getElementById('sett-dash-platform').textContent = 'â‚©' + platTotal.toLocaleString();
    document.getElementById('sett-dash-advance').textContent = 'â‚©' + advTotal.toLocaleString();
    document.getElementById('sett-dash-profit').textContent = 'â‚©' + (platTotal - advTotal).toLocaleString();
    document.getElementById('sett-dash-pending').textContent = reconcileList.filter(r => r.status === 'pending').length + 'ê±´';
    
    const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
    const statuses = { pending: 'ëŒ€ê¸°', received: 'ì…ê¸ˆì™„ë£Œ', transferred: 'ì§€ê¸‰ì™„ë£Œ' };
    document.getElementById('settDashPlatformTable').innerHTML = platformList.slice(0, 5).map(p => '<tr><td>' + p.settlement_week + '</td><td>' + (platforms[p.platform] || p.platform) + '</td><td>â‚©' + parseInt(p.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'received' ? 'badge-active' : 'badge-pending') + '">' + (statuses[p.status] || p.status) + '</span></td></tr>').join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
    document.getElementById('settDashAdvanceTable').innerHTML = advanceTransferList.slice(0, 5).map(a => { const pt = partnerList.find(x => x.id == a.partner_id); return '<tr><td>' + a.transfer_date + '</td><td>' + (pt ? pt.name : '-') + '</td><td>â‚©' + parseInt(a.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (a.status === 'transferred' ? 'badge-active' : 'badge-pending') + '">' + (statuses[a.status] || a.status) + '</span></td></tr>'; }).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
}

function renderPlatformTable() {
    document.getElementById('plat-total').textContent = platformList.length + 'ê±´';
    document.getElementById('plat-count-stat').textContent = platformList.reduce((s, p) => s + parseInt(p.delivery_count || 0), 0).toLocaleString() + 'ê±´';
    document.getElementById('plat-supply-stat').textContent = 'â‚©' + platformList.reduce((s, p) => s + parseFloat(p.supply_amount || 0), 0).toLocaleString();
    document.getElementById('plat-amount').textContent = 'â‚©' + platformList.reduce((s, p) => s + parseFloat(p.total_amount || 0), 0).toLocaleString();
    
    const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
    const tbody = document.getElementById('platformTableBody');
    if (!platformList.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = platformList.map(p => '<tr><td class="font-bold text-blue-400">' + p.settlement_week + '</td><td>' + (platforms[p.platform] || p.platform) + '</td><td class="text-xs">' + (p.work_start_date || '') + '<br>~' + (p.work_end_date || '') + '</td><td class="text-right">' + parseInt(p.delivery_count || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(p.supply_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(p.vat_amount || 0).toLocaleString() + '</td><td class="text-right font-bold">â‚©' + parseInt(p.total_amount || 0).toLocaleString() + '</td><td>' + (p.expected_date || '-') + '</td><td><button onclick="editPlatform(' + p.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deletePlatform(' + p.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>').join('');
}

function renderSettAdvanceTable() {
    document.getElementById('settadv-total').textContent = advanceTransferList.length + 'ê±´';
    document.getElementById('settadv-pending').textContent = advanceTransferList.filter(a => a.status === 'pending').length + 'ê±´';
    document.getElementById('settadv-transferred').textContent = advanceTransferList.filter(a => a.status === 'transferred').length + 'ê±´';
    document.getElementById('settadv-amount').textContent = 'â‚©' + advanceTransferList.reduce((s, a) => s + parseFloat(a.net_amount || 0), 0).toLocaleString();
    document.getElementById('settadv-fee-income').textContent = 'â‚©' + advanceTransferList.reduce((s, a) => s + parseFloat(a.fee_amount || 0), 0).toLocaleString();
    
    // í•„í„° ì ìš©
    const monthFilter = document.getElementById('settAdvMonthFilter')?.value || '';
    const partnerFilter = document.getElementById('settAdvPartnerFilter')?.value || '';
    const statusFilter = document.getElementById('settAdvStatusFilter')?.value || '';
    
    let filtered = advanceTransferList.filter(a => {
        if (monthFilter && !a.transfer_date?.startsWith(monthFilter)) return false;
        if (partnerFilter && a.partner_id != partnerFilter) return false;
        if (statusFilter && a.status !== statusFilter) return false;
        return true;
    });
    
    // í˜‘ë ¥ì‚¬ í•„í„° ì˜µì…˜ ë¡œë“œ
    const partnerFilterEl = document.getElementById('settAdvPartnerFilter');
    if (partnerFilterEl && partnerFilterEl.options.length <= 1) {
        partnerList.forEach(p => { partnerFilterEl.add(new Option(p.name, p.id)); });
    }
    
    const tbody = document.getElementById('settAdvanceTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = filtered.map(a => { const pt = partnerList.find(x => x.id == a.partner_id); return '<tr><td>' + a.transfer_date + '</td><td class="font-bold">' + (pt ? pt.name : '-') + '</td><td>' + (a.settlement_week || '-') + '</td><td class="text-right">â‚©' + parseInt(a.supply_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(a.vat_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(a.total_amount || 0).toLocaleString() + '</td><td class="text-right text-yellow-400">â‚©' + parseInt(a.fee_amount || 0).toLocaleString() + '</td><td class="text-right font-bold text-red-400">â‚©' + parseInt(a.net_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (a.status === 'transferred' ? 'badge-active' : 'badge-pending') + '">' + (a.status === 'transferred' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editSettAdvance(' + a.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteSettAdvance(' + a.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>'; }).join('');
}

// í”Œë«í¼ ì •ì‚° â†’ ì„ ì •ì‚° ì§€ê¸‰ ì—°ë™
async function syncFromPlatformSettlement() {
    // í”Œë«í¼ ì •ì‚° ì¤‘ ì•„ì§ ì„ ì •ì‚° ì•ˆ ëœ ê²ƒ ì°¾ê¸°
    const unsynced = platformSettList.filter(p => !p.synced_to_advance && p.status === 'received');
    
    if (!unsynced.length) {
        showToast('ì—°ë™í•  í”Œë«í¼ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
    }
    
    if (!confirm(unsynced.length + 'ê±´ì˜ í”Œë«í¼ ì •ì‚°ì„ ì„ ì •ì‚° ì§€ê¸‰ìœ¼ë¡œ ì—°ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    let cnt = 0;
    for (const p of unsynced) {
        // í”Œë«í¼ë³„ í˜‘ë ¥ì‚¬ ë§¤í•‘ (í•„ìš”ì‹œ)
        const partner = partnerList.find(pt => pt.name?.includes(p.platform) || pt.id == p.partner_id);
        
        const supplyAmount = Math.round(parseFloat(p.total_amount || 0) / 1.1);
        const vatAmount = parseFloat(p.total_amount || 0) - supplyAmount;
        const feeRate = 0.02; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ 2%
        const feeAmount = Math.round(parseFloat(p.total_amount || 0) * feeRate);
        const netAmount = parseFloat(p.total_amount || 0) - feeAmount;
        
        const data = {
            partner_id: partner?.id || null,
            transfer_date: new Date().toISOString().slice(0, 10),
            settlement_week: p.settlement_week,
            supply_amount: supplyAmount,
            vat_amount: vatAmount,
            total_amount: parseFloat(p.total_amount || 0),
            fee_rate: feeRate,
            fee_amount: feeAmount,
            net_amount: netAmount,
            status: 'pending',
            platform_settlement_id: p.id,
            memo: p.platform + ' ' + p.settlement_week + ' ì—°ë™'
        };
        
        const r = await supabaseCall('advance_transfers', 'POST', data);
        if (r && r[0]) { advanceTransferList.unshift(r[0]); cnt++; }
        
        // í”Œë«í¼ ì •ì‚°ì— ì—°ë™ í‘œì‹œ
        await supabaseCall('platform_settlements', 'PATCH', { synced_to_advance: true }, '?id=eq.' + p.id);
        p.synced_to_advance = true;
    }
    
    showToast(cnt + 'ê±´ ì„ ì •ì‚° ì§€ê¸‰ ì—°ë™ ì™„ë£Œ');
    renderSettAdvanceTable();
    renderPlatformTable();
}

function renderReconcileTable() {
    document.getElementById('rec-total').textContent = reconcileList.length + 'ê±´';
    document.getElementById('rec-pending').textContent = reconcileList.filter(r => r.status === 'pending').length + 'ê±´';
    document.getElementById('rec-matched').textContent = reconcileList.filter(r => r.status === 'matched').length + 'ê±´';
    document.getElementById('rec-issue').textContent = reconcileList.filter(r => r.status === 'issue').length + 'ê±´';
    
    const tbody = document.getElementById('reconcileTableBody');
    if (!reconcileList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const statuses = { pending: 'ëŒ€ê¸°', matched: 'ì™„ë£Œ', issue: 'ë¶ˆì¼ì¹˜' };
    const statusClass = { pending: 'badge-pending', matched: 'badge-active', issue: 'badge-error' };
    tbody.innerHTML = reconcileList.map(r => { const pt = partnerList.find(x => x.id == r.partner_id); return '<tr><td class="font-bold text-blue-400">' + r.settlement_week + '</td><td>' + (pt ? pt.name : '-') + '</td><td class="text-right text-blue-400">â‚©' + parseInt(r.platform_total || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(r.advance_total || 0).toLocaleString() + '</td><td class="text-right font-bold">â‚©' + parseInt(r.difference_amount || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(r.fee_income || 0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[r.status] || 'badge-pending') + '">' + (statuses[r.status] || r.status) + '</span></td><td><button onclick="editReconcile(' + r.id + ')" class="btn-secondary btn-sm mr-1">ìƒì„¸</button><button onclick="deleteReconcile(' + r.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>'; }).join('');
}

function renderCashbookTable() {
    // í•„í„° ì ìš©
    const monthFilter = document.getElementById('cashbookMonth')?.value || '';
    const typeFilter = document.getElementById('cashbookType')?.value || '';
    const linkFilter = document.getElementById('cashbookLink')?.value || '';
    const searchFilter = (document.getElementById('cashbookSearch')?.value || '').toLowerCase();
    
    let filtered = bankList.filter(b => {
        if (monthFilter && !b.transaction_date?.startsWith(monthFilter)) return false;
        if (typeFilter && b.transaction_type !== typeFilter) return false;
        if (linkFilter === 'linked' && !b.link_type) return false;
        if (linkFilter === 'unlinked' && b.link_type) return false;
        if (searchFilter && !(b.counterparty || '').toLowerCase().includes(searchFilter) && !(b.description || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    // í†µê³„
    const deposits = bankList.filter(b => b.transaction_type === 'deposit').reduce((s, b) => s + parseFloat(b.amount || 0), 0);
    const withdrawals = bankList.filter(b => b.transaction_type === 'withdrawal').reduce((s, b) => s + parseFloat(b.amount || 0), 0);
    const unlinked = bankList.filter(b => !b.link_type).length;
    
    document.getElementById('bank-deposit').textContent = 'â‚©' + deposits.toLocaleString();
    document.getElementById('bank-withdrawal').textContent = 'â‚©' + withdrawals.toLocaleString();
    document.getElementById('bank-balance').textContent = 'â‚©' + (deposits - withdrawals).toLocaleString();
    document.getElementById('bank-count').textContent = bankList.length + 'ê±´';
    document.getElementById('bank-unlinked').textContent = unlinked + 'ê±´';
    
    // ì”ì•¡ ê³„ì‚° (ë‚ ì§œìˆœ ì •ë ¬ í›„)
    const sorted = [...filtered].sort((a, b) => (a.transaction_date || '').localeCompare(b.transaction_date || ''));
    let runningBalance = 0;
    sorted.forEach(b => {
        if (b.transaction_type === 'deposit') runningBalance += parseFloat(b.amount || 0);
        else runningBalance -= parseFloat(b.amount || 0);
        b._balance = runningBalance;
    });
    
    const tbody = document.getElementById('bankTableBody');
    if (!sorted.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = sorted.map(b => {
        const linkBadge = b.link_type ? '<span class="badge badge-active text-xs">' + getLinkLabel(b.link_type) + '</span>' : '<span class="badge badge-pending text-xs">ë¯¸ì—°ê²°</span>';
        const isDeposit = b.transaction_type === 'deposit';
        return '<tr>' +
            '<td>' + b.transaction_date + '</td>' +
            '<td><span class="badge ' + (isDeposit ? 'badge-info' : 'badge-error') + '">' + (isDeposit ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ') + '</span></td>' +
            '<td class="font-bold">' + (b.counterparty || '-') + '</td>' +
            '<td class="text-right text-blue-400">' + (isDeposit ? 'â‚©' + parseInt(b.amount || 0).toLocaleString() : '') + '</td>' +
            '<td class="text-right text-red-400">' + (!isDeposit ? 'â‚©' + parseInt(b.amount || 0).toLocaleString() : '') + '</td>' +
            '<td class="text-right font-bold">â‚©' + parseInt(b._balance || 0).toLocaleString() + '</td>' +
            '<td class="text-xs">' + (b.description || '-') + '</td>' +
            '<td>' + linkBadge + '</td>' +
            '<td><button onclick="editCashbook(' + b.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteCashbook(' + b.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td>' +
            '</tr>';
    }).join('');
}

function renderBankTable() { renderCashbookTable(); }

function getLinkLabel(type) {
    const labels = { platform: 'í”Œë«í¼', advance: 'ì„ ì •ì‚°', weekly: 'ì£¼ì •ì‚°', taxinvoice: 'ì„¸ê¸ˆê³„ì‚°ì„œ' };
    return labels[type] || type;
}

function loadSettAdvancePartnerOptions() {
    const opts = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    const el = document.getElementById('settadv-partner');
    if (el) el.innerHTML = opts;
}

// ëª¨ë‹¬ ì—´ê¸°
function openPlatformModal() { document.getElementById('platformForm').reset(); document.getElementById('plat-id').value = ''; openModal('platformModal'); }
function openSettAdvanceModal() { document.getElementById('settAdvanceForm').reset(); document.getElementById('settadv-id').value = ''; loadSettAdvancePartnerOptions(); openModal('settAdvanceModal'); }
function openCashbookModal() { 
    document.getElementById('bankForm').reset(); 
    document.getElementById('bank-id').value = ''; 
    document.getElementById('bank-link-id').innerHTML = '<option value="">ì„ íƒ</option>';
    openModal('bankModal'); 
}
function openBankModal() { openCashbookModal(); }
function openReconcileModal() { showToast('ëŒ€ì‚¬ ë“±ë¡ ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }

// ì—°ê²° ì˜µì…˜ ë¡œë“œ
function loadLinkOptions() {
    const linkType = document.getElementById('bank-link-type').value;
    const linkIdSelect = document.getElementById('bank-link-id');
    linkIdSelect.innerHTML = '<option value="">ì„ íƒ</option>';
    
    if (linkType === 'platform') {
        const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
        platformList.forEach(p => {
            const label = (platforms[p.platform] || p.platform) + ' ' + p.settlement_week + ' (â‚©' + parseInt(p.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + p.id + '">' + label + '</option>';
        });
    } else if (linkType === 'advance') {
        advanceTransferList.forEach(a => {
            const partner = partnerList.find(p => p.id == a.partner_id);
            const label = (partner?.name || 'í˜‘ë ¥ì‚¬') + ' ' + (a.settlement_week || '') + ' (â‚©' + parseInt(a.net_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + a.id + '">' + label + '</option>';
        });
    } else if (linkType === 'weekly') {
        weeklyPayoutList.forEach(w => {
            const rider = riderList.find(r => r.id == w.rider_id);
            const label = (rider?.name || 'ë¼ì´ë”') + ' ' + (w.settlement_week || '') + ' (â‚©' + parseInt(w.net_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + w.id + '">' + label + '</option>';
        });
    }
}

// ë¶€ê°€ì„¸ ìë™ê³„ì‚°
function calcPlatformVat() {
    const supply = parseFloat(document.getElementById('plat-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('plat-vat').value = vat;
    document.getElementById('plat-total-amt').value = supply + vat;
}

function calcSettAdvanceTotal() {
    const supply = parseFloat(document.getElementById('settadv-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    const feeRate = parseFloat(document.getElementById('settadv-fee-rate').value) || 0;
    const total = supply + vat;
    const fee = Math.round(total * feeRate / 100);
    document.getElementById('settadv-vat').value = vat;
    document.getElementById('settadv-total-amt').value = total;
    document.getElementById('settadv-fee').value = fee;
    document.getElementById('settadv-net').value = total - fee;
}

// ì €ì¥
async function submitPlatform(e) {
    e.preventDefault();
    const id = document.getElementById('plat-id').value;
    const data = {
        platform: document.getElementById('plat-platform').value,
        settlement_week: document.getElementById('plat-week').value,
        work_start_date: document.getElementById('plat-start').value || null,
        work_end_date: document.getElementById('plat-end').value || null,
        expected_date: document.getElementById('plat-expected').value || null,
        delivery_count: parseInt(document.getElementById('plat-count').value) || 0,
        supply_amount: parseFloat(document.getElementById('plat-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('plat-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('plat-total-amt').value) || 0,
        memo: document.getElementById('plat-memo').value || null
    };
    try {
        if (id) { await supabaseCall('platform_settlements', 'PATCH', data, '?id=eq.' + id); showToast('ìˆ˜ì • ì™„ë£Œ'); }
        else { const r = await supabaseCall('platform_settlements', 'POST', data); if (r && r[0]) platformList.unshift(r[0]); showToast('ë“±ë¡ ì™„ë£Œ'); }
        closeModal('platformModal');
        renderPlatformTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// í”Œë«í¼ì •ì‚° ì‚­ì œ
async function deletePlatform(id) {
    if (!confirm('ì´ í”Œë«í¼ì •ì‚° í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('platform_settlements', 'DELETE', null, '?id=eq.' + id);
        platformList = platformList.filter(p => p.id !== id);
        showToast('ì‚­ì œ ì™„ë£Œ');
        renderPlatformTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

async function submitSettAdvance(e) {
    e.preventDefault();
    const id = document.getElementById('settadv-id').value;
    const data = {
        partner_id: document.getElementById('settadv-partner').value || null,
        transfer_date: document.getElementById('settadv-date').value,
        settlement_week: document.getElementById('settadv-week').value || null,
        supply_amount: parseFloat(document.getElementById('settadv-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('settadv-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('settadv-total-amt').value) || 0,
        fee_rate: parseFloat(document.getElementById('settadv-fee-rate').value) / 100 || 0,
        fee_amount: parseFloat(document.getElementById('settadv-fee').value) || 0,
        net_amount: parseFloat(document.getElementById('settadv-net').value) || 0,
        status: document.getElementById('settadv-status').value,
        memo: document.getElementById('settadv-memo').value || null
    };
    try {
        if (id) { await supabaseCall('advance_transfers', 'PATCH', data, '?id=eq.' + id); showToast('ìˆ˜ì • ì™„ë£Œ'); }
        else { const r = await supabaseCall('advance_transfers', 'POST', data); if (r && r[0]) advanceTransferList.unshift(r[0]); showToast('ë“±ë¡ ì™„ë£Œ'); }
        closeModal('settAdvanceModal');
        renderSettAdvanceTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì„ ì •ì‚°ì§€ê¸‰ ì‚­ì œ
async function deleteSettAdvance(id) {
    if (!confirm('ì´ ì„ ì •ì‚° ì§€ê¸‰ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('advance_transfers', 'DELETE', null, '?id=eq.' + id);
        advanceTransferList = advanceTransferList.filter(a => a.id !== id);
        showToast('ì‚­ì œ ì™„ë£Œ');
        renderSettAdvanceTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

async function submitCashbook(e) {
    e.preventDefault();
    const id = document.getElementById('bank-id').value;
    const data = {
        transaction_date: document.getElementById('bank-date').value,
        transaction_type: document.getElementById('bank-type').value,
        counterparty: document.getElementById('bank-counterparty').value || null,
        amount: parseFloat(document.getElementById('bank-amount').value) || 0,
        description: document.getElementById('bank-desc').value || null,
        link_type: document.getElementById('bank-link-type').value || null,
        link_id: document.getElementById('bank-link-id').value || null,
        bank_memo: document.getElementById('bank-memo2').value || null
    };
    try {
        if (id) { 
            await supabaseCall('bank_transactions', 'PATCH', data, '?id=eq.' + id); 
            const idx = bankList.findIndex(b => b.id == id);
            if (idx >= 0) bankList[idx] = { ...bankList[idx], ...data };
            showToast('ìˆ˜ì • ì™„ë£Œ'); 
        } else { 
            const r = await supabaseCall('bank_transactions', 'POST', data); 
            if (r && r[0]) bankList.unshift(r[0]); 
            showToast('ë“±ë¡ ì™„ë£Œ'); 
        }
        closeModal('bankModal');
        renderCashbookTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

async function submitBank(e) { return submitCashbook(e); }

// í˜„ê¸ˆì¶œë‚©ì¥ ì‚­ì œ
async function deleteCashbook(id) {
    if (!confirm('ì´ í˜„ê¸ˆì¶œë‚© í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('bank_transactions', 'DELETE', null, '?id=eq.' + id);
        bankList = bankList.filter(b => b.id !== id);
        showToast('ì‚­ì œ ì™„ë£Œ');
        renderCashbookTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

function editCashbook(id) {
    const b = bankList.find(x => x.id === id); if (!b) return;
    document.getElementById('bank-id').value = b.id;
    document.getElementById('bank-date').value = b.transaction_date || '';
    document.getElementById('bank-type').value = b.transaction_type || 'deposit';
    document.getElementById('bank-counterparty').value = b.counterparty || '';
    document.getElementById('bank-amount').value = b.amount || 0;
    document.getElementById('bank-desc').value = b.description || '';
    document.getElementById('bank-link-type').value = b.link_type || '';
    loadLinkOptions();
    document.getElementById('bank-link-id').value = b.link_id || '';
    document.getElementById('bank-memo2').value = b.bank_memo || '';
    openModal('bankModal');
}

function editBank(id) { editCashbook(id); }

// ìˆ˜ì •
function editPlatform(id) {
    const p = platformList.find(x => x.id === id); if (!p) return;
    document.getElementById('plat-id').value = p.id;
    document.getElementById('plat-platform').value = p.platform || '';
    document.getElementById('plat-week').value = p.settlement_week || '';
    document.getElementById('plat-start').value = p.work_start_date || '';
    document.getElementById('plat-end').value = p.work_end_date || '';
    document.getElementById('plat-expected').value = p.expected_date || '';
    document.getElementById('plat-count').value = p.delivery_count || 0;
    document.getElementById('plat-supply').value = p.supply_amount || 0;
    document.getElementById('plat-vat').value = p.vat_amount || 0;
    document.getElementById('plat-total-amt').value = p.total_amount || 0;
    document.getElementById('plat-memo').value = p.memo || '';
    openModal('platformModal');
}

function editSettAdvance(id) {
    const a = advanceTransferList.find(x => x.id === id); if (!a) return;
    loadSettAdvancePartnerOptions();
    document.getElementById('settadv-id').value = a.id;
    document.getElementById('settadv-partner').value = a.partner_id || '';
    document.getElementById('settadv-date').value = a.transfer_date || '';
    document.getElementById('settadv-week').value = a.settlement_week || '';
    document.getElementById('settadv-supply').value = a.supply_amount || 0;
    document.getElementById('settadv-vat').value = a.vat_amount || 0;
    document.getElementById('settadv-total-amt').value = a.total_amount || 0;
    document.getElementById('settadv-fee-rate').value = (a.fee_rate || 0) * 100;
    document.getElementById('settadv-fee').value = a.fee_amount || 0;
    document.getElementById('settadv-net').value = a.net_amount || 0;
    document.getElementById('settadv-status').value = a.status || 'pending';
    document.getElementById('settadv-memo').value = a.memo || '';
    openModal('settAdvanceModal');
}

function editBank(id) {
    const b = bankList.find(x => x.id === id); if (!b) return;
    document.getElementById('bank-id').value = b.id;
    document.getElementById('bank-date').value = b.transaction_date || '';
    document.getElementById('bank-type').value = b.transaction_type || 'deposit';
    document.getElementById('bank-amount').value = b.amount || 0;
    document.getElementById('bank-desc').value = b.description || '';
    document.getElementById('bank-memo2').value = b.bank_memo || '';
    openModal('bankModal');
}

function editReconcile(id) { 
    const r = reconcileList.find(x => x.id === id); 
    if (!r) return;
    
    document.getElementById('reconcileModalTitle').textContent = 'ğŸ”„ ëŒ€ì‚¬ ìƒì„¸/ìˆ˜ì •';
    document.getElementById('rec-id').value = r.id;
    document.getElementById('rec-week').value = r.settlement_week || '';
    loadReconcilePartnerOptions();
    document.getElementById('rec-partner').value = r.partner_id || '';
    document.getElementById('rec-platform').value = r.platform_total || 0;
    document.getElementById('rec-advance').value = r.advance_total || 0;
    document.getElementById('rec-diff').value = r.difference_amount || 0;
    document.getElementById('rec-fee').value = r.fee_income || 0;
    document.getElementById('rec-status').value = r.status || 'pending';
    document.getElementById('rec-memo').value = r.memo || '';
    openModal('reconcileModal');
}

// ëŒ€ì‚¬ê´€ë¦¬ ì‚­ì œ
async function deleteReconcile(id) {
    if (!confirm('ì´ ëŒ€ì‚¬ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('settlement_reconciliation', 'DELETE', null, '?id=eq.' + id);
        reconcileList = reconcileList.filter(r => r.id !== id);
        showToast('ì‚­ì œ ì™„ë£Œ');
        renderReconcileTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

// ìˆ˜ë™ ëŒ€ì‚¬ ëª¨ë‹¬ ì—´ê¸°
function openReconcileModal() {
    document.getElementById('reconcileModalTitle').textContent = 'ğŸ”„ ìˆ˜ë™ ëŒ€ì‚¬ ë“±ë¡';
    document.getElementById('reconcileForm').reset();
    document.getElementById('rec-id').value = '';
    loadReconcilePartnerOptions();
    openModal('reconcileModal');
}

// í˜‘ë ¥ì‚¬ ì˜µì…˜ ë¡œë“œ
function loadReconcilePartnerOptions() {
    const sel = document.getElementById('rec-partner');
    sel.innerHTML = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

// ëŒ€ì‚¬ ê³„ì‚°
function calcReconcile() {
    const platform = parseFloat(document.getElementById('rec-platform').value) || 0;
    const advance = parseFloat(document.getElementById('rec-advance').value) || 0;
    const diff = platform - advance;
    document.getElementById('rec-diff').value = diff;
    // ìˆ˜ìˆ˜ë£Œ = ì°¨ì•¡ (í”Œë«í¼ - ì„ ì •ì‚° = íŒ€ë¸Œë¡œ ìˆ˜ìµ)
    document.getElementById('rec-fee').value = diff > 0 ? diff : 0;
}

// ìˆ˜ë™ ëŒ€ì‚¬ ì €ì¥
async function submitReconcile(e) {
    e.preventDefault();
    const id = document.getElementById('rec-id').value;
    const data = {
        settlement_week: document.getElementById('rec-week').value,
        partner_id: document.getElementById('rec-partner').value || null,
        platform_total: parseFloat(document.getElementById('rec-platform').value) || 0,
        advance_total: parseFloat(document.getElementById('rec-advance').value) || 0,
        difference_amount: parseFloat(document.getElementById('rec-diff').value) || 0,
        fee_income: parseFloat(document.getElementById('rec-fee').value) || 0,
        status: document.getElementById('rec-status').value,
        memo: document.getElementById('rec-memo').value || null
    };
    
    try {
        if (id) {
            await supabaseCall('settlement_reconciliation', 'PATCH', data, '?id=eq.' + id);
            const idx = reconcileList.findIndex(x => x.id == id);
            if (idx >= 0) reconcileList[idx] = { ...reconcileList[idx], ...data };
            showToast('ëŒ€ì‚¬ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('settlement_reconciliation', 'POST', data);
            if (r && r[0]) reconcileList.unshift(r[0]);
            showToast('ëŒ€ì‚¬ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('reconcileModal');
        renderReconcileTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ìë™ ëŒ€ì‚¬ ì„ì‹œ ì €ì¥ìš©
let autoReconcileData = [];

// ìë™ ëŒ€ì‚¬ ì‹¤í–‰
async function autoReconcile() {
    showToast('ìë™ ëŒ€ì‚¬ ë¶„ì„ ì¤‘...', 'info');
    
    // í”Œë«í¼ì •ì‚° ë°ì´í„°ë¥¼ ì£¼ì°¨+í˜‘ë ¥ì‚¬ë³„ë¡œ ê·¸ë£¹í•‘
    const platformByWeek = {};
    platformList.forEach(p => {
        const key = (p.settlement_week || 'unknown') + '_' + (p.partner_id || 'all');
        if (!platformByWeek[key]) platformByWeek[key] = { week: p.settlement_week, partner_id: p.partner_id, total: 0, items: [] };
        platformByWeek[key].total += parseFloat(p.total_amount || 0);
        platformByWeek[key].items.push(p);
    });
    
    // ì„ ì •ì‚° ì§€ê¸‰ ë°ì´í„°ë¥¼ ì£¼ì°¨+í˜‘ë ¥ì‚¬ë³„ë¡œ ê·¸ë£¹í•‘
    const advanceByWeek = {};
    advanceTransferList.forEach(a => {
        const key = (a.settlement_week || 'unknown') + '_' + (a.partner_id || 'all');
        if (!advanceByWeek[key]) advanceByWeek[key] = { week: a.settlement_week, partner_id: a.partner_id, total: 0, items: [] };
        advanceByWeek[key].total += parseFloat(a.total_amount || a.net_amount || 0);
        advanceByWeek[key].items.push(a);
    });
    
    // ëŒ€ì‚¬ ê²°ê³¼ ìƒì„±
    autoReconcileData = [];
    const allKeys = new Set([...Object.keys(platformByWeek), ...Object.keys(advanceByWeek)]);
    
    allKeys.forEach(key => {
        const platform = platformByWeek[key] || { week: key.split('_')[0], partner_id: key.split('_')[1], total: 0, items: [] };
        const advance = advanceByWeek[key] || { week: key.split('_')[0], partner_id: key.split('_')[1], total: 0, items: [] };
        
        // ì´ë¯¸ ëŒ€ì‚¬ëœ ê±´ì€ ì œì™¸
        const existingRec = reconcileList.find(r => 
            r.settlement_week === platform.week && 
            (r.partner_id == platform.partner_id || (!r.partner_id && !platform.partner_id))
        );
        if (existingRec) return;
        
        const diff = platform.total - advance.total;
        const status = Math.abs(diff) < 100 ? 'matched' : (diff > 0 ? 'pending' : 'issue');
        
        autoReconcileData.push({
            settlement_week: platform.week,
            partner_id: platform.partner_id !== 'all' ? platform.partner_id : null,
            platform_total: platform.total,
            advance_total: advance.total,
            difference_amount: diff,
            fee_income: diff > 0 ? diff : 0,
            status: status,
            platform_items: platform.items,
            advance_items: advance.items
        });
    });
    
    if (!autoReconcileData.length) {
        showToast('ëŒ€ì‚¬í•  ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
    }
    
    // ê²°ê³¼ í‘œì‹œ
    const resultHtml = autoReconcileData.map((r, idx) => {
        const partner = partnerList.find(p => p.id == r.partner_id);
        const statusBadge = r.status === 'matched' ? 'badge-active' : (r.status === 'issue' ? 'badge-error' : 'badge-pending');
        const statusText = r.status === 'matched' ? 'âœ… ì¼ì¹˜' : (r.status === 'issue' ? 'âš ï¸ ë¶ˆì¼ì¹˜' : 'â³ í™•ì¸í•„ìš”');
        const diffColor = r.difference_amount >= 0 ? 'text-blue-400' : 'text-red-400';
        
        return `
        <div class="glass-card p-4 border-l-4 ${r.status === 'matched' ? 'border-green-500' : (r.status === 'issue' ? 'border-red-500' : 'border-yellow-500')}">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="rec-check-${idx}" checked class="w-5 h-5">
                    <span class="font-bold text-blue-400">${r.settlement_week || '-'}</span>
                    <span class="text-gray-400">${partner ? partner.name : 'ì „ì²´'}</span>
                </div>
                <span class="badge ${statusBadge}">${statusText}</span>
            </div>
            <div class="grid grid-cols-4 gap-4 text-sm">
                <div><span class="text-gray-500">í”Œë«í¼ì…ê¸ˆ:</span><br><span class="font-bold text-blue-400">â‚©${parseInt(r.platform_total).toLocaleString()}</span></div>
                <div><span class="text-gray-500">ì„ ì •ì‚°ì§€ê¸‰:</span><br><span class="font-bold text-red-400">â‚©${parseInt(r.advance_total).toLocaleString()}</span></div>
                <div><span class="text-gray-500">ì°¨ì•¡:</span><br><span class="font-bold ${diffColor}">â‚©${parseInt(r.difference_amount).toLocaleString()}</span></div>
                <div><span class="text-gray-500">ìˆ˜ìˆ˜ë£Œìˆ˜ìµ:</span><br><span class="font-bold text-green-400">â‚©${parseInt(r.fee_income).toLocaleString()}</span></div>
            </div>
        </div>`;
    }).join('');
    
    document.getElementById('autoReconcileResult').innerHTML = `
        <div class="mb-4 p-3 bg-blue-900/30 rounded-lg">
            <p class="text-sm"><span class="font-bold text-blue-400">${autoReconcileData.length}ê±´</span>ì˜ ëŒ€ì‚¬ ê²°ê³¼ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-xs text-gray-400 mt-1">ì²´í¬ë°•ìŠ¤ë¡œ ì €ì¥í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
        ${resultHtml}
    `;
    
    openModal('autoReconcileModal');
}

// ìë™ ëŒ€ì‚¬ ê²°ê³¼ ì €ì¥
async function saveAutoReconcile() {
    const toSave = autoReconcileData.filter((r, idx) => {
        const checkbox = document.getElementById('rec-check-' + idx);
        return checkbox && checkbox.checked;
    });
    
    if (!toSave.length) {
        showToast('ì €ì¥í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    showToast('ì €ì¥ ì¤‘...', 'info');
    let saved = 0;
    
    for (const r of toSave) {
        const data = {
            settlement_week: r.settlement_week,
            partner_id: r.partner_id,
            platform_total: r.platform_total,
            advance_total: r.advance_total,
            difference_amount: r.difference_amount,
            fee_income: r.fee_income,
            status: r.status
        };
        
        try {
            const result = await supabaseCall('settlement_reconciliation', 'POST', data);
            if (result && result[0]) {
                reconcileList.unshift(result[0]);
                saved++;
            }
        } catch (err) {
            console.log('ëŒ€ì‚¬ ì €ì¥ ì‹¤íŒ¨:', err);
        }
    }
    
    closeModal('autoReconcileModal');
    renderReconcileTable();
    showToast(saved + 'ê±´ ëŒ€ì‚¬ ì €ì¥ ì™„ë£Œ');
}

// ==================== ì£¼ì •ì‚° ì§€ê¸‰ ====================
function renderWeeklyPayoutTable() {
    document.getElementById('weekly-total').textContent = weeklyPayoutList.length + 'ê±´';
    document.getElementById('weekly-pending').textContent = weeklyPayoutList.filter(w => w.status === 'pending').length + 'ê±´';
    document.getElementById('weekly-paid').textContent = weeklyPayoutList.filter(w => w.status === 'paid').length + 'ê±´';
    document.getElementById('weekly-amount').textContent = 'â‚©' + weeklyPayoutList.reduce((s, w) => s + parseFloat(w.net_amount || 0), 0).toLocaleString();
    
    const sf = document.getElementById('weeklyStatusFilter').value;
    const wf = document.getElementById('weeklyWeekFilter').value;
    const q = (document.getElementById('weeklySearch').value || '').toLowerCase();
    
    let list = weeklyPayoutList;
    if (sf) list = list.filter(w => w.status === sf);
    if (wf) list = list.filter(w => (w.settlement_week || '').includes(wf));
    if (q) list = list.filter(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return (rider?.name || '').toLowerCase().includes(q) || (partner?.name || '').toLowerCase().includes(q);
    });
    
    const tbody = document.getElementById('weeklyPayoutTableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = list.map(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return '<tr><td class="font-bold text-blue-400">' + (w.settlement_week || '-') + '</td><td>' + (rider?.name || '-') + '</td><td>' + (partner?.name || '-') + '</td><td class="text-right">' + parseInt(w.delivery_count || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(w.delivery_revenue || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(w.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-blue-400">â‚©' + parseInt(w.net_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (w.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (w.status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editWeeklyPayout(' + w.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteWeeklyPayout(' + w.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>';
    }).join('');
}

function loadWeeklyPayoutOptions() {
    const riderOpts = '<option value="">ì„ íƒ</option>' + riderList.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    const partnerOpts = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    const riderEl = document.getElementById('weekly-rider');
    const partnerEl = document.getElementById('weekly-partner');
    if (riderEl) riderEl.innerHTML = riderOpts;
    if (partnerEl) partnerEl.innerHTML = partnerOpts;
}

function openWeeklyPayoutModal() {
    document.getElementById('weeklyPayoutForm').reset();
    document.getElementById('weekly-id').value = '';
    loadWeeklyPayoutOptions();
    openModal('weeklyPayoutModal');
}

function calcWeeklyPayout() {
    const revenue = parseFloat(document.getElementById('weekly-revenue').value) || 0;
    const fee = parseFloat(document.getElementById('weekly-fee').value) || 0;
    const insurance = parseFloat(document.getElementById('weekly-insurance').value) || 0;
    const other = parseFloat(document.getElementById('weekly-other').value) || 0;
    const deduction = fee + insurance + other;
    const net = revenue - deduction;
    document.getElementById('weekly-deduction').value = deduction;
    document.getElementById('weekly-net').value = net;
}

async function submitWeeklyPayout(e) {
    e.preventDefault();
    const id = document.getElementById('weekly-id').value;
    const data = {
        settlement_week: document.getElementById('weekly-week').value,
        payout_date: document.getElementById('weekly-date').value,
        rider_id: document.getElementById('weekly-rider').value || null,
        partner_id: document.getElementById('weekly-partner').value || null,
        delivery_count: parseInt(document.getElementById('weekly-count').value) || 0,
        delivery_revenue: parseFloat(document.getElementById('weekly-revenue').value) || 0,
        fee_amount: parseFloat(document.getElementById('weekly-fee').value) || 0,
        insurance_amount: parseFloat(document.getElementById('weekly-insurance').value) || 0,
        other_deduction: parseFloat(document.getElementById('weekly-other').value) || 0,
        total_deduction: parseFloat(document.getElementById('weekly-deduction').value) || 0,
        net_amount: parseFloat(document.getElementById('weekly-net').value) || 0,
        status: document.getElementById('weekly-status').value,
        bank_account: document.getElementById('weekly-account').value || null,
        memo: document.getElementById('weekly-memo').value || null
    };
    try {
        if (id) { await supabaseCall('weekly_payouts', 'PATCH', data, '?id=eq.' + id); showToast('ìˆ˜ì • ì™„ë£Œ'); }
        else { const r = await supabaseCall('weekly_payouts', 'POST', data); if (r && r[0]) weeklyPayoutList.unshift(r[0]); showToast('ë“±ë¡ ì™„ë£Œ'); }
        closeModal('weeklyPayoutModal');
        renderWeeklyPayoutTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì£¼ê°„ì§€ê¸‰ ì‚­ì œ
async function deleteWeeklyPayout(id) {
    if (!confirm('ì´ ì£¼ê°„ì§€ê¸‰ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('weekly_payouts', 'DELETE', null, '?id=eq.' + id);
        weeklyPayoutList = weeklyPayoutList.filter(w => w.id !== id);
        showToast('ì‚­ì œ ì™„ë£Œ');
        renderWeeklyPayoutTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

function editWeeklyPayout(id) {
    const w = weeklyPayoutList.find(x => x.id === id); if (!w) return;
    loadWeeklyPayoutOptions();
    document.getElementById('weekly-id').value = w.id;
    document.getElementById('weekly-week').value = w.settlement_week || '';
    document.getElementById('weekly-date').value = w.payout_date || '';
    document.getElementById('weekly-rider').value = w.rider_id || '';
    document.getElementById('weekly-partner').value = w.partner_id || '';
    document.getElementById('weekly-count').value = w.delivery_count || 0;
    document.getElementById('weekly-revenue').value = w.delivery_revenue || 0;
    document.getElementById('weekly-fee').value = w.fee_amount || 0;
    document.getElementById('weekly-insurance').value = w.insurance_amount || 0;
    document.getElementById('weekly-other').value = w.other_deduction || 0;
    document.getElementById('weekly-deduction').value = w.total_deduction || 0;
    document.getElementById('weekly-net').value = w.net_amount || 0;
    document.getElementById('weekly-status').value = w.status || 'pending';
    document.getElementById('weekly-account').value = w.bank_account || '';
    document.getElementById('weekly-memo').value = w.memo || '';
    openModal('weeklyPayoutModal');
}

// ==================== ì„ ì •ì‚° ì§€ê¸‰ ì—‘ì…€ ====================
function downloadSettAdvanceTemplate() {
    const headers = ['ì§€ê¸‰ì¼', 'í˜‘ë ¥ì‚¬ëª…', 'ì •ì‚°ì£¼ì°¨', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ìˆ˜ìˆ˜ë£Œìœ¨(%)', 'ìˆ˜ìˆ˜ë£Œê¸ˆì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ë©”ëª¨'];
    const sample = ['2025-01-20', 'í˜‘ë ¥ì‚¬A', '2025-W03', '1000000', '100000', '1100000', '3', '33000', '1067000', 'pending', ''];
    downloadExcelTemplate('ì„ ì •ì‚°ì§€ê¸‰_ì–‘ì‹', headers, sample);
}

async function uploadSettAdvanceExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const partnerName = row[1];
            const partner = partnerList.find(p => p.name === partnerName);
            const obj = {
                transfer_date: formatExcelDate(row[0]),
                partner_id: partner?.id || null,
                settlement_week: row[2] || null,
                supply_amount: parseFloat(row[3]) || 0,
                vat_amount: parseFloat(row[4]) || 0,
                total_amount: parseFloat(row[5]) || 0,
                fee_rate: (parseFloat(row[6]) || 0) / 100,
                fee_amount: parseFloat(row[7]) || 0,
                net_amount: parseFloat(row[8]) || 0,
                status: row[9] || 'pending',
                memo: row[10] || null
            };
            const r = await supabaseCall('advance_transfers', 'POST', obj);
            if (r && r[0]) { advanceTransferList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderSettAdvanceTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportSettAdvanceExcel() {
    const headers = ['ì§€ê¸‰ì¼', 'í˜‘ë ¥ì‚¬ëª…', 'ì •ì‚°ì£¼ì°¨', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ìˆ˜ìˆ˜ë£Œìœ¨(%)', 'ìˆ˜ìˆ˜ë£Œê¸ˆì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ë©”ëª¨'];
    const rows = advanceTransferList.map(a => {
        const partner = partnerList.find(p => p.id == a.partner_id);
        return [a.transfer_date, partner?.name || '', a.settlement_week || '', a.supply_amount, a.vat_amount, a.total_amount, (a.fee_rate || 0) * 100, a.fee_amount, a.net_amount, a.status, a.memo || ''];
    });
    downloadExcel('ì„ ì •ì‚°ì§€ê¸‰_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì£¼ì •ì‚° ì§€ê¸‰ ì—‘ì…€ ====================
function downloadWeeklyPayoutTemplate() {
    const headers = ['ì •ì‚°ì£¼ì°¨', 'ì§€ê¸‰ì¼', 'ë¼ì´ë”ëª…', 'í˜‘ë ¥ì‚¬ëª…', 'ë°°ë‹¬ê±´ìˆ˜', 'ë°°ë‹¬ìˆ˜ìµ', 'ìˆ˜ìˆ˜ë£Œ', 'ë³´í—˜ë£Œ', 'ê¸°íƒ€ê³µì œ', 'ì´ê³µì œì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ì§€ê¸‰ê³„ì¢Œ', 'ë©”ëª¨'];
    const sample = ['2025-W03', '2025-01-20', 'í™ê¸¸ë™', 'í˜‘ë ¥ì‚¬A', '100', '500000', '15000', '10000', '5000', '30000', '470000', 'pending', 'êµ­ë¯¼ 123-456-789', ''];
    downloadExcelTemplate('ì£¼ì •ì‚°ì§€ê¸‰_ì–‘ì‹', headers, sample);
}

async function uploadWeeklyPayoutExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const riderName = row[2];
            const partnerName = row[3];
            const rider = riderList.find(r => r.name === riderName);
            const partner = partnerList.find(p => p.name === partnerName);
            const obj = {
                settlement_week: row[0] || null,
                payout_date: formatExcelDate(row[1]),
                rider_id: rider?.id || null,
                partner_id: partner?.id || null,
                delivery_count: parseInt(row[4]) || 0,
                delivery_revenue: parseFloat(row[5]) || 0,
                fee_amount: parseFloat(row[6]) || 0,
                insurance_amount: parseFloat(row[7]) || 0,
                other_deduction: parseFloat(row[8]) || 0,
                total_deduction: parseFloat(row[9]) || 0,
                net_amount: parseFloat(row[10]) || 0,
                status: row[11] || 'pending',
                bank_account: row[12] || null,
                memo: row[13] || null
            };
            const r = await supabaseCall('weekly_payouts', 'POST', obj);
            if (r && r[0]) { weeklyPayoutList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderWeeklyPayoutTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportWeeklyPayoutExcel() {
    const headers = ['ì •ì‚°ì£¼ì°¨', 'ì§€ê¸‰ì¼', 'ë¼ì´ë”ëª…', 'í˜‘ë ¥ì‚¬ëª…', 'ë°°ë‹¬ê±´ìˆ˜', 'ë°°ë‹¬ìˆ˜ìµ', 'ìˆ˜ìˆ˜ë£Œ', 'ë³´í—˜ë£Œ', 'ê¸°íƒ€ê³µì œ', 'ì´ê³µì œì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ì§€ê¸‰ê³„ì¢Œ', 'ë©”ëª¨'];
    const rows = weeklyPayoutList.map(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return [w.settlement_week || '', w.payout_date, rider?.name || '', partner?.name || '', w.delivery_count, w.delivery_revenue, w.fee_amount, w.insurance_amount, w.other_deduction, w.total_deduction, w.net_amount, w.status, w.bank_account || '', w.memo || ''];
    });
    downloadExcel('ì£¼ì •ì‚°ì§€ê¸‰_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì…ì¶œê¸ˆ ë‚´ì—­ ì—‘ì…€ ====================
function downloadCashbookTemplate() {
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„(deposit/withdrawal)', 'ê±°ë˜ì²˜', 'ê¸ˆì•¡', 'ì ìš”', 'ì—°ê²°ìœ í˜•(platform/advance/weekly)', 'ë©”ëª¨'];
    const sample = ['2025-01-20', 'deposit', 'ë°°ë¯¼', '5000000', 'W03 ì •ì‚°ê¸ˆ ì…ê¸ˆ', 'platform', ''];
    downloadExcelTemplate('í˜„ê¸ˆì¶œë‚©ì¥_ì–‘ì‹', headers, sample);
}

function downloadBankTemplate() { downloadCashbookTemplate(); }

async function uploadBankExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 4) continue;
            const obj = {
                transaction_date: formatExcelDate(row[0]),
                transaction_type: (row[1] || '').toLowerCase() === 'withdrawal' ? 'withdrawal' : 'deposit',
                counterparty: row[2] || null,
                amount: parseFloat(row[3]) || 0,
                description: row[4] || null,
                link_type: row[5] || null,
                bank_memo: row[6] || null
            };
            const r = await supabaseCall('bank_transactions', 'POST', obj);
            if (r && r[0]) { bankList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderCashbookTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportCashbookExcel() {
    // ì”ì•¡ ê³„ì‚°
    const sorted = [...bankList].sort((a, b) => (a.transaction_date || '').localeCompare(b.transaction_date || ''));
    let runningBalance = 0;
    sorted.forEach(b => {
        if (b.transaction_type === 'deposit') runningBalance += parseFloat(b.amount || 0);
        else runningBalance -= parseFloat(b.amount || 0);
        b._balance = runningBalance;
    });
    
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„', 'ê±°ë˜ì²˜', 'ì…ê¸ˆ', 'ì¶œê¸ˆ', 'ì”ì•¡', 'ì ìš”', 'ì—°ê²°ìœ í˜•', 'ë©”ëª¨'];
    const rows = sorted.map(b => [
        b.transaction_date, 
        b.transaction_type === 'deposit' ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ',
        b.counterparty || '',
        b.transaction_type === 'deposit' ? b.amount : '',
        b.transaction_type === 'withdrawal' ? b.amount : '',
        b._balance,
        b.description || '', 
        getLinkLabel(b.link_type) || '',
        b.bank_memo || ''
    ]);
    downloadExcel('í˜„ê¸ˆì¶œë‚©ì¥_' + new Date().toISOString().slice(0,10), headers, rows);
}

function exportBankExcel() { exportCashbookExcel(); }

// ==================== ì—‘ì…€ ê³µí†µ í•¨ìˆ˜ ====================
function downloadExcelTemplate(filename, headers, sample) {
    const ws = XLSX.utils.aoa_to_sheet([headers, sample]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename + '.xlsx');
}

function downloadExcel(filename, headers, rows) {
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename + '.xlsx');
}

function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const wb = XLSX.read(e.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                resolve(data);
            } catch (err) { reject(err); }
        };
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsBinaryString(file);
    });
}

function formatExcelDate(val) {
    if (!val) return null;
    if (typeof val === 'number') {
        const d = new Date((val - 25569) * 86400000);
        return d.toISOString().slice(0, 10);
    }
    if (typeof val === 'string' && val.includes('-')) return val.slice(0, 10);
    return null;
}

// ==================== ë§¤ì…ë§¤ì¶œì¥ ====================
function showAccSubTab(sub) {
    document.getElementById('accSubTab-salesPurchase').classList.add('hidden');
    document.getElementById('accSubTab-journal').classList.add('hidden');
    document.getElementById('accSubTab-ledger').classList.add('hidden');
    document.getElementById('accSubTab-' + sub).classList.remove('hidden');
    document.getElementById('btn-salesPurchase').classList.remove('btn-primary');
    document.getElementById('btn-journal').classList.remove('btn-primary');
    document.getElementById('btn-ledger').classList.remove('btn-primary');
    document.getElementById('btn-salesPurchase').classList.add('btn-secondary');
    document.getElementById('btn-journal').classList.add('btn-secondary');
    document.getElementById('btn-ledger').classList.add('btn-secondary');
    document.getElementById('btn-' + sub).classList.remove('btn-secondary');
    document.getElementById('btn-' + sub).classList.add('btn-primary');
    if (sub === 'ledger') renderLedgerTable();
}

function renderSalesPurchaseTable() {
    // í•„í„°
    const monthFilter = document.getElementById('spMonthFilter')?.value || '';
    const typeFilter = document.getElementById('spTypeFilter')?.value || '';
    const taxFilter = document.getElementById('spTaxFilter')?.value || '';
    const searchFilter = (document.getElementById('spSearch')?.value || '').toLowerCase();
    
    let filtered = salesPurchaseList.filter(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return false;
        if (typeFilter && sp.transaction_type !== typeFilter) return false;
        if (taxFilter && sp.tax_invoice_status !== taxFilter) return false;
        if (searchFilter && !(sp.counterparty || '').toLowerCase().includes(searchFilter) && !(sp.item_name || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    // í†µê³„ ê³„ì‚°
    const salesItems = salesPurchaseList.filter(sp => sp.transaction_type === 'sales');
    const purchaseItems = salesPurchaseList.filter(sp => sp.transaction_type === 'purchase');
    const salesTotal = salesItems.reduce((s, sp) => s + parseFloat(sp.supply_amount || 0), 0);
    const purchaseTotal = purchaseItems.reduce((s, sp) => s + parseFloat(sp.supply_amount || 0), 0);
    const salesVat = salesItems.reduce((s, sp) => s + parseFloat(sp.vat_amount || 0), 0);
    const purchaseVat = purchaseItems.reduce((s, sp) => s + parseFloat(sp.vat_amount || 0), 0);
    
    document.getElementById('acc-sales').textContent = 'â‚©' + salesTotal.toLocaleString();
    document.getElementById('acc-purchase').textContent = 'â‚©' + purchaseTotal.toLocaleString();
    document.getElementById('acc-sales-vat').textContent = 'â‚©' + salesVat.toLocaleString();
    document.getElementById('acc-purchase-vat').textContent = 'â‚©' + purchaseVat.toLocaleString();
    document.getElementById('acc-vat-pay').textContent = 'â‚©' + (salesVat - purchaseVat).toLocaleString();
    document.getElementById('acc-profit').textContent = 'â‚©' + (salesTotal - purchaseTotal).toLocaleString();
    
    const tbody = document.getElementById('salesPurchaseTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = filtered.map(sp => {
        const isSales = sp.transaction_type === 'sales';
        const taxBadge = sp.tax_invoice_status === 'issued' ? '<span class="badge badge-active">ë°œí–‰</span>' : 
                         sp.tax_invoice_status === 'received' ? '<span class="badge badge-info">ìˆ˜ì·¨</span>' : 
                         '<span class="badge badge-pending">ë¯¸ë°œí–‰</span>';
        const linkBadge = sp.link_type ? '<span class="badge badge-active text-xs">' + getLinkLabel(sp.link_type) + '</span>' : '-';
        return '<tr>' +
            '<td>' + sp.transaction_date + '</td>' +
            '<td><span class="badge ' + (isSales ? 'badge-info' : 'badge-error') + '">' + (isSales ? 'ë§¤ì¶œ' : 'ë§¤ì…') + '</span></td>' +
            '<td class="font-bold">' + (sp.counterparty || '-') + '</td>' +
            '<td>' + (sp.item_name || '-') + '</td>' +
            '<td class="text-right">â‚©' + parseInt(sp.supply_amount || 0).toLocaleString() + '</td>' +
            '<td class="text-right">â‚©' + parseInt(sp.vat_amount || 0).toLocaleString() + '</td>' +
            '<td class="text-right font-bold ' + (isSales ? 'text-blue-400' : 'text-red-400') + '">â‚©' + parseInt(sp.total_amount || 0).toLocaleString() + '</td>' +
            '<td>' + taxBadge + '</td>' +
            '<td>' + linkBadge + '</td>' +
            '<td><button onclick="editSalesPurchase(' + sp.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteSalesPurchase(' + sp.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td>' +
            '</tr>';
    }).join('');
}

function openSalesPurchaseModal() {
    document.getElementById('salesPurchaseForm').reset();
    document.getElementById('sp-id').value = '';
    document.getElementById('sp-link-id').innerHTML = '<option value="">ì„ íƒ</option>';
    openModal('salesPurchaseModal');
}

function calcSPTotal() {
    // íšŒê³„ ê¸°ì¤€: ëª¨ë“  ê¸ˆì•¡ì€ ì •ìˆ˜(ì› ë‹¨ìœ„)ë¡œ ì²˜ë¦¬
    const supply = Math.round(parseFloat(document.getElementById('sp-supply').value) || 0);
    const vatType = document.querySelector('input[name="sp-vat-type"]:checked')?.value || 'auto';
    
    // ê³µê¸‰ê°€ì•¡ ì •ìˆ˜ë¡œ í‘œì‹œ
    document.getElementById('sp-supply').value = supply;
    
    let vat = 0;
    let total = 0;
    
    if (vatType === 'auto') {
        // ë¶€ê°€ì„¸ ìë™ 10% (ë°˜ì˜¬ë¦¼)
        vat = Math.round(supply * 0.1);
        total = supply + vat;
        document.getElementById('sp-vat').value = vat;
        document.getElementById('sp-total').value = total;
    } else if (vatType === 'manual') {
        // ì§ì ‘ ì…ë ¥ ëª¨ë“œ - ì •ìˆ˜ ì²˜ë¦¬
        vat = Math.round(parseFloat(document.getElementById('sp-vat').value) || 0);
        total = Math.round(parseFloat(document.getElementById('sp-total').value) || 0);
        document.getElementById('sp-vat').value = vat;
        document.getElementById('sp-total').value = total;
    } else if (vatType === 'none') {
        // ë¶€ê°€ì„¸ ì—†ìŒ
        vat = 0;
        total = supply;
        document.getElementById('sp-vat').value = 0;
        document.getElementById('sp-total').value = total;
    }
    
    console.log('ëª¨ë“œ:', vatType, 'ê³µê¸‰ê°€ì•¡:', supply, 'ë¶€ê°€ì„¸:', vat, 'í•©ê³„:', total);
}

function toggleVatMode() {
    const vatType = document.querySelector('input[name="sp-vat-type"]:checked')?.value || 'auto';
    const vatInput = document.getElementById('sp-vat');
    const totalInput = document.getElementById('sp-total');
    
    if (vatType === 'manual') {
        // ì§ì ‘ ì…ë ¥ ëª¨ë“œ - ë¶€ê°€ì„¸, í•©ê³„ ì…ë ¥ ê°€ëŠ¥
        vatInput.readOnly = false;
        vatInput.style.background = '';
        totalInput.readOnly = false;
        totalInput.style.background = '';
    } else {
        // ìë™ ëª¨ë“œ ë˜ëŠ” ë¶€ê°€ì„¸ ì—†ìŒ - readonly
        vatInput.readOnly = true;
        vatInput.style.background = 'var(--bg-tertiary)';
        totalInput.readOnly = true;
        totalInput.style.background = 'var(--bg-tertiary)';
    }
    
    // ì¬ê³„ì‚°
    calcSPTotal();
}

function toggleSPType() {
    const type = document.getElementById('sp-type').value;
    const taxStatus = document.getElementById('sp-tax-status');
    if (type === 'sales') {
        taxStatus.innerHTML = '<option value="pending">ë¯¸ë°œí–‰</option><option value="issued">ë°œí–‰</option>';
    } else {
        taxStatus.innerHTML = '<option value="pending">ë¯¸ìˆ˜ì·¨</option><option value="received">ìˆ˜ì·¨</option>';
    }
}

function loadSPLinkOptions() {
    const linkType = document.getElementById('sp-link-type').value;
    const linkIdSelect = document.getElementById('sp-link-id');
    linkIdSelect.innerHTML = '<option value="">ì„ íƒ</option>';
    
    if (linkType === 'platform') {
        const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
        platformList.forEach(p => {
            const label = (platforms[p.platform] || p.platform) + ' ' + p.settlement_week + ' (â‚©' + parseInt(p.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + p.id + '">' + label + '</option>';
        });
    } else if (linkType === 'advance') {
        advanceTransferList.forEach(a => {
            const partner = partnerList.find(p => p.id == a.partner_id);
            const label = (partner?.name || 'í˜‘ë ¥ì‚¬') + ' ' + (a.settlement_week || '') + ' (â‚©' + parseInt(a.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + a.id + '">' + label + '</option>';
        });
    }
}

async function submitSalesPurchase(e) {
    e.preventDefault();
    const id = document.getElementById('sp-id').value;
    
    // íšŒê³„ ê¸°ì¤€: ëª¨ë“  ê¸ˆì•¡ ì •ìˆ˜(ì› ë‹¨ìœ„) ì²˜ë¦¬
    const data = {
        transaction_date: document.getElementById('sp-date').value,
        transaction_type: document.getElementById('sp-type').value,
        counterparty: document.getElementById('sp-counterparty').value,
        item_name: document.getElementById('sp-item').value || null,
        supply_amount: Math.round(parseFloat(document.getElementById('sp-supply').value) || 0),
        vat_amount: Math.round(parseFloat(document.getElementById('sp-vat').value) || 0),
        total_amount: Math.round(parseFloat(document.getElementById('sp-total').value) || 0),
        tax_invoice_status: document.getElementById('sp-tax-status').value,
        link_type: document.getElementById('sp-link-type').value || null,
        link_id: document.getElementById('sp-link-id').value || null,
        memo: document.getElementById('sp-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('sales_purchases', 'PATCH', data, '?id=eq.' + id);
            const idx = salesPurchaseList.findIndex(sp => sp.id == id);
            if (idx >= 0) salesPurchaseList[idx] = { ...salesPurchaseList[idx], ...data };
            showToast('ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) salesPurchaseList.unshift(r[0]);
            showToast('ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('salesPurchaseModal');
        renderSalesPurchaseTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ë§¤ì…ë§¤ì¶œ ì‚­ì œ
async function deleteSalesPurchase(id) {
    if (!confirm('ì´ ë§¤ì…ë§¤ì¶œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await supabaseCall('sales_purchases', 'DELETE', null, '?id=eq.' + id);
        salesPurchaseList = salesPurchaseList.filter(sp => sp.id !== id);
        showToast('ì‚­ì œ ì™„ë£Œ');
        renderSalesPurchaseTable();
    } catch (err) { showToast('ì‚­ì œ ì‹¤íŒ¨', 'error'); }
}

function editSalesPurchase(id) {
    const sp = salesPurchaseList.find(x => x.id === id); if (!sp) return;
    document.getElementById('sp-id').value = sp.id;
    document.getElementById('sp-date').value = sp.transaction_date || '';
    document.getElementById('sp-type').value = sp.transaction_type || 'sales';
    toggleSPType();
    document.getElementById('sp-tax-status').value = sp.tax_invoice_status || 'pending';
    document.getElementById('sp-counterparty').value = sp.counterparty || '';
    document.getElementById('sp-item').value = sp.item_name || '';
    document.getElementById('sp-supply').value = sp.supply_amount || 0;
    document.getElementById('sp-vat').value = sp.vat_amount || 0;
    document.getElementById('sp-total').value = sp.total_amount || 0;
    document.getElementById('sp-link-type').value = sp.link_type || '';
    loadSPLinkOptions();
    document.getElementById('sp-link-id').value = sp.link_id || '';
    document.getElementById('sp-memo').value = sp.memo || '';
    openModal('salesPurchaseModal');
}

// ì •ì‚° ì—°ë™ - í”Œë«í¼ ì •ì‚° â†’ ë§¤ì¶œ, ì„ ì •ì‚° ì§€ê¸‰ â†’ ë§¤ì… ìë™ ë“±ë¡
async function syncFromSettlements() {
    let cnt = 0;
    const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡ì´ì¸ ', yogiyo: 'ìš”ê¸°ìš”' };
    
    // í”Œë«í¼ ì •ì‚° â†’ ë§¤ì¶œ
    for (const p of platformList) {
        const exists = salesPurchaseList.find(sp => sp.link_type === 'platform' && sp.link_id == p.id);
        if (!exists && p.total_amount > 0) {
            const data = {
                transaction_date: p.expected_date || p.work_end_date,
                transaction_type: 'sales',
                counterparty: platforms[p.platform] || p.platform,
                item_name: p.settlement_week + ' ì •ì‚°ê¸ˆ',
                supply_amount: p.supply_amount || 0,
                vat_amount: p.vat_amount || 0,
                total_amount: p.total_amount || 0,
                tax_invoice_status: 'pending',
                link_type: 'platform',
                link_id: p.id
            };
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
    }
    
    // ì„ ì •ì‚° ì§€ê¸‰ â†’ ë§¤ì…
    for (const a of advanceTransferList) {
        const exists = salesPurchaseList.find(sp => sp.link_type === 'advance' && sp.link_id == a.id);
        if (!exists && a.total_amount > 0) {
            const partner = partnerList.find(pt => pt.id == a.partner_id);
            const data = {
                transaction_date: a.transfer_date,
                transaction_type: 'purchase',
                counterparty: partner?.name || 'í˜‘ë ¥ì‚¬',
                item_name: (a.settlement_week || '') + ' ì„ ì •ì‚°',
                supply_amount: a.supply_amount || 0,
                vat_amount: a.vat_amount || 0,
                total_amount: a.total_amount || 0,
                tax_invoice_status: 'pending',
                link_type: 'advance',
                link_id: a.id
            };
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
    }
    
    showToast(cnt + 'ê±´ ì—°ë™ ì™„ë£Œ');
    renderSalesPurchaseTable();
}

// ë§¤ì…ë§¤ì¶œì¥ ì—‘ì…€
function downloadSalesPurchaseTemplate() {
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„(sales/purchase)', 'ê±°ë˜ì²˜', 'í’ˆëª©', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ì„¸ê¸ˆê³„ì‚°ì„œìƒíƒœ', 'ë©”ëª¨'];
    const sample = ['2025-01-20', 'sales', 'ë°°ë¯¼', 'W03 ì •ì‚°ê¸ˆ', '5000000', '500000', '5500000', 'issued', ''];
    downloadExcelTemplate('ë§¤ì…ë§¤ì¶œì¥_ì–‘ì‹', headers, sample);
}

async function uploadSalesPurchaseExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            
            // íšŒê³„ ê¸°ì¤€: ëª¨ë“  ê¸ˆì•¡ ì •ìˆ˜(ì› ë‹¨ìœ„) ì²˜ë¦¬
            const supplyAmt = Math.round(parseFloat(row[4]) || 0);
            const vatAmt = Math.round(parseFloat(row[5]) || 0);
            let totalAmt = Math.round(parseFloat(row[6]) || 0);
            
            // í•©ê³„ê°€ ì—†ìœ¼ë©´ ê³µê¸‰ê°€ì•¡ + ë¶€ê°€ì„¸
            if (!totalAmt && supplyAmt) {
                totalAmt = supplyAmt + vatAmt;
            }
            
            const obj = {
                transaction_date: formatExcelDate(row[0]),
                transaction_type: (row[1] || '').toLowerCase() === 'purchase' || (row[1] || '').includes('ë§¤ì…') ? 'purchase' : 'sales',
                counterparty: row[2] || null,
                item_name: row[3] || null,
                supply_amount: supplyAmt,
                vat_amount: vatAmt,
                total_amount: totalAmt,
                tax_invoice_status: row[7] || 'pending',
                memo: row[8] || null
            };
            const r = await supabaseCall('sales_purchases', 'POST', obj);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderSalesPurchaseTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportSalesPurchaseExcel() {
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„', 'ê±°ë˜ì²˜', 'í’ˆëª©', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ì„¸ê¸ˆê³„ì‚°ì„œ', 'ì—°ê²°', 'ë©”ëª¨'];
    const rows = salesPurchaseList.map(sp => [
        sp.transaction_date,
        sp.transaction_type === 'sales' ? 'ë§¤ì¶œ' : 'ë§¤ì…',
        sp.counterparty || '',
        sp.item_name || '',
        sp.supply_amount,
        sp.vat_amount,
        sp.total_amount,
        sp.tax_invoice_status === 'issued' ? 'ë°œí–‰' : sp.tax_invoice_status === 'received' ? 'ìˆ˜ì·¨' : 'ë¯¸ë°œí–‰',
        getLinkLabel(sp.link_type) || '',
        sp.memo || ''
    ]);
    downloadExcel('ë§¤ì…ë§¤ì¶œì¥_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì´ê³„ì •ì›ì¥ ====================
const ACCOUNT_CODES = {
    // ìì‚°
    '101': { name: 'í˜„ê¸ˆ', category: 'asset' },
    '102': { name: 'ë³´í†µì˜ˆê¸ˆ', category: 'asset' },
    '103': { name: 'ì •ê¸°ì˜ˆê¸ˆ', category: 'asset' },
    '108': { name: 'ë§¤ì¶œì±„ê¶Œ', category: 'asset' },
    '110': { name: 'ë¯¸ìˆ˜ê¸ˆ', category: 'asset' },
    '120': { name: 'ì¬ê³ ìì‚°', category: 'asset' },
    '150': { name: 'ì°¨ëŸ‰ìš´ë°˜êµ¬', category: 'asset' },
    '160': { name: 'ë¹„í’ˆ', category: 'asset' },
    // ë¶€ì±„
    '201': { name: 'ë§¤ì…ì±„ë¬´', category: 'liability' },
    '210': { name: 'ë¯¸ì§€ê¸‰ê¸ˆ', category: 'liability' },
    '220': { name: 'ì˜ˆìˆ˜ê¸ˆ', category: 'liability' },
    '230': { name: 'ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ', category: 'liability' },
    '240': { name: 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ', category: 'asset' },
    // ìë³¸
    '301': { name: 'ìë³¸ê¸ˆ', category: 'equity' },
    '310': { name: 'ì´ìµì‰ì—¬ê¸ˆ', category: 'equity' },
    // ìˆ˜ìµ
    '401': { name: 'ë§¤ì¶œ', category: 'revenue' },
    '402': { name: 'ìˆ˜ìˆ˜ë£Œìˆ˜ìµ', category: 'revenue' },
    '403': { name: 'ì´ììˆ˜ìµ', category: 'revenue' },
    '410': { name: 'ê¸°íƒ€ìˆ˜ìµ', category: 'revenue' },
    // ë¹„ìš©
    '501': { name: 'ê¸‰ì—¬', category: 'expense' },
    '502': { name: 'ì„ì°¨ë£Œ', category: 'expense' },
    '503': { name: 'í†µì‹ ë¹„', category: 'expense' },
    '504': { name: 'ì†Œëª¨í’ˆë¹„', category: 'expense' },
    '505': { name: 'ì ‘ëŒ€ë¹„', category: 'expense' },
    '506': { name: 'ê´‘ê³ ì„ ì „ë¹„', category: 'expense' },
    '510': { name: 'ì°¨ëŸ‰ìœ ì§€ë¹„', category: 'expense' },
    '520': { name: 'ë³´í—˜ë£Œ', category: 'expense' },
    '530': { name: 'ìˆ˜ìˆ˜ë£Œë¹„ìš©', category: 'expense' },
    '590': { name: 'ê¸°íƒ€ë¹„ìš©', category: 'expense' }
};

const CATEGORY_NAMES = { asset: 'ìì‚°', liability: 'ë¶€ì±„', equity: 'ìë³¸', revenue: 'ìˆ˜ìµ', expense: 'ë¹„ìš©' };

function renderLedgerTable() {
    const monthFilter = document.getElementById('ledgerMonthFilter')?.value || '';
    const categoryFilter = document.getElementById('ledgerCategoryFilter')?.value || '';
    
    // ë¶„ê°œì¥ ë°ì´í„° ê¸°ë°˜ ê³„ì •ë³„ ì§‘ê³„
    const accountTotals = {};
    
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        
        // ì°¨ë³€ ì²˜ë¦¬
        if (j.debit_account && j.debit_amount > 0) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
            accountTotals[code].count++;
        }
        // ëŒ€ë³€ ì²˜ë¦¬
        if (j.credit_account && j.credit_amount > 0) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
            accountTotals[code].count++;
        }
    });
    
    // ë§¤ì…ë§¤ì¶œì¥ì—ì„œë„ ì§‘ê³„ ì¶”ê°€
    salesPurchaseList.forEach(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return;
        
        if (sp.transaction_type === 'sales') {
            // ë§¤ì¶œ â†’ 401 ëŒ€ë³€, ë§¤ì¶œì±„ê¶Œ 108 ì°¨ë³€
            if (!accountTotals['401']) accountTotals['401'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['401'].credit += parseFloat(sp.supply_amount) || 0;
            accountTotals['401'].count++;
            
            if (!accountTotals['108']) accountTotals['108'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['108'].debit += parseFloat(sp.total_amount) || 0;
            
            // ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ
            if (sp.vat_amount > 0) {
                if (!accountTotals['230']) accountTotals['230'] = { debit: 0, credit: 0, count: 0 };
                accountTotals['230'].credit += parseFloat(sp.vat_amount) || 0;
            }
        } else {
            // ë§¤ì… â†’ ë¹„ìš© ì°¨ë³€, ë§¤ì…ì±„ë¬´ 201 ëŒ€ë³€
            if (!accountTotals['530']) accountTotals['530'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['530'].debit += parseFloat(sp.supply_amount) || 0;
            accountTotals['530'].count++;
            
            if (!accountTotals['201']) accountTotals['201'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['201'].credit += parseFloat(sp.total_amount) || 0;
            
            // ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ
            if (sp.vat_amount > 0) {
                if (!accountTotals['240']) accountTotals['240'] = { debit: 0, credit: 0, count: 0 };
                accountTotals['240'].debit += parseFloat(sp.vat_amount) || 0;
            }
        }
    });
    
    // ì´ê³„ ê³„ì‚°
    let assetTotal = 0, liabilityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    
    Object.keys(accountTotals).forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (!acc) return;
        const balance = accountTotals[code].debit - accountTotals[code].credit;
        
        if (acc.category === 'asset') assetTotal += balance;
        else if (acc.category === 'liability') liabilityTotal -= balance;
        else if (acc.category === 'revenue') revenueTotal -= balance;
        else if (acc.category === 'expense') expenseTotal += balance;
    });
    
    document.getElementById('ledger-asset').textContent = 'â‚©' + assetTotal.toLocaleString();
    document.getElementById('ledger-liability').textContent = 'â‚©' + liabilityTotal.toLocaleString();
    document.getElementById('ledger-revenue').textContent = 'â‚©' + revenueTotal.toLocaleString();
    document.getElementById('ledger-expense').textContent = 'â‚©' + expenseTotal.toLocaleString();
    
    // í…Œì´ë¸” ë Œë”ë§
    const tbody = document.getElementById('ledgerTableBody');
    const rows = [];
    
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (categoryFilter && acc.category !== categoryFilter) return;
        
        const totals = accountTotals[code] || { debit: 0, credit: 0, count: 0 };
        if (totals.debit === 0 && totals.credit === 0) return; // ê±°ë˜ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        
        const balance = totals.debit - totals.credit;
        const balanceClass = balance >= 0 ? 'text-blue-400' : 'text-red-400';
        const categoryClass = acc.category === 'asset' ? 'text-blue-300' : 
                              acc.category === 'liability' ? 'text-red-300' :
                              acc.category === 'revenue' ? 'text-green-300' :
                              acc.category === 'expense' ? 'text-orange-300' : 'text-gray-300';
        
        rows.push('<tr>' +
            '<td class="font-mono">' + code + '</td>' +
            '<td class="font-bold">' + acc.name + '</td>' +
            '<td><span class="' + categoryClass + '">' + CATEGORY_NAMES[acc.category] + '</span></td>' +
            '<td class="text-right text-blue-400">â‚©' + totals.debit.toLocaleString() + '</td>' +
            '<td class="text-right text-red-400">â‚©' + totals.credit.toLocaleString() + '</td>' +
            '<td class="text-right font-bold ' + balanceClass + '">â‚©' + balance.toLocaleString() + '</td>' +
            '<td class="text-center">' + totals.count + 'ê±´</td>' +
            '</tr>');
    });
    
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
    } else {
        tbody.innerHTML = rows.join('');
    }
}

function exportLedgerExcel() {
    const monthFilter = document.getElementById('ledgerMonthFilter')?.value || '';
    const headers = ['ê³„ì •ì½”ë“œ', 'ê³„ì •ê³¼ëª©', 'ë¶„ë¥˜', 'ì°¨ë³€í•©ê³„', 'ëŒ€ë³€í•©ê³„', 'ì”ì•¡'];
    const rows = [];
    
    // ìœ„ ë¡œì§ ë°˜ë³µ (ê°„ì†Œí™”)
    const accountTotals = {};
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        if (j.debit_account) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
        }
        if (j.credit_account) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
        }
    });
    
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        const totals = accountTotals[code] || { debit: 0, credit: 0 };
        if (totals.debit === 0 && totals.credit === 0) return;
        rows.push([code, acc.name, CATEGORY_NAMES[acc.category], totals.debit, totals.credit, totals.debit - totals.credit]);
    });
    
    downloadExcel('ì´ê³„ì •ì›ì¥_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì„¸ê¸ˆê³„ì‚°ì„œ â†’ ë§¤ì…ë§¤ì¶œì¥ ì—°ë™ ====================
async function syncTaxToSalesPurchase() {
    let cnt = 0;
    
    for (const inv of taxInvoiceList) {
        // ì´ë¯¸ ì—°ë™ëœ ê±´ í™•ì¸
        const exists = salesPurchaseList.find(sp => sp.link_type === 'taxinvoice' && sp.link_id == inv.id);
        if (exists) continue;
        
        const data = {
            transaction_date: inv.invoice_date,
            transaction_type: inv.invoice_type === 'sales' ? 'sales' : 'purchase',
            counterparty: inv.counterparty_name || '',
            item_name: inv.item_name || 'ì„¸ê¸ˆê³„ì‚°ì„œ',
            supply_amount: inv.supply_amount || 0,
            vat_amount: inv.vat_amount || 0,
            total_amount: inv.total_amount || 0,
            tax_invoice_status: inv.invoice_type === 'sales' ? 'issued' : 'received',
            link_type: 'taxinvoice',
            link_id: inv.id
        };
        
        const r = await supabaseCall('sales_purchases', 'POST', data);
        if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        
        // ì„¸ê¸ˆê³„ì‚°ì„œì— ì—°ë™ í‘œì‹œ ì—…ë°ì´íŠ¸
        await supabaseCall('hq_tax_invoices', 'PATCH', { synced_to_ledger: true }, '?id=eq.' + inv.id);
        inv.synced_to_ledger = true;
    }
    
    showToast(cnt + 'ê±´ ë§¤ì…ë§¤ì¶œì¥ ì—°ë™ ì™„ë£Œ');
    renderTaxInvoiceTable();
    renderSalesPurchaseTable();
}

// ==================== ë…ë¦½ íƒ­ ë Œë” í•¨ìˆ˜ë“¤ ====================

// ì´ê³„ì •ì›ì¥ (ë…ë¦½íƒ­)
function renderLedgerTable2() {
    const monthFilter = document.getElementById('ledger2MonthFilter')?.value || '';
    const categoryFilter = document.getElementById('ledger2CategoryFilter')?.value || '';
    
    const accountTotals = {};
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        if (j.debit_account && j.debit_amount > 0) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
            accountTotals[code].count++;
        }
        if (j.credit_account && j.credit_amount > 0) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
            accountTotals[code].count++;
        }
    });
    
    salesPurchaseList.forEach(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return;
        if (sp.transaction_type === 'sales') {
            if (!accountTotals['401']) accountTotals['401'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['401'].credit += parseFloat(sp.supply_amount) || 0;
            accountTotals['401'].count++;
        } else {
            if (!accountTotals['530']) accountTotals['530'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['530'].debit += parseFloat(sp.supply_amount) || 0;
            accountTotals['530'].count++;
        }
    });
    
    let assetTotal = 0, liabilityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    Object.keys(accountTotals).forEach(code => {
        const acc = ACCOUNT_CODES[code]; if (!acc) return;
        const balance = accountTotals[code].debit - accountTotals[code].credit;
        if (acc.category === 'asset') assetTotal += balance;
        else if (acc.category === 'liability') liabilityTotal -= balance;
        else if (acc.category === 'revenue') revenueTotal -= balance;
        else if (acc.category === 'expense') expenseTotal += balance;
    });
    
    document.getElementById('ledger2-asset').textContent = 'â‚©' + assetTotal.toLocaleString();
    document.getElementById('ledger2-liability').textContent = 'â‚©' + liabilityTotal.toLocaleString();
    document.getElementById('ledger2-revenue').textContent = 'â‚©' + revenueTotal.toLocaleString();
    document.getElementById('ledger2-expense').textContent = 'â‚©' + expenseTotal.toLocaleString();
    
    const tbody = document.getElementById('ledger2TableBody');
    const rows = [];
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (categoryFilter && acc.category !== categoryFilter) return;
        const totals = accountTotals[code] || { debit: 0, credit: 0, count: 0 };
        if (totals.debit === 0 && totals.credit === 0) return;
        const balance = totals.debit - totals.credit;
        const balanceClass = balance >= 0 ? 'text-blue-400' : 'text-red-400';
        const categoryClass = acc.category === 'asset' ? 'text-blue-300' : acc.category === 'liability' ? 'text-red-300' : acc.category === 'revenue' ? 'text-green-300' : 'text-orange-300';
        rows.push('<tr><td class="font-mono">' + code + '</td><td class="font-bold">' + acc.name + '</td><td><span class="' + categoryClass + '">' + CATEGORY_NAMES[acc.category] + '</span></td><td class="text-right text-blue-400">â‚©' + totals.debit.toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + totals.credit.toLocaleString() + '</td><td class="text-right font-bold ' + balanceClass + '">â‚©' + balance.toLocaleString() + '</td><td class="text-center">' + totals.count + 'ê±´</td></tr>');
    });
    tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
}

// ë¶„ê°œì¥ (ë…ë¦½íƒ­)
function renderJournalTable2() {
    const monthFilter = document.getElementById('journal2MonthFilter')?.value || '';
    const statusFilter = document.getElementById('journal2StatusFilter')?.value || '';
    const search = (document.getElementById('journal2Search')?.value || '').toLowerCase();
    
    let list = journalList.filter(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return false;
        if (statusFilter && j.status !== statusFilter) return false;
        if (search && !(j.description || '').toLowerCase().includes(search)) return false;
        return true;
    });
    
    const tbody = document.getElementById('journal2TableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const getAccName = (code) => { if (!code) return '-'; const c = code.split('-')[0]; return ACCOUNT_CODES[c]?.name || code; };
    tbody.innerHTML = list.map(j => '<tr><td>' + j.journal_date + '</td><td class="font-mono text-xs">' + (j.journal_no || '-') + '</td><td>' + getAccName(j.debit_account) + '</td><td class="text-right text-blue-400">â‚©' + parseInt(j.debit_amount || 0).toLocaleString() + '</td><td>' + getAccName(j.credit_account) + '</td><td class="text-right text-red-400">â‚©' + parseInt(j.credit_amount || 0).toLocaleString() + '</td><td class="text-xs">' + (j.description || '-') + '</td><td><span class="badge ' + (j.status === 'confirmed' ? 'badge-active' : 'badge-pending') + '">' + (j.status === 'confirmed' ? 'í™•ì •' : 'ìƒì„±') + '</span></td><td><button onclick="editJournal(' + j.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteJournal(' + j.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>').join('');
}

// ì¹´ë“œ ì‚¬ìš©ë‚´ì—­
function renderCardUsageTable() {
    const thisMonth = new Date().toISOString().slice(0,7);
    const monthlyUsage = cardTransList.filter(t => t.transaction_date?.startsWith(thisMonth)).reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    
    document.getElementById('card-usage-monthly').textContent = 'â‚©' + monthlyUsage.toLocaleString();
    document.getElementById('card-usage-count').textContent = cardTransList.length + 'ê±´';
    document.getElementById('card-usage-noreceipt').textContent = cardTransList.filter(t => !t.receipt_status || t.receipt_status === 'none').length + 'ê±´';
    document.getElementById('card-usage-pending').textContent = cardTransList.filter(t => !t.accounting_status || t.accounting_status === 'pending').length + 'ê±´';
    
    const tbody = document.getElementById('cardUsageTableBody');
    if (!cardTransList.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = cardTransList.map(t => {
        const card = cardList.find(c => c.id == t.card_id);
        return '<tr><td>' + t.transaction_date + '</td><td>' + (card?.card_alias || '-') + '</td><td>' + (t.merchant_name || '-') + '</td><td class="text-right text-red-400">â‚©' + parseInt(t.amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.receipt_status === 'received' ? 'badge-active' : 'badge-pending') + '">' + (t.receipt_status === 'received' ? 'ìˆ˜ì·¨' : 'ë¯¸ìˆ˜ì·¨') + '</span></td><td><span class="badge ' + (t.accounting_status === 'processed' ? 'badge-active' : 'badge-pending') + '">' + (t.accounting_status === 'processed' ? 'ì²˜ë¦¬' : 'ë¯¸ì²˜ë¦¬') + '</span></td><td><button class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

// ì§ì› ê´€ë¦¬ (ë…ë¦½íƒ­)
function renderEmployeeTable2() {
    document.getElementById('emp2-total').textContent = employeeList.length;
    document.getElementById('emp2-regular').textContent = employeeList.filter(e => e.employee_type === 'regular').length;
    document.getElementById('emp2-contract').textContent = employeeList.filter(e => e.employee_type === 'contract').length;
    document.getElementById('emp2-insured').textContent = employeeList.filter(e => e.has_insurance).length;
    
    const tbody = document.getElementById('employees2TableBody');
    if (!employeeList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const types = { regular: 'ì •ê·œì§', contract: 'ê³„ì•½ì§', parttime: 'íŒŒíŠ¸íƒ€ì„' };
    tbody.innerHTML = employeeList.map(e => '<tr><td class="font-mono">' + (e.employee_no || '-') + '</td><td class="font-bold">' + e.name + '</td><td><span class="badge badge-info">' + (types[e.employee_type] || e.employee_type) + '</span></td><td>' + (e.department || '-') + '</td><td class="text-right">â‚©' + parseInt(e.base_salary || 0).toLocaleString() + '</td><td>' + (e.has_insurance ? 'âœ…' : 'âŒ') + '</td><td><span class="badge ' + (e.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (e.status === 'active' ? 'ì¬ì§' : 'í‡´ì§') + '</span></td><td><button onclick="editEmployee(' + e.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteEmployee(' + e.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>').join('');
}

// ê¸‰ì—¬ ê´€ë¦¬ (ë…ë¦½íƒ­)
function renderPayrollTable2() {
    const thisMonth = new Date().toISOString().slice(0,7);
    const thisMonthPay = payrollList.filter(p => (p.pay_year + '-' + String(p.pay_month).padStart(2, '0')) === thisMonth);
    
    document.getElementById('pay2-count').textContent = thisMonthPay.length + 'ê±´';
    document.getElementById('pay2-gross').textContent = 'â‚©' + thisMonthPay.reduce((s, p) => s + parseFloat(p.gross_salary || 0), 0).toLocaleString();
    document.getElementById('pay2-deduct').textContent = 'â‚©' + thisMonthPay.reduce((s, p) => s + parseFloat(p.total_deduction || 0), 0).toLocaleString();
    document.getElementById('pay2-net').textContent = 'â‚©' + thisMonthPay.reduce((s, p) => s + parseFloat(p.net_salary || 0), 0).toLocaleString();
    
    const tbody = document.getElementById('payroll2TableBody');
    if (!payrollList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = payrollList.map(p => {
        const emp = employeeList.find(e => e.id == p.employee_id);
        return '<tr><td>' + p.pay_year + '-' + String(p.pay_month).padStart(2, '0') + '</td><td class="font-bold">' + (emp?.name || '-') + '</td><td class="text-right">â‚©' + parseInt(p.base_salary || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(p.total_allowance || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(p.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-blue-400">â‚©' + parseInt(p.net_salary || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (p.status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editPayroll(' + p.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deletePayroll(' + p.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td></tr>';
    }).join('');
}

// ê·¼ë¡œê³„ì•½ (ë…ë¦½íƒ­)
function renderContractTable2() {
    const today = new Date().toISOString().slice(0, 10);
    const contracts = contractList || [];
    
    document.getElementById('contract-total').textContent = contracts.length;
    document.getElementById('contract-active').textContent = contracts.filter(c => c.status === 'active').length;
    document.getElementById('contract-expiring').textContent = contracts.filter(c => { 
        if (!c.end_date) return false;
        const daysLeft = Math.floor((new Date(c.end_date) - new Date()) / 86400000);
        return daysLeft > 0 && daysLeft <= 30;
    }).length;
    document.getElementById('contract-expired').textContent = contracts.filter(c => c.end_date && c.end_date < today).length;
    
    const tbody = document.getElementById('contracts2TableBody');
    if (!contracts.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const types = { full_time: 'ì •ê·œì§', contract: 'ê³„ì•½ì§', part_time: 'íŒŒíŠ¸íƒ€ì„' };
    tbody.innerHTML = contracts.map(c => {
        const emp = employeeList.find(e => e.id == c.employee_id);
        return '<tr><td class="font-bold">' + (emp?.name || '-') + '</td><td><span class="badge badge-info">' + (types[c.contract_type] || c.contract_type) + '</span></td><td>' + (c.start_date || '-') + '</td><td>' + (c.end_date || 'ë¬´ê¸°í•œ') + '</td><td class="text-right">â‚©' + parseInt(c.base_salary || 0).toLocaleString() + '</td><td><span class="badge ' + (c.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (c.status === 'active' ? 'ìœ íš¨' : 'ë§Œë£Œ') + '</span></td><td><button onclick="editContract(' + c.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

// ë…ë¦½íƒ­ìš© wrapper
function renderLedgerTable() { 
    // íšŒê³„ê´€ë¦¬ ì„œë¸Œíƒ­ìš©
    const el = document.getElementById('ledgerTableBody');
    if (el) {
        const origFunc = renderLedgerTable.toString();
        // ê¸°ì¡´ í•¨ìˆ˜ ì‹¤í–‰
    }
    // ë…ë¦½íƒ­ìš©
    renderLedgerTable2();
}

// ==================== ì„¸ë¬´ì„œë¥˜ ë³´ê´€í•¨ ====================

let taxDocList = [];
let currentTaxFilter = 'all';

// ==================== ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨ ====================

let corpDocList = [];
let currentCorpFilter = 'all';

// ==================== ë²•ì¸ ê´€ë¦¬ ====================

let entityList = [];
let currentEntityId = null;

// ==================== ìê¸ˆ ì§‘í–‰/íšŒìˆ˜ ê´€ë¦¬ ====================

let fundList = [];

// ìê¸ˆ ë°ì´í„° ë¡œë“œ
async function loadFunds() {
    // ê¸°ì¡´ ìˆ˜ë™ ë“±ë¡ ìê¸ˆ ë‚´ì—­
    const manualData = await supabaseCall('fund_transfers', 'GET', null, '?order=transfer_date.desc');
    if (manualData) fundList = manualData;
    
    // ë¸Œë¡œì»´í¼ë‹ˆ í˜„ê¸ˆì¶œë‚©ì¥ì—ì„œ ìë™ ê°€ì ¸ì˜¤ê¸° (í…Œì´ë¸” ì—†ìœ¼ë©´ ë¬´ì‹œ)
    let bcCashbook = null;
    try { bcCashbook = await supabaseCall('bro_cashbook', 'GET', null, '?order=trans_date.desc&limit=50'); } catch(e) {}
    
    // ë¸Œë¡œëª¨í„°ìŠ¤ í˜„ê¸ˆì¶œë‚©ì¥ì—ì„œ ìë™ ê°€ì ¸ì˜¤ê¸° (í…Œì´ë¸” ì—†ìœ¼ë©´ ë¬´ì‹œ)
    let bmCashbook = null;
    try { bmCashbook = await supabaseCall('bro_cashbook', 'GET', null, '?order=trans_date.desc&limit=50'); } catch(e) {}
    
    // ìë™ ì—°ë™ ë°ì´í„°ë¥¼ fundList í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì„œ í•©ì¹˜ê¸°
    const autoFunds = [];
    
    // ë¸Œë¡œì»´í¼ë‹ˆ ë°ì´í„° ë³€í™˜
    if (bcCashbook && bcCashbook.length) {
        bcCashbook.forEach(c => {
            autoFunds.push({
                id: 'bc_' + c.id,
                transfer_date: c.trans_date,
                subsidiary: 'brocompany',
                transfer_type: parseFloat(c.deposit || 0) > 0 ? 'in' : 'out',
                amount: parseFloat(c.deposit || 0) > 0 ? c.deposit : c.withdrawal,
                purpose: c.description || c.counterparty || '-',
                status: 'completed',
                auto_sync: true
            });
        });
    }
    
    // ë¸Œë¡œëª¨í„°ìŠ¤ ë°ì´í„° ë³€í™˜
    if (bmCashbook && bmCashbook.length) {
        bmCashbook.forEach(c => {
            autoFunds.push({
                id: 'bm_' + c.id,
                transfer_date: c.trans_date,
                subsidiary: 'bromotors',
                transfer_type: parseFloat(c.deposit || 0) > 0 ? 'in' : 'out',
                amount: parseFloat(c.deposit || 0) > 0 ? c.deposit : c.withdrawal,
                purpose: c.description || c.counterparty || '-',
                status: 'completed',
                auto_sync: true
            });
        });
    }
    
    // ìˆ˜ë™ + ìë™ í•©ì¹˜ê¸° (ë‚ ì§œìˆœ ì •ë ¬)
    fundList = [...fundList, ...autoFunds].sort((a, b) => {
        const dateA = a.transfer_date || '';
        const dateB = b.transfer_date || '';
        return dateB.localeCompare(dateA);
    });
    
    renderFundTable();
    updateFundStats();
    updateSubsidiaryStats();
}

// ìê¸ˆ í†µê³„ ì—…ë°ì´íŠ¸
function updateFundStats() {
    const totalOut = fundList.filter(f => f.transfer_type === 'out' && f.status === 'completed').reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const totalIn = fundList.filter(f => f.transfer_type === 'in' && f.status === 'completed').reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const outstanding = totalOut - totalIn;
    
    // ì´ë²ˆë‹¬
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthlyOut = fundList.filter(f => f.transfer_type === 'out' && f.status === 'completed' && f.transfer_date?.startsWith(thisMonth)).reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const monthlyIn = fundList.filter(f => f.transfer_type === 'in' && f.status === 'completed' && f.transfer_date?.startsWith(thisMonth)).reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const monthlyNet = monthlyIn - monthlyOut;
    
    document.getElementById('fund-total-out').textContent = 'â‚©' + totalOut.toLocaleString();
    document.getElementById('fund-total-in').textContent = 'â‚©' + totalIn.toLocaleString();
    document.getElementById('fund-outstanding').textContent = 'â‚©' + outstanding.toLocaleString();
    document.getElementById('fund-monthly-net').textContent = (monthlyNet >= 0 ? 'â‚©' : '-â‚©') + Math.abs(monthlyNet).toLocaleString();
    document.getElementById('fund-monthly-net').className = 'text-xl font-bold ' + (monthlyNet >= 0 ? 'text-blue-400' : 'text-red-400');
    
    // ê·¸ë£¹ ì”ì•¡
    document.getElementById('group-balance').textContent = 'â‚©' + outstanding.toLocaleString();
}

// ìíšŒì‚¬ í˜„í™© ì—…ë°ì´íŠ¸ (HQ ë°ì´í„° ê¸°ë°˜)
async function updateSubsidiaryStats() {
    const thisMonth = new Date().toISOString().slice(0, 7);
    
    try {
        // ============ ë¸Œë¡œëª¨í„°ìŠ¤ (êµ¬ ë¸Œë¡œì»´í¼ë‹ˆ) - bro_cashbook í…Œì´ë¸” ============
        const bcCashbook = await supabaseCall('bro_cashbook', 'GET', null, '?order=date.desc&limit=1000');
        const bcThisMonth = (bcCashbook || []).filter(c => (c.date || '').startsWith(thisMonth));
        
        // ì´ë²ˆë‹¬ ìˆ˜ê¸ˆ (ìˆ˜ì…)
        const bcRevenue = bcThisMonth.filter(c => c.type === 'income').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
        // ì´ë²ˆë‹¬ ì •ì‚° (ì§€ì¶œ ì¤‘ ì •ì‚° ê´€ë ¨)
        const bcSettlement = bcThisMonth.filter(c => c.type === 'expense').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
        // ìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ)
        const bcProfit = bcRevenue - bcSettlement;
        
        document.getElementById('bc-revenue').textContent = 'â‚©' + bcRevenue.toLocaleString();
        document.getElementById('bc-settlement').textContent = 'â‚©' + bcSettlement.toLocaleString();
        document.getElementById('bc-profit').textContent = 'â‚©' + bcProfit.toLocaleString();
        
        // ============ ë¦¬ìŠ¤&ë Œíƒˆ (êµ¬ ë¸Œë¡œëª¨í„°ìŠ¤) - ledger + contracts í…Œì´ë¸” ============
        const bmLedger = await supabaseCall('ledger', 'GET', null, '?order=date.desc&limit=1000');
        const bmThisMonth = (bmLedger || []).filter(l => (l.date || '').startsWith(thisMonth));
        
        // ì´ë²ˆë‹¬ ë Œíƒˆìˆ˜ìµ
        const bmRevenue = bmThisMonth.filter(l => l.type === 'income' || l.type === 'ìˆ˜ì…').reduce((s, l) => s + parseFloat(l.amount || 0), 0);
        const bmExpense = bmThisMonth.filter(l => l.type === 'expense' || l.type === 'ì§€ì¶œ').reduce((s, l) => s + parseFloat(l.amount || 0), 0);
        
        // ë¯¸ìˆ˜ê¸ˆ - contracts í…Œì´ë¸”ì—ì„œ arrears í•©ê³„
        const bmContracts = await supabaseCall('contracts', 'GET', null, '?select=arrears');
        const bmArrears = (bmContracts || []).reduce((s, c) => s + parseFloat(c.arrears || 0), 0);
        
        // ìˆœìˆ˜ìµ
        const bmProfit = bmRevenue - bmExpense;
        
        document.getElementById('bm-revenue').textContent = 'â‚©' + bmRevenue.toLocaleString();
        document.getElementById('bm-arrears').textContent = 'â‚©' + bmArrears.toLocaleString();
        document.getElementById('bm-profit').textContent = 'â‚©' + bmProfit.toLocaleString();
        
        // ============ ê·¸ë£¹ í•©ê³„ ============
        const totalRevenue = bcRevenue + bmRevenue;
        const totalProfit = bcProfit + bmProfit;
        
        // ì „ì²´ ìê¸ˆ ì”ì•¡
        const bcBalance = (bcCashbook || []).reduce((s, c) => {
            if (c.type === 'income') return s + parseFloat(c.amount || 0);
            if (c.type === 'expense') return s - parseFloat(c.amount || 0);
            return s;
        }, 0);
        
        const bmBalance = (bmLedger || []).reduce((s, l) => {
            if (l.type === 'income' || l.type === 'ìˆ˜ì…') return s + parseFloat(l.amount || 0);
            if (l.type === 'expense' || l.type === 'ì§€ì¶œ') return s - parseFloat(l.amount || 0);
            return s;
        }, 0);
        
        document.getElementById('group-revenue').textContent = 'â‚©' + totalRevenue.toLocaleString();
        document.getElementById('group-profit').textContent = 'â‚©' + totalProfit.toLocaleString();
        document.getElementById('group-balance').textContent = 'â‚©' + (bcBalance + bmBalance).toLocaleString();
        
        console.log('ê·¸ë£¹ì‚¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', { bcRevenue, bcSettlement, bmRevenue, bmArrears });
        
    } catch (err) {
        console.error('ê·¸ë£¹ì‚¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
        // ì—ëŸ¬ ì‹œ 0ìœ¼ë¡œ í‘œì‹œ
        document.getElementById('bc-revenue').textContent = 'â‚©0';
        document.getElementById('bc-settlement').textContent = 'â‚©0';
        document.getElementById('bc-profit').textContent = 'â‚©0';
        document.getElementById('bm-revenue').textContent = 'â‚©0';
        document.getElementById('bm-arrears').textContent = 'â‚©0';
        document.getElementById('bm-profit').textContent = 'â‚©0';
        document.getElementById('group-revenue').textContent = 'â‚©0';
        document.getElementById('group-profit').textContent = 'â‚©0';
        document.getElementById('group-balance').textContent = 'â‚©0';
    }
}

// ìê¸ˆ í…Œì´ë¸” ë Œë”
function renderFundTable() {
    const tbody = document.getElementById('fundTableBody');
    
    if (!fundList.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ìê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const subsidiaryNames = { brocompany: 'ë¸Œë¡œì»´í¼ë‹ˆ', bromotors: 'ë¸Œë¡œëª¨í„°ìŠ¤' };
    const typeNames = { out: 'ì¶œê¸ˆ', in: 'ì…ê¸ˆ' };
    const typeColors = { out: 'text-red-400', in: 'text-green-400' };
    const statusBadges = { completed: 'badge-active', pending: 'badge-pending', cancelled: 'badge-error' };
    const statusNames = { completed: 'ì™„ë£Œ', pending: 'ëŒ€ê¸°', cancelled: 'ì·¨ì†Œ' };
    
    tbody.innerHTML = fundList.slice(0, 20).map(f => {
        const isAuto = f.auto_sync === true;
        return '<tr class="' + (isAuto ? 'opacity-80' : '') + '">' +
        '<td>' + (f.transfer_date || '-') + '</td>' +
        '<td class="font-bold">' + (subsidiaryNames[f.subsidiary] || f.subsidiary || '-') + (isAuto ? ' <span class="text-xs text-blue-400">ğŸ”„</span>' : '') + '</td>' +
        '<td><span class="' + (typeColors[f.transfer_type] || '') + ' font-bold">' + (typeNames[f.transfer_type] || f.transfer_type) + '</span></td>' +
        '<td class="text-right font-bold ' + (typeColors[f.transfer_type] || '') + '">' + (f.transfer_type === 'out' ? '-' : '+') + 'â‚©' + parseInt(f.amount || 0).toLocaleString() + '</td>' +
        '<td class="text-sm">' + (f.purpose || '-') + '</td>' +
        '<td><span class="badge ' + (statusBadges[f.status] || 'badge-pending') + '">' + (statusNames[f.status] || f.status) + '</span></td>' +
        '<td>' +
        (isAuto ? '<span class="text-xs text-gray-500">ìë™ì—°ë™</span>' : 
        '<button onclick="editFund(' + f.id + ')" class="btn-secondary btn-sm mr-1">âœï¸</button>' +
        '<button onclick="deleteFund(' + f.id + ')" class="btn-danger btn-sm">ğŸ—‘ï¸</button>') +
        '</td>' +
        '</tr>';
    }).join('');
}

// ìê¸ˆ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openFundModal() {
    document.getElementById('fundForm').reset();
    document.getElementById('fund-id').value = '';
    document.getElementById('fund-date').value = new Date().toISOString().slice(0, 10);
    openModal('fundModal');
}

// ìê¸ˆ ì €ì¥
async function submitFund(e) {
    e.preventDefault();
    
    const id = document.getElementById('fund-id').value;
    const data = {
        transfer_date: document.getElementById('fund-date').value,
        transfer_type: document.getElementById('fund-type').value,
        subsidiary: document.getElementById('fund-subsidiary').value,
        amount: parseFloat(document.getElementById('fund-amount').value) || 0,
        purpose: document.getElementById('fund-purpose').value || null,
        status: document.getElementById('fund-status').value,
        memo: document.getElementById('fund-memo').value || null
    };
    
    let result;
    if (id) {
        result = await supabaseCall('fund_transfers', 'PATCH', data, '?id=eq.' + id);
        if (result) {
            const idx = fundList.findIndex(f => f.id == id);
            if (idx >= 0) fundList[idx] = { ...fundList[idx], ...data };
            showToast('ìê¸ˆ ë‚´ì—­ ìˆ˜ì • ì™„ë£Œ');
        }
    } else {
        result = await supabaseCall('fund_transfers', 'POST', data);
        if (result && result[0]) {
            fundList.unshift(result[0]);
            showToast('ìê¸ˆ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    closeModal('fundModal');
    renderFundTable();
    updateFundStats();
}

// ìê¸ˆ ìˆ˜ì •
function editFund(id) {
    const fund = fundList.find(f => f.id === id);
    if (!fund) return;
    
    document.getElementById('fund-id').value = fund.id;
    document.getElementById('fund-date').value = fund.transfer_date || '';
    document.getElementById('fund-type').value = fund.transfer_type || '';
    document.getElementById('fund-subsidiary').value = fund.subsidiary || '';
    document.getElementById('fund-amount').value = fund.amount || '';
    document.getElementById('fund-purpose').value = fund.purpose || '';
    document.getElementById('fund-status').value = fund.status || 'completed';
    document.getElementById('fund-memo').value = fund.memo || '';
    
    openModal('fundModal');
}

// ìê¸ˆ ì‚­ì œ
async function deleteFund(id) {
    if (!confirm('ì´ ìê¸ˆ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await supabaseCall('fund_transfers', 'DELETE', null, '?id=eq.' + id);
    fundList = fundList.filter(f => f.id !== id);
    
    showToast('ìê¸ˆ ë‚´ì—­ ì‚­ì œ ì™„ë£Œ');
    renderFundTable();
    updateFundStats();
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ë²•ì¸)
async function loadEntities() {
    const data = await supabaseCall('entities', 'GET', null, '?order=created_at.desc');
    if (data) entityList = data;
    renderEntityCards();
}

// ë²•ì¸ ì¹´ë“œ ë Œë”
function renderEntityCards() {
    const totalDocs = corpDocList.length;
    
    document.getElementById('entity-total').textContent = entityList.length + 'ê°œ';
    document.getElementById('entity-active').textContent = entityList.filter(e => e.status === 'active').length + 'ê°œ';
    document.getElementById('entity-inactive').textContent = entityList.filter(e => e.status !== 'active').length + 'ê°œ';
    document.getElementById('entity-docs').textContent = totalDocs + 'ê°œ';
    
    const container = document.getElementById('entityCardList');
    
    if (!entityList.length) {
        container.innerHTML = '<div class="glass-card rounded-xl p-8 text-center col-span-full"><p class="text-gray-500">ë“±ë¡ëœ ë²•ì¸ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }
    
    container.innerHTML = entityList.map(e => {
        const docCount = corpDocList.filter(d => d.entity_name === e.name).length;
        const statusBadge = e.status === 'active' ? '<span class="badge badge-active">í™œì„±</span>' : '<span class="badge badge-pending">ë¹„í™œì„±</span>';
        
        return '<div class="glass-card rounded-xl p-4 cursor-pointer hover:border-blue-400/50 transition-all" onclick="openEntityDetail(' + e.id + ')">' +
            '<div class="flex justify-between items-start mb-3">' +
            '<h3 class="text-lg font-bold text-blue-400">' + e.name + '</h3>' +
            statusBadge +
            '</div>' +
            '<div class="space-y-2 text-sm">' +
            '<div class="flex justify-between"><span class="text-gray-400">ì‚¬ì—…ìë²ˆí˜¸</span><span>' + (e.business_no || '-') + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-400">ëŒ€í‘œì</span><span>' + (e.ceo_name || '-') + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-400">ëŒ€í‘œ ì—°ë½ì²˜</span><span>' + (e.ceo_phone || '-') + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-400">ì²¨ë¶€ì„œë¥˜</span><span class="text-blue-400">' + docCount + 'ê°œ</span></div>' +
            '</div>' +
            '</div>';
    }).join('');
}

// ë²•ì¸ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openEntityModal() {
    document.getElementById('entityForm').reset();
    document.getElementById('entity-id').value = '';
    document.getElementById('entityModalTitle').textContent = 'ğŸ¢ ë²•ì¸ ë“±ë¡';
    openModal('entityModal');
}

// ë²•ì¸ ì €ì¥
async function submitEntity(e) {
    e.preventDefault();
    
    const id = document.getElementById('entity-id').value;
    const data = {
        name: document.getElementById('entity-name').value,
        status: document.getElementById('entity-status').value,
        business_no: document.getElementById('entity-bizno').value || null,
        corporate_no: document.getElementById('entity-corpno').value || null,
        business_type: document.getElementById('entity-biztype').value || null,
        business_category: document.getElementById('entity-bizcategory').value || null,
        address: document.getElementById('entity-address').value || null,
        phone: document.getElementById('entity-phone').value || null,
        founded_date: document.getElementById('entity-founddate').value || null,
        ceo_name: document.getElementById('entity-ceoname').value || null,
        ceo_phone: document.getElementById('entity-ceophone').value || null,
        ceo_resident_no: document.getElementById('entity-ceoresidentno').value || null,
        ceo_email: document.getElementById('entity-ceoemail').value || null,
        ceo_address: document.getElementById('entity-ceoaddress').value || null,
        memo: document.getElementById('entity-memo').value || null
    };
    
    let result;
    if (id) {
        result = await supabaseCall('entities', 'PATCH', data, '?id=eq.' + id);
        if (result) {
            const idx = entityList.findIndex(e => e.id == id);
            if (idx >= 0) entityList[idx] = { ...entityList[idx], ...data };
            showToast('ë²•ì¸ ì •ë³´ ìˆ˜ì • ì™„ë£Œ');
        }
    } else {
        result = await supabaseCall('entities', 'POST', data);
        if (result && result[0]) {
            entityList.unshift(result[0]);
            showToast('ë²•ì¸ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    closeModal('entityModal');
    renderEntityCards();
}

// ë²•ì¸ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
function openEntityDetail(id) {
    const entity = entityList.find(e => e.id === id);
    if (!entity) return;
    
    currentEntityId = id;
    document.getElementById('entityDetailName').textContent = entity.name;
    
    // ê¸°ë³¸ì •ë³´ í‘œì‹œ
    const infoHtml = `
        <div class="grid grid-cols-2 gap-4">
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</p>
                <p class="font-bold">${entity.business_no || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ë²•ì¸ë“±ë¡ë²ˆí˜¸</p>
                <p class="font-bold">${entity.corporate_no || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì—…íƒœ</p>
                <p class="font-bold">${entity.business_type || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì—…ì¢…</p>
                <p class="font-bold">${entity.business_category || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3 col-span-2">
                <p class="text-gray-400 text-xs">ì‚¬ì—…ì¥ ì£¼ì†Œ</p>
                <p class="font-bold">${entity.address || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ëŒ€í‘œ ì „í™”</p>
                <p class="font-bold">${entity.phone || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì„¤ë¦½ì¼</p>
                <p class="font-bold">${entity.founded_date || '-'}</p>
            </div>
        </div>
        <div class="border-t border-white/10 pt-4 mt-4">
            <h4 class="text-blue-400 font-bold mb-3">ğŸ‘¤ ëŒ€í‘œì ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ëŒ€í‘œìëª…</p>
                    <p class="font-bold">${entity.ceo_name || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ì—°ë½ì²˜</p>
                    <p class="font-bold">${entity.ceo_phone || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</p>
                    <p class="font-bold">${entity.ceo_resident_no || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ì´ë©”ì¼</p>
                    <p class="font-bold">${entity.ceo_email || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3 col-span-2">
                    <p class="text-gray-400 text-xs">ëŒ€í‘œì ì£¼ì†Œ</p>
                    <p class="font-bold">${entity.ceo_address || '-'}</p>
                </div>
            </div>
        </div>
        ${entity.memo ? '<div class="border-t border-white/10 pt-4 mt-4"><p class="text-gray-400 text-xs">ë©”ëª¨</p><p>' + entity.memo + '</p></div>' : ''}
    `;
    
    document.getElementById('entityDetailInfo').innerHTML = infoHtml;
    
    // ì²¨ë¶€ì„œë¥˜ ë¡œë“œ
    renderEntityDocs(entity.name);
    
    showEntityDetailTab('info');
    openModal('entityDetailModal');
}

// ë²•ì¸ ìƒì„¸ íƒ­ ì „í™˜
function showEntityDetailTab(tab) {
    ['info', 'docs'].forEach(t => {
        document.getElementById('entityDetailContent-' + t).classList.add('hidden');
        document.getElementById('entityDetailTab-' + t).classList.remove('bg-blue-500/20', 'text-blue-400');
        document.getElementById('entityDetailTab-' + t).classList.add('text-gray-400');
    });
    document.getElementById('entityDetailContent-' + tab).classList.remove('hidden');
    document.getElementById('entityDetailTab-' + tab).classList.add('bg-blue-500/20', 'text-blue-400');
    document.getElementById('entityDetailTab-' + tab).classList.remove('text-gray-400');
}

// ë²•ì¸ë³„ ì²¨ë¶€ì„œë¥˜ ë Œë”
function renderEntityDocs(entityName) {
    console.log('renderEntityDocs - entityName:', entityName);
    console.log('corpDocList:', corpDocList);
    console.log('corpDocList entity_names:', corpDocList.map(d => d.entity_name));
    
    const docs = corpDocList.filter(d => d.entity_name === entityName);
    console.log('filtered docs:', docs);
    
    const tbody = document.getElementById('entityDocTableBody');
    
    if (!docs.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const categoryNames = { business: 'ì‚¬ì—…ìë“±ë¡ì¦', corporate: 'ë“±ê¸°ë¶€ë“±ë³¸', contract: 'ê³„ì•½ì„œ', license: 'ì¸í—ˆê°€', other: 'ê¸°íƒ€' };
    
    tbody.innerHTML = docs.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge badge-info">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td><button onclick="downloadCorpDoc(' + d.id + ')" class="btn-secondary btn-sm">ğŸ“¥</button></td>' +
            '</tr>';
    }).join('');
}

// í˜„ì¬ ë²•ì¸ ìˆ˜ì •
function editCurrentEntity() {
    const entity = entityList.find(e => e.id === currentEntityId);
    if (!entity) return;
    
    closeModal('entityDetailModal');
    
    document.getElementById('entity-id').value = entity.id;
    document.getElementById('entity-name').value = entity.name || '';
    document.getElementById('entity-status').value = entity.status || 'active';
    document.getElementById('entity-bizno').value = entity.business_no || '';
    document.getElementById('entity-corpno').value = entity.corporate_no || '';
    document.getElementById('entity-biztype').value = entity.business_type || '';
    document.getElementById('entity-bizcategory').value = entity.business_category || '';
    document.getElementById('entity-address').value = entity.address || '';
    document.getElementById('entity-phone').value = entity.phone || '';
    document.getElementById('entity-founddate').value = entity.founded_date || '';
    document.getElementById('entity-ceoname').value = entity.ceo_name || '';
    document.getElementById('entity-ceophone').value = entity.ceo_phone || '';
    document.getElementById('entity-ceoresidentno').value = entity.ceo_resident_no || '';
    document.getElementById('entity-ceoemail').value = entity.ceo_email || '';
    document.getElementById('entity-ceoaddress').value = entity.ceo_address || '';
    document.getElementById('entity-memo').value = entity.memo || '';
    
    document.getElementById('entityModalTitle').textContent = 'ğŸ¢ ë²•ì¸ ìˆ˜ì •';
    openModal('entityModal');
}

// í˜„ì¬ ë²•ì¸ ì‚­ì œ
async function deleteCurrentEntity() {
    if (!confirm('ì´ ë²•ì¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await supabaseCall('entities', 'DELETE', null, '?id=eq.' + currentEntityId);
    entityList = entityList.filter(e => e.id !== currentEntityId);
    
    closeModal('entityDetailModal');
    showToast('ë²•ì¸ ì‚­ì œ ì™„ë£Œ');
    renderEntityCards();
}

// ë²•ì¸ ì„œë¥˜ ì²¨ë¶€ (í˜„ì¬ ë²•ì¸ì—)
function openEntityDocUpload() {
    const entity = entityList.find(e => e.id === currentEntityId);
    if (!entity) return;
    
    closeModal('entityDetailModal');
    document.getElementById('corpdoc-entity').value = entity.name;
    openDocUploadModal();
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ë²•ì¸ì„œë¥˜)
async function loadCorpDocuments() {
    const data = await supabaseCall('corp_documents', 'GET', null, '?order=created_at.desc');
    if (data) corpDocList = data;
    renderCorpDocTable();
}

// ì¹´í…Œê³ ë¦¬ í•„í„° (ë²•ì¸ì„œë¥˜)
function filterCorpDocs(category) {
    currentCorpFilter = category;
    ['all', 'business', 'corporate', 'contract', 'license', 'other'].forEach(c => {
        const tab = document.getElementById('corpDocTab-' + c);
        if (tab) {
            tab.classList.remove('bg-blue-500/20', 'text-blue-400');
            tab.classList.add('text-gray-400');
        }
    });
    const activeTab = document.getElementById('corpDocTab-' + category);
    if (activeTab) {
        activeTab.classList.add('bg-blue-500/20', 'text-blue-400');
        activeTab.classList.remove('text-gray-400');
    }
    renderCorpDocTable();
}

// í…Œì´ë¸” ë Œë” (ë²•ì¸ì„œë¥˜)
function renderCorpDocTable() {
    const searchFilter = (document.getElementById('corpDocSearch')?.value || '').toLowerCase();
    const entityFilter = document.getElementById('corpDocEntity')?.value || '';
    
    let filtered = corpDocList.filter(d => {
        if (currentCorpFilter !== 'all' && d.category !== currentCorpFilter) return false;
        if (searchFilter && !(d.file_name || '').toLowerCase().includes(searchFilter) && !(d.description || '').toLowerCase().includes(searchFilter)) return false;
        if (entityFilter && d.entity_name !== entityFilter) return false;
        return true;
    });
    
    // í†µê³„
    document.getElementById('corpdoc-total').textContent = corpDocList.length + 'ê°œ';
    document.getElementById('corpdoc-business').textContent = corpDocList.filter(d => d.category === 'business').length + 'ê°œ';
    document.getElementById('corpdoc-corporate').textContent = corpDocList.filter(d => d.category === 'corporate').length + 'ê°œ';
    document.getElementById('corpdoc-contract').textContent = corpDocList.filter(d => d.category === 'contract').length + 'ê°œ';
    document.getElementById('corpdoc-license').textContent = corpDocList.filter(d => d.category === 'license').length + 'ê°œ';
    document.getElementById('corpdoc-other').textContent = corpDocList.filter(d => d.category === 'other').length + 'ê°œ';
    
    // ë²•ì¸ í•„í„° ì˜µì…˜ ë¡œë“œ
    const entityFilterEl = document.getElementById('corpDocEntity');
    if (entityFilterEl && entityFilterEl.options.length <= 1) {
        const entities = [...new Set(corpDocList.map(d => d.entity_name).filter(Boolean))];
        entities.forEach(e => { entityFilterEl.add(new Option(e, e)); });
    }
    
    const tbody = document.getElementById('corpDocTableBody');
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const categoryNames = { business: 'ì‚¬ì—…ìë“±ë¡ì¦', corporate: 'ë“±ê¸°ë¶€ë“±ë³¸', contract: 'ê³„ì•½ì„œ', license: 'ì¸í—ˆê°€', other: 'ê¸°íƒ€' };
    const categoryColors = { business: 'badge-info', corporate: 'badge-active', contract: 'badge-pending', license: 'badge-success', other: 'badge-error' };
    
    tbody.innerHTML = filtered.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge ' + (categoryColors[d.category] || 'badge-pending') + '">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td>' + (d.entity_name || '-') + '</td>' +
            '<td class="text-sm text-gray-400">' + (d.description || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td>' +
            '<button onclick="downloadCorpDoc(' + d.id + ')" class="btn-secondary btn-sm mr-1">ğŸ“¥</button>' +
            '<button onclick="deleteCorpDoc(' + d.id + ')" class="btn-danger btn-sm">ğŸ—‘ï¸</button>' +
            '</td>' +
            '</tr>';
    }).join('');
}

// ì—…ë¡œë“œ ëª¨ë‹¬ ì—´ê¸° (ë²•ì¸ì„œë¥˜)
function openDocUploadModal() {
    document.getElementById('docUploadForm').reset();
    document.getElementById('docUploadProgress').classList.add('hidden');
    document.getElementById('selectedDocFileList').innerHTML = '';
    openModal('docUploadModal');
}

// íŒŒì¼ ê°œìˆ˜ ì²´í¬ (ë²•ì¸ì„œë¥˜)
function checkDocFileLimit(input) {
    const files = input.files;
    const listEl = document.getElementById('selectedDocFileList');
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        input.value = '';
        listEl.innerHTML = '';
        return;
    }
    
    if (files.length > 0) {
        let html = '<div class="mt-2 p-2 bg-black/30 rounded-lg"><p class="text-blue-400 text-xs mb-1">ì„ íƒëœ íŒŒì¼ (' + files.length + 'ê°œ):</p>';
        for (let i = 0; i < files.length; i++) {
            const size = (files[i].size / 1024).toFixed(1);
            html += '<div class="text-xs text-gray-400">â€¢ ' + files[i].name + ' (' + size + ' KB)</div>';
        }
        html += '</div>';
        listEl.innerHTML = html;
    } else {
        listEl.innerHTML = '';
    }
}

// íŒŒì¼ ì—…ë¡œë“œ (ë²•ì¸ì„œë¥˜)
async function submitDocUpload(e) {
    e.preventDefault();
    
    const category = document.getElementById('corpdoc-category').value;
    const entityName = document.getElementById('corpdoc-entity').value;
    const description = document.getElementById('corpdoc-desc').value;
    const fileInput = document.getElementById('corpdoc-file');
    const files = fileInput.files;
    
    if (!files.length) {
        showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    document.getElementById('docUploadProgress').classList.remove('hidden');
    const progressBar = document.getElementById('docUploadProgressBar');
    const progressText = document.getElementById('docUploadProgressText');
    
    let successCount = 0;
    let failCount = 0;
    
    // Storage ë²„í‚·ëª… (documentsë¡œ í†µì¼ - ê¸°ì¡´ ë²„í‚· ì‚¬ìš©)
    const BUCKET_NAME = 'documents';
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = Math.round(((i + 1) / files.length) * 100);
        progressBar.style.width = progress + '%';
        progressText.textContent = 'ì—…ë¡œë“œ ì¤‘... (' + (i + 1) + '/' + files.length + ')';
        
        try {
            const timestamp = Date.now();
            // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
            const ext = file.name.split('.').pop().toLowerCase();
            // Storage ê²½ë¡œëŠ” ì˜ë¬¸+ìˆ«ìë§Œ (í•œê¸€ íŒŒì¼ëª…ì€ DBì— ì €ì¥)
            const safeFileName = timestamp + '_' + Math.random().toString(36).substr(2, 8) + '.' + ext;
            const filePath = 'corp/' + category + '/' + safeFileName;
            
            console.log('Uploading to:', BUCKET_NAME + '/' + filePath, '(ì›ë³¸:', file.name, ')');
            
            // Supabase Storageì— ì§ì ‘ fetchë¡œ ì—…ë¡œë“œ
            const uploadRes = await fetch(SUPABASE_URL + '/storage/v1/object/' + BUCKET_NAME + '/' + filePath, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': file.type || 'application/octet-stream',
                    'x-upsert': 'true'
                },
                body: file
            });
            
            if (!uploadRes.ok) {
                const errText = await uploadRes.text();
                console.error('Storage upload failed:', uploadRes.status, errText);
                throw new Error('Upload failed: ' + uploadRes.status + ' - ' + errText);
            }
            
            console.log('Upload success, saving to DB...');
            
            const docData = {
                category: category,
                file_name: file.name,
                file_path: filePath,
                file_size: file.size,
                file_type: file.type,
                entity_name: entityName || null,
                description: description || null,
                uploaded_by: currentUser?.username || 'system'
            };
            
            const result = await supabaseCall('corp_documents', 'POST', docData);
            console.log('DB result:', result);
            
            if (result && result[0]) {
                corpDocList.unshift(result[0]);
                successCount++;
            } else {
                // DB ì €ì¥ ì‹¤íŒ¨í•´ë„ íŒŒì¼ì€ ì—…ë¡œë“œ ëìœ¼ë‹ˆ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                successCount++;
            }
        } catch (err) {
            console.error('Upload error:', file.name, err);
            failCount++;
        }
    }
    
    progressBar.style.width = '100%';
    
    if (failCount === 0) {
        showToast(successCount + 'ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    } else {
        showToast(successCount + 'ê°œ ì„±ê³µ, ' + failCount + 'ê°œ ì‹¤íŒ¨', 'error');
    }
    
    closeModal('docUploadModal');
    
    // corpDocList ë‹¤ì‹œ ë¡œë“œ
    await loadCorpDocuments();
    
    document.getElementById('docUploadProgress').classList.add('hidden');
    
    // ë²•ì¸ ìƒì„¸ì—ì„œ ì—…ë¡œë“œí•œ ê²½ìš°, í•´ë‹¹ ë²•ì¸ ìƒì„¸ ë‹¤ì‹œ ì—´ê¸°
    if (entityName && currentEntityId) {
        const entityId = currentEntityId;
        setTimeout(() => {
            openEntityDetail(entityId);
            setTimeout(() => showEntityDetailTab('docs'), 100);
        }, 200);
    }
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ë²•ì¸ì„œë¥˜)
async function downloadCorpDoc(id) {
    const doc = corpDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        // Public URLë¡œ ë‹¤ìš´ë¡œë“œ (documents ë²„í‚· ì‚¬ìš©)
        const url = SUPABASE_URL + '/storage/v1/object/public/documents/' + doc.file_path;
        console.log('Download URL:', url);
        const a = document.createElement('a');
        a.href = url;
        a.download = doc.file_name;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showToast('ë‹¤ìš´ë¡œë“œ ì‹œì‘');
    } catch (err) {
        console.error('Download error:', err);
        showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
    }
}

// íŒŒì¼ ì‚­ì œ (ë²•ì¸ì„œë¥˜)
async function deleteCorpDoc(id) {
    if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const doc = corpDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        // Storageì—ì„œ íŒŒì¼ ì‚­ì œ (documents ë²„í‚· ì‚¬ìš©)
        await fetch(SUPABASE_URL + '/storage/v1/object/documents/' + doc.file_path, {
            method: 'DELETE',
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            }
        });
        
        // DBì—ì„œ ë ˆì½”ë“œ ì‚­ì œ
        await supabaseCall('corp_documents', 'DELETE', null, '?id=eq.' + id);
        
        corpDocList = corpDocList.filter(d => d.id !== id);
        showToast('íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
        renderCorpDocTable();
    } catch (err) {
        console.error('Delete error:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ì„¸ë¬´ì„œë¥˜)
async function loadTaxDocuments() {
    const data = await supabaseCall('tax_documents', 'GET', null, '?order=created_at.desc');
    if (data) taxDocList = data;
    renderTaxDocTable();
}

// ì¹´í…Œê³ ë¦¬ í•„í„°
function filterTaxDocs(category) {
    currentTaxFilter = category;
    ['all', 'withholding', 'statement', 'other'].forEach(c => {
        const tab = document.getElementById('taxDocTab-' + c);
        if (tab) {
            tab.classList.remove('bg-blue-500/20', 'text-blue-400');
            tab.classList.add('text-gray-400');
        }
    });
    const activeTab = document.getElementById('taxDocTab-' + category);
    if (activeTab) {
        activeTab.classList.add('bg-blue-500/20', 'text-blue-400');
        activeTab.classList.remove('text-gray-400');
    }
    renderTaxDocTable();
}

// í…Œì´ë¸” ë Œë”
function renderTaxDocTable() {
    const searchFilter = (document.getElementById('taxDocSearch')?.value || '').toLowerCase();
    const monthFilter = document.getElementById('taxDocMonth')?.value || '';
    
    let filtered = taxDocList.filter(d => {
        if (currentTaxFilter !== 'all' && d.category !== currentTaxFilter) return false;
        if (searchFilter && !(d.file_name || '').toLowerCase().includes(searchFilter) && !(d.description || '').toLowerCase().includes(searchFilter)) return false;
        if (monthFilter && !d.document_date?.startsWith(monthFilter)) return false;
        return true;
    });
    
    // í†µê³„
    document.getElementById('taxdoc-total').textContent = taxDocList.length + 'ê°œ';
    document.getElementById('taxdoc-withholding').textContent = taxDocList.filter(d => d.category === 'withholding').length + 'ê°œ';
    document.getElementById('taxdoc-statement').textContent = taxDocList.filter(d => d.category === 'statement').length + 'ê°œ';
    document.getElementById('taxdoc-other').textContent = taxDocList.filter(d => d.category === 'other').length + 'ê°œ';
    
    const tbody = document.getElementById('taxDocTableBody');
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const categoryNames = { withholding: 'ì›ì²œì„¸ ì‹ ê³ ', statement: 'ì§€ê¸‰ëª…ì„¸ì„œ', other: 'ê¸°íƒ€ ì„œë¥˜' };
    const categoryColors = { withholding: 'badge-info', statement: 'badge-active', other: 'badge-pending' };
    
    tbody.innerHTML = filtered.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge ' + (categoryColors[d.category] || 'badge-pending') + '">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td>' + (d.document_date || '-') + '</td>' +
            '<td class="text-sm text-gray-400">' + (d.description || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td>' +
            '<button onclick="downloadTaxDoc(' + d.id + ')" class="btn-secondary btn-sm mr-1">ğŸ“¥</button>' +
            '<button onclick="deleteTaxDoc(' + d.id + ')" class="btn-danger btn-sm">ğŸ—‘ï¸</button>' +
            '</td>' +
            '</tr>';
    }).join('');
}

// ì—…ë¡œë“œ ëª¨ë‹¬ ì—´ê¸°
function openTaxUploadModal() {
    document.getElementById('taxUploadForm').reset();
    document.getElementById('uploadProgress').classList.add('hidden');
    document.getElementById('selectedFileList').innerHTML = '';
    openModal('taxUploadModal');
}

// íŒŒì¼ ê°œìˆ˜ ì²´í¬ (ìµœëŒ€ 10ê°œ)
function checkFileLimit(input) {
    const files = input.files;
    const listEl = document.getElementById('selectedFileList');
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        input.value = '';
        listEl.innerHTML = '';
        return;
    }
    
    // ì„ íƒëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ
    if (files.length > 0) {
        let html = '<div class="mt-2 p-2 bg-black/30 rounded-lg"><p class="text-blue-400 text-xs mb-1">ì„ íƒëœ íŒŒì¼ (' + files.length + 'ê°œ):</p>';
        for (let i = 0; i < files.length; i++) {
            const size = (files[i].size / 1024).toFixed(1);
            html += '<div class="text-xs text-gray-400">â€¢ ' + files[i].name + ' (' + size + ' KB)</div>';
        }
        html += '</div>';
        listEl.innerHTML = html;
    } else {
        listEl.innerHTML = '';
    }
}

// íŒŒì¼ ì—…ë¡œë“œ (ë‹¤ì¤‘)
async function submitTaxUpload(e) {
    e.preventDefault();
    
    const category = document.getElementById('taxdoc-category').value;
    const docDate = document.getElementById('taxdoc-date').value;
    const description = document.getElementById('taxdoc-desc').value;
    const fileInput = document.getElementById('taxdoc-file');
    const files = fileInput.files;
    
    if (!files.length) {
        showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ í‘œì‹œ
    document.getElementById('uploadProgress').classList.remove('hidden');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressText = document.getElementById('uploadProgressText');
    
    let successCount = 0;
    let failCount = 0;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = Math.round(((i + 1) / files.length) * 100);
        progressBar.style.width = progress + '%';
        progressText.textContent = 'ì—…ë¡œë“œ ì¤‘... (' + (i + 1) + '/' + files.length + ')';
        
        try {
            // íŒŒì¼ ê²½ë¡œ ìƒì„±
            const timestamp = Date.now();
            const safeName = file.name.replace(/[^a-zA-Z0-9ê°€-í£._-]/g, '_');
            const filePath = category + '/' + timestamp + '_' + safeName;
            
            // Supabase Storageì— ì—…ë¡œë“œ
            const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                .from('tax-documents')
                .upload(filePath, file);
            
            if (uploadError) {
                throw uploadError;
            }
            
            // ë©”íƒ€ë°ì´í„° ì €ì¥
            const docData = {
                category: category,
                file_name: file.name,
                file_path: filePath,
                file_size: file.size,
                file_type: file.type,
                description: description || null,
                document_date: docDate || null,
                uploaded_by: currentUser?.username || 'system'
            };
            
            const result = await supabaseCall('tax_documents', 'POST', docData);
            
            if (result && result[0]) {
                taxDocList.unshift(result[0]);
                successCount++;
            }
        } catch (err) {
            console.error('Upload error:', file.name, err);
            failCount++;
        }
    }
    
    progressBar.style.width = '100%';
    
    if (failCount === 0) {
        showToast(successCount + 'ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    } else {
        showToast(successCount + 'ê°œ ì„±ê³µ, ' + failCount + 'ê°œ ì‹¤íŒ¨', 'error');
    }
    
    closeModal('taxUploadModal');
    renderTaxDocTable();
    document.getElementById('uploadProgress').classList.add('hidden');
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ
async function downloadTaxDoc(id) {
    const doc = taxDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        const { data, error } = await window.supabaseClient.storage
            .from('tax-documents')
            .download(doc.file_path);
        
        if (error) throw error;
        
        // ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = doc.file_name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    } catch (err) {
        console.error('Download error:', err);
        showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
    }
}

// íŒŒì¼ ì‚­ì œ
async function deleteTaxDoc(id) {
    if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const doc = taxDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        // Storageì—ì„œ ì‚­ì œ
        await window.supabaseClient.storage
            .from('tax-documents')
            .remove([doc.file_path]);
        
        // DBì—ì„œ ì‚­ì œ
        await supabaseCall('tax_documents', 'DELETE', null, '?id=eq.' + id);
        
        taxDocList = taxDocList.filter(d => d.id !== id);
        showToast('íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
        renderTaxDocTable();
    } catch (err) {
        console.error('Delete error:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

// ==================== ğŸ” ë¹„ë°€ ê³µê°„ ====================
const SECRET_KEY = 'teambro_secret_';
let secretUnlocked = false;

// ë¹„ë°€ ê³µê°„ ì ‘ê·¼
function openSecretAccess() {
    const modal = document.createElement('div');
    modal.id = 'secretAccessModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content" style="max-width:400px">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">ğŸ”</div>
                <h3 class="text-xl font-bold text-purple-400">Secret Space</h3>
                <p class="text-gray-500 text-sm mt-2">Enter access code</p>
            </div>
            <form onsubmit="verifySecretCode(event)">
                <input type="password" id="secretCodeInput" class="input-field text-center text-2xl tracking-widest" 
                       placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20" autocomplete="off" autofocus>
                <div id="secretCodeError" class="text-red-400 text-sm text-center mt-2 hidden">ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤</div>
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="closeSecretModal()" class="flex-1 btn-secondary">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 btn-primary" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">ì…ì¥</button>
                </div>
            </form>
            <div class="text-center mt-4">
                <button onclick="showSetSecretCode()" class="text-xs text-gray-500 hover:text-purple-400">Settings</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('secretCodeInput').focus();
}

function closeSecretModal() {
    const modal = document.getElementById('secretAccessModal');
    if (modal) modal.remove();
}

function verifySecretCode(e) {
    e.preventDefault();
    const input = document.getElementById('secretCodeInput').value;
    const storedCode = localStorage.getItem(SECRET_KEY + 'code');
    
    if (!storedCode) {
        if (input.length >= 4) {
            localStorage.setItem(SECRET_KEY + 'code', btoa(input));
            secretUnlocked = true;
            closeSecretModal();
            enterSecretSpace();
            showToast('ë¹„ë°€ ì½”ë“œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        } else {
            document.getElementById('secretCodeError').textContent = '4ìë¦¬ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
            document.getElementById('secretCodeError').classList.remove('hidden');
        }
        return;
    }
    
    if (btoa(input) === storedCode) {
        secretUnlocked = true;
        closeSecretModal();
        enterSecretSpace();
    } else {
        document.getElementById('secretCodeError').textContent = 'ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤';
        document.getElementById('secretCodeError').classList.remove('hidden');
        document.getElementById('secretCodeInput').value = '';
    }
}

function showSetSecretCode() {
    const currentCode = prompt('í˜„ì¬ ì½”ë“œ ì…ë ¥ (ì²˜ìŒì´ë©´ ë¹ˆì¹¸):');
    const storedCode = localStorage.getItem(SECRET_KEY + 'code');
    
    if (storedCode && btoa(currentCode || '') !== storedCode) {
        showToast('í˜„ì¬ ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    const newCode = prompt('ìƒˆ ì½”ë“œ ì…ë ¥ (4ìë¦¬ ì´ìƒ):');
    if (newCode && newCode.length >= 4) {
        localStorage.setItem(SECRET_KEY + 'code', btoa(newCode));
        showToast('ì½”ë“œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    }
}

function enterSecretSpace() {
    document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('tab-secret').classList.remove('hidden');
    document.getElementById('pageTitle').textContent = 'ğŸ” Secret Space';
    loadSecretData();
    showSecretTab('cashbook');
}

function lockSecretSpace() {
    secretUnlocked = false;
    showTab('dashboard');
    showToast('Secret Space locked', 'info');
}

// ë¹„ë°€ íƒ­ ì „í™˜
function showSecretTab(tab) {
    document.querySelectorAll('.secret-tab-content').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('[id^="secret-tab-"]').forEach(b => {
        b.classList.remove('bg-purple-500/20', 'text-purple-400', 'border', 'border-purple-500/50');
        b.classList.add('bg-zinc-800', 'text-gray-400');
    });
    
    const content = document.getElementById('secret-content-' + tab);
    const btn = document.getElementById('secret-tab-' + tab);
    if (content) content.classList.remove('hidden');
    if (btn) {
        btn.classList.remove('bg-zinc-800', 'text-gray-400');
        btn.classList.add('bg-purple-500/20', 'text-purple-400', 'border', 'border-purple-500/50');
    }
    
    // ê° íƒ­ë³„ ë°ì´í„° ë¡œë“œ
    if (tab === 'cashbook') renderSecretCashbook();
    if (tab === 'ilsu') renderIlsuTable();
    if (tab === 'loan') renderLoanTable();
    if (tab === 'vault') renderSecretVault();
    if (tab === 'bigdata') { renderSecretMemos(); renderSecretTodos(); renderSecretContacts(); renderSecretSchedules(); }
}

function loadSecretData() {
    renderSecretCashbook();
}

// ==================== ğŸ’° ê¸ˆì „ì¶œë‚©ë¶€ ====================
function getSecretCashbook() {
    const data = localStorage.getItem(SECRET_KEY + 'cashbook');
    return data ? JSON.parse(data) : [];
}

function saveSecretCashbook(list) {
    localStorage.setItem(SECRET_KEY + 'cashbook', JSON.stringify(list));
}

function renderSecretCashbook() {
    const list = getSecretCashbook();
    const income = list.filter(c => c.type === 'income').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
    const expense = list.filter(c => c.type === 'expense').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthData = list.filter(c => c.date?.startsWith(thisMonth));
    const monthBalance = monthData.filter(c => c.type === 'income').reduce((s, c) => s + parseFloat(c.amount || 0), 0) -
                         monthData.filter(c => c.type === 'expense').reduce((s, c) => s + parseFloat(c.amount || 0), 0);
    
    document.getElementById('scb-income').textContent = 'â‚©' + income.toLocaleString();
    document.getElementById('scb-expense').textContent = 'â‚©' + expense.toLocaleString();
    document.getElementById('scb-balance').textContent = 'â‚©' + (income - expense).toLocaleString();
    document.getElementById('scb-month').textContent = 'â‚©' + monthBalance.toLocaleString();
    
    const tbody = document.getElementById('secretCashbookBody');
    if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
    }
    
    let balance = 0;
    const sorted = [...list].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
    sorted.forEach(c => {
        if (c.type === 'income') balance += parseFloat(c.amount || 0);
        else balance -= parseFloat(c.amount || 0);
        c._balance = balance;
    });
    
    tbody.innerHTML = sorted.reverse().map((c, i) => `
        <tr>
            <td>${c.date || '-'}</td>
            <td><span class="badge ${c.type === 'income' ? 'badge-active' : 'badge-error'}">${c.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'}</span></td>
            <td>${c.desc || '-'}</td>
            <td class="text-right font-bold ${c.type === 'income' ? 'text-green-400' : 'text-red-400'}">${c.type === 'income' ? '+' : '-'}â‚©${parseInt(c.amount || 0).toLocaleString()}</td>
            <td class="text-right">â‚©${parseInt(c._balance || 0).toLocaleString()}</td>
            <td><button onclick="deleteSecretCashbook(${list.length - 1 - i})" class="text-red-400 text-sm hover:text-red-300">ì‚­ì œ</button></td>
        </tr>
    `).join('');
}

function openSecretCashbookModal() {
    const type = prompt('êµ¬ë¶„ (1: ìˆ˜ì…, 2: ì§€ì¶œ):');
    if (!type) return;
    const date = prompt('ë‚ ì§œ (YYYY-MM-DD):', new Date().toISOString().slice(0, 10));
    const desc = prompt('ë‚´ìš©:');
    const amount = prompt('ê¸ˆì•¡:');
    
    if (!amount || isNaN(amount)) { showToast('ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
    
    const list = getSecretCashbook();
    list.unshift({
        type: type === '1' ? 'income' : 'expense',
        date: date || new Date().toISOString().slice(0, 10),
        desc: desc || '',
        amount: parseFloat(amount)
    });
    saveSecretCashbook(list);
    renderSecretCashbook();
    showToast('ë‚´ì—­ ì¶”ê°€ë¨');
}

function deleteSecretCashbook(index) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const list = getSecretCashbook();
    list.splice(index, 1);
    saveSecretCashbook(list);
    renderSecretCashbook();
}

// ==================== ğŸ“… ì¼ìˆ˜ì¥ë¶€ ====================
function getIlsuList() {
    const data = localStorage.getItem(SECRET_KEY + 'ilsu');
    return data ? JSON.parse(data) : [];
}

function saveIlsuList(list) {
    localStorage.setItem(SECRET_KEY + 'ilsu', JSON.stringify(list));
}

function renderIlsuTable() {
    const list = getIlsuList();
    const principal = list.reduce((s, i) => s + parseFloat(i.principal || 0), 0);
    const interest = list.reduce((s, i) => s + parseFloat(i.dailyInterest || 0) * parseInt(i.days || 0), 0);
    const collected = list.reduce((s, i) => s + parseFloat(i.collected || 0), 0);
    const active = list.filter(i => i.status === 'active').length;
    
    document.getElementById('ilsu-principal').textContent = 'â‚©' + principal.toLocaleString();
    document.getElementById('ilsu-interest').textContent = 'â‚©' + interest.toLocaleString();
    document.getElementById('ilsu-collected').textContent = 'â‚©' + collected.toLocaleString();
    document.getElementById('ilsu-active').textContent = active + 'ê±´';
    
    const tbody = document.getElementById('ilsuTableBody');
    if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
    }
    
    tbody.innerHTML = list.map((i, idx) => {
        const totalDue = parseFloat(i.principal || 0) + (parseFloat(i.dailyInterest || 0) * parseInt(i.days || 0));
        const remaining = totalDue - parseFloat(i.collected || 0);
        return `
        <tr>
            <td class="font-bold">${i.name || '-'}</td>
            <td class="text-right">â‚©${parseInt(i.principal || 0).toLocaleString()}</td>
            <td class="text-right text-yellow-400">â‚©${parseInt(i.dailyInterest || 0).toLocaleString()}</td>
            <td>${i.startDate || '-'}</td>
            <td>${i.days || 0}ì¼</td>
            <td class="text-right text-green-400">â‚©${parseInt(i.collected || 0).toLocaleString()}</td>
            <td class="text-right text-red-400">â‚©${parseInt(remaining).toLocaleString()}</td>
            <td><span class="badge ${i.status === 'completed' ? 'badge-active' : 'badge-pending'}">${i.status === 'completed' ? 'ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}</span></td>
            <td>
                <button onclick="collectIlsu(${idx})" class="btn-secondary btn-sm mr-1">íšŒìˆ˜</button>
                <button onclick="deleteIlsu(${idx})" class="text-red-400 text-sm">ì‚­ì œ</button>
            </td>
        </tr>`;
    }).join('');
}

function openIlsuModal() {
    const name = prompt('ì´ë¦„:');
    if (!name) return;
    const principal = prompt('ì›ê¸ˆ:');
    const dailyInterest = prompt('ì¼ ì´ì:');
    const days = prompt('ê¸°ê°„ (ì¼):');
    const startDate = prompt('ì‹œì‘ì¼ (YYYY-MM-DD):', new Date().toISOString().slice(0, 10));
    
    const list = getIlsuList();
    list.unshift({
        name,
        principal: parseFloat(principal) || 0,
        dailyInterest: parseFloat(dailyInterest) || 0,
        days: parseInt(days) || 30,
        startDate: startDate || new Date().toISOString().slice(0, 10),
        collected: 0,
        status: 'active'
    });
    saveIlsuList(list);
    renderIlsuTable();
    showToast('ì¼ìˆ˜ ë“±ë¡ë¨');
}

function collectIlsu(index) {
    const amount = prompt('íšŒìˆ˜ ê¸ˆì•¡:');
    if (!amount || isNaN(amount)) return;
    
    const list = getIlsuList();
    list[index].collected = (parseFloat(list[index].collected) || 0) + parseFloat(amount);
    
    const totalDue = parseFloat(list[index].principal || 0) + (parseFloat(list[index].dailyInterest || 0) * parseInt(list[index].days || 0));
    if (list[index].collected >= totalDue) {
        list[index].status = 'completed';
    }
    
    saveIlsuList(list);
    renderIlsuTable();
    showToast('íšŒìˆ˜ ì²˜ë¦¬ë¨');
}

function deleteIlsu(index) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const list = getIlsuList();
    list.splice(index, 1);
    saveIlsuList(list);
    renderIlsuTable();
}

// ==================== ğŸ¦ ëŒ€ì¶œì¥ë¶€ ====================
function getLoanList() {
    const data = localStorage.getItem(SECRET_KEY + 'loans');
    return data ? JSON.parse(data) : [];
}

function saveLoanList(list) {
    localStorage.setItem(SECRET_KEY + 'loans', JSON.stringify(list));
}

function renderLoanTable() {
    const list = getLoanList();
    const total = list.reduce((s, l) => s + parseFloat(l.amount || 0), 0);
    const interest = list.reduce((s, l) => s + (parseFloat(l.amount || 0) * (parseFloat(l.rate || 0) / 100)), 0);
    const paid = list.reduce((s, l) => s + parseFloat(l.paid || 0), 0);
    const active = list.filter(l => l.status === 'active').length;
    
    document.getElementById('loan-total').textContent = 'â‚©' + total.toLocaleString();
    document.getElementById('loan-interest').textContent = 'â‚©' + Math.round(interest).toLocaleString();
    document.getElementById('loan-paid').textContent = 'â‚©' + paid.toLocaleString();
    document.getElementById('loan-active').textContent = active + 'ê±´';
    
    const tbody = document.getElementById('loanTableBody');
    if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
        return;
    }
    
    tbody.innerHTML = list.map((l, idx) => {
        const totalDue = parseFloat(l.amount || 0) + (parseFloat(l.amount || 0) * (parseFloat(l.rate || 0) / 100));
        const remaining = totalDue - parseFloat(l.paid || 0);
        return `
        <tr>
            <td class="font-bold">${l.name || '-'}</td>
            <td class="text-right">â‚©${parseInt(l.amount || 0).toLocaleString()}</td>
            <td class="text-right text-yellow-400">${l.rate || 0}%</td>
            <td>${l.loanDate || '-'}</td>
            <td>${l.dueDate || '-'}</td>
            <td class="text-right text-green-400">â‚©${parseInt(l.paid || 0).toLocaleString()}</td>
            <td class="text-right text-red-400">â‚©${parseInt(remaining).toLocaleString()}</td>
            <td><span class="badge ${l.status === 'completed' ? 'badge-active' : 'badge-pending'}">${l.status === 'completed' ? 'ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}</span></td>
            <td>
                <button onclick="payLoan(${idx})" class="btn-secondary btn-sm mr-1">ìƒí™˜</button>
                <button onclick="deleteLoan(${idx})" class="text-red-400 text-sm">ì‚­ì œ</button>
            </td>
        </tr>`;
    }).join('');
}

function openLoanModal() {
    const name = prompt('ì´ë¦„:');
    if (!name) return;
    const amount = prompt('ëŒ€ì¶œê¸ˆ:');
    const rate = prompt('ì´ìœ¨ (%):');
    const loanDate = prompt('ëŒ€ì¶œì¼ (YYYY-MM-DD):', new Date().toISOString().slice(0, 10));
    const dueDate = prompt('ë§Œê¸°ì¼ (YYYY-MM-DD):');
    
    const list = getLoanList();
    list.unshift({
        name,
        amount: parseFloat(amount) || 0,
        rate: parseFloat(rate) || 0,
        loanDate: loanDate || new Date().toISOString().slice(0, 10),
        dueDate: dueDate || '',
        paid: 0,
        status: 'active'
    });
    saveLoanList(list);
    renderLoanTable();
    showToast('ëŒ€ì¶œ ë“±ë¡ë¨');
}

function payLoan(index) {
    const amount = prompt('ìƒí™˜ ê¸ˆì•¡:');
    if (!amount || isNaN(amount)) return;
    
    const list = getLoanList();
    list[index].paid = (parseFloat(list[index].paid) || 0) + parseFloat(amount);
    
    const totalDue = parseFloat(list[index].amount || 0) + (parseFloat(list[index].amount || 0) * (parseFloat(list[index].rate || 0) / 100));
    if (list[index].paid >= totalDue) {
        list[index].status = 'completed';
    }
    
    saveLoanList(list);
    renderLoanTable();
    showToast('ìƒí™˜ ì²˜ë¦¬ë¨');
}

function deleteLoan(index) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const list = getLoanList();
    list.splice(index, 1);
    saveLoanList(list);
    renderLoanTable();
}

// ==================== ğŸ”‘ ë¹„ë°€ê¸ˆê³  ====================
function getSecretVault() {
    const data = localStorage.getItem(SECRET_KEY + 'vault');
    return data ? JSON.parse(data) : [];
}

function saveSecretVault(vault) {
    localStorage.setItem(SECRET_KEY + 'vault', JSON.stringify(vault));
}

function renderSecretVault() {
    const vault = getSecretVault();
    const container = document.getElementById('secretVaultList');
    if (!vault.length) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4 col-span-full">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    container.innerHTML = vault.map((v, i) => `
        <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/20">
            <div class="flex items-center gap-3 mb-2">
                <div class="text-2xl">${v.icon || 'ğŸ”‘'}</div>
                <div class="flex-1">
                    <div class="font-bold text-purple-400">${v.title}</div>
                    <div class="text-xs text-gray-500">${v.username || ''}</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="showVaultItem(${i})" class="flex-1 btn-secondary btn-sm">ë³´ê¸°</button>
                <button onclick="copyVaultPassword(${i})" class="flex-1 btn-primary btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1)">ë³µì‚¬</button>
                <button onclick="deleteVaultItem(${i})" class="text-red-400 px-2">âœ•</button>
            </div>
        </div>
    `).join('');
}

function addSecretVault() {
    const title = prompt('í•­ëª© ì´ë¦„ (ì˜ˆ: ë„¤ì´ë²„ ê³„ì •):');
    if (!title) return;
    const username = prompt('ì•„ì´ë””/ì´ë©”ì¼:');
    const password = prompt('ë¹„ë°€ë²ˆí˜¸/ê°’:');
    const memo = prompt('ë©”ëª¨ (ì„ íƒ):');
    
    const vault = getSecretVault();
    vault.unshift({ title, username: username || '', password: password || '', memo: memo || '', icon: 'ğŸ”‘', date: new Date().toISOString() });
    saveSecretVault(vault);
    renderSecretVault();
    showToast('ê¸ˆê³ ì— ì €ì¥ë¨');
}

function showVaultItem(index) {
    const vault = getSecretVault();
    const v = vault[index];
    alert(`ğŸ“Œ ${v.title}\n\nğŸ‘¤ ì•„ì´ë””: ${v.username || '-'}\nğŸ”‘ ë¹„ë°€ë²ˆí˜¸: ${v.password || '-'}\nğŸ“ ë©”ëª¨: ${v.memo || '-'}`);
}

function copyVaultPassword(index) {
    const vault = getSecretVault();
    navigator.clipboard.writeText(vault[index].password || '');
    showToast('ë¹„ë°€ë²ˆí˜¸ ë³µì‚¬ë¨');
}

function deleteVaultItem(index) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const vault = getSecretVault();
    vault.splice(index, 1);
    saveSecretVault(vault);
    renderSecretVault();
}

// ==================== ğŸ“Š My BigData ====================
// ë©”ëª¨
function getSecretMemos() { return JSON.parse(localStorage.getItem(SECRET_KEY + 'memos') || '[]'); }
function saveSecretMemos(memos) { localStorage.setItem(SECRET_KEY + 'memos', JSON.stringify(memos)); }
function renderSecretMemos() {
    const memos = getSecretMemos();
    const container = document.getElementById('secretMemoList');
    if (!container) return;
    if (!memos.length) { container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ì €ì¥ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
    container.innerHTML = memos.map((m, i) => `
        <div class="p-3 rounded-lg bg-purple-500/10 border border-purple-500/20">
            <div class="flex justify-between items-start mb-2">
                <span class="text-xs text-gray-500">${m.date}</span>
                <button onclick="deleteSecretMemo(${i})" class="text-red-400 text-xs">ì‚­ì œ</button>
            </div>
            <p class="text-sm text-gray-300 whitespace-pre-wrap">${m.content}</p>
        </div>
    `).join('');
}
function addSecretMemo() {
    const content = prompt('ë©”ëª¨ ë‚´ìš©:');
    if (!content) return;
    const memos = getSecretMemos();
    memos.unshift({ content, date: new Date().toLocaleString('ko-KR') });
    saveSecretMemos(memos);
    renderSecretMemos();
    showToast('ë©”ëª¨ ì €ì¥ë¨');
}
function deleteSecretMemo(index) {
    if (!confirm('ì‚­ì œ?')) return;
    const memos = getSecretMemos();
    memos.splice(index, 1);
    saveSecretMemos(memos);
    renderSecretMemos();
}

// í• ì¼
function getSecretTodos() { return JSON.parse(localStorage.getItem(SECRET_KEY + 'todos') || '[]'); }
function saveSecretTodos(todos) { localStorage.setItem(SECRET_KEY + 'todos', JSON.stringify(todos)); }
function renderSecretTodos() {
    const todos = getSecretTodos();
    const container = document.getElementById('secretTodoList');
    if (!container) return;
    if (!todos.length) { container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
    container.innerHTML = todos.map((t, i) => `
        <div class="flex items-center gap-3 p-2 rounded-lg ${t.done ? 'bg-green-500/10' : 'bg-purple-500/10'}">
            <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleSecretTodo(${i})" class="w-4 h-4 accent-purple-500">
            <span class="flex-1 text-sm ${t.done ? 'line-through text-gray-500' : 'text-gray-300'}">${t.text}</span>
            <button onclick="deleteSecretTodo(${i})" class="text-red-400 text-xs">âœ•</button>
        </div>
    `).join('');
}
function addSecretTodo() {
    const text = prompt('í• ì¼:');
    if (!text) return;
    const todos = getSecretTodos();
    todos.unshift({ text, done: false });
    saveSecretTodos(todos);
    renderSecretTodos();
}
function toggleSecretTodo(i) { const todos = getSecretTodos(); todos[i].done = !todos[i].done; saveSecretTodos(todos); renderSecretTodos(); }
function deleteSecretTodo(i) { const todos = getSecretTodos(); todos.splice(i, 1); saveSecretTodos(todos); renderSecretTodos(); }

// ì—°ë½ì²˜
function getSecretContacts() { return JSON.parse(localStorage.getItem(SECRET_KEY + 'contacts') || '[]'); }
function saveSecretContacts(list) { localStorage.setItem(SECRET_KEY + 'contacts', JSON.stringify(list)); }
function renderSecretContacts() {
    const list = getSecretContacts();
    const container = document.getElementById('secretContactList');
    if (!container) return;
    if (!list.length) { container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ì €ì¥ëœ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
    container.innerHTML = list.map((c, i) => `
        <div class="flex items-center gap-3 p-2 rounded-lg bg-purple-500/10">
            <div class="flex-1">
                <div class="font-bold text-sm">${c.name}</div>
                <div class="text-xs text-gray-500">${c.phone || ''} ${c.memo ? 'Â· ' + c.memo : ''}</div>
            </div>
            <button onclick="deleteSecretContact(${i})" class="text-red-400 text-xs">âœ•</button>
        </div>
    `).join('');
}
function addSecretContact() {
    const name = prompt('ì´ë¦„:');
    if (!name) return;
    const phone = prompt('ì—°ë½ì²˜:');
    const memo = prompt('ë©”ëª¨:');
    const list = getSecretContacts();
    list.unshift({ name, phone: phone || '', memo: memo || '' });
    saveSecretContacts(list);
    renderSecretContacts();
}
function deleteSecretContact(i) { const list = getSecretContacts(); list.splice(i, 1); saveSecretContacts(list); renderSecretContacts(); }

// ì¼ì •
function getSecretSchedules() { return JSON.parse(localStorage.getItem(SECRET_KEY + 'schedules') || '[]'); }
function saveSecretSchedules(list) { localStorage.setItem(SECRET_KEY + 'schedules', JSON.stringify(list)); }
function renderSecretSchedules() {
    const list = getSecretSchedules();
    const container = document.getElementById('secretScheduleList');
    if (!container) return;
    if (!list.length) { container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>'; return; }
    container.innerHTML = list.sort((a, b) => (a.date || '').localeCompare(b.date || '')).map((s, i) => `
        <div class="flex items-center gap-3 p-2 rounded-lg bg-purple-500/10">
            <div class="text-center px-2 py-1 rounded bg-purple-500/30">
                <div class="text-xs text-purple-400">${(s.date || '').slice(5, 7)}ì›”</div>
                <div class="text-lg font-bold text-white">${(s.date || '').slice(8, 10)}</div>
            </div>
            <div class="flex-1">
                <div class="font-bold text-sm">${s.title}</div>
                <div class="text-xs text-gray-500">${s.memo || ''}</div>
            </div>
            <button onclick="deleteSecretSchedule(${i})" class="text-red-400 text-xs">âœ•</button>
        </div>
    `).join('');
}
function addSecretSchedule() {
    const title = prompt('ì¼ì • ì œëª©:');
    if (!title) return;
    const date = prompt('ë‚ ì§œ (YYYY-MM-DD):');
    const memo = prompt('ë©”ëª¨:');
    const list = getSecretSchedules();
    list.unshift({ title, date: date || '', memo: memo || '' });
    saveSecretSchedules(list);
    renderSecretSchedules();
}
function deleteSecretSchedule(i) { const list = getSecretSchedules(); list.splice(i, 1); saveSecretSchedules(list); renderSecretSchedules(); }
</script>
</body>
</html>
