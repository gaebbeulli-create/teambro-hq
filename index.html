<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TEAM BRO - ë³¸ì‚¬ ERP</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap');
        
        /* 2026 íŠ¸ë Œë“œ - Expressive Minimalism + Soft Spatial */
        :root {
            --bg-primary: #fefefe;
            --bg-secondary: #f8f9fc;
            --bg-tertiary: #eef1f6;
            --bg-card: #ffffff;
            --border: #e8ecf2;
            --border-hover: #d0d7e2;
            --text-primary: #1a1f36;
            --text-secondary: #4a5568;
            --text-muted: #8492a6;
            --accent: #635bff;
            --accent-hover: #5046e5;
            --accent-light: #f0f0ff;
            --success: #00d4aa;
            --success-light: #e6fff9;
            --warning: #ffb020;
            --warning-light: #fff8e6;
            --danger: #ff5a5f;
            --danger-light: #fff0f0;
            --sidebar-bg: linear-gradient(180deg, #fefefe 0%, #f8f9fc 100%);
            --header-bg: rgba(254, 254, 254, 0.85);
            --card-shadow: 0 2px 8px rgba(26, 31, 54, 0.04), 0 8px 24px rgba(26, 31, 54, 0.06);
            --card-shadow-hover: 0 4px 12px rgba(26, 31, 54, 0.06), 0 12px 32px rgba(26, 31, 54, 0.1);
        }
        
        /* ë‹¤í¬ëª¨ë“œ - Soft Dark + Gradient Accent */
        [data-theme="dark"] {
            --bg-primary: #0f0f12;
            --bg-secondary: #16161d;
            --bg-tertiary: #1e1e28;
            --bg-card: #1a1a24;
            --border: #2a2a3a;
            --border-hover: #3a3a4d;
            --text-primary: #f0f2f5;
            --text-secondary: #9ca3b4;
            --text-muted: #636b7e;
            --accent: #817dff;
            --accent-hover: #9590ff;
            --accent-light: rgba(129, 125, 255, 0.12);
            --success: #00e6b8;
            --success-light: rgba(0, 230, 184, 0.12);
            --warning: #ffc040;
            --warning-light: rgba(255, 192, 64, 0.12);
            --danger: #ff6b6b;
            --danger-light: rgba(255, 107, 107, 0.12);
            --sidebar-bg: linear-gradient(180deg, #0f0f12 0%, #16161d 100%);
            --header-bg: rgba(15, 15, 18, 0.9);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 8px 24px rgba(0, 0, 0, 0.3);
            --card-shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.3), 0 16px 40px rgba(0, 0, 0, 0.4);
        }
        
        * { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            box-sizing: border-box;
        }
        
        body { 
            background: var(--bg-secondary); 
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            transition: background 0.4s ease, color 0.3s ease;
        }
        
        /* ì¹´ë“œ - Soft Spatial (ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì) */
        .glass-card { 
            background: var(--bg-card);
            border: 1px solid var(--border); 
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover { 
            border-color: var(--border-hover);
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }
        
        /* ê·¸ë¼ë°ì´ì…˜ í…ìŠ¤íŠ¸ - Vibrant Gradient */
        .gradient-text {
            background: linear-gradient(135deg, var(--accent) 0%, #00d4aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }
        
        .hidden { display: none; }
        
        /* ë°ì´í„° í…Œì´ë¸” */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { 
            background: var(--bg-secondary); 
            padding: 14px 18px; 
            text-align: left; 
            font-size: 12px; 
            font-weight: 700; 
            color: var(--text-muted); 
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .data-table td { 
            padding: 16px 18px; 
            border-bottom: 1px solid var(--border); 
            font-size: 14px; 
            color: var(--text-primary);
            font-weight: 500;
        }
        .data-table tr { transition: background 0.2s ease; }
        .data-table tr:hover { background: var(--bg-secondary); }
        .data-table tr:last-child td { border-bottom: none; }
        
        /* ì¸í’‹ í•„ë“œ */
        .input-field { 
            background: var(--bg-primary); 
            border: 1.5px solid var(--border); 
            color: var(--text-primary); 
            padding: 14px 18px; 
            border-radius: 12px; 
            width: 100%; 
            transition: all 0.25s ease;
            font-size: 15px;
            font-weight: 500;
        }
        .input-field:focus { 
            outline: none; 
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        .input-field::placeholder { color: var(--text-muted); }
        
        /* ë²„íŠ¼ - Gradient Accent */
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            color: white; 
            font-weight: 600; 
            padding: 14px 28px; 
            border-radius: 12px; 
            cursor: pointer; 
            border: none;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            box-shadow: 0 4px 14px rgba(99, 91, 255, 0.25);
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 91, 255, 0.35);
        }
        
        .btn-secondary { 
            background: var(--bg-card); 
            border: 1.5px solid var(--border); 
            color: var(--text-primary); 
            padding: 14px 28px; 
            border-radius: 12px; 
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-secondary:hover { 
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, var(--danger) 0%, #e53e3e 100%);
            border: none; 
            color: white; 
            padding: 14px 28px; 
            border-radius: 12px; 
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 600;
            box-shadow: 0 4px 14px rgba(255, 90, 95, 0.25);
        }
        .btn-danger:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 90, 95, 0.35);
        }
        
        .btn-sm { padding: 10px 18px; font-size: 13px; }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(15, 15, 18, 0.6); 
            backdrop-filter: blur(8px);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
            padding: 20px;
        }
        .modal-content { 
            background: var(--bg-card); 
            border: 1px solid var(--border);
            border-radius: 24px; 
            padding: 32px; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.25);
            animation: modalIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* ë°°ì§€ - Soft Color */
        .badge { 
            padding: 6px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .badge-active { background: var(--success-light); color: var(--success); }
        .badge-inactive { background: var(--bg-tertiary); color: var(--text-muted); }
        .badge-pending { background: var(--warning-light); color: #d69e00; }
        .badge-biz { background: var(--accent-light); color: var(--accent); }
        .badge-info { background: #f3e8ff; color: #8b5cf6; }
        .badge-error { background: var(--danger-light); color: var(--danger); }
        .badge-nonbiz { background: #fff7ed; color: #ea580c; }
        .badge-success { background: var(--success-light); color: var(--success); }
        
        [data-theme="dark"] .badge-pending { color: var(--warning); }
        [data-theme="dark"] .badge-info { background: rgba(139, 92, 246, 0.12); color: #a78bfa; }
        [data-theme="dark"] .badge-nonbiz { background: rgba(234, 88, 12, 0.12); color: #fb923c; }
        
        /* í† ìŠ¤íŠ¸ - Micro Delight Animation */
        .toast { 
            position: fixed; 
            top: 24px; 
            right: 24px; 
            padding: 16px 24px; 
            border-radius: 14px; 
            z-index: 200;
            font-weight: 600;
            font-size: 14px;
            animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .toast-success { background: linear-gradient(135deg, var(--success) 0%, #00c49a 100%); color: white; }
        .toast-error { background: linear-gradient(135deg, var(--danger) 0%, #e53e3e 100%); color: white; }
        .toast-info { background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%); color: white; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-16px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        @media (max-width: 768px) { 
            .sidebar { display: none !important; } 
            .mobile-nav { display: flex !important; } 
        }
        
        /* ì‚¬ì´ë“œë°” - Expressive Minimalism */
        .menu-group { margin-bottom: 8px; }
        .menu-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            padding: 20px 20px 12px 20px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 20px;
            font-size: 15px;
            color: var(--text-secondary);
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            background: transparent;
            border: none;
            cursor: pointer;
            margin: 4px 12px;
            font-weight: 500;
        }
        .sidebar-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(4px);
        }
        .sidebar-item.active {
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(99, 91, 255, 0.3);
        }
        .sidebar-item .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.7;
        }
        .sidebar-item .sidebar-icon {
            font-size: 20px;
        }
        
        /* ë‹¤í¬ëª¨ë“œ í† ê¸€ - Micro Delight */
        .theme-toggle {
            position: relative;
            width: 56px;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid var(--border);
        }
        .theme-toggle::after {
            content: 'â˜€ï¸';
            position: absolute;
            top: 3px;
            left: 4px;
            width: 22px;
            height: 22px;
            background: var(--bg-card);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] .theme-toggle {
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            border-color: transparent;
        }
        [data-theme="dark"] .theme-toggle::after {
            content: 'ğŸŒ™';
            left: 28px;
        }
        
        .glow-purple, .glow-blue, .glow-cyan {
            box-shadow: var(--card-shadow);
        }
        
        /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        .text-gray-400, .text-gray-500, .text-zinc-400, .text-zinc-500 { 
            color: var(--text-muted) !important; 
        }
        .text-gray-900, .text-zinc-900, .text-white {
            color: var(--text-primary) !important;
        }
        
        /* í¬ì¸íŠ¸ ì»¬ëŸ¬ - Vibrant Colors */
        .text-purple-400 { color: #8b5cf6 !important; }
        .text-blue-400 { color: var(--accent) !important; }
        .text-green-400 { color: var(--success) !important; }
        .text-red-400 { color: var(--danger) !important; }
        .text-yellow-400 { color: var(--warning) !important; }
        .text-orange-400 { color: #f97316 !important; }
        .text-pink-400 { color: #ec4899 !important; }
        .text-cyan-400 { color: #06b6d4 !important; }
        
        [data-theme="dark"] .text-purple-400 { color: #a78bfa !important; }
        [data-theme="dark"] .text-blue-400 { color: #817dff !important; }
        [data-theme="dark"] .text-green-400 { color: #00e6b8 !important; }
        [data-theme="dark"] .text-red-400 { color: #ff6b6b !important; }
        [data-theme="dark"] .text-yellow-400 { color: #ffc040 !important; }
        [data-theme="dark"] .text-orange-400 { color: #fb923c !important; }
        [data-theme="dark"] .text-pink-400 { color: #f472b6 !important; }
        [data-theme="dark"] .text-cyan-400 { color: #22d3ee !important; }
        
        /* ìˆ«ì í¬ê¸° */
        .text-xl { font-size: 1.35rem !important; font-weight: 700 !important; }
        .text-2xl { font-size: 1.75rem !important; font-weight: 700 !important; }
        .text-3xl { font-size: 2.25rem !important; font-weight: 700 !important; }
        
        /* ë°°ê²½ìƒ‰ */
        .bg-white { background: var(--bg-card) !important; }
        .bg-gray-50, .bg-gray-100 { background: var(--bg-secondary) !important; }
        
        /* íƒ€ì´í‹€ */
        h2, h3 { 
            color: var(--text-primary); 
            font-weight: 700;
        }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.125rem; }
    </style>
</head>
<body class="min-h-screen">
    <div id="toast-container"></div>

    <!-- ë¡œë”© -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex items-center justify-center" style="background: var(--bg-secondary)">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-6 gradient-text">TEAM BRO</h1>
            <div class="flex items-center justify-center gap-2">
                <div class="w-2.5 h-2.5 rounded-full animate-pulse" style="background: var(--accent)"></div>
                <div class="w-2.5 h-2.5 rounded-full animate-pulse" style="background: var(--success); animation-delay: 0.15s"></div>
                <div class="w-2.5 h-2.5 rounded-full animate-pulse" style="background: #8b5cf6; animation-delay: 0.3s"></div>
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginPage" class="hidden relative z-10 min-h-screen flex items-center justify-center px-4" style="background: var(--bg-secondary)">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="w-16 h-16 mx-auto mb-5 rounded-2xl flex items-center justify-center font-bold text-white text-xl" style="background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%); box-shadow: 0 8px 24px rgba(99, 91, 255, 0.3);">TB</div>
                <h1 class="text-3xl font-bold mb-2" style="color: var(--text-primary)">TEAM BRO</h1>
                <p class="text-sm font-medium" style="color: var(--text-muted)">ë³¸ì‚¬ í†µí•© ERP</p>
            </div>
            <div class="glass-card p-8">
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">ì•„ì´ë””</label>
                        <input type="text" id="loginUsername" class="input-field" required placeholder="ì•„ì´ë”” ì…ë ¥">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" class="input-field" required placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                    <div id="loginError" class="hidden p-3 rounded-xl text-sm font-semibold" style="background: var(--danger-light); color: var(--danger)"></div>
                    <button type="submit" class="w-full btn-primary py-4 text-base mt-2">ë¡œê·¸ì¸</button>
                </form>
            </div>
            <p class="text-center text-xs mt-8 font-medium" style="color: var(--text-muted)">Â© 2025 TEAM BRO</p>
        </div>
    </div>

    <!-- ë©”ì¸ -->
    <div id="mainSystem" class="hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar fixed left-0 top-0 h-screen border-r hidden md:block" style="width: 280px; background: var(--sidebar-bg); border-color: var(--border); overflow-y:auto; z-index: 50;">
            <!-- ë¡œê³  -->
            <div class="p-6 border-b" style="border-color: var(--border)">
                <div class="flex items-center gap-3 cursor-pointer" onclick="showTab('dashboard')">
                    <div class="w-11 h-11 rounded-xl flex items-center justify-center font-bold text-white text-base" style="background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%); box-shadow: 0 4px 12px rgba(99, 91, 255, 0.25);">TB</div>
                    <span class="text-xl font-bold gradient-text">TeamBro</span>
                </div>
            </div>
            
            <nav class="p-4 space-y-6">
                <!-- ëŒ€ì‹œë³´ë“œ -->
                <div>
                    <button onclick="showTab('dashboard')" id="nav-dashboard" class="sidebar-item active w-full">
                        <span class="sidebar-icon">ğŸ“Š</span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </button>
                </div>

                <!-- ê¸°ì´ˆì •ë³´ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ‘¥ ê¸°ì´ˆì •ë³´</div>
                    <button onclick="showTab('riders')" id="nav-riders" class="sidebar-item w-full"><span class="dot"></span>ë¼ì´ë” ê´€ë¦¬</button>
                    <button onclick="showTab('partners')" id="nav-partners" class="sidebar-item w-full"><span class="dot"></span>í˜‘ë ¥ì‚¬ ê´€ë¦¬</button>
                    <button onclick="showTab('sales')" id="nav-sales" class="sidebar-item w-full"><span class="dot"></span>ì˜ì—…ì ê´€ë¦¬</button>
                    <button onclick="showTab('entities')" id="nav-entities" class="sidebar-item w-full"><span class="dot"></span>ë²•ì¸ ê´€ë¦¬</button>
                </div>

                <!-- ì •ì‚°ê´€ë¦¬ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ’° ì •ì‚°ê´€ë¦¬</div>
                    <button onclick="showTab('sett-dashboard')" id="nav-sett-dashboard" class="sidebar-item w-full"><span class="dot"></span>ì •ì‚° í˜„í™©</button>
                    <button onclick="showTab('platform')" id="nav-platform" class="sidebar-item w-full"><span class="dot"></span>í”Œë«í¼ì •ì‚°ì…ê¸ˆ</button>
                    <button onclick="showTab('sett-advance')" id="nav-sett-advance" class="sidebar-item w-full"><span class="dot"></span>ì„ ì •ì‚° ì§€ê¸‰</button>
                    <button onclick="showTab('weekly-payout')" id="nav-weekly-payout" class="sidebar-item w-full"><span class="dot"></span>ì£¼ì •ì‚° ì§€ê¸‰</button>
                    <button onclick="showTab('reconcile')" id="nav-reconcile" class="sidebar-item w-full"><span class="dot"></span>ëŒ€ì‚¬ ê´€ë¦¬</button>
                </div>

                <!-- ì¬ë¬´ê´€ë¦¬ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ’µ ì¬ë¬´ê´€ë¦¬</div>
                    <button onclick="showTab('bank')" id="nav-bank" class="sidebar-item w-full"><span class="dot"></span>í˜„ê¸ˆì¶œë‚©ì¥</button>
                    <button onclick="showTab('accounting')" id="nav-accounting" class="sidebar-item w-full"><span class="dot"></span>ë§¤ì…ë§¤ì¶œì¥</button>
                    <button onclick="showTab('taxinvoice')" id="nav-taxinvoice" class="sidebar-item w-full"><span class="dot"></span>ì„¸ê¸ˆê³„ì‚°ì„œ</button>
                    <button onclick="showTab('ledger')" id="nav-ledger" class="sidebar-item w-full"><span class="dot"></span>ì´ê³„ì •ì›ì¥</button>
                    <button onclick="showTab('journal')" id="nav-journal" class="sidebar-item w-full"><span class="dot"></span>ë¶„ê°œì¥</button>
                </div>

                <!-- ì¹´ë“œ/ìì‚° -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ’³ ì¹´ë“œ/ìì‚°</div>
                    <button onclick="showTab('cards')" id="nav-cards" class="sidebar-item w-full"><span class="dot"></span>ë²•ì¸ì¹´ë“œ ê´€ë¦¬</button>
                    <button onclick="showTab('card-usage')" id="nav-card-usage" class="sidebar-item w-full"><span class="dot"></span>ì¹´ë“œ ì‚¬ìš©ë‚´ì—­</button>
                </div>

                <!-- ì¸ì‚¬ê´€ë¦¬ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ§‘â€ğŸ’¼ ì¸ì‚¬ê´€ë¦¬</div>
                    <button onclick="showTab('employees')" id="nav-employees" class="sidebar-item w-full"><span class="dot"></span>ì§ì› ê´€ë¦¬</button>
                    <button onclick="showTab('payroll')" id="nav-payroll" class="sidebar-item w-full"><span class="dot"></span>ê¸‰ì—¬ ê´€ë¦¬</button>
                    <button onclick="showTab('contracts')" id="nav-contracts" class="sidebar-item w-full"><span class="dot"></span>ê·¼ë¡œê³„ì•½</button>
                </div>

                <!-- ë¬¸ì„œ/ì„¸ë¬´ -->
                <div class="menu-group">
                    <div class="menu-title">ğŸ“‹ ë¬¸ì„œ/ì„¸ë¬´</div>
                    <button onclick="showTab('tax')" id="nav-tax" class="sidebar-item w-full"><span class="dot"></span>ì„¸ë¬´ ê´€ë¦¬</button>
                    <button onclick="showTab('docs')" id="nav-docs" class="sidebar-item w-full"><span class="dot"></span>ë¬¸ì„œ ê´€ë¦¬</button>
                    <button onclick="showTab('excel')" id="nav-excel" class="sidebar-item w-full"><span class="dot"></span>ì—…ë¡œë“œ ì–‘ì‹</button>
                </div>

                <!-- ì‹œìŠ¤í…œ -->
                <div class="menu-group">
                    <div class="menu-title">âš™ï¸ ì‹œìŠ¤í…œ</div>
                    <button onclick="showTab('users')" id="nav-users" class="sidebar-item w-full"><span class="dot"></span>ì‚¬ìš©ì ê´€ë¦¬</button>
                    <button onclick="showTab('logs')" id="nav-logs" class="sidebar-item w-full"><span class="dot"></span>ê°ì‚¬ ë¡œê·¸</button>
                    <button onclick="showTab('settings')" id="nav-settings" class="sidebar-item w-full"><span class="dot"></span>ì‹œìŠ¤í…œ ì„¤ì •</button>
                </div>
            </nav>
            

        </aside>

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="fixed top-0 right-0 z-40 border-b" style="left: 280px; background: var(--header-bg); backdrop-filter: blur(16px); border-color: var(--border);">
            <div class="px-8 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="toggleMobileMenu()" class="text-xl md:hidden" style="color: var(--text-secondary)">â˜°</button>
                    <h2 id="pageTitle" class="text-xl font-bold" style="color: var(--text-primary)">ëŒ€ì‹œë³´ë“œ</h2>
                </div>
                <div class="flex items-center gap-5">
                    <div class="theme-toggle" onclick="toggleTheme()" title="ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ"></div>
                    <span id="headerUserName" class="text-sm font-semibold hidden md:inline" style="color: var(--text-secondary)">ê´€ë¦¬ì</span>
                    <button onclick="logout()" class="text-sm font-semibold transition-all hover:opacity-70" style="color: var(--danger)">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <!-- ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-zinc-900/95 backdrop-blur-lg border-t border-white/5 z-40">
            <button onclick="showTab('dashboard')" class="flex-1 py-3 text-center text-xs text-zinc-500 hover:text-purple-400 transition-colors">ğŸ“Š<br>ëŒ€ì‹œë³´ë“œ</button>
            <button onclick="showTab('riders')" class="flex-1 py-3 text-center text-xs text-zinc-500 hover:text-purple-400 transition-colors">ğŸï¸<br>ë¼ì´ë”</button>
            <button onclick="showTab('partners')" class="flex-1 py-3 text-center text-xs text-zinc-500 hover:text-purple-400 transition-colors">ğŸ¤<br>í˜‘ë ¥ì‚¬</button>
            <button onclick="showTab('entities')" class="flex-1 py-3 text-center text-xs text-zinc-500 hover:text-purple-400 transition-colors">ğŸ¢<br>ë²•ì¸</button>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="pt-24 p-8 pb-24 md:pb-8 min-h-screen" style="margin-left: 0;" id="mainContent">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="tab-dashboard" class="tab-content">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">ëŒ€ì‹œë³´ë“œ</h2>
                    <p class="text-zinc-500 text-sm">íŒ€ë¸Œë¡œ ê·¸ë£¹ í†µí•© í˜„í™©</p>
                </div>
                
                <!-- ê¸°ë³¸ í†µê³„ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass-card p-5 cursor-pointer" onclick="showTab('riders')">
                        <div class="text-zinc-500 text-xs mb-2">ë¼ì´ë”</div>
                        <div class="text-2xl font-bold text-white" id="stat-riders">0ëª…</div>
                    </div>
                    <div class="glass-card p-5 cursor-pointer" onclick="showTab('partners')">
                        <div class="text-zinc-500 text-xs mb-2">í˜‘ë ¥ì‚¬</div>
                        <div class="text-2xl font-bold text-white" id="stat-partners">0ê°œ</div>
                    </div>
                    <div class="glass-card p-5 cursor-pointer" onclick="showTab('sales')">
                        <div class="text-zinc-500 text-xs mb-2">ì˜ì—…ì</div>
                        <div class="text-2xl font-bold text-white" id="stat-sales">0ëª…</div>
                    </div>
                    <div class="glass-card p-5">
                        <div class="text-zinc-500 text-xs mb-2">ì´ë²ˆë‹¬ ìˆ˜ìˆ˜ë£Œ</div>
                        <div class="text-2xl font-bold text-emerald-400">â‚©0</div>
                    </div>
                </div>
                
                <!-- ê·¸ë£¹ì‚¬ í˜„í™© -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-white mb-4">ğŸ¢ ê·¸ë£¹ì‚¬ í˜„í™©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- ë¸Œë¡œì»´í¼ë‹ˆ -->
                        <div class="glass-card p-5 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-blue-400">ë¸Œë¡œì»´í¼ë‹ˆ</h4>
                                <span class="badge badge-active">ìš´ì˜ì¤‘</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ë²ˆë‹¬ ë§¤ì¶œ</span><span class="text-white font-medium" id="bc-revenue">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ë²ˆë‹¬ ì •ì‚°</span><span class="text-amber-400" id="bc-settlement">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ)</span><span class="text-emerald-400 font-medium" id="bc-profit">â‚©0</span></div>
                            </div>
                            <a href="https://gaebbeulli-create.github.io/teambro-erp/" target="_blank" class="block mt-4 text-center text-xs text-blue-400 hover:text-blue-300 transition-colors">ERP ë°”ë¡œê°€ê¸° â†’</a>
                        </div>
                        
                        <!-- ë¸Œë¡œëª¨í„°ìŠ¤ -->
                        <div class="glass-card p-5 border-l-4 border-purple-500">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-purple-400">ë¸Œë¡œëª¨í„°ìŠ¤</h4>
                                <span class="badge badge-active">ìš´ì˜ì¤‘</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ë²ˆë‹¬ ë Œíƒˆìˆ˜ìµ</span><span class="text-white font-medium" id="bm-revenue">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ë¯¸ìˆ˜ê¸ˆ</span><span class="text-red-400" id="bm-arrears">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ìˆœìˆ˜ìµ</span><span class="text-emerald-400 font-medium" id="bm-profit">â‚©0</span></div>
                            </div>
                            <a href="https://gaebbeulli-create.github.io/bromotors/" target="_blank" class="block mt-4 text-center text-xs text-purple-400 hover:text-purple-300 transition-colors">ERP ë°”ë¡œê°€ê¸° â†’</a>
                        </div>
                        
                        <!-- ê·¸ë£¹ í•©ê³„ -->
                        <div class="glass-card p-5 border-l-4 border-emerald-500">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-emerald-400">ê·¸ë£¹ í•©ê³„</h4>
                                <span class="text-xs text-zinc-500">ì´ë²ˆë‹¬</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ ë§¤ì¶œ</span><span class="text-white font-medium" id="group-revenue">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ì´ ìˆ˜ìµ</span><span class="text-emerald-400 font-medium" id="group-profit">â‚©0</span></div>
                                <div class="flex justify-between"><span class="text-zinc-500">ìê¸ˆ ì”ì•¡</span><span class="text-amber-400 font-medium" id="group-balance">â‚©0</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ìê¸ˆ ì§‘í–‰/íšŒìˆ˜ -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white">ğŸ’° ìê¸ˆ ì§‘í–‰/íšŒìˆ˜</h3>
                        <button onclick="openFundModal()" class="btn-primary btn-sm">+ ìê¸ˆ ë“±ë¡</button>
                    </div>
                    
                    <!-- ìê¸ˆ í†µê³„ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ì´ ì§‘í–‰</div>
                            <div class="text-xl font-bold text-red-400" id="fund-total-out">â‚©0</div>
                        </div>
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ì´ íšŒìˆ˜</div>
                            <div class="text-xl font-bold text-emerald-400" id="fund-total-in">â‚©0</div>
                        </div>
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ë¯¸íšŒìˆ˜ ì”ì•¡</div>
                            <div class="text-xl font-bold text-amber-400" id="fund-outstanding">â‚©0</div>
                        </div>
                        <div class="glass-card p-4 text-center">
                            <div class="text-zinc-500 text-xs mb-1">ì´ë²ˆë‹¬ ìˆœì´ë™</div>
                            <div class="text-xl font-bold text-purple-400" id="fund-monthly-net">â‚©0</div>
                        </div>
                    </div>
                    
                    <!-- ìê¸ˆ ë‚´ì—­ í…Œì´ë¸” -->
                    <div class="glass-card overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>ì¼ì</th><th>ìíšŒì‚¬</th><th>êµ¬ë¶„</th><th>ê¸ˆì•¡</th><th>ìš©ë„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="fundTableBody"><tr><td colspan="7" class="text-center py-8 text-zinc-500">ìê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ë¼ì´ë” ê´€ë¦¬ -->
                <div id="tab-riders" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸï¸ ë¼ì´ë” ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('rider')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('riderExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('rider')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openRiderModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="riderExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('rider', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="rider-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterList('rider','active')"><div class="text-gray-400 text-xs">í™œì„±</div><div class="text-xl font-bold text-green-400" id="rider-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterList('rider','inactive')"><div class="text-gray-400 text-xs">ë¹„í™œì„±</div><div class="text-xl font-bold text-gray-400" id="rider-inactive">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì£¼ë¯¼ë²ˆí˜¸ ë¯¸ë“±ë¡</div><div class="text-xl font-bold text-red-400" id="rider-nossn">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="riderStatusFilter" class="input-field" style="width:100px" onchange="renderTable('rider')"><option value="">ì „ì²´</option><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select>
                            <select id="riderPartnerFilter" class="input-field" style="width:150px" onchange="renderTable('rider')"><option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option></select>
                            <input type="text" id="riderSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê²€ìƒ‰..." onkeyup="renderTable('rider')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>í˜‘ë ¥ì‚¬</th><th>ì›ì²œì§•ìˆ˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="riderTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- í˜‘ë ¥ì‚¬ ê´€ë¦¬ -->
                <div id="tab-partners" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ¤ í˜‘ë ¥ì‚¬ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('partner')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('partnerExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('partner')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openPartnerModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="partnerExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('partner', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="partner-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ì—…ì</div><div class="text-xl font-bold text-blue-400" id="partner-biz">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¹„ì‚¬ì—…ì</div><div class="text-xl font-bold text-orange-400" id="partner-nonbiz">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì†Œì† ë¼ì´ë”</div><div class="text-xl font-bold text-purple-400" id="partner-riders">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>í˜‘ë ¥ì‚¬ëª…</th><th>ì½”ë“œ</th><th>êµ¬ë¶„</th><th>ëŒ€í‘œì</th><th>ì—°ë½ì²˜</th><th>ë¼ì´ë”ìˆ˜</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="partnerTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì˜ì—…ì ê´€ë¦¬ -->
                <div id="tab-sales" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’¼ ì˜ì—…ì ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('sales')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('salesExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('sales')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openSalesModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="salesExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('sales', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="sales-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê°œì¸</div><div class="text-xl font-bold text-purple-400" id="sales-ind">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê°œì¸ì‚¬ì—…ì</div><div class="text-xl font-bold text-blue-400" id="sales-sole">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë²•ì¸</div><div class="text-xl font-bold text-pink-400" id="sales-corp">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="salesStatusFilter" class="input-field" style="width:100px" onchange="renderTable('sales')"><option value="">ì „ì²´</option><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select>
                            <select id="salesTypeFilter" class="input-field" style="width:120px" onchange="renderTable('sales')"><option value="">ì „ì²´ìœ í˜•</option><option value="individual">ê°œì¸</option><option value="sole_prop">ê°œì¸ì‚¬ì—…ì</option><option value="corporation">ë²•ì¸</option></select>
                            <input type="text" id="salesSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê²€ìƒ‰..." onkeyup="renderTable('sales')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì½”ë“œ</th><th>ì´ë¦„</th><th>ìœ í˜•</th><th>ì—°ë½ì²˜</th><th>ì§€ê¸‰ì£¼ê¸°</th><th>ì›ì²œì§•ìˆ˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="salesTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì ê´€ë¦¬ -->
                <div id="tab-users" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h2>
                        <button onclick="openUserModal()" class="btn-primary btn-sm">+ ì‚¬ìš©ì ë“±ë¡</button>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ê¶Œí•œ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="userTableBody"><tr><td colspan="5" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ë²•ì¸ ê´€ë¦¬ -->
                <div id="tab-entities" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ¢ ë²•ì¸ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openEntityModal()" class="btn-primary btn-sm">+ ë²•ì¸ ë“±ë¡</button>
                        </div>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´ ë²•ì¸</div><div class="text-xl font-bold text-purple-400" id="entity-total">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">í™œì„±</div><div class="text-xl font-bold text-green-400" id="entity-active">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¹„í™œì„±</div><div class="text-xl font-bold text-gray-400" id="entity-inactive">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì²¨ë¶€ì„œë¥˜</div><div class="text-xl font-bold text-blue-400" id="entity-docs">0ê°œ</div></div>
                    </div>
                    
                    <!-- ë²•ì¸ ì¹´ë“œ ëª©ë¡ -->
                    <div id="entityCardList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-card rounded-xl p-8 text-center col-span-full"><p class="text-gray-500">ë“±ë¡ëœ ë²•ì¸ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
                    </div>
                </div>

                <!-- ì •ì‚° ê´€ë¦¬ -->
                <div id="tab-settlement" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’° ì •ì‚° ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('settlement')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('settlementExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportToExcel('settlement')" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openSettlementModal()" class="btn-primary btn-sm">+ ì •ì‚° ë“±ë¡</button>
                            <input type="file" id="settlementExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel('settlement', this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="sett-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('pending')"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="sett-pending">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('confirmed')"><div class="text-gray-400 text-xs">í™•ì •</div><div class="text-xl font-bold text-blue-400" id="sett-confirmed">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center cursor-pointer" onclick="filterSettlement('paid')"><div class="text-gray-400 text-xs">ì§€ê¸‰ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="sett-paid">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì •ì‚°ê¸ˆ</div><div class="text-xl font-bold text-purple-400" id="sett-amount">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="settWeekFilter" class="input-field" style="width:130px" onchange="renderTable('settlement')"><option value="">ì „ì²´ ì£¼ì°¨</option></select>
                            <select id="settStatusFilter" class="input-field" style="width:100px" onchange="renderTable('settlement')"><option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="confirmed">í™•ì •</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select>
                            <select id="settPartnerFilter" class="input-field" style="width:150px" onchange="renderTable('settlement')"><option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option></select>
                            <input type="text" id="settSearch" class="input-field flex-1" style="min-width:150px" placeholder="ë¼ì´ë” ê²€ìƒ‰..." onkeyup="renderTable('settlement')">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>ê·¼ë¬´ê¸°ê°„</th><th>ë¼ì´ë”</th><th>í˜‘ë ¥ì‚¬</th><th>ì´ìˆ˜ì…</th><th>ê³µì œ</th><th>ì„ ì •ì‚°</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="settlementTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì§€ê¸‰ ê´€ë¦¬ (ì§ì› ê¸‰ì—¬) -->
                <div id="tab-payout" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ‘¥ ì¸ì‚¬ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openEmployeeModal()" class="btn-secondary btn-sm">+ ì§ì› ë“±ë¡</button>
                            <button onclick="openPayrollModal()" class="btn-primary btn-sm">+ ê¸‰ì—¬ ë“±ë¡</button>
                        </div>
                    </div>
                    
                    <!-- ì§ì› ëª©ë¡ -->
                    <h3 class="text-lg font-bold mb-3 text-purple-400">ğŸ‘¤ ì§ì› ëª©ë¡</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="emp-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì •ê·œì§</div><div class="text-xl font-bold text-blue-400" id="emp-regular">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³„ì•½ì§</div><div class="text-xl font-bold text-yellow-400" id="emp-contract">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">4ëŒ€ë³´í—˜</div><div class="text-xl font-bold text-green-400" id="emp-insured">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>êµ¬ë¶„</th><th>ë¶€ì„œ</th><th>ê¸°ë³¸ê¸‰</th><th>4ëŒ€ë³´í—˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="employeeTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                    
                    <!-- ê¸‰ì—¬ ë‚´ì—­ -->
                    <h3 class="text-lg font-bold mb-3 text-purple-400">ğŸ’° ê¸‰ì—¬ ì§€ê¸‰ ë‚´ì—­</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì§€ê¸‰</div><div class="text-xl font-bold text-purple-400" id="pay-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="pay-gross">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê³µì œì•¡</div><div class="text-xl font-bold text-red-400" id="pay-deduct">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‹¤ì§€ê¸‰ í•©ê³„</div><div class="text-xl font-bold text-green-400" id="pay-net">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>ì§€ê¸‰ì›”</th><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ìˆ˜ë‹¹</th><th>ì´ì§€ê¸‰</th><th>ê³µì œ</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="payrollTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                    
                    <!-- ê·¼ë¡œê³„ì•½ì„œ ì—…ë¡œë“œ -->
                    <h3 class="text-lg font-bold mb-3 text-orange-400">ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ ê´€ë¦¬</h3>
                    <div class="glass-card rounded-xl p-4 mb-4">
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4">
                            <select id="contractEmpSelect" class="input-field" style="width:200px">
                                <option value="">ì§ì› ì„ íƒ</option>
                            </select>
                            <label class="btn-secondary btn-sm cursor-pointer">
                                ğŸ“ íŒŒì¼ ì„ íƒ
                                <input type="file" id="contractFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="hidden" onchange="handleContractUpload(this)">
                            </label>
                            <span id="contractFileName" class="text-gray-400 text-sm">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                            <button onclick="uploadContract()" class="btn-primary btn-sm">ì—…ë¡œë“œ</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">* PDF, ì´ë¯¸ì§€(JPG, PNG), Word íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥</div>
                        <div class="glass-card rounded-lg overflow-hidden">
                            <table class="data-table"><thead><tr><th>ì§ì›</th><th>íŒŒì¼ëª…</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="contractTableBody"><tr><td colspan="4" class="text-center py-4 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- ì„¸ë¬´ ê´€ë¦¬ -->
                <div id="tab-tax" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“‹ ì„¸ë¬´ ì„œë¥˜ ë³´ê´€í•¨</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openTaxUploadModal()" class="btn-primary btn-sm">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                        </div>
                    </div>
                    
                    <!-- ì„¤ëª… ë°°ë„ˆ -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-blue-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“</span>
                            <div>
                                <p class="text-blue-400 font-bold">ì„¸ë¬´ì„œë¥˜ í´ë¼ìš°ë“œ ë³´ê´€í•¨</p>
                                <p class="text-gray-400 text-sm">ì„¸ë¬´ì„œì—ì„œ ë°›ì€ ì›ì²œì„¸ ì‹ ê³ ì„œ, ì§€ê¸‰ëª…ì„¸ì„œ ë“± ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•˜ê³  ë³´ê´€í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
                    <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                        <button onclick="filterTaxDocs('all')" id="taxDocTab-all" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-purple-500/20 text-purple-400">ì „ì²´</button>
                        <button onclick="filterTaxDocs('withholding')" id="taxDocTab-withholding" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì›ì²œì„¸ ì‹ ê³ </button>
                        <button onclick="filterTaxDocs('statement')" id="taxDocTab-statement" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì§€ê¸‰ëª…ì„¸ì„œ</button>
                        <button onclick="filterTaxDocs('other')" id="taxDocTab-other" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ê¸°íƒ€ ì„œë¥˜</button>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´ íŒŒì¼</div><div class="text-xl font-bold text-purple-400" id="taxdoc-total">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì›ì²œì„¸ ì‹ ê³ </div><div class="text-xl font-bold text-blue-400" id="taxdoc-withholding">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§€ê¸‰ëª…ì„¸ì„œ</div><div class="text-xl font-bold text-purple-400" id="taxdoc-statement">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê¸°íƒ€ ì„œë¥˜</div><div class="text-xl font-bold text-yellow-400" id="taxdoc-other">0ê°œ</div></div>
                    </div>
                    
                    <!-- ê²€ìƒ‰/í•„í„° -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="taxDocSearch" class="input-field flex-1" style="min-width:200px" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." onkeyup="renderTaxDocTable()">
                            <input type="month" id="taxDocMonth" class="input-field" style="width:150px" onchange="renderTaxDocTable()">
                        </div>
                    </div>
                    
                    <!-- íŒŒì¼ ëª©ë¡ -->
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>íŒŒì¼ëª…</th><th>ì„œë¥˜ì¼ì</th><th>ì„¤ëª…</th><th>í¬ê¸°</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="taxDocTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ë¬¸ì„œ ê´€ë¦¬ (ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨) -->
                <div id="tab-docs" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“ ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="openDocUploadModal()" class="btn-primary btn-sm">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</button>
                        </div>
                    </div>
                    
                    <!-- ì„¤ëª… ë°°ë„ˆ -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-purple-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ¢</span>
                            <div>
                                <p class="text-purple-400 font-bold">ë²•ì¸ì„œë¥˜ í´ë¼ìš°ë“œ ë³´ê´€í•¨</p>
                                <p class="text-gray-400 text-sm">ì‚¬ì—…ìë“±ë¡ì¦, ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸, ê³„ì•½ì„œ ë“± ì¤‘ìš” ë²•ì¸ì„œë¥˜ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
                    <div class="flex gap-2 mb-4 border-b border-white/10 pb-2 flex-wrap">
                        <button onclick="filterCorpDocs('all')" id="corpDocTab-all" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-purple-500/20 text-purple-400">ì „ì²´</button>
                        <button onclick="filterCorpDocs('business')" id="corpDocTab-business" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì‚¬ì—…ìë“±ë¡ì¦</button>
                        <button onclick="filterCorpDocs('corporate')" id="corpDocTab-corporate" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸</button>
                        <button onclick="filterCorpDocs('contract')" id="corpDocTab-contract" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ê³„ì•½ì„œ</button>
                        <button onclick="filterCorpDocs('license')" id="corpDocTab-license" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì¸í—ˆê°€ì„œë¥˜</button>
                        <button onclick="filterCorpDocs('other')" id="corpDocTab-other" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ê¸°íƒ€</button>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="corpdoc-total">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ì—…ìë“±ë¡</div><div class="text-xl font-bold text-blue-400" id="corpdoc-business">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë“±ê¸°ë¶€ë“±ë³¸</div><div class="text-xl font-bold text-purple-400" id="corpdoc-corporate">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³„ì•½ì„œ</div><div class="text-xl font-bold text-yellow-400" id="corpdoc-contract">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì¸í—ˆê°€</div><div class="text-xl font-bold text-green-400" id="corpdoc-license">0ê°œ</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê¸°íƒ€</div><div class="text-xl font-bold text-gray-400" id="corpdoc-other">0ê°œ</div></div>
                    </div>
                    
                    <!-- ê²€ìƒ‰/í•„í„° -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="corpDocSearch" class="input-field flex-1" style="min-width:200px" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." onkeyup="renderCorpDocTable()">
                            <select id="corpDocEntity" class="input-field" style="width:150px" onchange="renderCorpDocTable()"><option value="">ì „ì²´ ë²•ì¸</option></select>
                        </div>
                    </div>
                    
                    <!-- íŒŒì¼ ëª©ë¡ -->
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>íŒŒì¼ëª…</th><th>ë²•ì¸/ëŒ€ìƒ</th><th>ì„¤ëª…</th><th>í¬ê¸°</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="corpDocTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì—‘ì…€ ê´€ë¦¬ -->
                <div id="tab-excel" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“Š ì—‘ì…€ ê´€ë¦¬</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">ğŸï¸</div><div><h4 class="font-bold">ë¼ì´ë” í…œí”Œë¦¿</h4><p class="text-xs text-gray-400">ì¼ê´„ ì—…ë¡œë“œìš©</p></div></div>
                            <button onclick="downloadTemplate('rider')" class="btn-secondary btn-sm w-full">ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">ğŸ¤</div><div><h4 class="font-bold">í˜‘ë ¥ì‚¬ í…œí”Œë¦¿</h4><p class="text-xs text-gray-400">ì¼ê´„ ì—…ë¡œë“œìš©</p></div></div>
                            <button onclick="downloadTemplate('partner')" class="btn-secondary btn-sm w-full">ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3"><div class="text-2xl">ğŸ’¼</div><div><h4 class="font-bold">ì˜ì—…ì í…œí”Œë¦¿</h4><p class="text-xs text-gray-400">ì¼ê´„ ì—…ë¡œë“œìš©</p></div></div>
                            <button onclick="downloadTemplate('sales')" class="btn-secondary btn-sm w-full">ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                </div>

                <!-- ì¹´ë“œ ê´€ë¦¬ -->
                <div id="tab-cards" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’³ ì¹´ë“œ ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openCardModal()" class="btn-primary btn-sm">+ ì¹´ë“œ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="card-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ìš©ì¤‘</div><div class="text-xl font-bold text-green-400" id="card-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì¼ì‹œì¤‘ì§€</div><div class="text-xl font-bold text-yellow-400" id="card-suspended">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì‚¬ìš©ì•¡</div><div class="text-xl font-bold text-purple-400" id="card-monthly">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden mb-6">
                        <table class="data-table"><thead><tr><th>ì¹´ë“œë³„ì¹­</th><th>ì¹´ë“œë²ˆí˜¸</th><th>ì¹´ë“œì‚¬</th><th>ë‹´ë‹¹ì</th><th>ì¼í•œë„</th><th>ì›”í•œë„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="cardTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                    <h3 class="text-lg font-bold mb-4">ğŸ“‹ ìµœê·¼ ì‚¬ìš©ë‚´ì—­</h3>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì‹œ</th><th>ì¹´ë“œ</th><th>ê°€ë§¹ì </th><th>ê¸ˆì•¡</th><th>ì¦ë¹™</th><th>íšŒê³„</th></tr></thead>
                        <tbody id="cardTransTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì •ì‚° í˜„í™© ëŒ€ì‹œë³´ë“œ -->
                <div id="tab-sett-dashboard" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“Š ì •ì‚° í˜„í™©</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">í”Œë«í¼ ë°›ì„ê¸ˆì•¡</div>
                            <div class="text-2xl font-bold text-blue-400" id="sett-dash-platform">â‚©0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">ì„ ì •ì‚° ì§€ê¸‰ì•¡</div>
                            <div class="text-2xl font-bold text-red-400" id="sett-dash-advance">â‚©0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">ì°¨ì•¡ (ìˆ˜ìµ)</div>
                            <div class="text-2xl font-bold text-purple-400" id="sett-dash-profit">â‚©0</div>
                        </div>
                        <div class="glass-card rounded-xl p-4 text-center">
                            <div class="text-gray-400 text-xs mb-1">ëŒ€ì‚¬ ë¯¸ì™„ë£Œ</div>
                            <div class="text-2xl font-bold text-yellow-400" id="sett-dash-pending">0ê±´</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="font-bold mb-4 text-purple-400">ğŸ“¥ ìµœê·¼ í”Œë«í¼ ì •ì‚°</h3>
                            <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>í”Œë«í¼</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                            <tbody id="settDashPlatformTable"><tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                        </div>
                        <div class="glass-card rounded-xl p-4">
                            <h3 class="font-bold mb-4 text-red-400">ğŸ“¤ ìµœê·¼ ì„ ì •ì‚° ì§€ê¸‰</h3>
                            <table class="data-table"><thead><tr><th>ì¼ì</th><th>í˜‘ë ¥ì‚¬</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th></tr></thead>
                            <tbody id="settDashAdvanceTable"><tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- í”Œë«í¼ ì •ì‚° -->
                <div id="tab-platform" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“¥ í”Œë«í¼ì •ì‚°ì…ê¸ˆ</h2>
                        <button onclick="openPlatformModal()" class="btn-primary btn-sm">+ ì •ì‚° ë“±ë¡</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="plat-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê±´ìˆ˜</div><div class="text-xl font-bold text-yellow-400" id="plat-count-stat">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³µê¸‰ê°€ í•©ê³„</div><div class="text-xl font-bold text-green-400" id="plat-supply-stat">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê¸ˆì•¡</div><div class="text-xl font-bold text-blue-400" id="plat-amount">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>í”Œë«í¼</th><th>ì…‹íŠ¸ê¸°ê°„</th><th>ì™„ë£Œê±´ìˆ˜</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ê²°ì œì…ê¸ˆì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="platformTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì„ ì •ì‚° ì§€ê¸‰ -->
                <div id="tab-sett-advance" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“¤ ì„ ì •ì‚° ì§€ê¸‰ (í•˜ìœ„ë²•ì¸)</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="syncFromPlatformSettlement()" class="btn-secondary btn-sm">ğŸ”„ í”Œë«í¼ì •ì‚° ì—°ë™</button>
                            <button onclick="downloadSettAdvanceTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('settAdvanceExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportSettAdvanceExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openSettAdvanceModal()" class="btn-primary btn-sm">+ ì§€ê¸‰ ë“±ë¡</button>
                            <input type="file" id="settAdvanceExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadSettAdvanceExcel(this)">
                        </div>
                    </div>
                    
                    <!-- ì„¤ëª… ë°°ë„ˆ -->
                    <div class="glass-card rounded-xl p-4 mb-4 border-l-4 border-yellow-400">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ’¡</span>
                            <div>
                                <p class="text-yellow-400 font-bold">ì„ ì •ì‚°ì´ë€?</p>
                                <p class="text-gray-400 text-sm">í”Œë«í¼(ë°°ë¯¼/ì¿ íŒ¡) ì •ì‚°ê¸ˆ ì…ê¸ˆ ì „, íŒ€ë¸Œë¡œê°€ í•˜ìœ„ë²•ì¸(í˜‘ë ¥ì‚¬)ì—ê²Œ ë¨¼ì € ìµì¼ ì •ì‚°í•´ì£¼ëŠ” ê²ƒ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="settadv-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="settadv-pending">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§€ê¸‰ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="settadv-transferred">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-red-400" id="settadv-amount">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìˆ˜ìˆ˜ë£Œ ìˆ˜ìµ</div><div class="text-xl font-bold text-purple-400" id="settadv-fee-income">â‚©0</div></div>
                    </div>
                    
                    <!-- í•„í„° -->
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="settAdvMonthFilter" class="input-field" style="width:150px" onchange="renderSettAdvanceTable()">
                            <select id="settAdvPartnerFilter" class="input-field" style="width:150px" onchange="renderSettAdvanceTable()"><option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option></select>
                            <select id="settAdvStatusFilter" class="input-field" style="width:100px" onchange="renderSettAdvanceTable()"><option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="transferred">ì™„ë£Œ</option></select>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì§€ê¸‰ì¼</th><th>í˜‘ë ¥ì‚¬(í•˜ìœ„ë²•ì¸)</th><th>ì£¼ì°¨</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="settAdvanceTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ëŒ€ì‚¬ê´€ë¦¬ -->
                <div id="tab-reconcile" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ”„ ëŒ€ì‚¬ê´€ë¦¬ (ë§¤ì¹­)</h2>
                        <div class="flex gap-2">
                            <button onclick="autoReconcile()" class="btn-secondary btn-sm">âš¡ ìë™ ëŒ€ì‚¬</button>
                            <button onclick="openReconcileModal()" class="btn-primary btn-sm">+ ìˆ˜ë™ ëŒ€ì‚¬</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="rec-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="rec-pending">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="rec-matched">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¶ˆì¼ì¹˜</div><div class="text-xl font-bold text-red-400" id="rec-issue">0ê±´</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>í˜‘ë ¥ì‚¬</th><th>í”Œë«í¼ê¸ˆì•¡</th><th>ì„ ì •ì‚°ê¸ˆì•¡</th><th>ì°¨ì•¡</th><th>ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="reconcileTableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì£¼ì •ì‚° ì§€ê¸‰ -->
                <div id="tab-weekly-payout" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“† ì£¼ì •ì‚° ì§€ê¸‰</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadWeeklyPayoutTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('weeklyPayoutExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportWeeklyPayoutExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openWeeklyPayoutModal()" class="btn-primary btn-sm">+ ì£¼ì •ì‚° ë“±ë¡</button>
                            <input type="file" id="weeklyPayoutExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadWeeklyPayoutExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="weekly-total">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ëŒ€ê¸°</div><div class="text-xl font-bold text-yellow-400" id="weekly-pending">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì§€ê¸‰ì™„ë£Œ</div><div class="text-xl font-bold text-green-400" id="weekly-paid">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="weekly-amount">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="weeklyWeekFilter" class="input-field" style="width:130px" placeholder="ì£¼ì°¨ (2025-W03)">
                            <select id="weeklyStatusFilter" class="input-field" style="width:100px" onchange="renderWeeklyPayoutTable()"><option value="">ì „ì²´</option><option value="pending">ëŒ€ê¸°</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select>
                            <input type="text" id="weeklySearch" class="input-field flex-1" style="min-width:150px" placeholder="ë¼ì´ë”/í˜‘ë ¥ì‚¬ ê²€ìƒ‰..." onkeyup="renderWeeklyPayoutTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì£¼ì°¨</th><th>ë¼ì´ë”</th><th>í˜‘ë ¥ì‚¬</th><th>ë°°ë‹¬ê±´ìˆ˜</th><th>ë°°ë‹¬ìˆ˜ìµ</th><th>ê³µì œì•¡</th><th>ì‹¤ì§€ê¸‰ì•¡</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="weeklyPayoutTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- í˜„ê¸ˆì¶œë‚©ì¥ -->
                <div id="tab-bank" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“’ í˜„ê¸ˆì¶œë‚©ì¥</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadCashbookTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('bankExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportCashbookExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                            <button onclick="openCashbookModal()" class="btn-primary btn-sm">+ ê±°ë˜ ë“±ë¡</button>
                            <input type="file" id="bankExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadBankExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì…ê¸ˆ</div><div class="text-xl font-bold text-blue-400" id="bank-deposit">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì¶œê¸ˆ</div><div class="text-xl font-bold text-red-400" id="bank-withdrawal">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">í˜„ì¬ ì”ì•¡</div><div class="text-xl font-bold text-purple-400" id="bank-balance">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê±°ë˜ê±´ìˆ˜</div><div class="text-xl font-bold text-purple-400" id="bank-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì—°ê²°</div><div class="text-xl font-bold text-yellow-400" id="bank-unlinked">0ê±´</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2 items-center">
                            <input type="month" id="cashbookMonth" class="input-field" style="width:150px" onchange="renderCashbookTable()">
                            <select id="cashbookType" class="input-field" style="width:100px" onchange="renderCashbookTable()">
                                <option value="">ì „ì²´</option>
                                <option value="deposit">ì…ê¸ˆ</option>
                                <option value="withdrawal">ì¶œê¸ˆ</option>
                            </select>
                            <select id="cashbookLink" class="input-field" style="width:120px" onchange="renderCashbookTable()">
                                <option value="">ì—°ê²°ìƒíƒœ</option>
                                <option value="linked">ì—°ê²°ë¨</option>
                                <option value="unlinked">ë¯¸ì—°ê²°</option>
                            </select>
                            <input type="text" id="cashbookSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê±°ë˜ì²˜/ì ìš” ê²€ìƒ‰..." onkeyup="renderCashbookTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì</th><th>êµ¬ë¶„</th><th>ê±°ë˜ì²˜</th><th>ì…ê¸ˆ</th><th>ì¶œê¸ˆ</th><th>ì”ì•¡</th><th>ì ìš”</th><th>ì—°ê²°</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="bankTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬ -->
                <div id="tab-taxinvoice" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="downloadTemplate('taxinvoice')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('taxInvoiceExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportTaxInvoiceExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="syncTaxToSalesPurchase()" class="btn-secondary btn-sm">ğŸ”„ ë§¤ì…ë§¤ì¶œ ì—°ë™</button>
                            <button onclick="openTaxInvoiceModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                            <input type="file" id="taxInvoiceExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadTaxInvoiceExcel(this)">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì… ê±´ìˆ˜</div><div class="text-xl font-bold text-red-400" id="inv-purchase">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì… ê¸ˆì•¡</div><div class="text-xl font-bold text-red-400" id="inv-purchase-amt">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì¶œ ê±´ìˆ˜</div><div class="text-xl font-bold text-blue-400" id="inv-sales">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì¶œ ê¸ˆì•¡</div><div class="text-xl font-bold text-blue-400" id="inv-sales-amt">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì—°ë™</div><div class="text-xl font-bold text-yellow-400" id="inv-unsynced">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="invTypeFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">ì „ì²´</option><option value="purchase">ë§¤ì…</option><option value="sales">ë§¤ì¶œ</option></select>
                            <select id="invStatusFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">ì „ì²´</option><option value="unpaid">ë¯¸ì§€ê¸‰</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select>
                            <select id="invSyncFilter" class="input-field" style="width:100px" onchange="renderTaxInvoiceTable()"><option value="">ì—°ë™ìƒíƒœ</option><option value="synced">ì—°ë™ë¨</option><option value="unsynced">ë¯¸ì—°ë™</option></select>
                            <input type="month" id="invMonthFilter" class="input-field" style="width:150px" onchange="renderTaxInvoiceTable()">
                            <input type="text" id="invSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê±°ë˜ì²˜ ê²€ìƒ‰..." onkeyup="renderTaxInvoiceTable()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ìœ í˜•</th><th>ë°œí–‰ì¼</th><th>ê±°ë˜ì²˜</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ì§€ê¸‰ìƒíƒœ</th><th>ì—°ë™</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="taxInvoiceTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- íšŒê³„ ê´€ë¦¬ -->
                <div id="tab-accounting" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“Š íšŒê³„ ê´€ë¦¬</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="showAccSubTab('salesPurchase')" class="btn-primary btn-sm" id="btn-salesPurchase">ğŸ“‹ ë§¤ì…ë§¤ì¶œ</button>
                            <button onclick="showAccSubTab('ledger')" class="btn-secondary btn-sm" id="btn-ledger">ğŸ“š ì´ê³„ì •ì›ì¥</button>
                            <button onclick="showAccSubTab('journal')" class="btn-secondary btn-sm" id="btn-journal">ğŸ“’ ë¶„ê°œì¥</button>
                        </div>
                    </div>
                    
                    <!-- ìš”ì•½ ëŒ€ì‹œë³´ë“œ -->
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ë§¤ì¶œ</div><div class="text-xl font-bold text-blue-400" id="acc-sales">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ë§¤ì…</div><div class="text-xl font-bold text-red-400" id="acc-purchase">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì¶œ ë¶€ê°€ì„¸</div><div class="text-xl font-bold text-blue-300" id="acc-sales-vat">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§¤ì… ë¶€ê°€ì„¸</div><div class="text-xl font-bold text-red-300" id="acc-purchase-vat">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë‚©ë¶€ ë¶€ê°€ì„¸</div><div class="text-xl font-bold text-yellow-400" id="acc-vat-pay">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìˆœì´ìµ</div><div class="text-xl font-bold text-purple-400" id="acc-profit">â‚©0</div></div>
                    </div>
                    
                    <!-- ë§¤ì…ë§¤ì¶œì¥ -->
                    <div id="accSubTab-salesPurchase">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">ğŸ“‹ ë§¤ì…ë§¤ì¶œì¥</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadSalesPurchaseTemplate()" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                                <button onclick="document.getElementById('salesPurchaseExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                                <button onclick="exportSalesPurchaseExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´</button>
                                <button onclick="syncFromSettlements()" class="btn-secondary btn-sm">ğŸ”„ ì •ì‚° ì—°ë™</button>
                                <button onclick="openSalesPurchaseModal()" class="btn-primary btn-sm">+ ë“±ë¡</button>
                                <input type="file" id="salesPurchaseExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadSalesPurchaseExcel(this)">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="spMonthFilter" class="input-field" style="width:150px" onchange="renderSalesPurchaseTable()">
                                <select id="spTypeFilter" class="input-field" style="width:100px" onchange="renderSalesPurchaseTable()">
                                    <option value="">ì „ì²´</option>
                                    <option value="sales">ë§¤ì¶œ</option>
                                    <option value="purchase">ë§¤ì…</option>
                                </select>
                                <select id="spTaxFilter" class="input-field" style="width:120px" onchange="renderSalesPurchaseTable()">
                                    <option value="">ì„¸ê¸ˆê³„ì‚°ì„œ</option>
                                    <option value="issued">ë°œí–‰</option>
                                    <option value="received">ìˆ˜ì·¨</option>
                                    <option value="pending">ë¯¸ë°œí–‰</option>
                                </select>
                                <input type="text" id="spSearch" class="input-field flex-1" style="min-width:150px" placeholder="ê±°ë˜ì²˜/í’ˆëª© ê²€ìƒ‰..." onkeyup="renderSalesPurchaseTable()">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden mb-6">
                            <table class="data-table"><thead><tr><th>ì¼ì</th><th>êµ¬ë¶„</th><th>ê±°ë˜ì²˜</th><th>í’ˆëª©</th><th>ê³µê¸‰ê°€</th><th>ë¶€ê°€ì„¸</th><th>í•©ê³„</th><th>ì„¸ê¸ˆê³„ì‚°ì„œ</th><th>ì—°ê²°</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="salesPurchaseTableBody"><tr><td colspan="10" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                        </div>
                    </div>
                    
                    <!-- ë¶„ê°œì¥ -->
                    <div id="accSubTab-journal" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">ğŸ“’ ë¶„ê°œì¥</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadTemplate('journal')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                                <button onclick="document.getElementById('journalExcelInput').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                                <button onclick="exportJournalExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                                <button onclick="openJournalModal()" class="btn-primary btn-sm">+ ë¶„ê°œ ë“±ë¡</button>
                                <input type="file" id="journalExcelInput" accept=".xlsx,.xls" class="hidden" onchange="uploadJournalExcel(this)">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="accMonthFilter" class="input-field" style="width:150px" onchange="renderJournalTable()">
                                <select id="accStatusFilter" class="input-field" style="width:100px" onchange="renderJournalTable()"><option value="">ì „ì²´</option><option value="created">ìƒì„±</option><option value="confirmed">í™•ì •</option></select>
                                <select id="accAccountFilter" class="input-field" style="width:150px" onchange="renderJournalTable()">
                                    <option value="">ì „ì²´ ê³„ì •</option>
                                    <optgroup label="ìì‚°">
                                        <option value="101">í˜„ê¸ˆ</option>
                                        <option value="102">ë³´í†µì˜ˆê¸ˆ</option>
                                        <option value="108">ë§¤ì¶œì±„ê¶Œ</option>
                                        <option value="120">ì¬ê³ ìì‚°</option>
                                    </optgroup>
                                    <optgroup label="ë¶€ì±„">
                                        <option value="201">ë§¤ì…ì±„ë¬´</option>
                                        <option value="210">ë¯¸ì§€ê¸‰ê¸ˆ</option>
                                        <option value="220">ì˜ˆìˆ˜ê¸ˆ</option>
                                    </optgroup>
                                    <optgroup label="ìˆ˜ìµ">
                                        <option value="401">ë§¤ì¶œ</option>
                                        <option value="402">ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</option>
                                    </optgroup>
                                    <optgroup label="ë¹„ìš©">
                                        <option value="501">ê¸‰ì—¬</option>
                                        <option value="502">ì„ì°¨ë£Œ</option>
                                        <option value="503">í†µì‹ ë¹„</option>
                                        <option value="504">ì†Œëª¨í’ˆë¹„</option>
                                        <option value="510">ì°¨ëŸ‰ìœ ì§€ë¹„</option>
                                    </optgroup>
                                </select>
                                <input type="text" id="accSearch" class="input-field flex-1" style="min-width:150px" placeholder="ì ìš” ê²€ìƒ‰..." onkeyup="renderJournalTable()">
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden">
                            <table class="data-table"><thead><tr><th>ì¼ì</th><th>ë¶„ê°œë²ˆí˜¸</th><th>ì°¨ë³€ê³„ì •</th><th>ì°¨ë³€ê¸ˆì•¡</th><th>ëŒ€ë³€ê³„ì •</th><th>ëŒ€ë³€ê¸ˆì•¡</th><th>ì ìš”</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="journalTableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                        </div>
                    </div>
                    
                    <!-- ì´ê³„ì •ì›ì¥ -->
                    <div id="accSubTab-ledger" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <h3 class="text-lg font-bold">ğŸ“š ì´ê³„ì •ì›ì¥</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="exportLedgerExcel()" class="btn-secondary btn-sm">ğŸ“Š ì—‘ì…€ ë‹¤ìš´</button>
                                <button onclick="renderLedgerTable()" class="btn-secondary btn-sm">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                        </div>
                        <div class="glass-card rounded-xl p-3 mb-4">
                            <div class="flex flex-wrap gap-2">
                                <input type="month" id="ledgerMonthFilter" class="input-field" style="width:150px" onchange="renderLedgerTable()">
                                <select id="ledgerCategoryFilter" class="input-field" style="width:120px" onchange="renderLedgerTable()">
                                    <option value="">ì „ì²´ ë¶„ë¥˜</option>
                                    <option value="asset">ìì‚°</option>
                                    <option value="liability">ë¶€ì±„</option>
                                    <option value="equity">ìë³¸</option>
                                    <option value="revenue">ìˆ˜ìµ</option>
                                    <option value="expense">ë¹„ìš©</option>
                                </select>
                            </div>
                        </div>
                        <!-- ê³„ì •ê³¼ëª©ë³„ ìš”ì•½ ì¹´ë“œ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-blue-400">
                                <div class="text-gray-400 text-xs">ìì‚° ì´ê³„</div>
                                <div class="text-xl font-bold text-blue-400" id="ledger-asset">â‚©0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-red-400">
                                <div class="text-gray-400 text-xs">ë¶€ì±„ ì´ê³„</div>
                                <div class="text-xl font-bold text-red-400" id="ledger-liability">â‚©0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-green-400">
                                <div class="text-gray-400 text-xs">ìˆ˜ìµ ì´ê³„</div>
                                <div class="text-xl font-bold text-green-400" id="ledger-revenue">â‚©0</div>
                            </div>
                            <div class="glass-card rounded-xl p-3 text-center border-l-4 border-orange-400">
                                <div class="text-gray-400 text-xs">ë¹„ìš© ì´ê³„</div>
                                <div class="text-xl font-bold text-orange-400" id="ledger-expense">â‚©0</div>
                            </div>
                        </div>
                        <div class="glass-card rounded-xl overflow-hidden">
                            <table class="data-table"><thead><tr><th>ê³„ì •ì½”ë“œ</th><th>ê³„ì •ê³¼ëª©</th><th>ë¶„ë¥˜</th><th>ì°¨ë³€ í•©ê³„</th><th>ëŒ€ë³€ í•©ê³„</th><th>ì”ì•¡</th><th>ê±°ë˜ê±´ìˆ˜</th></tr></thead>
                            <tbody id="ledgerTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- ì´ê³„ì •ì›ì¥ (ë…ë¦½íƒ­) -->
                <div id="tab-ledger" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“š ì´ê³„ì •ì›ì¥</h2>
                        <div class="flex gap-2">
                            <button onclick="exportLedgerExcel()" class="btn-secondary btn-sm">ğŸ“Š ì—‘ì…€ ë‹¤ìš´</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-blue-400"><div class="text-gray-400 text-xs">ìì‚° ì´ê³„</div><div class="text-xl font-bold text-blue-400" id="ledger2-asset">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-red-400"><div class="text-gray-400 text-xs">ë¶€ì±„ ì´ê³„</div><div class="text-xl font-bold text-red-400" id="ledger2-liability">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-green-400"><div class="text-gray-400 text-xs">ìˆ˜ìµ ì´ê³„</div><div class="text-xl font-bold text-green-400" id="ledger2-revenue">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center border-l-4 border-orange-400"><div class="text-gray-400 text-xs">ë¹„ìš© ì´ê³„</div><div class="text-xl font-bold text-orange-400" id="ledger2-expense">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="ledger2MonthFilter" class="input-field" style="width:150px" onchange="renderLedgerTable2()">
                            <select id="ledger2CategoryFilter" class="input-field" style="width:120px" onchange="renderLedgerTable2()">
                                <option value="">ì „ì²´ ë¶„ë¥˜</option>
                                <option value="asset">ìì‚°</option>
                                <option value="liability">ë¶€ì±„</option>
                                <option value="revenue">ìˆ˜ìµ</option>
                                <option value="expense">ë¹„ìš©</option>
                            </select>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ê³„ì •ì½”ë“œ</th><th>ê³„ì •ê³¼ëª©</th><th>ë¶„ë¥˜</th><th>ì°¨ë³€ í•©ê³„</th><th>ëŒ€ë³€ í•©ê³„</th><th>ì”ì•¡</th><th>ê±°ë˜ê±´ìˆ˜</th></tr></thead>
                        <tbody id="ledger2TableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ë¶„ê°œì¥ (ë…ë¦½íƒ­) -->
                <div id="tab-journal" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“’ ë¶„ê°œì¥</h2>
                        <div class="flex gap-2">
                            <button onclick="downloadTemplate('journal')" class="btn-secondary btn-sm">ğŸ“¥ ì–‘ì‹</button>
                            <button onclick="document.getElementById('journalExcelInput2').click()" class="btn-secondary btn-sm">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button onclick="exportJournalExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="openJournalModal()" class="btn-primary btn-sm">+ ë¶„ê°œ ë“±ë¡</button>
                            <input type="file" id="journalExcelInput2" accept=".xlsx,.xls" class="hidden" onchange="uploadJournalExcel(this)">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <input type="month" id="journal2MonthFilter" class="input-field" style="width:150px" onchange="renderJournalTable2()">
                            <select id="journal2StatusFilter" class="input-field" style="width:100px" onchange="renderJournalTable2()"><option value="">ì „ì²´</option><option value="created">ìƒì„±</option><option value="confirmed">í™•ì •</option></select>
                            <input type="text" id="journal2Search" class="input-field flex-1" style="min-width:150px" placeholder="ì ìš” ê²€ìƒ‰..." onkeyup="renderJournalTable2()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì</th><th>ë¶„ê°œë²ˆí˜¸</th><th>ì°¨ë³€ê³„ì •</th><th>ì°¨ë³€ê¸ˆì•¡</th><th>ëŒ€ë³€ê³„ì •</th><th>ëŒ€ë³€ê¸ˆì•¡</th><th>ì ìš”</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="journal2TableBody"><tr><td colspan="9" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì¹´ë“œ ì‚¬ìš©ë‚´ì—­ -->
                <div id="tab-card-usage" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’³ ì¹´ë“œ ì‚¬ìš©ë‚´ì—­</h2>
                        <div class="flex gap-2">
                            <button onclick="exportCardTransExcel()" class="btn-secondary btn-sm">ğŸ“Š ë‹¤ìš´ë¡œë“œ</button>
                            <button onclick="openCardTransModal()" class="btn-primary btn-sm">+ ì‚¬ìš©ë‚´ì—­ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì‚¬ìš©</div><div class="text-xl font-bold text-red-400" id="card-usage-monthly">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‚¬ìš©ê±´ìˆ˜</div><div class="text-xl font-bold text-blue-400" id="card-usage-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì¦ë¹™</div><div class="text-xl font-bold text-yellow-400" id="card-usage-noreceipt">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë¯¸ì²˜ë¦¬</div><div class="text-xl font-bold text-orange-400" id="card-usage-pending">0ê±´</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì‹œ</th><th>ì¹´ë“œ</th><th>ê°€ë§¹ì </th><th>ê¸ˆì•¡</th><th>ì¦ë¹™</th><th>íšŒê³„ì²˜ë¦¬</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="cardUsageTableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì§ì› ê´€ë¦¬ -->
                <div id="tab-employees" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ‘¤ ì§ì› ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openEmployeeModal()" class="btn-primary btn-sm">+ ì§ì› ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´</div><div class="text-xl font-bold text-purple-400" id="emp2-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì •ê·œì§</div><div class="text-xl font-bold text-blue-400" id="emp2-regular">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ê³„ì•½ì§</div><div class="text-xl font-bold text-yellow-400" id="emp2-contract">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">4ëŒ€ë³´í—˜</div><div class="text-xl font-bold text-green-400" id="emp2-insured">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>êµ¬ë¶„</th><th>ë¶€ì„œ</th><th>ê¸°ë³¸ê¸‰</th><th>4ëŒ€ë³´í—˜</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="employees2TableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ê¸‰ì—¬ ê´€ë¦¬ -->
                <div id="tab-payroll" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ’° ê¸‰ì—¬ ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openPayrollModal()" class="btn-primary btn-sm">+ ê¸‰ì—¬ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ë²ˆë‹¬ ì§€ê¸‰</div><div class="text-xl font-bold text-purple-400" id="pay2-count">0ê±´</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-blue-400" id="pay2-gross">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì´ ê³µì œì•¡</div><div class="text-xl font-bold text-red-400" id="pay2-deduct">â‚©0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì‹¤ì§€ê¸‰ì•¡</div><div class="text-xl font-bold text-purple-400" id="pay2-net">â‚©0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì§€ê¸‰ì›”</th><th>ì§ì›</th><th>ê¸°ë³¸ê¸‰</th><th>ìˆ˜ë‹¹</th><th>ê³µì œ</th><th>ì‹¤ì§€ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="payroll2TableBody"><tr><td colspan="8" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ê·¼ë¡œê³„ì•½ -->
                <div id="tab-contracts" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold">ğŸ“ ê·¼ë¡œê³„ì•½ ê´€ë¦¬</h2>
                        <div class="flex gap-2">
                            <button onclick="openContractModal()" class="btn-primary btn-sm">+ ê³„ì•½ ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ì „ì²´ ê³„ì•½</div><div class="text-xl font-bold text-purple-400" id="contract-total">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ìœ íš¨ ê³„ì•½</div><div class="text-xl font-bold text-green-400" id="contract-active">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§Œë£Œ ì˜ˆì •</div><div class="text-xl font-bold text-yellow-400" id="contract-expiring">0</div></div>
                        <div class="glass-card rounded-xl p-3 text-center"><div class="text-gray-400 text-xs">ë§Œë£Œë¨</div><div class="text-xl font-bold text-red-400" id="contract-expired">0</div></div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì§ì›</th><th>ê³„ì•½ìœ í˜•</th><th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th><th>ê¸°ë³¸ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="contracts2TableBody"><tr><td colspan="7" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ê°ì‚¬ ë¡œê·¸ -->
                <div id="tab-logs" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“œ ê°ì‚¬ ë¡œê·¸</h2>
                    <div class="glass-card rounded-xl p-3 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="logTableFilter" class="input-field" style="width:150px" onchange="renderAuditLogs()"><option value="">ì „ì²´ í…Œì´ë¸”</option><option value="corporate_cards">ë²•ì¸ì¹´ë“œ</option><option value="card_transactions">ì¹´ë“œì‚¬ìš©</option><option value="hq_tax_invoices">ì„¸ê¸ˆê³„ì‚°ì„œ</option><option value="accounting_journals">íšŒê³„ë¶„ê°œ</option></select>
                            <select id="logActionFilter" class="input-field" style="width:100px" onchange="renderAuditLogs()"><option value="">ì „ì²´</option><option value="INSERT">ë“±ë¡</option><option value="UPDATE">ìˆ˜ì •</option><option value="DELETE">ì‚­ì œ</option></select>
                            <input type="date" id="logDateFilter" class="input-field" style="width:150px" onchange="renderAuditLogs()">
                        </div>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden">
                        <table class="data-table"><thead><tr><th>ì¼ì‹œ</th><th>í…Œì´ë¸”</th><th>ì•¡ì…˜</th><th>ë ˆì½”ë“œID</th><th>ë³€ê²½ì</th><th>ìƒì„¸</th></tr></thead>
                        <tbody id="auditLogTableBody"><tr><td colspan="6" class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</td></tr></tbody></table>
                    </div>
                </div>

                <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
                <div id="tab-settings" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2>
                    <div class="glass-card rounded-xl p-8 text-center"><div class="text-4xl mb-4">âš™ï¸</div><p class="text-gray-400">ì‹œìŠ¤í…œ ì„¤ì • ê¸°ëŠ¥ ì¤€ë¹„ì¤‘</p></div>
                </div>
            </main>
        </div>
    </div>

    <!-- ë¼ì´ë” ëª¨ë‹¬ -->
    <div id="riderModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 id="riderModalTitle" class="text-xl font-bold text-purple-400">ğŸï¸ ë¼ì´ë” ë“±ë¡</h3><button onclick="closeModal('riderModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="riderForm" onsubmit="submitForm('rider',event)" class="space-y-4">
                <input type="hidden" id="rider-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì´ë¦„ *</label><input type="text" id="rider-name" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì—°ë½ì²˜</label><input type="tel" id="rider-phone" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">í˜‘ë ¥ì‚¬</label><select id="rider-partner" class="input-field"><option value="">ì„ íƒì•ˆí•¨</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="rider-status" class="input-field"><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì£¼ì†Œ</label><input type="text" id="rider-address" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì€í–‰</label><select id="rider-bank" class="input-field"><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option><option value="KAKAO">ì¹´ì¹´ì˜¤</option><option value="TOSS">í† ìŠ¤</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="rider-account-no" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì˜ˆê¸ˆì£¼</label><input type="text" id="rider-account-holder" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì£¼ë¯¼ë²ˆí˜¸</label><input type="text" id="rider-ssn" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì›ì²œì§•ìˆ˜</label><select id="rider-tax-type" class="input-field"><option value="">ì„ íƒ</option><option value="3.3">3.3%</option><option value="8.8">8.8%</option><option value="none">ì—†ìŒ</option></select></div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="rider-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('riderModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í˜‘ë ¥ì‚¬ ëª¨ë‹¬ -->
    <div id="partnerModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 id="partnerModalTitle" class="text-xl font-bold text-purple-400">ğŸ¤ í˜‘ë ¥ì‚¬ ë“±ë¡</h3><button onclick="closeModal('partnerModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="partnerForm" onsubmit="submitForm('partner',event)" class="space-y-4">
                <input type="hidden" id="partner-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">í˜‘ë ¥ì‚¬ëª… *</label><input type="text" id="partner-name" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">í˜‘ë ¥ì‚¬ì½”ë“œ *</label><input type="text" id="partner-code" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">êµ¬ë¶„</label><select id="partner-type" class="input-field" onchange="toggleBizFields()"><option value="non_biz">ë¹„ì‚¬ì—…ì</option><option value="biz">ì‚¬ì—…ì</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="partner-rep" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì—°ë½ì²˜</label><input type="tel" id="partner-phone" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì´ë©”ì¼</label><input type="email" id="partner-email" class="input-field"></div>
                </div>
                <div id="partnerBizFields" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="partner-bizno" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì—…ì¢…</label><input type="text" id="partner-biztype" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì£¼ì†Œ</label><input type="text" id="partner-address" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì€í–‰</label><select id="partner-bank" class="input-field"><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="partner-accountno" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="partner-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('partnerModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì˜ì—…ì ëª¨ë‹¬ -->
    <div id="salesModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px">
            <div class="flex justify-between items-center mb-4"><h3 id="salesModalTitle" class="text-xl font-bold text-purple-400">ğŸ’¼ ì˜ì—…ì ë“±ë¡</h3><button onclick="closeModal('salesModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="salesForm" onsubmit="submitForm('sales',event)" class="space-y-4">
                <input type="hidden" id="sales-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì˜ì—…ìì½”ë“œ *</label><input type="text" id="sales-code" class="input-field" placeholder="SB-0001" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìœ í˜• *</label><select id="sales-type" class="input-field" required onchange="toggleSalesBizFields()"><option value="individual">ê°œì¸</option><option value="sole_prop">ê°œì¸ì‚¬ì—…ì</option><option value="corporation">ë²•ì¸</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì´ë¦„ *</label><input type="text" id="sales-name" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì—°ë½ì²˜</label><input type="tel" id="sales-phone" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì´ë©”ì¼</label><input type="email" id="sales-email" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ì—­</label><input type="text" id="sales-region" class="input-field"></div>
                </div>
                <div id="salesBizFields" class="hidden grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="sales-bizno" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="sales-repname" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì£¼ì†Œ</label><input type="text" id="sales-address" class="input-field"></div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì€í–‰</label><select id="sales-bank" class="input-field"><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option><option value="KAKAO">ì¹´ì¹´ì˜¤</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì˜ˆê¸ˆì£¼</label><input type="text" id="sales-bank-holder" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="sales-bank-account" class="input-field"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ì£¼ê¸°</label><select id="sales-payout-cycle" class="input-field"><option value="monthly">ì›”</option><option value="weekly">ì£¼</option><option value="per_case">ê±´ë³„</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì›ì²œì§•ìˆ˜ìœ¨</label><select id="sales-withholding-rate" class="input-field"><option value="0.033">3.3%</option><option value="0.088">8.8%</option><option value="0">ì—†ìŒ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="sales-status" class="input-field"><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="sales-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('salesModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ëª¨ë‹¬ -->
    <div id="userModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 id="userModalTitle" class="text-xl font-bold text-purple-400">ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡</h3><button onclick="closeModal('userModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="userForm" onsubmit="submitUser(event)" class="space-y-4">
                <input type="hidden" id="user-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì´ë¦„ *</label><input type="text" id="user-name" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì•„ì´ë”” *</label><input type="text" id="user-username" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="user-password" class="input-field"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ê¶Œí•œ</label><select id="user-role" class="input-field"><option value="STAFF">ì§ì›</option><option value="MANAGER">ë§¤ë‹ˆì €</option><option value="ADMIN">ê´€ë¦¬ì</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="user-status" class="input-field"><option value="true">í™œì„±</option><option value="false">ë¹„í™œì„±</option></select></div>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('userModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì •ì‚° ëª¨ë‹¬ -->
    <div id="settlementModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:900px">
            <div class="flex justify-between items-center mb-4"><h3 id="settlementModalTitle" class="text-xl font-bold text-purple-400">ğŸ’° ì •ì‚° ë“±ë¡</h3><button onclick="closeModal('settlementModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="settlementForm" onsubmit="submitSettlement(event)" class="space-y-4">
                <input type="hidden" id="sett-id">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="sett-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê·¼ë¬´ì‹œì‘(ìˆ˜)</label><input type="date" id="sett-start" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê·¼ë¬´ì¢…ë£Œ(í™”)</label><input type="date" id="sett-end" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ì˜ˆì •ì¼(ê¸ˆ)</label><input type="date" id="sett-paydate" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ë¼ì´ë” *</label><select id="sett-rider" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">í˜‘ë ¥ì‚¬</label><select id="sett-partner" class="input-field"><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">í”Œë«í¼</label><select id="sett-platform" class="input-field"><option value="">ì„ íƒ</option><option value="baemin">ë°°ë¯¼</option><option value="coupang">ì¿ íŒ¡ì´ì¸ </option><option value="yogiyo">ìš”ê¸°ìš”</option></select></div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ’µ ìˆ˜ì… í•­ëª©</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë°°ë‹¬ë£Œ</label><input type="number" id="sett-delivery" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¯¸ì…˜ë¹„</label><input type="number" id="sett-mission" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì¶”ê°€ì§€ê¸‰</label><input type="number" id="sett-extra" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í˜ì´ë°±</label><input type="number" id="sett-payback" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì¸ì„¼í‹°ë¸Œ</label><input type="number" id="sett-incentive" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">íŒ</label><input type="number" id="sett-tip" class="input-field" value="0" onchange="calcSettlement()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-red-400 font-bold mb-3">ğŸ“‰ ê³µì œ í•­ëª©</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë³´í—˜ë£Œ</label><input type="number" id="sett-insurance" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì¥ë¹„ëŒ€ì—¬ë£Œ</label><input type="number" id="sett-rental" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">íŒ¨ë„í‹°</label><input type="number" id="sett-penalty" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸°íƒ€ê³µì œ</label><input type="number" id="sett-other" class="input-field" value="0" onchange="calcSettlement()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <h4 class="text-purple-400 font-bold mb-3">âš¡ ì„ ì •ì‚°</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì„ ì •ì‚° ê¸ˆì•¡</label><input type="number" id="sett-advance" class="input-field" value="0" onchange="calcSettlement()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ìƒíƒœ</label><select id="sett-status" class="input-field"><option value="pending">ëŒ€ê¸°</option><option value="confirmed">í™•ì •</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4 mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì´ ìˆ˜ì…</div><div class="text-lg font-bold text-purple-400" id="calc-gross">â‚©0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì´ ê³µì œ</div><div class="text-lg font-bold text-red-400" id="calc-deduct">â‚©0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì„ ì •ì‚°</div><div class="text-lg font-bold text-purple-400" id="calc-advance">â‚©0</div></div>
                        <div class="glass-card rounded-lg p-3"><div class="text-xs text-gray-400">ì‹¤ì§€ê¸‰ì•¡</div><div class="text-lg font-bold text-green-400" id="calc-net">â‚©0</div></div>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="sett-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('settlementModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì¹´ë“œ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="cardModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="cardModalTitle" class="text-xl font-bold text-purple-400">ğŸ’³ ì¹´ë“œ ë“±ë¡</h3><button onclick="closeModal('cardModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="cardForm" onsubmit="submitCard(event)" class="space-y-4">
                <input type="hidden" id="card-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¹´ë“œë³„ì¹­ *</label><input type="text" id="card-alias" class="input-field" placeholder="ìš´ì˜ë¹„ì¹´ë“œ" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì†Œì†ë²•ì¸</label><input type="text" id="card-company" class="input-field" placeholder="íŒ€ë¸Œë¡œ"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¹´ë“œì‚¬ *</label><select id="card-company-name" class="input-field" required><option value="">ì„ íƒ</option><option value="KB">êµ­ë¯¼</option><option value="SHINHAN">ì‹ í•œ</option><option value="WOORI">ìš°ë¦¬</option><option value="HANA">í•˜ë‚˜</option><option value="NH">ë†í˜‘</option><option value="BC">BC</option><option value="SAMSUNG">ì‚¼ì„±</option><option value="LOTTE">ë¡¯ë°</option><option value="HYUNDAI">í˜„ëŒ€</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì¹´ë“œë²ˆí˜¸ (ë§ˆìŠ¤í‚¹)</label><input type="text" id="card-number" class="input-field" placeholder="1234-****-****-5678"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì—°ê²°í†µì¥</label><input type="text" id="card-bank" class="input-field" placeholder="ìš°ë¦¬ì€í–‰ 1002-xxx"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìœ íš¨ê¸°ê°„</label><input type="date" id="card-valid" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì‚¬ìš©ë¶€ì„œ</label><input type="text" id="card-dept" class="input-field" placeholder="ê²½ì˜ì§€ì›íŒ€"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì‹¤ì‚¬ìš©ì</label><input type="text" id="card-user" class="input-field" placeholder="í™ê¸¸ë™"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ’° í•œë„ ì„¤ì •</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì¼ í•œë„</label><input type="number" id="card-daily" class="input-field" value="0"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì›” í•œë„</label><input type="number" id="card-monthly" class="input-field" value="0"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <label class="flex items-center gap-2"><input type="checkbox" id="card-online" checked> <span class="text-sm">ì˜¨ë¼ì¸ ê²°ì œ í—ˆìš©</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="card-overseas"> <span class="text-sm">í•´ì™¸ ê²°ì œ í—ˆìš©</span></label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ë°œê¸‰ì¼</label><input type="date" id="card-issued" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="card-status" class="input-field"><option value="active">ì‚¬ìš©ì¤‘</option><option value="suspended">ì¼ì‹œì¤‘ì§€</option><option value="terminated">í•´ì§€</option></select></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="card-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('cardModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì¹´ë“œ ì‚¬ìš©ë‚´ì—­ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="cardTransModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ’³ ì‚¬ìš©ë‚´ì—­ ë“±ë¡</h3><button onclick="closeModal('cardTransModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="cardTransForm" onsubmit="submitCardTrans(event)" class="space-y-4">
                <input type="hidden" id="cardtrans-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì‚¬ìš©ì¼ì‹œ *</label><input type="datetime-local" id="cardtrans-date" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì¹´ë“œ *</label><select id="cardtrans-card" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ê°€ë§¹ì ëª… *</label><input type="text" id="cardtrans-merchant" class="input-field" required placeholder="ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì "></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê¸ˆì•¡ *</label><input type="number" id="cardtrans-amount" class="input-field" required placeholder="0"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì—…ì¢…</label><input type="text" id="cardtrans-category" class="input-field" placeholder="ìŒì‹ì , ì£¼ìœ ì†Œ ë“±"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ìŠ¹ì¸ë²ˆí˜¸</label><input type="text" id="cardtrans-approval" class="input-field" placeholder="12345678"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¦ë¹™ ìƒíƒœ</label>
                        <select id="cardtrans-evidence" class="input-field">
                            <option value="pending">ë¯¸ì œì¶œ</option>
                            <option value="submitted">ì œì¶œ</option>
                            <option value="approved">ìŠ¹ì¸</option>
                        </select>
                    </div>
                    <div><label class="block text-sm text-purple-400 mb-1">íšŒê³„ ì²˜ë¦¬</label>
                        <select id="cardtrans-accounting" class="input-field">
                            <option value="pending">ë¯¸ì²˜ë¦¬</option>
                            <option value="journalized">ë¶„ê°œì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="cardtrans-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('cardTransModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í”Œë«í¼ ì •ì‚° ëª¨ë‹¬ -->
    <div id="platformModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ“¥ í”Œë«í¼ ì •ì‚° ë“±ë¡</h3><button onclick="closeModal('platformModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="platformForm" onsubmit="submitPlatform(event)" class="space-y-4">
                <input type="hidden" id="plat-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">í”Œë«í¼ *</label><select id="plat-platform" class="input-field" required><option value="">ì„ íƒ</option><option value="baemin">ë°°ë¯¼</option><option value="coupang">ì¿ íŒ¡ì´ì¸ </option><option value="yogiyo">ìš”ê¸°ìš”</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="plat-week" class="input-field" placeholder="2025-W03" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì…‹íŠ¸ì‹œì‘</label><input type="date" id="plat-start" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì…‹íŠ¸ì¢…ë£Œ</label><input type="date" id="plat-end" class="input-field"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ê²°ì œì…ê¸ˆì¼</label><input type="date" id="plat-expected" class="input-field"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì´ ì™„ë£Œê±´ìˆ˜</label><input type="number" id="plat-count" class="input-field" value="0"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡</label><input type="number" id="plat-supply" class="input-field" value="0" onchange="calcPlatformVat()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="plat-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="plat-total-amt" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="plat-memo" class="input-field" rows="4"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('platformModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì„ ì •ì‚° ì§€ê¸‰ ëª¨ë‹¬ -->
    <div id="settAdvanceModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-red-400">ğŸ“¤ ì„ ì •ì‚° ì§€ê¸‰ ë“±ë¡</h3><button onclick="closeModal('settAdvanceModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="settAdvanceForm" onsubmit="submitSettAdvance(event)" class="space-y-4">
                <input type="hidden" id="settadv-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">í˜‘ë ¥ì‚¬ *</label><select id="settadv-partner" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ì¼ *</label><input type="date" id="settadv-date" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì •ì‚°ì£¼ì°¨</label><input type="text" id="settadv-week" class="input-field" placeholder="2025-W03"></div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡</label><input type="number" id="settadv-supply" class="input-field" value="0" onchange="calcSettAdvanceTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="settadv-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="settadv-total-amt" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-yellow-400 font-bold mb-3">ğŸ’¸ ìˆ˜ìˆ˜ë£Œ</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label><input type="number" id="settadv-fee-rate" class="input-field" value="0" step="0.01" onchange="calcSettAdvanceTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡</label><input type="number" id="settadv-fee" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì‹¤ì§€ê¸‰ì•¡</label><input type="number" id="settadv-net" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="settadv-status" class="input-field"><option value="pending">ëŒ€ê¸°</option><option value="transferred">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="settadv-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('settAdvanceModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì„¸ë¬´ì„œë¥˜ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="taxUploadModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ“¤ ì„¸ë¬´ì„œë¥˜ ì—…ë¡œë“œ</h3><button onclick="closeModal('taxUploadModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="taxUploadForm" onsubmit="submitTaxUpload(event)" class="space-y-4">
                <div><label class="block text-sm text-purple-400 mb-1">ì¹´í…Œê³ ë¦¬ *</label>
                    <select id="taxdoc-category" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="withholding">ì›ì²œì„¸ ì‹ ê³ </option>
                        <option value="statement">ì§€ê¸‰ëª…ì„¸ì„œ</option>
                        <option value="other">ê¸°íƒ€ ì„œë¥˜</option>
                    </select>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì„œë¥˜ì¼ì</label>
                    <input type="date" id="taxdoc-date" class="input-field">
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">íŒŒì¼ ì„ íƒ * (ìµœëŒ€ 10ê°œ)</label>
                    <input type="file" id="taxdoc-file" class="input-field" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.doc,.docx" multiple required onchange="checkFileLimit(this)">
                    <p class="text-gray-500 text-xs mt-1">PDF, ì´ë¯¸ì§€, ì—‘ì…€, ì›Œë“œ íŒŒì¼ ì§€ì› | í•œ ë²ˆì— ìµœëŒ€ 10ê°œ</p>
                    <div id="selectedFileList" class="mt-2 text-sm text-gray-400"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì„¤ëª…</label>
                    <input type="text" id="taxdoc-desc" class="input-field" placeholder="2025ë…„ 1ì›” ì›ì²œì„¸ ì‹ ê³ ì„œ">
                </div>
                <div id="uploadProgress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="uploadProgressBar" class="bg-purple-400 h-2 rounded-full transition-all" style="width:0%"></div>
                    </div>
                    <p id="uploadProgressText" class="text-center text-sm text-gray-400 mt-1">ì—…ë¡œë“œ ì¤‘... (0/0)</p>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('taxUploadModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì—…ë¡œë“œ</button></div>
            </form>
        </div>
    </div>

    <!-- ë²•ì¸ì„œë¥˜ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="docUploadModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ“¤ ë²•ì¸ì„œë¥˜ ì—…ë¡œë“œ</h3><button onclick="closeModal('docUploadModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="docUploadForm" onsubmit="submitDocUpload(event)" class="space-y-4">
                <div><label class="block text-sm text-purple-400 mb-1">ì¹´í…Œê³ ë¦¬ *</label>
                    <select id="corpdoc-category" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="business">ì‚¬ì—…ìë“±ë¡ì¦</option>
                        <option value="corporate">ë²•ì¸ë“±ê¸°ë¶€ë“±ë³¸</option>
                        <option value="contract">ê³„ì•½ì„œ</option>
                        <option value="license">ì¸í—ˆê°€ì„œë¥˜</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë²•ì¸/ëŒ€ìƒ</label>
                    <input type="text" id="corpdoc-entity" class="input-field" placeholder="íŒ€ë¸Œë¡œ, ë¸Œë¡œëª¨í„°ìŠ¤ ë“±">
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">íŒŒì¼ ì„ íƒ * (ìµœëŒ€ 10ê°œ)</label>
                    <input type="file" id="corpdoc-file" class="input-field" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.doc,.docx" multiple required onchange="checkDocFileLimit(this)">
                    <p class="text-gray-500 text-xs mt-1">PDF, ì´ë¯¸ì§€, ì—‘ì…€, ì›Œë“œ íŒŒì¼ ì§€ì› | í•œ ë²ˆì— ìµœëŒ€ 10ê°œ</p>
                    <div id="selectedDocFileList" class="mt-2 text-sm text-gray-400"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì„¤ëª…</label>
                    <input type="text" id="corpdoc-desc" class="input-field" placeholder="2025ë…„ ê°±ì‹  ì‚¬ì—…ìë“±ë¡ì¦">
                </div>
                <div id="docUploadProgress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div id="docUploadProgressBar" class="bg-purple-400 h-2 rounded-full transition-all" style="width:0%"></div>
                    </div>
                    <p id="docUploadProgressText" class="text-center text-sm text-gray-400 mt-1">ì—…ë¡œë“œ ì¤‘... (0/0)</p>
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('docUploadModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì—…ë¡œë“œ</button></div>
            </form>
        </div>
    </div>

    <!-- ë²•ì¸ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="entityModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4"><h3 id="entityModalTitle" class="text-xl font-bold text-purple-400">ğŸ¢ ë²•ì¸ ë“±ë¡</h3><button onclick="closeModal('entityModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="entityForm" onsubmit="submitEntity(event)" class="space-y-4">
                <input type="hidden" id="entity-id">
                
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="border-b border-white/10 pb-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë²•ì¸ëª… *</label><input type="text" id="entity-name" class="input-field" required placeholder="(ì£¼)íŒ€ë¸Œë¡œì„œìš¸"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ìƒíƒœ</label><select id="entity-status" class="input-field"><option value="active">í™œì„±</option><option value="inactive">ë¹„í™œì„±</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><input type="text" id="entity-bizno" class="input-field" placeholder="000-00-00000"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë²•ì¸ë“±ë¡ë²ˆí˜¸</label><input type="text" id="entity-corpno" class="input-field" placeholder="000000-0000000"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ì—…íƒœ</label><input type="text" id="entity-biztype" class="input-field" placeholder="ì„œë¹„ìŠ¤ì—…"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì—…ì¢…</label><input type="text" id="entity-bizcategory" class="input-field" placeholder="ë°°ë‹¬ëŒ€í–‰"></div>
                    </div>
                    <div class="mt-3"><label class="block text-sm text-gray-400 mb-1">ì‚¬ì—…ì¥ ì£¼ì†Œ</label><input type="text" id="entity-address" class="input-field" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..."></div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œ ì „í™”</label><input type="text" id="entity-phone" class="input-field" placeholder="02-0000-0000"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì„¤ë¦½ì¼</label><input type="date" id="entity-founddate" class="input-field"></div>
                    </div>
                </div>
                
                <!-- ëŒ€í‘œì ì •ë³´ -->
                <div class="border-b border-white/10 pb-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ‘¤ ëŒ€í‘œì ì •ë³´</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="entity-ceoname" class="input-field" placeholder="í™ê¸¸ë™"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì—°ë½ì²˜</label><input type="text" id="entity-ceophone" class="input-field" placeholder="010-0000-0000"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì£¼ë¯¼ë²ˆí˜¸</label><input type="text" id="entity-ceoresidentno" class="input-field" placeholder="000000-0000000"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì´ë©”ì¼</label><input type="email" id="entity-ceoemail" class="input-field" placeholder="ceo@example.com"></div>
                    </div>
                    <div class="mt-3"><label class="block text-sm text-gray-400 mb-1">ëŒ€í‘œì ì£¼ì†Œ</label><input type="text" id="entity-ceoaddress" class="input-field" placeholder="ì„œìš¸ì‹œ..."></div>
                </div>
                
                <!-- ë©”ëª¨ -->
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="entity-memo" class="input-field" rows="2" placeholder="ê¸°íƒ€ ì°¸ê³ ì‚¬í•­"></textarea></div>
                
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('entityModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ë²•ì¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="entityDetailModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:800px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ¢ <span id="entityDetailName">ë²•ì¸ëª…</span></h3><button onclick="closeModal('entityDetailModal')" class="text-gray-400 text-2xl">&times;</button></div>
            
            <!-- íƒ­ -->
            <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                <button onclick="showEntityDetailTab('info')" id="entityDetailTab-info" class="px-4 py-2 rounded-t-lg text-sm font-bold bg-purple-500/20 text-purple-400">ê¸°ë³¸ì •ë³´</button>
                <button onclick="showEntityDetailTab('docs')" id="entityDetailTab-docs" class="px-4 py-2 rounded-t-lg text-sm text-gray-400 hover:text-white">ì²¨ë¶€ì„œë¥˜</button>
            </div>
            
            <!-- ê¸°ë³¸ì •ë³´ íƒ­ -->
            <div id="entityDetailContent-info">
                <div id="entityDetailInfo" class="space-y-4"></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="editCurrentEntity()" class="btn-secondary">âœï¸ ìˆ˜ì •</button>
                    <button onclick="deleteCurrentEntity()" class="btn-danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            </div>
            
            <!-- ì²¨ë¶€ì„œë¥˜ íƒ­ -->
            <div id="entityDetailContent-docs" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-400 text-sm">ì´ ë²•ì¸ì— ì—°ê²°ëœ ì„œë¥˜</p>
                    <button onclick="openEntityDocUpload()" class="btn-primary btn-sm">ğŸ“¤ ì„œë¥˜ ì²¨ë¶€</button>
                </div>
                <div class="glass-card rounded-xl overflow-hidden">
                    <table class="data-table"><thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>íŒŒì¼ëª…</th><th>í¬ê¸°</th><th>ì—…ë¡œë“œì¼</th><th>ê´€ë¦¬</th></tr></thead>
                    <tbody id="entityDocTableBody"><tr><td colspan="5" class="text-center py-8 text-gray-500">ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- ìê¸ˆ ì§‘í–‰/íšŒìˆ˜ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="fundModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ’° ìê¸ˆ ë“±ë¡</h3><button onclick="closeModal('fundModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="fundForm" onsubmit="submitFund(event)" class="space-y-4">
                <input type="hidden" id="fund-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¼ì *</label><input type="date" id="fund-date" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">êµ¬ë¶„ *</label>
                        <select id="fund-type" class="input-field" required>
                            <option value="">ì„ íƒ</option>
                            <option value="out">ì§‘í–‰ (ì¶œê¸ˆ)</option>
                            <option value="in">íšŒìˆ˜ (ì…ê¸ˆ)</option>
                        </select>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ìíšŒì‚¬ *</label>
                    <select id="fund-subsidiary" class="input-field" required>
                        <option value="">ì„ íƒ</option>
                        <option value="brocompany">ë¸Œë¡œì»´í¼ë‹ˆ</option>
                        <option value="bromotors">ë¸Œë¡œëª¨í„°ìŠ¤</option>
                    </select>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ê¸ˆì•¡ *</label><input type="number" id="fund-amount" class="input-field" required placeholder="0"></div>
                <div><label class="block text-sm text-purple-400 mb-1">ìš©ë„/ë‚´ìš©</label><input type="text" id="fund-purpose" class="input-field" placeholder="ìš´ì˜ìê¸ˆ, ìˆ˜ìµê¸ˆ íšŒìˆ˜ ë“±"></div>
                <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label>
                    <select id="fund-status" class="input-field">
                        <option value="completed">ì™„ë£Œ</option>
                        <option value="pending">ëŒ€ê¸°</option>
                        <option value="cancelled">ì·¨ì†Œ</option>
                    </select>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="fund-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('fundModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- í˜„ê¸ˆì¶œë‚©ì¥ ëª¨ë‹¬ -->
    <div id="bankModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ“’ ê±°ë˜ ë“±ë¡</h3><button onclick="closeModal('bankModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="bankForm" onsubmit="submitCashbook(event)" class="space-y-4">
                <input type="hidden" id="bank-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¼ì *</label><input type="date" id="bank-date" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">êµ¬ë¶„ *</label><select id="bank-type" class="input-field" required onchange="toggleCashbookLink()"><option value="deposit">ì…ê¸ˆ</option><option value="withdrawal">ì¶œê¸ˆ</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ê±°ë˜ì²˜</label><input type="text" id="bank-counterparty" class="input-field" placeholder="ë°°ë¯¼, í˜‘ë ¥ì‚¬A ë“±"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ê¸ˆì•¡ *</label><input type="number" id="bank-amount" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì ìš”</label><input type="text" id="bank-desc" class="input-field" placeholder="W03 ì •ì‚°ê¸ˆ, ì„ ì •ì‚° ì§€ê¸‰ ë“±"></div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ”— ì—°ê²° (ì„ íƒ)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ìœ í˜•</label>
                            <select id="bank-link-type" class="input-field" onchange="loadLinkOptions()">
                                <option value="">ì—°ê²°ì•ˆí•¨</option>
                                <option value="platform">í”Œë«í¼ ì •ì‚°</option>
                                <option value="advance">ì„ ì •ì‚° ì§€ê¸‰</option>
                                <option value="weekly">ì£¼ì •ì‚° ì§€ê¸‰</option>
                            </select>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ëŒ€ìƒ</label>
                            <select id="bank-link-id" class="input-field"><option value="">ì„ íƒ</option></select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="bank-memo2" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('bankModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ë§¤ì…ë§¤ì¶œì¥ ëª¨ë‹¬ -->
    <div id="salesPurchaseModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:650px">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ“‹ ë§¤ì…ë§¤ì¶œ ë“±ë¡</h3><button onclick="closeModal('salesPurchaseModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="salesPurchaseForm" onsubmit="submitSalesPurchase(event)" class="space-y-4">
                <input type="hidden" id="sp-id">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¼ì *</label><input type="date" id="sp-date" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">êµ¬ë¶„ *</label>
                        <select id="sp-type" class="input-field" required onchange="toggleSPType()">
                            <option value="sales">ë§¤ì¶œ</option>
                            <option value="purchase">ë§¤ì…</option>
                        </select>
                    </div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì„¸ê¸ˆê³„ì‚°ì„œ</label>
                        <select id="sp-tax-status" class="input-field">
                            <option value="pending">ë¯¸ë°œí–‰</option>
                            <option value="issued">ë°œí–‰</option>
                            <option value="received">ìˆ˜ì·¨</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ê±°ë˜ì²˜ *</label><input type="text" id="sp-counterparty" class="input-field" placeholder="ë°°ë¯¼, í˜‘ë ¥ì‚¬A ë“±" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">í’ˆëª©</label><input type="text" id="sp-item" class="input-field" placeholder="W03 ì •ì‚°ê¸ˆ, ìš©ì—­ë¹„ ë“±"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡ *</label><input type="number" id="sp-supply" class="input-field" value="0" required onchange="calcSPTotal()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="sp-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="sp-total" class="input-field font-bold" value="0" readonly></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ”— ì—°ê²° (ì„ íƒ)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ìœ í˜•</label>
                            <select id="sp-link-type" class="input-field" onchange="loadSPLinkOptions()">
                                <option value="">ì—°ê²°ì•ˆí•¨</option>
                                <option value="platform">í”Œë«í¼ ì •ì‚°</option>
                                <option value="advance">ì„ ì •ì‚° ì§€ê¸‰</option>
                            </select>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì—°ê²°ëŒ€ìƒ</label>
                            <select id="sp-link-id" class="input-field"><option value="">ì„ íƒ</option></select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="sp-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('salesPurchaseModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>
    <div id="weeklyPayoutModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-purple-400">ğŸ“† ì£¼ì •ì‚° ì§€ê¸‰ ë“±ë¡</h3><button onclick="closeModal('weeklyPayoutModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="weeklyPayoutForm" onsubmit="submitWeeklyPayout(event)" class="space-y-4">
                <input type="hidden" id="weekly-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì •ì‚°ì£¼ì°¨ *</label><input type="text" id="weekly-week" class="input-field" placeholder="2025-W03" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ì¼ *</label><input type="date" id="weekly-date" class="input-field" required></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ë¼ì´ë” *</label><select id="weekly-rider" class="input-field" required><option value="">ì„ íƒ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">í˜‘ë ¥ì‚¬</label><select id="weekly-partner" class="input-field"><option value="">ì„ íƒ</option></select></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ“Š ë°°ë‹¬ ì‹¤ì </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ë°°ë‹¬ê±´ìˆ˜</label><input type="number" id="weekly-count" class="input-field" value="0"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë°°ë‹¬ìˆ˜ìµ</label><input type="number" id="weekly-revenue" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-red-400 font-bold mb-3">ğŸ’¸ ê³µì œ í•­ëª©</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ìˆ˜ìˆ˜ë£Œ</label><input type="number" id="weekly-fee" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë³´í—˜ë£Œ</label><input type="number" id="weekly-insurance" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸°íƒ€ê³µì œ</label><input type="number" id="weekly-other" class="input-field" value="0" onchange="calcWeeklyPayout()"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div><label class="block text-sm text-gray-400 mb-1">ì´ ê³µì œì•¡</label><input type="number" id="weekly-deduction" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ì‹¤ì§€ê¸‰ì•¡</label><input type="number" id="weekly-net" class="input-field font-bold text-purple-400" value="0" readonly></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="weekly-status" class="input-field"><option value="pending">ëŒ€ê¸°</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ê³„ì¢Œ</label><input type="text" id="weekly-account" class="input-field" placeholder="ì€í–‰ ê³„ì¢Œë²ˆí˜¸"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="weekly-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('weeklyPayoutModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ì„¸ê¸ˆê³„ì‚°ì„œ ëª¨ë‹¬ -->
    <div id="taxInvoiceModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:600px">
            <div class="flex justify-between items-center mb-4"><h3 id="taxInvoiceModalTitle" class="text-xl font-bold text-purple-400">ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ë“±ë¡</h3><button onclick="closeModal('taxInvoiceModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="taxInvoiceForm" onsubmit="submitTaxInvoice(event)" class="space-y-4">
                <input type="hidden" id="inv-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ìœ í˜• *</label><select id="inv-type" class="input-field" required><option value="purchase">ë§¤ì…</option><option value="sales">ë§¤ì¶œ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ë°œí–‰ì¼ *</label><input type="date" id="inv-date" class="input-field" required></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ê±°ë˜ì²˜ëª… *</label><input type="text" id="inv-vendor" class="input-field" required placeholder="ê±°ë˜ì²˜ëª…"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="inv-bizno" class="input-field" placeholder="123-45-67890"></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="inv-ceo" class="input-field"></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-purple-400 font-bold mb-3">ğŸ’° ê¸ˆì•¡</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³µê¸‰ê°€ì•¡</label><input type="number" id="inv-supply" class="input-field" value="0" onchange="calcTaxInvoice()"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ë¶€ê°€ì„¸ (10%)</label><input type="number" id="inv-vat" class="input-field" value="0" readonly></div>
                        <div><label class="block text-sm text-gray-400 mb-1">í•©ê³„</label><input type="number" id="inv-total" class="input-field" value="0" readonly></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ìƒíƒœ</label><select id="inv-status" class="input-field"><option value="unpaid">ë¯¸ì§€ê¸‰</option><option value="paid">ì§€ê¸‰ì™„ë£Œ</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì§€ê¸‰ì¼</label><input type="date" id="inv-paiddate" class="input-field"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">í’ˆëª©</label><input type="text" id="inv-item" class="input-field" placeholder="í’ˆëª©/ì„œë¹„ìŠ¤ëª…"></div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="inv-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('taxInvoiceModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

    <!-- ë¶„ê°œ ëª¨ë‹¬ -->
    <div id="journalModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:700px">
            <div class="flex justify-between items-center mb-4"><h3 id="journalModalTitle" class="text-xl font-bold text-purple-400">ğŸ“Š ë¶„ê°œ ë“±ë¡</h3><button onclick="closeModal('journalModal')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="journalForm" onsubmit="submitJournal(event)" class="space-y-4">
                <input type="hidden" id="jnl-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ì¼ì *</label><input type="date" id="jnl-date" class="input-field" required></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ë¶„ê°œë²ˆí˜¸</label><input type="text" id="jnl-number" class="input-field" placeholder="ìë™ìƒì„±" readonly></div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-blue-400 font-bold mb-3">ğŸ“¥ ì°¨ë³€ (Debit)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³„ì •ê³¼ëª©</label><select id="jnl-debit-account" class="input-field">
                            <option value="">ì„ íƒ</option>
                            <optgroup label="ìì‚°"><option value="101-í˜„ê¸ˆ">í˜„ê¸ˆ</option><option value="102-ë³´í†µì˜ˆê¸ˆ">ë³´í†µì˜ˆê¸ˆ</option><option value="108-ë§¤ì¶œì±„ê¶Œ">ë§¤ì¶œì±„ê¶Œ</option><option value="120-ì¬ê³ ìì‚°">ì¬ê³ ìì‚°</option></optgroup>
                            <optgroup label="ë¹„ìš©"><option value="501-ê¸‰ì—¬">ê¸‰ì—¬</option><option value="502-ì„ì°¨ë£Œ">ì„ì°¨ë£Œ</option><option value="503-í†µì‹ ë¹„">í†µì‹ ë¹„</option><option value="504-ì†Œëª¨í’ˆë¹„">ì†Œëª¨í’ˆë¹„</option><option value="510-ì°¨ëŸ‰ìœ ì§€ë¹„">ì°¨ëŸ‰ìœ ì§€ë¹„</option></optgroup>
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸ˆì•¡</label><input type="number" id="jnl-debit-amount" class="input-field" value="0"></div>
                    </div>
                </div>
                <div class="border-t border-white/10 pt-4">
                    <h4 class="text-red-400 font-bold mb-3">ğŸ“¤ ëŒ€ë³€ (Credit)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-1">ê³„ì •ê³¼ëª©</label><select id="jnl-credit-account" class="input-field">
                            <option value="">ì„ íƒ</option>
                            <optgroup label="ë¶€ì±„"><option value="201-ë§¤ì…ì±„ë¬´">ë§¤ì…ì±„ë¬´</option><option value="210-ë¯¸ì§€ê¸‰ê¸ˆ">ë¯¸ì§€ê¸‰ê¸ˆ</option><option value="220-ì˜ˆìˆ˜ê¸ˆ">ì˜ˆìˆ˜ê¸ˆ</option></optgroup>
                            <optgroup label="ìì‚°"><option value="101-í˜„ê¸ˆ">í˜„ê¸ˆ</option><option value="102-ë³´í†µì˜ˆê¸ˆ">ë³´í†µì˜ˆê¸ˆ</option></optgroup>
                            <optgroup label="ìˆ˜ìµ"><option value="401-ë§¤ì¶œ">ë§¤ì¶œ</option><option value="402-ìˆ˜ìˆ˜ë£Œìˆ˜ìµ">ìˆ˜ìˆ˜ë£Œìˆ˜ìµ</option></optgroup>
                        </select></div>
                        <div><label class="block text-sm text-gray-400 mb-1">ê¸ˆì•¡</label><input type="number" id="jnl-credit-amount" class="input-field" value="0"></div>
                    </div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ì ìš” *</label><input type="text" id="jnl-desc" class="input-field" placeholder="ê±°ë˜ ë‚´ìš©" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm text-purple-400 mb-1">ìƒíƒœ</label><select id="jnl-status" class="input-field"><option value="created">ìƒì„±</option><option value="confirmed">í™•ì •</option></select></div>
                    <div><label class="block text-sm text-purple-400 mb-1">ì¦ë¹™</label><input type="text" id="jnl-evidence" class="input-field" placeholder="ì˜ìˆ˜ì¦ë²ˆí˜¸ ë“±"></div>
                </div>
                <div><label class="block text-sm text-purple-400 mb-1">ë©”ëª¨</label><textarea id="jnl-memo" class="input-field" rows="2"></textarea></div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('journalModal')" class="flex-1 btn-secondary">ì·¨ì†Œ</button><button type="submit" class="flex-1 btn-primary">ì €ì¥</button></div>
            </form>
        </div>
    </div>

<script>
const SUPABASE_URL = 'https://jizaefuhiikpkcxolibc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppemFlZnVoaWlrcGtjeG9saWJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDM3MDIsImV4cCI6MjA4MzY3OTcwMn0.WXFNYvSl1n9pp0yZpD8ndNZdEHvL53wtDzrJz9Y_ssg';

// í…Œë§ˆ ê´€ë¦¬
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
}

function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
}

// í˜ì´ì§€ ë¡œë“œì‹œ í…Œë§ˆ ì´ˆê¸°í™”
initTheme();

let currentUser = null;
let riderList = [], partnerList = [], salesList = [], userList = [], settlementList = [];
let cardList = [], cardTransList = [], taxInvoiceList = [], journalList = [], auditLogList = [];
let employeeList = [], payrollList = [];
let platformList = [], advanceTransferList = [], reconcileList = [], bankList = [], weeklyPayoutList = [];
let salesPurchaseList = [];

async function supabaseCall(table, method, body = null, query = '') {
    try {
        const options = { method, headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': method === 'POST' ? 'return=representation' : '' } };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + query, options);
        if (!res.ok) throw new Error('API Error: ' + res.status);
        const text = await res.text();
        return text ? JSON.parse(text) : null;
    } catch (e) { console.error('Supabase Error:', e); return null; }
}

function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.textContent = msg;
    document.getElementById('toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function toggleMenu(menu) {
    const el = document.getElementById('menu-' + menu);
    const arrow = document.getElementById('arrow-' + menu);
    if (el.classList.contains('hidden')) {
        el.classList.remove('hidden');
        arrow.textContent = 'â–¼';
    } else {
        el.classList.add('hidden');
        arrow.textContent = 'â–¶';
    }
}

let sidebarOpen = true;
function toggleSidebar() {
    const sidebar = document.getElementById('sidebarMenu');
    if (sidebarOpen) {
        sidebar.style.display = 'none';
        sidebarOpen = false;
    } else {
        sidebar.style.display = 'block';
        sidebarOpen = true;
    }
}

function showTab(tab) {
    console.log('showTab called:', tab);
    
    // ì‚¬ì´ë“œë°” ì•„ì´í…œ active ì²˜ë¦¬
    document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('nav-' + tab);
    if (btn) btn.classList.add('active');
    
    // íƒ­ ì»¨í…ì¸  ì „í™˜
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    const tabEl = document.getElementById('tab-' + tab);
    console.log('tabEl found:', tabEl);
    if (tabEl) {
        tabEl.classList.remove('hidden');
        console.log('hidden removed, classes:', tabEl.className);
    }
    
    // í˜ì´ì§€ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
    const titles = {
        'dashboard': 'ëŒ€ì‹œë³´ë“œ', 'riders': 'ë¼ì´ë” ê´€ë¦¬', 'partners': 'í˜‘ë ¥ì‚¬ ê´€ë¦¬', 
        'sales': 'ì˜ì—…ì ê´€ë¦¬', 'entities': 'ë²•ì¸ ê´€ë¦¬', 'sett-dashboard': 'ì •ì‚° í˜„í™©',
        'platform': 'í”Œë«í¼ì •ì‚°ì…ê¸ˆ', 'sett-advance': 'ì„ ì •ì‚° ì§€ê¸‰', 'weekly-payout': 'ì£¼ì •ì‚° ì§€ê¸‰',
        'reconcile': 'ëŒ€ì‚¬ ê´€ë¦¬', 'bank': 'í˜„ê¸ˆì¶œë‚©ì¥', 'accounting': 'ë§¤ì…ë§¤ì¶œì¥',
        'taxinvoice': 'ì„¸ê¸ˆê³„ì‚°ì„œ', 'ledger': 'ì´ê³„ì •ì›ì¥', 'journal': 'ë¶„ê°œì¥',
        'cards': 'ë²•ì¸ì¹´ë“œ ê´€ë¦¬', 'card-usage': 'ì¹´ë“œ ì‚¬ìš©ë‚´ì—­', 'employees': 'ì§ì› ê´€ë¦¬',
        'payroll': 'ê¸‰ì—¬ ê´€ë¦¬', 'contracts': 'ê·¼ë¡œê³„ì•½', 'tax': 'ì„¸ë¬´ì„œë¥˜ ë³´ê´€í•¨',
        'docs': 'ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨', 'excel': 'ì—…ë¡œë“œ ì–‘ì‹', 'users': 'ì‚¬ìš©ì ê´€ë¦¬',
        'logs': 'ê°ì‚¬ ë¡œê·¸', 'settings': 'ì‹œìŠ¤í…œ ì„¤ì •'
    };
    const titleEl = document.getElementById('pageTitle');
    if (titleEl) titleEl.textContent = titles[tab] || tab;
    
    // ê¸°ì´ˆì •ë³´
    if (tab === 'dashboard') loadDashboard();
    if (tab === 'riders') { loadStats('rider'); renderTable('rider'); loadPartnerOptions(); }
    if (tab === 'partners') { loadStats('partner'); renderTable('partner'); }
    if (tab === 'sales') { loadStats('sales'); renderTable('sales'); }
    if (tab === 'entities') { loadEntities(); }
    
    // ì •ì‚°ê´€ë¦¬
    if (tab === 'sett-dashboard') loadSettlementDashboard();
    if (tab === 'platform') renderPlatformTable();
    if (tab === 'sett-advance') { renderSettAdvanceTable(); loadSettAdvancePartnerOptions(); }
    if (tab === 'weekly-payout') { renderWeeklyPayoutTable(); loadWeeklyPayoutOptions(); }
    if (tab === 'reconcile') renderReconcileTable();
    
    // ì¬ë¬´ê´€ë¦¬
    if (tab === 'bank') renderCashbookTable();
    if (tab === 'accounting') { renderSalesPurchaseTable(); }
    if (tab === 'taxinvoice') renderTaxInvoiceTable();
    if (tab === 'ledger') renderLedgerTable();
    if (tab === 'journal') renderJournalTable2();
    
    // ì¹´ë“œ/ìì‚°
    if (tab === 'cards') renderCardTable();
    if (tab === 'card-usage') renderCardTransTable();
    
    // ì¸ì‚¬ê´€ë¦¬
    if (tab === 'employees') renderEmployeeTable();
    if (tab === 'payroll') renderPayrollTable();
    if (tab === 'contracts') { loadContractEmpOptions(); renderContractTable(); }
    
    // ë¬¸ì„œ/ì„¸ë¬´
    if (tab === 'tax') { loadTaxDocuments(); }
    if (tab === 'docs') { loadCorpDocuments(); }
    
    // ì‹œìŠ¤í…œ
    if (tab === 'users') renderUserTable();
    if (tab === 'logs') { try { renderAuditLogs(); } catch(e) { console.log('audit logs error', e); } }
    if (tab === 'settings') { /* ì„¤ì • í˜ì´ì§€ */ }
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const users = await supabaseCall('hq_users', 'GET', null, '?username=eq.' + encodeURIComponent(username));
    if (users && users.length > 0 && users[0].password_hash === password && users[0].is_active) {
        currentUser = users[0];
        sessionStorage.setItem('teambro_hq_session', JSON.stringify({ userId: currentUser.id, timestamp: Date.now() }));
        await loadAllData();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainSystem').classList.remove('hidden');
        // PCì—ì„œ main ì˜ì—­ margin-left ì„¤ì •
        if (window.innerWidth >= 768) {
            document.getElementById('mainContent').style.marginLeft = '280px';
        }
        document.getElementById('headerUserName').textContent = currentUser.name;
        loadDashboard();
        showToast(currentUser.name + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!');
    } else {
        document.getElementById('loginError').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        document.getElementById('loginError').classList.remove('hidden');
    }
}

function logout() {
    sessionStorage.removeItem('teambro_hq_session');
    document.getElementById('mainSystem').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
}

async function restoreSession() {
    const data = sessionStorage.getItem('teambro_hq_session');
    if (!data) return false;
    try {
        const session = JSON.parse(data);
        if (Date.now() - session.timestamp > 86400000) return false;
        const users = await supabaseCall('hq_users', 'GET', null, '?id=eq.' + session.userId);
        if (!users || !users.length || !users[0].is_active) return false;
        currentUser = users[0];
        await loadAllData();
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainSystem').classList.remove('hidden');
        // PCì—ì„œ main ì˜ì—­ margin-left ì„¤ì •
        if (window.innerWidth >= 768) {
            document.getElementById('mainContent').style.marginLeft = '280px';
        }
        document.getElementById('headerUserName').textContent = currentUser.name;
        loadDashboard();
        return true;
    } catch (e) { return false; }
}

async function loadAllData() {
    const [r, p, s, u, st, cd, ct, ti, jn, emp, pay, plat, advt, recon, bnk, wkly, sp] = await Promise.all([
        supabaseCall('riders', 'GET', null, '?order=created_at.desc'),
        supabaseCall('partners', 'GET', null, '?order=created_at.desc'),
        supabaseCall('sales_reps', 'GET', null, '?order=created_at.desc'),
        supabaseCall('hq_users', 'GET', null, '?order=id.asc'),
        supabaseCall('settlements', 'GET', null, '?order=created_at.desc'),
        supabaseCall('corporate_cards', 'GET', null, '?order=created_at.desc'),
        supabaseCall('card_transactions', 'GET', null, '?order=transaction_date.desc&limit=50'),
        supabaseCall('hq_tax_invoices', 'GET', null, '?order=invoice_date.desc'),
        supabaseCall('accounting_journals', 'GET', null, '?order=journal_date.desc'),
        supabaseCall('employees', 'GET', null, '?order=created_at.desc'),
        supabaseCall('payrolls', 'GET', null, '?order=pay_year.desc,pay_month.desc'),
        supabaseCall('platform_settlements', 'GET', null, '?order=created_at.desc'),
        supabaseCall('advance_transfers', 'GET', null, '?order=created_at.desc'),
        supabaseCall('settlement_reconciliation', 'GET', null, '?order=created_at.desc'),
        supabaseCall('bank_transactions', 'GET', null, '?order=transaction_date.desc'),
        supabaseCall('weekly_payouts', 'GET', null, '?order=created_at.desc'),
        supabaseCall('sales_purchases', 'GET', null, '?order=transaction_date.desc')
    ]);
    riderList = r || [];
    partnerList = p || [];
    salesList = s || [];
    userList = u || [];
    settlementList = st || [];
    cardList = cd || [];
    cardTransList = ct || [];
    taxInvoiceList = ti || [];
    journalList = jn || [];
    employeeList = emp || [];
    platformList = plat || [];
    advanceTransferList = advt || [];
    reconcileList = recon || [];
    bankList = bnk || [];
    weeklyPayoutList = wkly || [];
    payrollList = pay || [];
    salesPurchaseList = sp || [];
}

function loadDashboard() {
    document.getElementById('stat-riders').textContent = riderList.length + 'ëª…';
    document.getElementById('stat-partners').textContent = partnerList.length + 'ê°œ';
    document.getElementById('stat-sales').textContent = salesList.length + 'ëª…';
    
    // ìê¸ˆ ë°ì´í„° ë¡œë“œ
    loadFunds();
}

function loadStats(type) {
    if (type === 'rider') {
        document.getElementById('rider-total').textContent = riderList.length;
        document.getElementById('rider-active').textContent = riderList.filter(r => r.status === 'active').length;
        document.getElementById('rider-inactive').textContent = riderList.filter(r => r.status === 'inactive').length;
        document.getElementById('rider-nossn').textContent = riderList.filter(r => !r.ssn).length;
    } else if (type === 'partner') {
        document.getElementById('partner-total').textContent = partnerList.length;
        document.getElementById('partner-biz').textContent = partnerList.filter(p => p.type === 'biz').length;
        document.getElementById('partner-nonbiz').textContent = partnerList.filter(p => p.type !== 'biz').length;
        document.getElementById('partner-riders').textContent = riderList.filter(r => r.partner_id).length;
    } else if (type === 'sales') {
        document.getElementById('sales-total').textContent = salesList.length;
        document.getElementById('sales-ind').textContent = salesList.filter(s => s.sales_type === 'individual').length;
        document.getElementById('sales-sole').textContent = salesList.filter(s => s.sales_type === 'sole_prop').length;
        document.getElementById('sales-corp').textContent = salesList.filter(s => s.sales_type === 'corporation').length;
    } else if (type === 'settlement') {
        document.getElementById('sett-total').textContent = settlementList.length;
        document.getElementById('sett-pending').textContent = settlementList.filter(s => s.status === 'pending').length;
        document.getElementById('sett-confirmed').textContent = settlementList.filter(s => s.status === 'confirmed').length;
        document.getElementById('sett-paid').textContent = settlementList.filter(s => s.status === 'paid').length;
        const total = settlementList.reduce((sum, s) => sum + parseFloat(s.gross_amount || 0), 0);
        document.getElementById('sett-amount').textContent = 'â‚©' + total.toLocaleString();
    }
}

function renderTable(type) {
    if (type === 'rider') {
        const sf = document.getElementById('riderStatusFilter').value;
        const pf = document.getElementById('riderPartnerFilter').value;
        const q = (document.getElementById('riderSearch').value || '').toLowerCase();
        let list = riderList;
        if (sf) list = list.filter(r => r.status === sf);
        if (pf) list = list.filter(r => r.partner_id == pf);
        if (q) list = list.filter(r => (r.name||'').toLowerCase().includes(q) || (r.phone||'').includes(q));
        const tbody = document.getElementById('riderTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        tbody.innerHTML = list.map(r => {
            const p = partnerList.find(x => x.id == r.partner_id);
            return '<tr><td class="font-bold">' + r.name + '</td><td>' + (r.phone||'-') + '</td><td>' + (p?p.name:'-') + '</td><td>' + (r.tax_type||'-') + '</td><td><span class="badge ' + (r.status==='active'?'badge-active">í™œì„±':'badge-inactive">ë¹„í™œì„±') + '</span></td><td><button onclick="editItem(\'rider\',' + r.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
        }).join('');
    } else if (type === 'partner') {
        const tbody = document.getElementById('partnerTableBody');
        if (!partnerList.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        tbody.innerHTML = partnerList.map(p => {
            const cnt = riderList.filter(r => r.partner_id == p.id).length;
            return '<tr><td class="font-bold">' + p.name + '</td><td>' + (p.code||'-') + '</td><td><span class="badge ' + (p.type==='biz'?'badge-biz">ì‚¬ì—…ì':'badge-nonbiz">ë¹„ì‚¬ì—…ì') + '</span></td><td>' + (p.rep_name||'-') + '</td><td>' + (p.phone||'-') + '</td><td>' + cnt + 'ëª…</td><td><button onclick="editItem(\'partner\',' + p.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
        }).join('');
    } else if (type === 'sales') {
        const sf = document.getElementById('salesStatusFilter').value;
        const tf = document.getElementById('salesTypeFilter').value;
        const q = (document.getElementById('salesSearch').value || '').toLowerCase();
        let list = salesList;
        if (sf) list = list.filter(s => s.status === sf);
        if (tf) list = list.filter(s => s.sales_type === tf);
        if (q) list = list.filter(s => (s.name||'').toLowerCase().includes(q) || (s.sales_code||'').toLowerCase().includes(q));
        const tbody = document.getElementById('salesTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        const types = { individual: 'ê°œì¸', sole_prop: 'ê°œì¸ì‚¬ì—…ì', corporation: 'ë²•ì¸' };
        const cycles = { monthly: 'ì›”', weekly: 'ì£¼', per_case: 'ê±´ë³„' };
        tbody.innerHTML = list.map(s => '<tr><td class="font-bold text-purple-400">' + (s.sales_code||'-') + '</td><td>' + s.name + '</td><td><span class="badge badge-biz">' + (types[s.sales_type]||s.sales_type) + '</span></td><td>' + (s.phone||'-') + '</td><td>' + (cycles[s.payout_cycle]||'-') + '</td><td>' + (s.withholding_rate?(parseFloat(s.withholding_rate)*100).toFixed(1)+'%':'-') + '</td><td><span class="badge ' + (s.status==='active'?'badge-active">í™œì„±':'badge-inactive">ë¹„í™œì„±') + '</span></td><td><button onclick="editItem(\'sales\',' + s.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
    } else if (type === 'settlement') {
        const wf = document.getElementById('settWeekFilter').value;
        const sf = document.getElementById('settStatusFilter').value;
        const pf = document.getElementById('settPartnerFilter').value;
        const q = (document.getElementById('settSearch').value || '').toLowerCase();
        let list = settlementList;
        if (wf) list = list.filter(s => s.settlement_week === wf);
        if (sf) list = list.filter(s => s.status === sf);
        if (pf) list = list.filter(s => s.partner_id == pf);
        if (q) { const rids = riderList.filter(r => (r.name||'').toLowerCase().includes(q)).map(r => r.id); list = list.filter(s => rids.includes(s.rider_id)); }
        const tbody = document.getElementById('settlementTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
        const statuses = { pending: 'ëŒ€ê¸°', confirmed: 'í™•ì •', paid: 'ì§€ê¸‰ì™„ë£Œ' };
        const statusClass = { pending: 'badge-pending', confirmed: 'badge-biz', paid: 'badge-active' };
        tbody.innerHTML = list.map(s => {
            const r = riderList.find(x => x.id == s.rider_id);
            const p = partnerList.find(x => x.id == s.partner_id);
            return '<tr><td class="font-bold text-purple-400">' + (s.settlement_week||'-') + '</td><td class="text-xs">' + (s.work_start_date||'') + '<br>~' + (s.work_end_date||'') + '</td><td>' + (r?r.name:'-') + '</td><td>' + (p?p.name:'-') + '</td><td class="text-right">â‚©' + parseInt(s.gross_amount||0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(s.deduction_amount||0).toLocaleString() + '</td><td class="text-right text-purple-400">â‚©' + parseInt(s.advance_amount||0).toLocaleString() + '</td><td class="text-right font-bold text-green-400">â‚©' + parseInt(s.net_amount||0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[s.status]||'badge-inactive') + '">' + (statuses[s.status]||s.status) + '</span></td><td><button onclick="editSettlement(' + s.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
        }).join('');
    }
}

function filterList(type, status) {
    if (type === 'rider') { document.getElementById('riderStatusFilter').value = status; renderTable('rider'); }
}

function loadPartnerOptions() {
    const opt = '<option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    document.getElementById('riderPartnerFilter').innerHTML = opt;
    document.getElementById('rider-partner').innerHTML = '<option value="">ì„ íƒì•ˆí•¨</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

function toggleBizFields() { document.getElementById('partnerBizFields').classList.toggle('hidden', document.getElementById('partner-type').value !== 'biz'); }
function toggleSalesBizFields() { document.getElementById('salesBizFields').classList.toggle('hidden', document.getElementById('sales-type').value === 'individual'); }

function openRiderModal() { document.getElementById('riderModalTitle').textContent = 'ğŸï¸ ë¼ì´ë” ë“±ë¡'; document.getElementById('riderForm').reset(); document.getElementById('rider-id').value = ''; openModal('riderModal'); }
function openPartnerModal() { document.getElementById('partnerModalTitle').textContent = 'ğŸ¤ í˜‘ë ¥ì‚¬ ë“±ë¡'; document.getElementById('partnerForm').reset(); document.getElementById('partner-id').value = ''; document.getElementById('partnerBizFields').classList.add('hidden'); openModal('partnerModal'); }
function openSalesModal() { document.getElementById('salesModalTitle').textContent = 'ğŸ’¼ ì˜ì—…ì ë“±ë¡'; document.getElementById('salesForm').reset(); document.getElementById('sales-id').value = ''; document.getElementById('salesBizFields').classList.add('hidden'); openModal('salesModal'); }

function editItem(type, id) {
    if (type === 'rider') {
        const r = riderList.find(x => x.id === id); if (!r) return;
        document.getElementById('riderModalTitle').textContent = 'ğŸï¸ ë¼ì´ë” ìˆ˜ì •';
        document.getElementById('rider-id').value = r.id;
        document.getElementById('rider-name').value = r.name || '';
        document.getElementById('rider-phone').value = r.phone || '';
        document.getElementById('rider-partner').value = r.partner_id || '';
        document.getElementById('rider-status').value = r.status || 'active';
        document.getElementById('rider-address').value = r.address || '';
        document.getElementById('rider-bank').value = r.bank || '';
        document.getElementById('rider-account-no').value = r.account_no || '';
        document.getElementById('rider-account-holder').value = r.account_holder || '';
        document.getElementById('rider-ssn').value = r.ssn || '';
        document.getElementById('rider-tax-type').value = r.tax_type || '';
        document.getElementById('rider-memo').value = r.memo || '';
        openModal('riderModal');
    } else if (type === 'partner') {
        const p = partnerList.find(x => x.id === id); if (!p) return;
        document.getElementById('partnerModalTitle').textContent = 'ğŸ¤ í˜‘ë ¥ì‚¬ ìˆ˜ì •';
        document.getElementById('partner-id').value = p.id;
        document.getElementById('partner-name').value = p.name || '';
        document.getElementById('partner-code').value = p.code || '';
        document.getElementById('partner-type').value = p.type || 'non_biz';
        document.getElementById('partner-rep').value = p.rep_name || '';
        document.getElementById('partner-phone').value = p.phone || '';
        document.getElementById('partner-email').value = p.email || '';
        document.getElementById('partner-bizno').value = p.biz_no || '';
        document.getElementById('partner-biztype').value = p.biz_type || '';
        document.getElementById('partner-address').value = p.address || '';
        document.getElementById('partner-bank').value = p.bank || '';
        document.getElementById('partner-accountno').value = p.account_no || '';
        document.getElementById('partner-memo').value = p.memo || '';
        toggleBizFields();
        openModal('partnerModal');
    } else if (type === 'sales') {
        const s = salesList.find(x => x.id === id); if (!s) return;
        document.getElementById('salesModalTitle').textContent = 'ğŸ’¼ ì˜ì—…ì ìˆ˜ì •';
        document.getElementById('sales-id').value = s.id;
        document.getElementById('sales-code').value = s.sales_code || '';
        document.getElementById('sales-type').value = s.sales_type || 'individual';
        document.getElementById('sales-name').value = s.name || '';
        document.getElementById('sales-phone').value = s.phone || '';
        document.getElementById('sales-email').value = s.email || '';
        document.getElementById('sales-region').value = s.region || '';
        document.getElementById('sales-bizno').value = s.biz_no || '';
        document.getElementById('sales-repname').value = s.rep_name || '';
        document.getElementById('sales-address').value = s.address || '';
        document.getElementById('sales-bank').value = s.bank_name || '';
        document.getElementById('sales-bank-holder').value = s.bank_holder || '';
        document.getElementById('sales-bank-account').value = s.bank_account || '';
        document.getElementById('sales-payout-cycle').value = s.payout_cycle || 'monthly';
        document.getElementById('sales-withholding-rate').value = s.withholding_rate || '0.033';
        document.getElementById('sales-status').value = s.status || 'active';
        document.getElementById('sales-memo').value = s.memo || '';
        toggleSalesBizFields();
        openModal('salesModal');
    }
}

async function submitForm(type, e) {
    e.preventDefault();
    let id, data, table, list;
    if (type === 'rider') {
        id = document.getElementById('rider-id').value;
        data = { name: document.getElementById('rider-name').value, phone: document.getElementById('rider-phone').value || null, partner_id: document.getElementById('rider-partner').value || null, status: document.getElementById('rider-status').value, address: document.getElementById('rider-address').value || null, bank: document.getElementById('rider-bank').value || null, account_no: document.getElementById('rider-account-no').value || null, account_holder: document.getElementById('rider-account-holder').value || null, ssn: document.getElementById('rider-ssn').value || null, tax_type: document.getElementById('rider-tax-type').value || null, memo: document.getElementById('rider-memo').value || null };
        table = 'riders'; list = riderList;
    } else if (type === 'partner') {
        id = document.getElementById('partner-id').value;
        data = { name: document.getElementById('partner-name').value, code: document.getElementById('partner-code').value, type: document.getElementById('partner-type').value, rep_name: document.getElementById('partner-rep').value || null, phone: document.getElementById('partner-phone').value || null, email: document.getElementById('partner-email').value || null, biz_no: document.getElementById('partner-bizno').value || null, biz_type: document.getElementById('partner-biztype').value || null, address: document.getElementById('partner-address').value || null, bank: document.getElementById('partner-bank').value || null, account_no: document.getElementById('partner-accountno').value || null, memo: document.getElementById('partner-memo').value || null };
        table = 'partners'; list = partnerList;
    } else if (type === 'sales') {
        id = document.getElementById('sales-id').value;
        data = { sales_code: document.getElementById('sales-code').value, sales_type: document.getElementById('sales-type').value, name: document.getElementById('sales-name').value, phone: document.getElementById('sales-phone').value || null, email: document.getElementById('sales-email').value || null, region: document.getElementById('sales-region').value || null, biz_no: document.getElementById('sales-bizno').value || null, rep_name: document.getElementById('sales-repname').value || null, address: document.getElementById('sales-address').value || null, bank_name: document.getElementById('sales-bank').value || null, bank_holder: document.getElementById('sales-bank-holder').value || null, bank_account: document.getElementById('sales-bank-account').value || null, payout_cycle: document.getElementById('sales-payout-cycle').value, withholding_rate: parseFloat(document.getElementById('sales-withholding-rate').value), withholding_enabled: true, status: document.getElementById('sales-status').value, memo: document.getElementById('sales-memo').value || null };
        table = 'sales_reps'; list = salesList;
    }
    try {
        if (id) {
            await supabaseCall(table, 'PATCH', data, '?id=eq.' + id);
            const idx = list.findIndex(x => x.id == id);
            if (idx >= 0) list[idx] = { ...list[idx], ...data };
            showToast('ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall(table, 'POST', data);
            if (r && r[0]) list.unshift(r[0]);
            showToast('ë“±ë¡ ì™„ë£Œ');
        }
        closeModal(type + 'Modal');
        loadStats(type); renderTable(type); loadDashboard();
        if (type === 'partner') loadPartnerOptions();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì •ì‚° ê´€ë¦¬
function loadSettlementFilters() {
    const weeks = [...new Set(settlementList.map(s => s.settlement_week))].sort().reverse();
    document.getElementById('settWeekFilter').innerHTML = '<option value="">ì „ì²´ ì£¼ì°¨</option>' + weeks.map(w => '<option value="' + w + '">' + w + '</option>').join('');
    document.getElementById('settPartnerFilter').innerHTML = '<option value="">ì „ì²´ í˜‘ë ¥ì‚¬</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    document.getElementById('sett-rider').innerHTML = '<option value="">ì„ íƒ</option>' + riderList.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    document.getElementById('sett-partner').innerHTML = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
}

function filterSettlement(status) { document.getElementById('settStatusFilter').value = status; renderTable('settlement'); }

function openSettlementModal() {
    document.getElementById('settlementModalTitle').textContent = 'ğŸ’° ì •ì‚° ë“±ë¡';
    document.getElementById('settlementForm').reset();
    document.getElementById('sett-id').value = '';
    loadSettlementFilters();
    calcSettlement();
    openModal('settlementModal');
}

function editSettlement(id) {
    const s = settlementList.find(x => x.id === id); if (!s) return;
    document.getElementById('settlementModalTitle').textContent = 'ğŸ’° ì •ì‚° ìˆ˜ì •';
    document.getElementById('sett-id').value = s.id;
    document.getElementById('sett-week').value = s.settlement_week || '';
    document.getElementById('sett-start').value = s.work_start_date || '';
    document.getElementById('sett-end').value = s.work_end_date || '';
    document.getElementById('sett-paydate').value = s.payment_date || '';
    document.getElementById('sett-rider').value = s.rider_id || '';
    document.getElementById('sett-partner').value = s.partner_id || '';
    document.getElementById('sett-platform').value = s.platform || '';
    document.getElementById('sett-delivery').value = s.delivery_fee || 0;
    document.getElementById('sett-mission').value = s.mission_fee || 0;
    document.getElementById('sett-extra').value = s.extra_pay || 0;
    document.getElementById('sett-payback').value = s.payback || 0;
    document.getElementById('sett-incentive').value = s.incentive || 0;
    document.getElementById('sett-tip').value = s.tip || 0;
    document.getElementById('sett-insurance').value = s.insurance_fee || 0;
    document.getElementById('sett-rental').value = s.rental_fee || 0;
    document.getElementById('sett-penalty').value = s.penalty || 0;
    document.getElementById('sett-other').value = s.other_deduction || 0;
    document.getElementById('sett-advance').value = s.advance_amount || 0;
    document.getElementById('sett-status').value = s.status || 'pending';
    document.getElementById('sett-memo').value = s.memo || '';
    loadSettlementFilters();
    calcSettlement();
    openModal('settlementModal');
}

function calcSettlement() {
    const gross = parseFloat(document.getElementById('sett-delivery').value||0) + parseFloat(document.getElementById('sett-mission').value||0) + parseFloat(document.getElementById('sett-extra').value||0) + parseFloat(document.getElementById('sett-payback').value||0) + parseFloat(document.getElementById('sett-incentive').value||0) + parseFloat(document.getElementById('sett-tip').value||0);
    const deduct = parseFloat(document.getElementById('sett-insurance').value||0) + parseFloat(document.getElementById('sett-rental').value||0) + parseFloat(document.getElementById('sett-penalty').value||0) + parseFloat(document.getElementById('sett-other').value||0);
    const advance = parseFloat(document.getElementById('sett-advance').value||0);
    const net = gross - deduct - advance;
    document.getElementById('calc-gross').textContent = 'â‚©' + gross.toLocaleString();
    document.getElementById('calc-deduct').textContent = 'â‚©' + deduct.toLocaleString();
    document.getElementById('calc-advance').textContent = 'â‚©' + advance.toLocaleString();
    document.getElementById('calc-net').textContent = 'â‚©' + net.toLocaleString();
}

async function submitSettlement(e) {
    e.preventDefault();
    const id = document.getElementById('sett-id').value;
    const gross = parseFloat(document.getElementById('sett-delivery').value||0) + parseFloat(document.getElementById('sett-mission').value||0) + parseFloat(document.getElementById('sett-extra').value||0) + parseFloat(document.getElementById('sett-payback').value||0) + parseFloat(document.getElementById('sett-incentive').value||0) + parseFloat(document.getElementById('sett-tip').value||0);
    const deduct = parseFloat(document.getElementById('sett-insurance').value||0) + parseFloat(document.getElementById('sett-rental').value||0) + parseFloat(document.getElementById('sett-penalty').value||0) + parseFloat(document.getElementById('sett-other').value||0);
    const advance = parseFloat(document.getElementById('sett-advance').value||0);
    const data = {
        settlement_week: document.getElementById('sett-week').value,
        work_start_date: document.getElementById('sett-start').value || null,
        work_end_date: document.getElementById('sett-end').value || null,
        payment_date: document.getElementById('sett-paydate').value || null,
        rider_id: document.getElementById('sett-rider').value || null,
        partner_id: document.getElementById('sett-partner').value || null,
        platform: document.getElementById('sett-platform').value || null,
        delivery_fee: document.getElementById('sett-delivery').value || 0,
        mission_fee: document.getElementById('sett-mission').value || 0,
        extra_pay: document.getElementById('sett-extra').value || 0,
        payback: document.getElementById('sett-payback').value || 0,
        incentive: document.getElementById('sett-incentive').value || 0,
        tip: document.getElementById('sett-tip').value || 0,
        insurance_fee: document.getElementById('sett-insurance').value || 0,
        rental_fee: document.getElementById('sett-rental').value || 0,
        penalty: document.getElementById('sett-penalty').value || 0,
        other_deduction: document.getElementById('sett-other').value || 0,
        gross_amount: gross,
        deduction_amount: deduct,
        advance_amount: advance,
        net_amount: gross - deduct - advance,
        status: document.getElementById('sett-status').value,
        memo: document.getElementById('sett-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('settlements', 'PATCH', data, '?id=eq.' + id);
            const idx = settlementList.findIndex(x => x.id == id);
            if (idx >= 0) settlementList[idx] = { ...settlementList[idx], ...data };
            showToast('ì •ì‚° ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('settlements', 'POST', data);
            if (r && r[0]) settlementList.unshift(r[0]);
            showToast('ì •ì‚° ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('settlementModal');
        loadStats('settlement');
        renderTable('settlement');
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì‚¬ìš©ì ê´€ë¦¬
function renderUserTable() {
    const tbody = document.getElementById('userTableBody');
    if (!userList.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = userList.map(u => '<tr><td class="font-bold">' + u.name + '</td><td>' + u.username + '</td><td><span class="badge ' + (u.role==='ADMIN'?'badge-active':'badge-inactive') + '">' + u.role + '</span></td><td><span class="badge ' + (u.is_active?'badge-active">í™œì„±':'badge-inactive">ë¹„í™œì„±') + '</span></td><td><button onclick="editUser(' + u.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function openUserModal() { document.getElementById('userModalTitle').textContent = 'ğŸ‘¤ ì‚¬ìš©ì ë“±ë¡'; document.getElementById('userForm').reset(); document.getElementById('user-id').value = ''; openModal('userModal'); }

function editUser(id) {
    const u = userList.find(x => x.id === id); if (!u) return;
    document.getElementById('userModalTitle').textContent = 'ğŸ‘¤ ì‚¬ìš©ì ìˆ˜ì •';
    document.getElementById('user-id').value = u.id;
    document.getElementById('user-name').value = u.name || '';
    document.getElementById('user-username').value = u.username || '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-role').value = u.role || 'STAFF';
    document.getElementById('user-status').value = u.is_active ? 'true' : 'false';
    openModal('userModal');
}

async function submitUser(e) {
    e.preventDefault();
    const id = document.getElementById('user-id').value;
    const data = { name: document.getElementById('user-name').value, username: document.getElementById('user-username').value, role: document.getElementById('user-role').value, is_active: document.getElementById('user-status').value === 'true' };
    const pw = document.getElementById('user-password').value;
    if (pw) data.password_hash = pw;
    try {
        if (id) {
            await supabaseCall('hq_users', 'PATCH', data, '?id=eq.' + id);
            const idx = userList.findIndex(x => x.id == id);
            if (idx >= 0) userList[idx] = { ...userList[idx], ...data };
            showToast('ì‚¬ìš©ì ìˆ˜ì • ì™„ë£Œ');
        } else {
            if (!pw) { showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
            const r = await supabaseCall('hq_users', 'POST', data);
            if (r && r[0]) userList.push(r[0]);
            showToast('ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('userModal');
        renderUserTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì—‘ì…€ ê¸°ëŠ¥
const TEMPLATES = {
    rider: { filename: 'ë¼ì´ë”_ì–‘ì‹.xlsx', headers: ['ì´ë¦„*','ì—°ë½ì²˜','í˜‘ë ¥ì‚¬ì½”ë“œ','ì£¼ì†Œ','ì€í–‰','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì£¼ë¯¼ë²ˆí˜¸','ì›ì²œì§•ìˆ˜','ìƒíƒœ','ë©”ëª¨'], fields: ['name','phone','partner_code','address','bank','account_holder','account_no','ssn','tax_type','status','memo'], sample: ['í™ê¸¸ë™','010-1234-5678','DP123','ì„œìš¸','KB','í™ê¸¸ë™','1234567890','900101-1234567','3.3','active','ë©”ëª¨'] },
    partner: { filename: 'í˜‘ë ¥ì‚¬_ì–‘ì‹.xlsx', headers: ['í˜‘ë ¥ì‚¬ëª…*','í˜‘ë ¥ì‚¬ì½”ë“œ*','êµ¬ë¶„','ëŒ€í‘œì','ì—°ë½ì²˜','ì´ë©”ì¼','ì‚¬ì—…ìë²ˆí˜¸','ì—…ì¢…','ì£¼ì†Œ','ì€í–‰','ê³„ì¢Œë²ˆí˜¸','ë©”ëª¨'], fields: ['name','code','type','rep_name','phone','email','biz_no','biz_type','address','bank','account_no','memo'], sample: ['ë°°ë¯¼íŒ€ë¸Œë¡œ','DP123','biz','ê¹€ëŒ€í‘œ','02-1234-5678','test@test.com','123-45-67890','ìš´ì†¡ì—…','ì„œìš¸','KB','1234567890','ë©”ëª¨'] },
    sales: { filename: 'ì˜ì—…ì_ì–‘ì‹.xlsx', headers: ['ì˜ì—…ìì½”ë“œ*','ì´ë¦„*','ìœ í˜•','ì—°ë½ì²˜','ì´ë©”ì¼','ì§€ì—­','ì£¼ì†Œ','ì‚¬ì—…ìë²ˆí˜¸','ëŒ€í‘œìëª…','ì€í–‰','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì›ì²œì§•ìˆ˜ìœ¨','ì§€ê¸‰ì£¼ê¸°','ìƒíƒœ','ë©”ëª¨'], fields: ['sales_code','name','sales_type','phone','email','region','address','biz_no','rep_name','bank_name','bank_holder','bank_account','withholding_rate','payout_cycle','status','memo'], sample: ['SB-0001','ê¹€ì˜ì—…','individual','010-1234-5678','sales@test.com','ì„œìš¸','ì„œìš¸ì‹œ','','','KB','ê¹€ì˜ì—…','1234567890','0.033','monthly','active','ë©”ëª¨'] },
    taxinvoice: { filename: 'ì„¸ê¸ˆê³„ì‚°ì„œ_ì–‘ì‹.xlsx', headers: ['ìœ í˜•(ë§¤ì…/ë§¤ì¶œ)*','ë°œí–‰ì¼*','ê±°ë˜ì²˜*','ì‚¬ì—…ìë²ˆí˜¸','ëŒ€í‘œì','ê³µê¸‰ê°€ì•¡*','ë¶€ê°€ì„¸','í•©ê³„','ì§€ê¸‰ìƒíƒœ','í’ˆëª©','ë©”ëª¨'], sample: ['ë§¤ì…','2025-01-15','(ì£¼)í…ŒìŠ¤íŠ¸','123-45-67890','ê¹€ëŒ€í‘œ','1000000','100000','1100000','ë¯¸ì§€ê¸‰','ë¬¼í’ˆëŒ€','ë©”ëª¨'] },
    journal: { filename: 'ë¶„ê°œì¥_ì–‘ì‹.xlsx', headers: ['ì¼ì*','ë¶„ê°œë²ˆí˜¸','ì°¨ë³€ê³„ì •','ì°¨ë³€ê¸ˆì•¡*','ëŒ€ë³€ê³„ì •','ëŒ€ë³€ê¸ˆì•¡*','ì ìš”*','ìƒíƒœ','ë©”ëª¨'], sample: ['2025-01-15','JNL-001','102-ë³´í†µì˜ˆê¸ˆ','1000000','401-ë§¤ì¶œ','1000000','ë§¤ì¶œëŒ€ê¸ˆ ì…ê¸ˆ','ìƒì„±','ë©”ëª¨'] }
};

function downloadTemplate(type) {
    const tpl = TEMPLATES[type];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([tpl.headers, tpl.sample]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, tpl.filename);
    showToast('ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'info');
}

function exportToExcel(type) {
    let data, filename, headers;
    if (type === 'rider') {
        headers = ['ì´ë¦„','ì—°ë½ì²˜','í˜‘ë ¥ì‚¬','ì£¼ì†Œ','ì€í–‰','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì£¼ë¯¼ë²ˆí˜¸','ì›ì²œì§•ìˆ˜','ìƒíƒœ','ë©”ëª¨'];
        data = riderList.map(r => { const p = partnerList.find(x => x.id == r.partner_id); return [r.name, r.phone, p?p.name:'', r.address, r.bank, r.account_holder, r.account_no, r.ssn, r.tax_type, r.status, r.memo]; });
        filename = 'ë¼ì´ë”ëª©ë¡.xlsx';
    } else if (type === 'partner') {
        headers = ['í˜‘ë ¥ì‚¬ëª…','ì½”ë“œ','êµ¬ë¶„','ëŒ€í‘œì','ì—°ë½ì²˜','ì´ë©”ì¼','ì‚¬ì—…ìë²ˆí˜¸','ì—…ì¢…','ì£¼ì†Œ','ì€í–‰','ê³„ì¢Œë²ˆí˜¸','ë©”ëª¨'];
        data = partnerList.map(p => [p.name, p.code, p.type, p.rep_name, p.phone, p.email, p.biz_no, p.biz_type, p.address, p.bank, p.account_no, p.memo]);
        filename = 'í˜‘ë ¥ì‚¬ëª©ë¡.xlsx';
    } else if (type === 'sales') {
        headers = ['ì½”ë“œ','ì´ë¦„','ìœ í˜•','ì—°ë½ì²˜','ì´ë©”ì¼','ì§€ì—­','ì£¼ì†Œ','ì€í–‰','ì˜ˆê¸ˆì£¼','ê³„ì¢Œë²ˆí˜¸','ì›ì²œì§•ìˆ˜ìœ¨','ì§€ê¸‰ì£¼ê¸°','ìƒíƒœ','ë©”ëª¨'];
        data = salesList.map(s => [s.sales_code, s.name, s.sales_type, s.phone, s.email, s.region, s.address, s.bank_name, s.bank_holder, s.bank_account, s.withholding_rate, s.payout_cycle, s.status, s.memo]);
        filename = 'ì˜ì—…ìëª©ë¡.xlsx';
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename);
    showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'info');
}

async function uploadExcel(type, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
            if (rows.length < 2) { showToast('ë°ì´í„° ì—†ìŒ', 'error'); return; }
            const tpl = TEMPLATES[type];
            let count = 0;
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                const data = {};
                tpl.fields.forEach((f, idx) => {
                    if (row[idx] !== undefined && row[idx] !== '') {
                        if (f === 'partner_code') {
                            const p = partnerList.find(x => x.code === row[idx]);
                            if (p) data['partner_id'] = p.id;
                        } else if (f === 'withholding_rate') {
                            data[f] = parseFloat(row[idx]) || 0.033;
                        } else {
                            data[f] = row[idx];
                        }
                    }
                });
                if (!data.name && !data.sales_code) continue;
                const table = type === 'rider' ? 'riders' : type === 'partner' ? 'partners' : 'sales_reps';
                if (type === 'sales') data.withholding_enabled = true;
                const result = await supabaseCall(table, 'POST', data);
                if (result) count++;
            }
            showToast(count + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
            await loadAllData();
            loadStats(type); renderTable(type); loadDashboard();
            if (type === 'partner') loadPartnerOptions();
        } catch (err) { console.error(err); showToast('ì—…ë¡œë“œ ì‹¤íŒ¨', 'error'); }
    };
    reader.readAsBinaryString(file);
    input.value = '';
}

document.addEventListener('DOMContentLoaded', async () => {
    const restored = await restoreSession();
    document.getElementById('loadingScreen').classList.add('hidden');
    if (!restored) document.getElementById('loginPage').classList.remove('hidden');
});

// ==================== ë²•ì¸ì¹´ë“œ ê´€ë¦¬ ====================
function renderCardTable() {
    document.getElementById('card-total').textContent = cardList.length;
    document.getElementById('card-active').textContent = cardList.filter(c => c.status === 'active').length;
    document.getElementById('card-suspended').textContent = cardList.filter(c => c.status === 'suspended').length;
    const monthly = cardTransList.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    document.getElementById('card-monthly').textContent = 'â‚©' + monthly.toLocaleString();
    
    const tbody = document.getElementById('cardTableBody');
    if (!cardList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const statuses = { active: 'ì‚¬ìš©ì¤‘', suspended: 'ì¼ì‹œì¤‘ì§€', terminated: 'í•´ì§€' };
    const statusClass = { active: 'badge-active', suspended: 'badge-pending', terminated: 'badge-inactive' };
    tbody.innerHTML = cardList.map(c => '<tr><td class="font-bold">' + (c.card_alias || '-') + '</td><td>' + (c.card_number_masked || '-') + '</td><td>' + (c.card_company || '-') + '</td><td>' + (c.primary_user || '-') + '</td><td class="text-right">â‚©' + parseInt(c.daily_limit || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(c.monthly_limit || 0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[c.status] || 'badge-inactive') + '">' + (statuses[c.status] || c.status) + '</span></td><td><button onclick="editCard(' + c.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function renderCardTransTable() {
    // í†µê³„ ì—…ë°ì´íŠ¸
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthlyUsage = cardTransList.filter(t => t.transaction_date?.startsWith(thisMonth)).reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    const noReceipt = cardTransList.filter(t => t.evidence_status === 'pending').length;
    const pending = cardTransList.filter(t => t.accounting_status === 'pending').length;
    
    const monthlyEl = document.getElementById('card-usage-monthly');
    const countEl = document.getElementById('card-usage-count');
    const noReceiptEl = document.getElementById('card-usage-noreceipt');
    const pendingEl = document.getElementById('card-usage-pending');
    
    if (monthlyEl) monthlyEl.textContent = 'â‚©' + monthlyUsage.toLocaleString();
    if (countEl) countEl.textContent = cardTransList.length + 'ê±´';
    if (noReceiptEl) noReceiptEl.textContent = noReceipt + 'ê±´';
    if (pendingEl) pendingEl.textContent = pending + 'ê±´';
    
    const tbody = document.getElementById('cardUsageTableBody');
    if (!tbody) return;
    
    if (!cardTransList.length) { 
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; 
        return; 
    }
    
    const evidenceStatus = { pending: 'ë¯¸ì œì¶œ', submitted: 'ì œì¶œ', approved: 'ìŠ¹ì¸' };
    const accStatus = { pending: 'ë¯¸ì²˜ë¦¬', journalized: 'ì™„ë£Œ' };
    
    tbody.innerHTML = cardTransList.map(t => {
        const card = cardList.find(c => c.id == t.card_id);
        return '<tr>' +
            '<td>' + (t.transaction_date || '-') + '</td>' +
            '<td>' + (card ? card.card_alias : '-') + '</td>' +
            '<td>' + (t.merchant_name || '-') + '</td>' +
            '<td class="text-right font-bold">â‚©' + parseInt(t.amount || 0).toLocaleString() + '</td>' +
            '<td><span class="badge ' + (t.evidence_status === 'approved' ? 'badge-active' : 'badge-pending') + '">' + (evidenceStatus[t.evidence_status] || 'ë¯¸ì œì¶œ') + '</span></td>' +
            '<td><span class="badge ' + (t.accounting_status === 'journalized' ? 'badge-active' : 'badge-pending') + '">' + (accStatus[t.accounting_status] || 'ë¯¸ì²˜ë¦¬') + '</span></td>' +
            '<td><button onclick="editCardTrans(' + t.id + ')" class="btn-secondary btn-sm mr-1">ìˆ˜ì •</button><button onclick="deleteCardTrans(' + t.id + ')" class="btn-danger btn-sm">ì‚­ì œ</button></td>' +
            '</tr>';
    }).join('');
}

function openCardTransModal() {
    document.getElementById('cardTransForm').reset();
    document.getElementById('cardtrans-id').value = '';
    document.getElementById('cardtrans-date').value = new Date().toISOString().slice(0, 16);
    
    // ì¹´ë“œ ì˜µì…˜ ë¡œë“œ
    const select = document.getElementById('cardtrans-card');
    select.innerHTML = '<option value="">ì„ íƒ</option>' + cardList.map(c => '<option value="' + c.id + '">' + (c.card_alias || c.card_number_masked) + '</option>').join('');
    
    openModal('cardTransModal');
}

function editCardTrans(id) {
    const t = cardTransList.find(x => x.id === id);
    if (!t) return;
    
    document.getElementById('cardtrans-id').value = t.id;
    document.getElementById('cardtrans-date').value = t.transaction_date ? t.transaction_date.replace(' ', 'T').slice(0, 16) : '';
    
    const select = document.getElementById('cardtrans-card');
    select.innerHTML = '<option value="">ì„ íƒ</option>' + cardList.map(c => '<option value="' + c.id + '">' + (c.card_alias || c.card_number_masked) + '</option>').join('');
    select.value = t.card_id || '';
    
    document.getElementById('cardtrans-merchant').value = t.merchant_name || '';
    document.getElementById('cardtrans-amount').value = t.amount || '';
    document.getElementById('cardtrans-category').value = t.category || '';
    document.getElementById('cardtrans-approval').value = t.approval_number || '';
    document.getElementById('cardtrans-evidence').value = t.evidence_status || 'pending';
    document.getElementById('cardtrans-accounting').value = t.accounting_status || 'pending';
    document.getElementById('cardtrans-memo').value = t.memo || '';
    
    openModal('cardTransModal');
}

async function submitCardTrans(e) {
    e.preventDefault();
    const id = document.getElementById('cardtrans-id').value;
    const data = {
        transaction_date: document.getElementById('cardtrans-date').value.replace('T', ' '),
        card_id: parseInt(document.getElementById('cardtrans-card').value) || null,
        merchant_name: document.getElementById('cardtrans-merchant').value,
        amount: parseFloat(document.getElementById('cardtrans-amount').value) || 0,
        category: document.getElementById('cardtrans-category').value || null,
        approval_number: document.getElementById('cardtrans-approval').value || null,
        evidence_status: document.getElementById('cardtrans-evidence').value,
        accounting_status: document.getElementById('cardtrans-accounting').value,
        memo: document.getElementById('cardtrans-memo').value || null
    };
    
    let result;
    if (id) {
        result = await supabaseCall('card_transactions', 'PATCH', data, '?id=eq.' + id);
        if (result) {
            const idx = cardTransList.findIndex(t => t.id == id);
            if (idx >= 0) cardTransList[idx] = { ...cardTransList[idx], ...data };
            showToast('ì‚¬ìš©ë‚´ì—­ ìˆ˜ì • ì™„ë£Œ');
        }
    } else {
        result = await supabaseCall('card_transactions', 'POST', data);
        if (result && result[0]) {
            cardTransList.unshift(result[0]);
            showToast('ì‚¬ìš©ë‚´ì—­ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    closeModal('cardTransModal');
    renderCardTransTable();
}

async function deleteCardTrans(id) {
    if (!confirm('ì´ ì‚¬ìš©ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await supabaseCall('card_transactions', 'DELETE', null, '?id=eq.' + id);
    cardTransList = cardTransList.filter(t => t.id !== id);
    
    showToast('ì‚¬ìš©ë‚´ì—­ ì‚­ì œ ì™„ë£Œ');
    renderCardTransTable();
}

function openCardModal() {
    document.getElementById('cardModalTitle').textContent = 'ğŸ’³ ì¹´ë“œ ë“±ë¡';
    document.getElementById('cardForm').reset();
    document.getElementById('card-id').value = '';
    openModal('cardModal');
}

function editCard(id) {
    const c = cardList.find(x => x.id === id); if (!c) return;
    document.getElementById('cardModalTitle').textContent = 'ğŸ’³ ì¹´ë“œ ìˆ˜ì •';
    document.getElementById('card-id').value = c.id;
    document.getElementById('card-alias').value = c.card_alias || '';
    document.getElementById('card-company').value = c.company_name || '';
    document.getElementById('card-company-name').value = c.card_company || '';
    document.getElementById('card-number').value = c.card_number_masked || '';
    document.getElementById('card-bank').value = c.linked_bank_account || '';
    document.getElementById('card-valid').value = c.valid_until || '';
    document.getElementById('card-dept').value = c.department || '';
    document.getElementById('card-user').value = c.primary_user || '';
    document.getElementById('card-daily').value = c.daily_limit || 0;
    document.getElementById('card-monthly').value = c.monthly_limit || 0;
    document.getElementById('card-online').checked = c.allow_online !== false;
    document.getElementById('card-overseas').checked = c.allow_overseas === true;
    document.getElementById('card-issued').value = c.issued_at || '';
    document.getElementById('card-status').value = c.status || 'active';
    document.getElementById('card-memo').value = c.memo || '';
    openModal('cardModal');
}

async function submitCard(e) {
    e.preventDefault();
    const id = document.getElementById('card-id').value;
    const data = {
        card_alias: document.getElementById('card-alias').value,
        company_name: document.getElementById('card-company').value || null,
        card_company: document.getElementById('card-company-name').value,
        card_number_masked: document.getElementById('card-number').value || null,
        linked_bank_account: document.getElementById('card-bank').value || null,
        valid_until: document.getElementById('card-valid').value || null,
        department: document.getElementById('card-dept').value || null,
        primary_user: document.getElementById('card-user').value || null,
        daily_limit: parseFloat(document.getElementById('card-daily').value) || 0,
        monthly_limit: parseFloat(document.getElementById('card-monthly').value) || 0,
        allow_online: document.getElementById('card-online').checked,
        allow_overseas: document.getElementById('card-overseas').checked,
        issued_at: document.getElementById('card-issued').value || null,
        status: document.getElementById('card-status').value,
        memo: document.getElementById('card-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('corporate_cards', 'PATCH', data, '?id=eq.' + id);
            const idx = cardList.findIndex(x => x.id == id);
            if (idx >= 0) cardList[idx] = { ...cardList[idx], ...data };
            showToast('ì¹´ë“œ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('corporate_cards', 'POST', data);
            if (r && r[0]) cardList.unshift(r[0]);
            showToast('ì¹´ë“œ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('cardModal');
        renderCardTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ==================== ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬ ====================
function renderTaxInvoiceTable() {
    const purchases = taxInvoiceList.filter(t => t.invoice_type === 'purchase');
    const sales = taxInvoiceList.filter(t => t.invoice_type === 'sales');
    const unsynced = taxInvoiceList.filter(t => !t.synced_to_ledger);
    
    document.getElementById('inv-purchase').textContent = purchases.length;
    document.getElementById('inv-purchase-amt').textContent = 'â‚©' + purchases.reduce((s, t) => s + parseFloat(t.total_amount || 0), 0).toLocaleString();
    document.getElementById('inv-sales').textContent = sales.length;
    document.getElementById('inv-sales-amt').textContent = 'â‚©' + sales.reduce((s, t) => s + parseFloat(t.total_amount || 0), 0).toLocaleString();
    document.getElementById('inv-unsynced').textContent = unsynced.length;
    
    const typeFilter = document.getElementById('invTypeFilter').value;
    const statusFilter = document.getElementById('invStatusFilter').value;
    const syncFilter = document.getElementById('invSyncFilter')?.value || '';
    const search = (document.getElementById('invSearch').value || '').toLowerCase();
    let list = taxInvoiceList;
    if (typeFilter) list = list.filter(t => t.invoice_type === typeFilter);
    if (statusFilter) list = list.filter(t => t.payment_status === statusFilter);
    if (syncFilter === 'synced') list = list.filter(t => t.synced_to_ledger);
    if (syncFilter === 'unsynced') list = list.filter(t => !t.synced_to_ledger);
    if (search) list = list.filter(t => (t.partner_name || '').toLowerCase().includes(search));
    
    const tbody = document.getElementById('taxInvoiceTableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const types = { purchase: 'ë§¤ì…', sales: 'ë§¤ì¶œ' };
    const payStatus = { unpaid: 'ë¯¸ì§€ê¸‰', paid: 'ì§€ê¸‰ì™„ë£Œ' };
    tbody.innerHTML = list.map(t => {
        const syncBadge = t.synced_to_ledger ? '<span class="badge badge-active text-xs">ì—°ë™</span>' : '<span class="badge badge-pending text-xs">ë¯¸ì—°ë™</span>';
        return '<tr><td><span class="badge ' + (t.invoice_type === 'purchase' ? 'badge-error' : 'badge-info') + '">' + (types[t.invoice_type] || t.invoice_type) + '</span></td><td>' + t.invoice_date + '</td><td class="font-bold">' + (t.partner_name || '-') + '</td><td class="text-right">â‚©' + parseInt(t.supply_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(t.vat_amount || 0).toLocaleString() + '</td><td class="text-right font-bold">â‚©' + parseInt(t.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.payment_status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (payStatus[t.payment_status] || 'ë¯¸ì§€ê¸‰') + '</span></td><td>' + syncBadge + '</td><td><button onclick="editTaxInvoice(' + t.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

function openTaxInvoiceModal() {
    document.getElementById('taxInvoiceModalTitle').textContent = 'ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ë“±ë¡';
    document.getElementById('taxInvoiceForm').reset();
    document.getElementById('inv-id').value = '';
    document.getElementById('inv-date').value = new Date().toISOString().split('T')[0];
    openModal('taxInvoiceModal');
}

function editTaxInvoice(id) {
    const t = taxInvoiceList.find(x => x.id === id); if (!t) return;
    document.getElementById('taxInvoiceModalTitle').textContent = 'ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì •';
    document.getElementById('inv-id').value = t.id;
    document.getElementById('inv-type').value = t.invoice_type || 'purchase';
    document.getElementById('inv-date').value = t.invoice_date || '';
    document.getElementById('inv-vendor').value = t.partner_name || '';
    document.getElementById('inv-bizno').value = t.biz_no || '';
    document.getElementById('inv-ceo').value = t.ceo_name || '';
    document.getElementById('inv-supply').value = t.supply_amount || 0;
    document.getElementById('inv-vat').value = t.vat_amount || 0;
    document.getElementById('inv-total').value = t.total_amount || 0;
    document.getElementById('inv-status').value = t.payment_status || 'unpaid';
    document.getElementById('inv-paiddate').value = t.paid_date || '';
    document.getElementById('inv-item').value = t.item_name || '';
    document.getElementById('inv-memo').value = t.memo || '';
    openModal('taxInvoiceModal');
}

function calcTaxInvoice() {
    const supply = parseFloat(document.getElementById('inv-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('inv-vat').value = vat;
    document.getElementById('inv-total').value = supply + vat;
}

async function submitTaxInvoice(e) {
    e.preventDefault();
    const id = document.getElementById('inv-id').value;
    const data = {
        invoice_type: document.getElementById('inv-type').value,
        invoice_date: document.getElementById('inv-date').value,
        partner_name: document.getElementById('inv-vendor').value,
        biz_no: document.getElementById('inv-bizno').value || null,
        ceo_name: document.getElementById('inv-ceo').value || null,
        supply_amount: parseFloat(document.getElementById('inv-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('inv-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('inv-total').value) || 0,
        payment_status: document.getElementById('inv-status').value,
        paid_date: document.getElementById('inv-paiddate').value || null,
        item_name: document.getElementById('inv-item').value || null,
        memo: document.getElementById('inv-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('hq_tax_invoices', 'PATCH', data, '?id=eq.' + id);
            const idx = taxInvoiceList.findIndex(x => x.id == id);
            if (idx >= 0) taxInvoiceList[idx] = { ...taxInvoiceList[idx], ...data };
            showToast('ì„¸ê¸ˆê³„ì‚°ì„œ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('hq_tax_invoices', 'POST', data);
            if (r && r[0]) taxInvoiceList.unshift(r[0]);
            showToast('ì„¸ê¸ˆê³„ì‚°ì„œ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('taxInvoiceModal');
        renderTaxInvoiceTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ì„¸ê¸ˆê³„ì‚°ì„œ ì—‘ì…€
function exportTaxInvoiceExcel() {
    const headers = ['ìœ í˜•','ë°œí–‰ì¼','ê±°ë˜ì²˜','ì‚¬ì—…ìë²ˆí˜¸','ëŒ€í‘œì','ê³µê¸‰ê°€ì•¡','ë¶€ê°€ì„¸','í•©ê³„','ì§€ê¸‰ìƒíƒœ','í’ˆëª©','ë©”ëª¨'];
    const data = taxInvoiceList.map(t => [t.invoice_type === 'purchase' ? 'ë§¤ì…' : 'ë§¤ì¶œ', t.invoice_date, t.partner_name, t.biz_no, t.ceo_name, t.supply_amount, t.vat_amount, t.total_amount, t.payment_status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ë¯¸ì§€ê¸‰', t.item_name, t.memo]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'ì„¸ê¸ˆê³„ì‚°ì„œ');
    XLSX.writeFile(wb, 'ì„¸ê¸ˆê³„ì‚°ì„œëª©ë¡.xlsx');
    showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

async function uploadTaxInvoiceExcel(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (rows.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let count = 0;
        for (let i = 1; i < rows.length; i++) {
            const r = rows[i]; if (!r[2]) continue;
            const data = {
                invoice_type: r[0] === 'ë§¤ì…' ? 'purchase' : 'sales',
                invoice_date: r[1],
                partner_name: r[2],
                biz_no: r[3] || null,
                ceo_name: r[4] || null,
                supply_amount: parseFloat(r[5]) || 0,
                vat_amount: parseFloat(r[6]) || 0,
                total_amount: parseFloat(r[7]) || 0,
                payment_status: r[8] === 'ì§€ê¸‰ì™„ë£Œ' ? 'paid' : 'unpaid',
                item_name: r[9] || null,
                memo: r[10] || null
            };
            const res = await supabaseCall('hq_tax_invoices', 'POST', data);
            if (res && res[0]) { taxInvoiceList.unshift(res[0]); count++; }
        }
        showToast(count + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderTaxInvoiceTable();
    };
    reader.readAsBinaryString(input.files[0]);
    input.value = '';
}

// ==================== íšŒê³„ ê´€ë¦¬ ====================
function renderJournalTable() {
    document.getElementById('acc-count').textContent = journalList.length + 'ê±´';
    document.getElementById('acc-debit').textContent = 'â‚©' + journalList.reduce((s, j) => s + parseFloat(j.debit_amount || 0), 0).toLocaleString();
    document.getElementById('acc-credit').textContent = 'â‚©' + journalList.reduce((s, j) => s + parseFloat(j.credit_amount || 0), 0).toLocaleString();
    document.getElementById('acc-pending').textContent = journalList.filter(j => j.status === 'created').length + 'ê±´';
    
    const tbody = document.getElementById('journalTableBody');
    if (!journalList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const statuses = { created: 'ìƒì„±', confirmed: 'í™•ì •', cancelled: 'ì·¨ì†Œ' };
    const statusClass = { created: 'badge-pending', confirmed: 'badge-active', cancelled: 'badge-inactive' };
    tbody.innerHTML = journalList.map(j => '<tr><td>' + j.journal_date + '</td><td class="font-bold text-purple-400">' + (j.journal_no || '-') + '</td><td>' + (j.debit_account || '-') + '</td><td class="text-right text-blue-400">â‚©' + parseInt(j.debit_amount || 0).toLocaleString() + '</td><td>' + (j.credit_account || '-') + '</td><td class="text-right text-red-400">â‚©' + parseInt(j.credit_amount || 0).toLocaleString() + '</td><td class="text-xs">' + (j.description || '-') + '</td><td><span class="badge ' + (statusClass[j.status] || 'badge-pending') + '">' + (statuses[j.status] || j.status) + '</span></td><td><button onclick="editJournal(' + j.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function openJournalModal() {
    document.getElementById('journalModalTitle').textContent = 'ğŸ“Š ë¶„ê°œ ë“±ë¡';
    document.getElementById('journalForm').reset();
    document.getElementById('jnl-id').value = '';
    document.getElementById('jnl-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('jnl-number').value = 'JNL-' + Date.now();
    openModal('journalModal');
}

function editJournal(id) {
    const j = journalList.find(x => x.id === id); if (!j) return;
    document.getElementById('journalModalTitle').textContent = 'ğŸ“Š ë¶„ê°œ ìˆ˜ì •';
    document.getElementById('jnl-id').value = j.id;
    document.getElementById('jnl-date').value = j.journal_date || '';
    document.getElementById('jnl-number').value = j.journal_no || '';
    document.getElementById('jnl-debit-account').value = j.debit_account || '';
    document.getElementById('jnl-debit-amount').value = j.debit_amount || 0;
    document.getElementById('jnl-credit-account').value = j.credit_account || '';
    document.getElementById('jnl-credit-amount').value = j.credit_amount || 0;
    document.getElementById('jnl-desc').value = j.description || '';
    document.getElementById('jnl-status').value = j.status || 'created';
    document.getElementById('jnl-evidence').value = j.evidence_no || '';
    document.getElementById('jnl-memo').value = j.memo || '';
    openModal('journalModal');
}

async function submitJournal(e) {
    e.preventDefault();
    const id = document.getElementById('jnl-id').value;
    const data = {
        journal_date: document.getElementById('jnl-date').value,
        journal_no: document.getElementById('jnl-number').value,
        debit_account: document.getElementById('jnl-debit-account').value,
        debit_amount: parseFloat(document.getElementById('jnl-debit-amount').value) || 0,
        credit_account: document.getElementById('jnl-credit-account').value,
        credit_amount: parseFloat(document.getElementById('jnl-credit-amount').value) || 0,
        description: document.getElementById('jnl-desc').value,
        status: document.getElementById('jnl-status').value,
        evidence_no: document.getElementById('jnl-evidence').value || null,
        memo: document.getElementById('jnl-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('accounting_journals', 'PATCH', data, '?id=eq.' + id);
            const idx = journalList.findIndex(x => x.id == id);
            if (idx >= 0) journalList[idx] = { ...journalList[idx], ...data };
            showToast('ë¶„ê°œ ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('accounting_journals', 'POST', data);
            if (r && r[0]) journalList.unshift(r[0]);
            showToast('ë¶„ê°œ ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('journalModal');
        renderJournalTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

// ë¶„ê°œ ì—‘ì…€
function exportJournalExcel() {
    const headers = ['ì¼ì','ë¶„ê°œë²ˆí˜¸','ì°¨ë³€ê³„ì •','ì°¨ë³€ê¸ˆì•¡','ëŒ€ë³€ê³„ì •','ëŒ€ë³€ê¸ˆì•¡','ì ìš”','ìƒíƒœ','ë©”ëª¨'];
    const data = journalList.map(j => [j.journal_date, j.journal_no, j.debit_account, j.debit_amount, j.credit_account, j.credit_amount, j.description, j.status === 'confirmed' ? 'í™•ì •' : 'ìƒì„±', j.memo]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'ë¶„ê°œì¥');
    XLSX.writeFile(wb, 'ë¶„ê°œì¥.xlsx');
    showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

async function uploadJournalExcel(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (rows.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let count = 0;
        for (let i = 1; i < rows.length; i++) {
            const r = rows[i]; if (!r[0]) continue;
            const data = {
                journal_date: r[0],
                journal_no: r[1] || 'JNL-' + Date.now() + i,
                debit_account: r[2] || '',
                debit_amount: parseFloat(r[3]) || 0,
                credit_account: r[4] || '',
                credit_amount: parseFloat(r[5]) || 0,
                description: r[6] || '',
                status: r[7] === 'í™•ì •' ? 'confirmed' : 'created',
                memo: r[8] || null
            };
            const res = await supabaseCall('accounting_journals', 'POST', data);
            if (res && res[0]) { journalList.unshift(res[0]); count++; }
        }
        showToast(count + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderJournalTable();
    };
    reader.readAsBinaryString(input.files[0]);
    input.value = '';
}

// ==================== ê°ì‚¬ ë¡œê·¸ ====================
async function renderAuditLogs() {
    const logs = await supabaseCall('audit_logs', 'GET', null, '?order=changed_at.desc&limit=50');
    auditLogList = logs || [];
    const tbody = document.getElementById('auditLogTableBody');
    if (!auditLogList.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const actions = { INSERT: 'ë“±ë¡', UPDATE: 'ìˆ˜ì •', DELETE: 'ì‚­ì œ' };
    const actionClass = { INSERT: 'badge-active', UPDATE: 'badge-pending', DELETE: 'badge-error' };
    tbody.innerHTML = auditLogList.map(l => '<tr><td class="text-xs">' + (l.changed_at || '').substring(0, 19) + '</td><td>' + (l.table_name || '-') + '</td><td><span class="badge ' + (actionClass[l.action_type] || 'badge-info') + '">' + (actions[l.action_type] || l.action_type) + '</span></td><td>' + l.record_id + '</td><td>' + (l.changed_by || '-') + '</td><td><button onclick="viewAuditDetail(' + l.id + ')" class="btn-secondary btn-sm">ìƒì„¸</button></td></tr>').join('');
}

function viewAuditDetail(id) { showToast('ê°ì‚¬ ë¡œê·¸ ìƒì„¸ ë³´ê¸° ì¤€ë¹„ì¤‘', 'info'); }

// ==================== ì§€ê¸‰ ê´€ë¦¬ (ì§ì›/ê¸‰ì—¬) ====================
function renderEmployeeTable() {
    document.getElementById('emp-total').textContent = employeeList.length;
    document.getElementById('emp-regular').textContent = employeeList.filter(e => e.emp_type === 'regular').length;
    document.getElementById('emp-contract').textContent = employeeList.filter(e => e.emp_type === 'contract').length;
    document.getElementById('emp-insured').textContent = employeeList.filter(e => e.insurance_enabled).length;
    
    const tbody = document.getElementById('employeeTableBody');
    if (!employeeList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const types = { regular: 'ì •ê·œì§', contract: 'ê³„ì•½ì§' };
    const typeClass = { regular: 'badge-info', contract: 'badge-pending' };
    tbody.innerHTML = employeeList.map(e => '<tr><td class="font-bold text-purple-400">' + (e.emp_code || '-') + '</td><td>' + e.name + '</td><td><span class="badge ' + (typeClass[e.emp_type] || 'badge-info') + '">' + (types[e.emp_type] || e.emp_type) + '</span></td><td>' + (e.department || '-') + '</td><td class="text-right">â‚©' + parseInt(e.base_salary || 0).toLocaleString() + '</td><td>' + (e.insurance_enabled ? '<span class="text-green-400">âœ“</span>' : '<span class="text-gray-500">-</span>') + '</td><td><span class="badge ' + (e.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (e.status === 'active' ? 'ì¬ì§' : 'í‡´ì‚¬') + '</span></td><td><button onclick="editEmployee(' + e.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function renderPayrollTable() {
    const thisMonth = new Date().getMonth() + 1;
    const thisYear = new Date().getFullYear();
    const thisMonthPayrolls = payrollList.filter(p => p.pay_year == thisYear && p.pay_month == thisMonth);
    
    document.getElementById('pay-count').textContent = thisMonthPayrolls.length + 'ê±´';
    document.getElementById('pay-gross').textContent = 'â‚©' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.gross_pay || 0), 0).toLocaleString();
    document.getElementById('pay-deduct').textContent = 'â‚©' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.total_deduction || 0), 0).toLocaleString();
    document.getElementById('pay-net').textContent = 'â‚©' + thisMonthPayrolls.reduce((s, p) => s + parseFloat(p.net_pay || 0), 0).toLocaleString();
    
    const tbody = document.getElementById('payrollTableBody');
    if (!payrollList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = payrollList.map(p => {
        const emp = employeeList.find(e => e.id == p.employee_id);
        const allowance = parseFloat(p.overtime_pay || 0) + parseFloat(p.bonus || 0) + parseFloat(p.meal_allowance || 0) + parseFloat(p.transport_allowance || 0) + parseFloat(p.other_allowance || 0);
        return '<tr><td class="font-bold">' + p.pay_year + 'ë…„ ' + p.pay_month + 'ì›”</td><td>' + (emp ? emp.name : '-') + '</td><td class="text-right">â‚©' + parseInt(p.base_salary || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(allowance).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(p.gross_pay || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(p.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-green-400">â‚©' + parseInt(p.net_pay || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (p.status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editPayroll(' + p.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

function openEmployeeModal() { showToast('ì§ì› ë“±ë¡ ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }
function editEmployee(id) { showToast('ì§ì› ìˆ˜ì • ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }
function openPayrollModal() { showToast('ê¸‰ì—¬ ë“±ë¡ ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }
function editPayroll(id) { showToast('ê¸‰ì—¬ ìˆ˜ì • ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }

// ê·¼ë¡œê³„ì•½ì„œ ì—…ë¡œë“œ
let selectedContractFile = null;

function loadContractEmpOptions() {
    const sel = document.getElementById('contractEmpSelect');
    sel.innerHTML = '<option value="">ì§ì› ì„ íƒ</option>' + employeeList.map(e => '<option value="' + e.id + '">' + e.name + ' (' + (e.emp_code || '-') + ')</option>').join('');
}

function handleContractUpload(input) {
    if (input.files && input.files[0]) {
        selectedContractFile = input.files[0];
        document.getElementById('contractFileName').textContent = selectedContractFile.name;
    }
}

async function uploadContract() {
    const empId = document.getElementById('contractEmpSelect').value;
    if (!empId) { showToast('ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
    if (!selectedContractFile) { showToast('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
    
    // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•´ì„œ ì €ì¥ (ê°„ë‹¨í•œ ë°©ë²•)
    const reader = new FileReader();
    reader.onload = async (e) => {
        const emp = employeeList.find(x => x.id == empId);
        const contract = {
            employee_id: parseInt(empId),
            employee_name: emp ? emp.name : '',
            file_name: selectedContractFile.name,
            file_size: selectedContractFile.size,
            file_type: selectedContractFile.type,
            file_data: e.target.result,
            uploaded_at: new Date().toISOString()
        };
        
        // localStorageì— ì €ì¥ (ì„ì‹œ)
        let contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
        contracts.push(contract);
        localStorage.setItem('employee_contracts', JSON.stringify(contracts));
        
        showToast('ì—…ë¡œë“œ ì™„ë£Œ');
        selectedContractFile = null;
        document.getElementById('contractFileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
        document.getElementById('contractFileInput').value = '';
        renderContractTable();
    };
    reader.readAsDataURL(selectedContractFile);
}

function renderContractTable() {
    const contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    const tbody = document.getElementById('contractTableBody');
    if (!contracts.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = contracts.map((c, idx) => '<tr><td>' + (c.employee_name || '-') + '</td><td class="text-purple-400">' + c.file_name + '</td><td>' + (c.uploaded_at || '').substring(0, 10) + '</td><td><button onclick="downloadContract(' + idx + ')" class="btn-secondary btn-sm mr-1">ë‹¤ìš´</button><button onclick="deleteContract(' + idx + ')" class="btn-sm" style="background:rgba(239,68,68,0.2);color:#EF4444;border:1px solid rgba(239,68,68,0.3);border-radius:8px">ì‚­ì œ</button></td></tr>').join('');
}

function downloadContract(idx) {
    const contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    const c = contracts[idx];
    if (!c) return;
    const link = document.createElement('a');
    link.href = c.file_data;
    link.download = c.file_name;
    link.click();
}

function deleteContract(idx) {
    if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    let contracts = JSON.parse(localStorage.getItem('employee_contracts') || '[]');
    contracts.splice(idx, 1);
    localStorage.setItem('employee_contracts', JSON.stringify(contracts));
    showToast('ì‚­ì œ ì™„ë£Œ');
    renderContractTable();
}

// ==================== ì •ì‚°ê´€ë¦¬ ì‹œìŠ¤í…œ ====================
function loadSettlementDashboard() {
    const platTotal = platformList.reduce((s, p) => s + parseFloat(p.total_amount || 0), 0);
    const advTotal = advanceTransferList.reduce((s, a) => s + parseFloat(a.total_amount || 0), 0);
    document.getElementById('sett-dash-platform').textContent = 'â‚©' + platTotal.toLocaleString();
    document.getElementById('sett-dash-advance').textContent = 'â‚©' + advTotal.toLocaleString();
    document.getElementById('sett-dash-profit').textContent = 'â‚©' + (platTotal - advTotal).toLocaleString();
    document.getElementById('sett-dash-pending').textContent = reconcileList.filter(r => r.status === 'pending').length + 'ê±´';
    
    const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
    const statuses = { pending: 'ëŒ€ê¸°', received: 'ì…ê¸ˆì™„ë£Œ', transferred: 'ì§€ê¸‰ì™„ë£Œ' };
    document.getElementById('settDashPlatformTable').innerHTML = platformList.slice(0, 5).map(p => '<tr><td>' + p.settlement_week + '</td><td>' + (platforms[p.platform] || p.platform) + '</td><td>â‚©' + parseInt(p.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'received' ? 'badge-active' : 'badge-pending') + '">' + (statuses[p.status] || p.status) + '</span></td></tr>').join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
    document.getElementById('settDashAdvanceTable').innerHTML = advanceTransferList.slice(0, 5).map(a => { const pt = partnerList.find(x => x.id == a.partner_id); return '<tr><td>' + a.transfer_date + '</td><td>' + (pt ? pt.name : '-') + '</td><td>â‚©' + parseInt(a.total_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (a.status === 'transferred' ? 'badge-active' : 'badge-pending') + '">' + (statuses[a.status] || a.status) + '</span></td></tr>'; }).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
}

function renderPlatformTable() {
    document.getElementById('plat-total').textContent = platformList.length + 'ê±´';
    document.getElementById('plat-count-stat').textContent = platformList.reduce((s, p) => s + parseInt(p.delivery_count || 0), 0).toLocaleString() + 'ê±´';
    document.getElementById('plat-supply-stat').textContent = 'â‚©' + platformList.reduce((s, p) => s + parseFloat(p.supply_amount || 0), 0).toLocaleString();
    document.getElementById('plat-amount').textContent = 'â‚©' + platformList.reduce((s, p) => s + parseFloat(p.total_amount || 0), 0).toLocaleString();
    
    const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
    const tbody = document.getElementById('platformTableBody');
    if (!platformList.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = platformList.map(p => '<tr><td class="font-bold text-purple-400">' + p.settlement_week + '</td><td>' + (platforms[p.platform] || p.platform) + '</td><td class="text-xs">' + (p.work_start_date || '') + '<br>~' + (p.work_end_date || '') + '</td><td class="text-right">' + parseInt(p.delivery_count || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(p.supply_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(p.vat_amount || 0).toLocaleString() + '</td><td class="text-right font-bold">â‚©' + parseInt(p.total_amount || 0).toLocaleString() + '</td><td>' + (p.expected_date || '-') + '</td><td><button onclick="editPlatform(' + p.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

function renderSettAdvanceTable() {
    document.getElementById('settadv-total').textContent = advanceTransferList.length + 'ê±´';
    document.getElementById('settadv-pending').textContent = advanceTransferList.filter(a => a.status === 'pending').length + 'ê±´';
    document.getElementById('settadv-transferred').textContent = advanceTransferList.filter(a => a.status === 'transferred').length + 'ê±´';
    document.getElementById('settadv-amount').textContent = 'â‚©' + advanceTransferList.reduce((s, a) => s + parseFloat(a.net_amount || 0), 0).toLocaleString();
    document.getElementById('settadv-fee-income').textContent = 'â‚©' + advanceTransferList.reduce((s, a) => s + parseFloat(a.fee_amount || 0), 0).toLocaleString();
    
    // í•„í„° ì ìš©
    const monthFilter = document.getElementById('settAdvMonthFilter')?.value || '';
    const partnerFilter = document.getElementById('settAdvPartnerFilter')?.value || '';
    const statusFilter = document.getElementById('settAdvStatusFilter')?.value || '';
    
    let filtered = advanceTransferList.filter(a => {
        if (monthFilter && !a.transfer_date?.startsWith(monthFilter)) return false;
        if (partnerFilter && a.partner_id != partnerFilter) return false;
        if (statusFilter && a.status !== statusFilter) return false;
        return true;
    });
    
    // í˜‘ë ¥ì‚¬ í•„í„° ì˜µì…˜ ë¡œë“œ
    const partnerFilterEl = document.getElementById('settAdvPartnerFilter');
    if (partnerFilterEl && partnerFilterEl.options.length <= 1) {
        partnerList.forEach(p => { partnerFilterEl.add(new Option(p.name, p.id)); });
    }
    
    const tbody = document.getElementById('settAdvanceTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = filtered.map(a => { const pt = partnerList.find(x => x.id == a.partner_id); return '<tr><td>' + a.transfer_date + '</td><td class="font-bold">' + (pt ? pt.name : '-') + '</td><td>' + (a.settlement_week || '-') + '</td><td class="text-right">â‚©' + parseInt(a.supply_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(a.vat_amount || 0).toLocaleString() + '</td><td class="text-right">â‚©' + parseInt(a.total_amount || 0).toLocaleString() + '</td><td class="text-right text-yellow-400">â‚©' + parseInt(a.fee_amount || 0).toLocaleString() + '</td><td class="text-right font-bold text-red-400">â‚©' + parseInt(a.net_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (a.status === 'transferred' ? 'badge-active' : 'badge-pending') + '">' + (a.status === 'transferred' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editSettAdvance(' + a.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>'; }).join('');
}

// í”Œë«í¼ ì •ì‚° â†’ ì„ ì •ì‚° ì§€ê¸‰ ì—°ë™
async function syncFromPlatformSettlement() {
    // í”Œë«í¼ ì •ì‚° ì¤‘ ì•„ì§ ì„ ì •ì‚° ì•ˆ ëœ ê²ƒ ì°¾ê¸°
    const unsynced = platformSettList.filter(p => !p.synced_to_advance && p.status === 'received');
    
    if (!unsynced.length) {
        showToast('ì—°ë™í•  í”Œë«í¼ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
        return;
    }
    
    if (!confirm(unsynced.length + 'ê±´ì˜ í”Œë«í¼ ì •ì‚°ì„ ì„ ì •ì‚° ì§€ê¸‰ìœ¼ë¡œ ì—°ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    let cnt = 0;
    for (const p of unsynced) {
        // í”Œë«í¼ë³„ í˜‘ë ¥ì‚¬ ë§¤í•‘ (í•„ìš”ì‹œ)
        const partner = partnerList.find(pt => pt.name?.includes(p.platform) || pt.id == p.partner_id);
        
        const supplyAmount = Math.round(parseFloat(p.total_amount || 0) / 1.1);
        const vatAmount = parseFloat(p.total_amount || 0) - supplyAmount;
        const feeRate = 0.02; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ 2%
        const feeAmount = Math.round(parseFloat(p.total_amount || 0) * feeRate);
        const netAmount = parseFloat(p.total_amount || 0) - feeAmount;
        
        const data = {
            partner_id: partner?.id || null,
            transfer_date: new Date().toISOString().slice(0, 10),
            settlement_week: p.settlement_week,
            supply_amount: supplyAmount,
            vat_amount: vatAmount,
            total_amount: parseFloat(p.total_amount || 0),
            fee_rate: feeRate,
            fee_amount: feeAmount,
            net_amount: netAmount,
            status: 'pending',
            platform_settlement_id: p.id,
            memo: p.platform + ' ' + p.settlement_week + ' ì—°ë™'
        };
        
        const r = await supabaseCall('advance_transfers', 'POST', data);
        if (r && r[0]) { advanceTransferList.unshift(r[0]); cnt++; }
        
        // í”Œë«í¼ ì •ì‚°ì— ì—°ë™ í‘œì‹œ
        await supabaseCall('platform_settlements', 'PATCH', { synced_to_advance: true }, '?id=eq.' + p.id);
        p.synced_to_advance = true;
    }
    
    showToast(cnt + 'ê±´ ì„ ì •ì‚° ì§€ê¸‰ ì—°ë™ ì™„ë£Œ');
    renderSettAdvanceTable();
    renderPlatformTable();
}

function renderReconcileTable() {
    document.getElementById('rec-total').textContent = reconcileList.length + 'ê±´';
    document.getElementById('rec-pending').textContent = reconcileList.filter(r => r.status === 'pending').length + 'ê±´';
    document.getElementById('rec-matched').textContent = reconcileList.filter(r => r.status === 'matched').length + 'ê±´';
    document.getElementById('rec-issue').textContent = reconcileList.filter(r => r.status === 'issue').length + 'ê±´';
    
    const tbody = document.getElementById('reconcileTableBody');
    if (!reconcileList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    const statuses = { pending: 'ëŒ€ê¸°', matched: 'ì™„ë£Œ', issue: 'ë¶ˆì¼ì¹˜' };
    const statusClass = { pending: 'badge-pending', matched: 'badge-active', issue: 'badge-error' };
    tbody.innerHTML = reconcileList.map(r => { const pt = partnerList.find(x => x.id == r.partner_id); return '<tr><td class="font-bold text-purple-400">' + r.settlement_week + '</td><td>' + (pt ? pt.name : '-') + '</td><td class="text-right text-blue-400">â‚©' + parseInt(r.platform_total || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(r.advance_total || 0).toLocaleString() + '</td><td class="text-right font-bold">â‚©' + parseInt(r.difference_amount || 0).toLocaleString() + '</td><td class="text-right text-purple-400">â‚©' + parseInt(r.fee_income || 0).toLocaleString() + '</td><td><span class="badge ' + (statusClass[r.status] || 'badge-pending') + '">' + (statuses[r.status] || r.status) + '</span></td><td><button onclick="editReconcile(' + r.id + ')" class="btn-secondary btn-sm">ìƒì„¸</button></td></tr>'; }).join('');
}

function renderCashbookTable() {
    // í•„í„° ì ìš©
    const monthFilter = document.getElementById('cashbookMonth')?.value || '';
    const typeFilter = document.getElementById('cashbookType')?.value || '';
    const linkFilter = document.getElementById('cashbookLink')?.value || '';
    const searchFilter = (document.getElementById('cashbookSearch')?.value || '').toLowerCase();
    
    let filtered = bankList.filter(b => {
        if (monthFilter && !b.transaction_date?.startsWith(monthFilter)) return false;
        if (typeFilter && b.transaction_type !== typeFilter) return false;
        if (linkFilter === 'linked' && !b.link_type) return false;
        if (linkFilter === 'unlinked' && b.link_type) return false;
        if (searchFilter && !(b.counterparty || '').toLowerCase().includes(searchFilter) && !(b.description || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    // í†µê³„
    const deposits = bankList.filter(b => b.transaction_type === 'deposit').reduce((s, b) => s + parseFloat(b.amount || 0), 0);
    const withdrawals = bankList.filter(b => b.transaction_type === 'withdrawal').reduce((s, b) => s + parseFloat(b.amount || 0), 0);
    const unlinked = bankList.filter(b => !b.link_type).length;
    
    document.getElementById('bank-deposit').textContent = 'â‚©' + deposits.toLocaleString();
    document.getElementById('bank-withdrawal').textContent = 'â‚©' + withdrawals.toLocaleString();
    document.getElementById('bank-balance').textContent = 'â‚©' + (deposits - withdrawals).toLocaleString();
    document.getElementById('bank-count').textContent = bankList.length + 'ê±´';
    document.getElementById('bank-unlinked').textContent = unlinked + 'ê±´';
    
    // ì”ì•¡ ê³„ì‚° (ë‚ ì§œìˆœ ì •ë ¬ í›„)
    const sorted = [...filtered].sort((a, b) => (a.transaction_date || '').localeCompare(b.transaction_date || ''));
    let runningBalance = 0;
    sorted.forEach(b => {
        if (b.transaction_type === 'deposit') runningBalance += parseFloat(b.amount || 0);
        else runningBalance -= parseFloat(b.amount || 0);
        b._balance = runningBalance;
    });
    
    const tbody = document.getElementById('bankTableBody');
    if (!sorted.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = sorted.map(b => {
        const linkBadge = b.link_type ? '<span class="badge badge-active text-xs">' + getLinkLabel(b.link_type) + '</span>' : '<span class="badge badge-pending text-xs">ë¯¸ì—°ê²°</span>';
        const isDeposit = b.transaction_type === 'deposit';
        return '<tr>' +
            '<td>' + b.transaction_date + '</td>' +
            '<td><span class="badge ' + (isDeposit ? 'badge-info' : 'badge-error') + '">' + (isDeposit ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ') + '</span></td>' +
            '<td class="font-bold">' + (b.counterparty || '-') + '</td>' +
            '<td class="text-right text-blue-400">' + (isDeposit ? 'â‚©' + parseInt(b.amount || 0).toLocaleString() : '') + '</td>' +
            '<td class="text-right text-red-400">' + (!isDeposit ? 'â‚©' + parseInt(b.amount || 0).toLocaleString() : '') + '</td>' +
            '<td class="text-right font-bold">â‚©' + parseInt(b._balance || 0).toLocaleString() + '</td>' +
            '<td class="text-xs">' + (b.description || '-') + '</td>' +
            '<td>' + linkBadge + '</td>' +
            '<td><button onclick="editCashbook(' + b.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td>' +
            '</tr>';
    }).join('');
}

function renderBankTable() { renderCashbookTable(); }

function getLinkLabel(type) {
    const labels = { platform: 'í”Œë«í¼', advance: 'ì„ ì •ì‚°', weekly: 'ì£¼ì •ì‚°', taxinvoice: 'ì„¸ê¸ˆê³„ì‚°ì„œ' };
    return labels[type] || type;
}

function loadSettAdvancePartnerOptions() {
    const opts = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    const el = document.getElementById('settadv-partner');
    if (el) el.innerHTML = opts;
}

// ëª¨ë‹¬ ì—´ê¸°
function openPlatformModal() { document.getElementById('platformForm').reset(); document.getElementById('plat-id').value = ''; openModal('platformModal'); }
function openSettAdvanceModal() { document.getElementById('settAdvanceForm').reset(); document.getElementById('settadv-id').value = ''; loadSettAdvancePartnerOptions(); openModal('settAdvanceModal'); }
function openCashbookModal() { 
    document.getElementById('bankForm').reset(); 
    document.getElementById('bank-id').value = ''; 
    document.getElementById('bank-link-id').innerHTML = '<option value="">ì„ íƒ</option>';
    openModal('bankModal'); 
}
function openBankModal() { openCashbookModal(); }
function openReconcileModal() { showToast('ëŒ€ì‚¬ ë“±ë¡ ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }

// ì—°ê²° ì˜µì…˜ ë¡œë“œ
function loadLinkOptions() {
    const linkType = document.getElementById('bank-link-type').value;
    const linkIdSelect = document.getElementById('bank-link-id');
    linkIdSelect.innerHTML = '<option value="">ì„ íƒ</option>';
    
    if (linkType === 'platform') {
        const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
        platformList.forEach(p => {
            const label = (platforms[p.platform] || p.platform) + ' ' + p.settlement_week + ' (â‚©' + parseInt(p.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + p.id + '">' + label + '</option>';
        });
    } else if (linkType === 'advance') {
        advanceTransferList.forEach(a => {
            const partner = partnerList.find(p => p.id == a.partner_id);
            const label = (partner?.name || 'í˜‘ë ¥ì‚¬') + ' ' + (a.settlement_week || '') + ' (â‚©' + parseInt(a.net_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + a.id + '">' + label + '</option>';
        });
    } else if (linkType === 'weekly') {
        weeklyPayoutList.forEach(w => {
            const rider = riderList.find(r => r.id == w.rider_id);
            const label = (rider?.name || 'ë¼ì´ë”') + ' ' + (w.settlement_week || '') + ' (â‚©' + parseInt(w.net_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + w.id + '">' + label + '</option>';
        });
    }
}

// ë¶€ê°€ì„¸ ìë™ê³„ì‚°
function calcPlatformVat() {
    const supply = parseFloat(document.getElementById('plat-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('plat-vat').value = vat;
    document.getElementById('plat-total-amt').value = supply + vat;
}

function calcSettAdvanceTotal() {
    const supply = parseFloat(document.getElementById('settadv-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    const feeRate = parseFloat(document.getElementById('settadv-fee-rate').value) || 0;
    const total = supply + vat;
    const fee = Math.round(total * feeRate / 100);
    document.getElementById('settadv-vat').value = vat;
    document.getElementById('settadv-total-amt').value = total;
    document.getElementById('settadv-fee').value = fee;
    document.getElementById('settadv-net').value = total - fee;
}

// ì €ì¥
async function submitPlatform(e) {
    e.preventDefault();
    const id = document.getElementById('plat-id').value;
    const data = {
        platform: document.getElementById('plat-platform').value,
        settlement_week: document.getElementById('plat-week').value,
        work_start_date: document.getElementById('plat-start').value || null,
        work_end_date: document.getElementById('plat-end').value || null,
        expected_date: document.getElementById('plat-expected').value || null,
        delivery_count: parseInt(document.getElementById('plat-count').value) || 0,
        supply_amount: parseFloat(document.getElementById('plat-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('plat-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('plat-total-amt').value) || 0,
        memo: document.getElementById('plat-memo').value || null
    };
    try {
        if (id) { await supabaseCall('platform_settlements', 'PATCH', data, '?id=eq.' + id); showToast('ìˆ˜ì • ì™„ë£Œ'); }
        else { const r = await supabaseCall('platform_settlements', 'POST', data); if (r && r[0]) platformList.unshift(r[0]); showToast('ë“±ë¡ ì™„ë£Œ'); }
        closeModal('platformModal');
        renderPlatformTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

async function submitSettAdvance(e) {
    e.preventDefault();
    const id = document.getElementById('settadv-id').value;
    const data = {
        partner_id: document.getElementById('settadv-partner').value || null,
        transfer_date: document.getElementById('settadv-date').value,
        settlement_week: document.getElementById('settadv-week').value || null,
        supply_amount: parseFloat(document.getElementById('settadv-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('settadv-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('settadv-total-amt').value) || 0,
        fee_rate: parseFloat(document.getElementById('settadv-fee-rate').value) / 100 || 0,
        fee_amount: parseFloat(document.getElementById('settadv-fee').value) || 0,
        net_amount: parseFloat(document.getElementById('settadv-net').value) || 0,
        status: document.getElementById('settadv-status').value,
        memo: document.getElementById('settadv-memo').value || null
    };
    try {
        if (id) { await supabaseCall('advance_transfers', 'PATCH', data, '?id=eq.' + id); showToast('ìˆ˜ì • ì™„ë£Œ'); }
        else { const r = await supabaseCall('advance_transfers', 'POST', data); if (r && r[0]) advanceTransferList.unshift(r[0]); showToast('ë“±ë¡ ì™„ë£Œ'); }
        closeModal('settAdvanceModal');
        renderSettAdvanceTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

async function submitCashbook(e) {
    e.preventDefault();
    const id = document.getElementById('bank-id').value;
    const data = {
        transaction_date: document.getElementById('bank-date').value,
        transaction_type: document.getElementById('bank-type').value,
        counterparty: document.getElementById('bank-counterparty').value || null,
        amount: parseFloat(document.getElementById('bank-amount').value) || 0,
        description: document.getElementById('bank-desc').value || null,
        link_type: document.getElementById('bank-link-type').value || null,
        link_id: document.getElementById('bank-link-id').value || null,
        bank_memo: document.getElementById('bank-memo2').value || null
    };
    try {
        if (id) { 
            await supabaseCall('bank_transactions', 'PATCH', data, '?id=eq.' + id); 
            const idx = bankList.findIndex(b => b.id == id);
            if (idx >= 0) bankList[idx] = { ...bankList[idx], ...data };
            showToast('ìˆ˜ì • ì™„ë£Œ'); 
        } else { 
            const r = await supabaseCall('bank_transactions', 'POST', data); 
            if (r && r[0]) bankList.unshift(r[0]); 
            showToast('ë“±ë¡ ì™„ë£Œ'); 
        }
        closeModal('bankModal');
        renderCashbookTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

async function submitBank(e) { return submitCashbook(e); }

function editCashbook(id) {
    const b = bankList.find(x => x.id === id); if (!b) return;
    document.getElementById('bank-id').value = b.id;
    document.getElementById('bank-date').value = b.transaction_date || '';
    document.getElementById('bank-type').value = b.transaction_type || 'deposit';
    document.getElementById('bank-counterparty').value = b.counterparty || '';
    document.getElementById('bank-amount').value = b.amount || 0;
    document.getElementById('bank-desc').value = b.description || '';
    document.getElementById('bank-link-type').value = b.link_type || '';
    loadLinkOptions();
    document.getElementById('bank-link-id').value = b.link_id || '';
    document.getElementById('bank-memo2').value = b.bank_memo || '';
    openModal('bankModal');
}

function editBank(id) { editCashbook(id); }

// ìˆ˜ì •
function editPlatform(id) {
    const p = platformList.find(x => x.id === id); if (!p) return;
    document.getElementById('plat-id').value = p.id;
    document.getElementById('plat-platform').value = p.platform || '';
    document.getElementById('plat-week').value = p.settlement_week || '';
    document.getElementById('plat-start').value = p.work_start_date || '';
    document.getElementById('plat-end').value = p.work_end_date || '';
    document.getElementById('plat-expected').value = p.expected_date || '';
    document.getElementById('plat-count').value = p.delivery_count || 0;
    document.getElementById('plat-supply').value = p.supply_amount || 0;
    document.getElementById('plat-vat').value = p.vat_amount || 0;
    document.getElementById('plat-total-amt').value = p.total_amount || 0;
    document.getElementById('plat-memo').value = p.memo || '';
    openModal('platformModal');
}

function editSettAdvance(id) {
    const a = advanceTransferList.find(x => x.id === id); if (!a) return;
    loadSettAdvancePartnerOptions();
    document.getElementById('settadv-id').value = a.id;
    document.getElementById('settadv-partner').value = a.partner_id || '';
    document.getElementById('settadv-date').value = a.transfer_date || '';
    document.getElementById('settadv-week').value = a.settlement_week || '';
    document.getElementById('settadv-supply').value = a.supply_amount || 0;
    document.getElementById('settadv-vat').value = a.vat_amount || 0;
    document.getElementById('settadv-total-amt').value = a.total_amount || 0;
    document.getElementById('settadv-fee-rate').value = (a.fee_rate || 0) * 100;
    document.getElementById('settadv-fee').value = a.fee_amount || 0;
    document.getElementById('settadv-net').value = a.net_amount || 0;
    document.getElementById('settadv-status').value = a.status || 'pending';
    document.getElementById('settadv-memo').value = a.memo || '';
    openModal('settAdvanceModal');
}

function editBank(id) {
    const b = bankList.find(x => x.id === id); if (!b) return;
    document.getElementById('bank-id').value = b.id;
    document.getElementById('bank-date').value = b.transaction_date || '';
    document.getElementById('bank-type').value = b.transaction_type || 'deposit';
    document.getElementById('bank-amount').value = b.amount || 0;
    document.getElementById('bank-desc').value = b.description || '';
    document.getElementById('bank-memo2').value = b.bank_memo || '';
    openModal('bankModal');
}

function editReconcile(id) { showToast('ëŒ€ì‚¬ ìƒì„¸ ëª¨ë‹¬ ì¤€ë¹„ì¤‘', 'info'); }
async function autoReconcile() { showToast('ìë™ ëŒ€ì‚¬ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘', 'info'); }

// ==================== ì£¼ì •ì‚° ì§€ê¸‰ ====================
function renderWeeklyPayoutTable() {
    document.getElementById('weekly-total').textContent = weeklyPayoutList.length + 'ê±´';
    document.getElementById('weekly-pending').textContent = weeklyPayoutList.filter(w => w.status === 'pending').length + 'ê±´';
    document.getElementById('weekly-paid').textContent = weeklyPayoutList.filter(w => w.status === 'paid').length + 'ê±´';
    document.getElementById('weekly-amount').textContent = 'â‚©' + weeklyPayoutList.reduce((s, w) => s + parseFloat(w.net_amount || 0), 0).toLocaleString();
    
    const sf = document.getElementById('weeklyStatusFilter').value;
    const wf = document.getElementById('weeklyWeekFilter').value;
    const q = (document.getElementById('weeklySearch').value || '').toLowerCase();
    
    let list = weeklyPayoutList;
    if (sf) list = list.filter(w => w.status === sf);
    if (wf) list = list.filter(w => (w.settlement_week || '').includes(wf));
    if (q) list = list.filter(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return (rider?.name || '').toLowerCase().includes(q) || (partner?.name || '').toLowerCase().includes(q);
    });
    
    const tbody = document.getElementById('weeklyPayoutTableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = list.map(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return '<tr><td class="font-bold text-purple-400">' + (w.settlement_week || '-') + '</td><td>' + (rider?.name || '-') + '</td><td>' + (partner?.name || '-') + '</td><td class="text-right">' + parseInt(w.delivery_count || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(w.delivery_revenue || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(w.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-purple-400">â‚©' + parseInt(w.net_amount || 0).toLocaleString() + '</td><td><span class="badge ' + (w.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (w.status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editWeeklyPayout(' + w.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

function loadWeeklyPayoutOptions() {
    const riderOpts = '<option value="">ì„ íƒ</option>' + riderList.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    const partnerOpts = '<option value="">ì„ íƒ</option>' + partnerList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
    const riderEl = document.getElementById('weekly-rider');
    const partnerEl = document.getElementById('weekly-partner');
    if (riderEl) riderEl.innerHTML = riderOpts;
    if (partnerEl) partnerEl.innerHTML = partnerOpts;
}

function openWeeklyPayoutModal() {
    document.getElementById('weeklyPayoutForm').reset();
    document.getElementById('weekly-id').value = '';
    loadWeeklyPayoutOptions();
    openModal('weeklyPayoutModal');
}

function calcWeeklyPayout() {
    const revenue = parseFloat(document.getElementById('weekly-revenue').value) || 0;
    const fee = parseFloat(document.getElementById('weekly-fee').value) || 0;
    const insurance = parseFloat(document.getElementById('weekly-insurance').value) || 0;
    const other = parseFloat(document.getElementById('weekly-other').value) || 0;
    const deduction = fee + insurance + other;
    const net = revenue - deduction;
    document.getElementById('weekly-deduction').value = deduction;
    document.getElementById('weekly-net').value = net;
}

async function submitWeeklyPayout(e) {
    e.preventDefault();
    const id = document.getElementById('weekly-id').value;
    const data = {
        settlement_week: document.getElementById('weekly-week').value,
        payout_date: document.getElementById('weekly-date').value,
        rider_id: document.getElementById('weekly-rider').value || null,
        partner_id: document.getElementById('weekly-partner').value || null,
        delivery_count: parseInt(document.getElementById('weekly-count').value) || 0,
        delivery_revenue: parseFloat(document.getElementById('weekly-revenue').value) || 0,
        fee_amount: parseFloat(document.getElementById('weekly-fee').value) || 0,
        insurance_amount: parseFloat(document.getElementById('weekly-insurance').value) || 0,
        other_deduction: parseFloat(document.getElementById('weekly-other').value) || 0,
        total_deduction: parseFloat(document.getElementById('weekly-deduction').value) || 0,
        net_amount: parseFloat(document.getElementById('weekly-net').value) || 0,
        status: document.getElementById('weekly-status').value,
        bank_account: document.getElementById('weekly-account').value || null,
        memo: document.getElementById('weekly-memo').value || null
    };
    try {
        if (id) { await supabaseCall('weekly_payouts', 'PATCH', data, '?id=eq.' + id); showToast('ìˆ˜ì • ì™„ë£Œ'); }
        else { const r = await supabaseCall('weekly_payouts', 'POST', data); if (r && r[0]) weeklyPayoutList.unshift(r[0]); showToast('ë“±ë¡ ì™„ë£Œ'); }
        closeModal('weeklyPayoutModal');
        renderWeeklyPayoutTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

function editWeeklyPayout(id) {
    const w = weeklyPayoutList.find(x => x.id === id); if (!w) return;
    loadWeeklyPayoutOptions();
    document.getElementById('weekly-id').value = w.id;
    document.getElementById('weekly-week').value = w.settlement_week || '';
    document.getElementById('weekly-date').value = w.payout_date || '';
    document.getElementById('weekly-rider').value = w.rider_id || '';
    document.getElementById('weekly-partner').value = w.partner_id || '';
    document.getElementById('weekly-count').value = w.delivery_count || 0;
    document.getElementById('weekly-revenue').value = w.delivery_revenue || 0;
    document.getElementById('weekly-fee').value = w.fee_amount || 0;
    document.getElementById('weekly-insurance').value = w.insurance_amount || 0;
    document.getElementById('weekly-other').value = w.other_deduction || 0;
    document.getElementById('weekly-deduction').value = w.total_deduction || 0;
    document.getElementById('weekly-net').value = w.net_amount || 0;
    document.getElementById('weekly-status').value = w.status || 'pending';
    document.getElementById('weekly-account').value = w.bank_account || '';
    document.getElementById('weekly-memo').value = w.memo || '';
    openModal('weeklyPayoutModal');
}

// ==================== ì„ ì •ì‚° ì§€ê¸‰ ì—‘ì…€ ====================
function downloadSettAdvanceTemplate() {
    const headers = ['ì§€ê¸‰ì¼', 'í˜‘ë ¥ì‚¬ëª…', 'ì •ì‚°ì£¼ì°¨', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ìˆ˜ìˆ˜ë£Œìœ¨(%)', 'ìˆ˜ìˆ˜ë£Œê¸ˆì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ë©”ëª¨'];
    const sample = ['2025-01-20', 'í˜‘ë ¥ì‚¬A', '2025-W03', '1000000', '100000', '1100000', '3', '33000', '1067000', 'pending', ''];
    downloadExcelTemplate('ì„ ì •ì‚°ì§€ê¸‰_ì–‘ì‹', headers, sample);
}

async function uploadSettAdvanceExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const partnerName = row[1];
            const partner = partnerList.find(p => p.name === partnerName);
            const obj = {
                transfer_date: formatExcelDate(row[0]),
                partner_id: partner?.id || null,
                settlement_week: row[2] || null,
                supply_amount: parseFloat(row[3]) || 0,
                vat_amount: parseFloat(row[4]) || 0,
                total_amount: parseFloat(row[5]) || 0,
                fee_rate: (parseFloat(row[6]) || 0) / 100,
                fee_amount: parseFloat(row[7]) || 0,
                net_amount: parseFloat(row[8]) || 0,
                status: row[9] || 'pending',
                memo: row[10] || null
            };
            const r = await supabaseCall('advance_transfers', 'POST', obj);
            if (r && r[0]) { advanceTransferList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderSettAdvanceTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportSettAdvanceExcel() {
    const headers = ['ì§€ê¸‰ì¼', 'í˜‘ë ¥ì‚¬ëª…', 'ì •ì‚°ì£¼ì°¨', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ìˆ˜ìˆ˜ë£Œìœ¨(%)', 'ìˆ˜ìˆ˜ë£Œê¸ˆì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ë©”ëª¨'];
    const rows = advanceTransferList.map(a => {
        const partner = partnerList.find(p => p.id == a.partner_id);
        return [a.transfer_date, partner?.name || '', a.settlement_week || '', a.supply_amount, a.vat_amount, a.total_amount, (a.fee_rate || 0) * 100, a.fee_amount, a.net_amount, a.status, a.memo || ''];
    });
    downloadExcel('ì„ ì •ì‚°ì§€ê¸‰_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì£¼ì •ì‚° ì§€ê¸‰ ì—‘ì…€ ====================
function downloadWeeklyPayoutTemplate() {
    const headers = ['ì •ì‚°ì£¼ì°¨', 'ì§€ê¸‰ì¼', 'ë¼ì´ë”ëª…', 'í˜‘ë ¥ì‚¬ëª…', 'ë°°ë‹¬ê±´ìˆ˜', 'ë°°ë‹¬ìˆ˜ìµ', 'ìˆ˜ìˆ˜ë£Œ', 'ë³´í—˜ë£Œ', 'ê¸°íƒ€ê³µì œ', 'ì´ê³µì œì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ì§€ê¸‰ê³„ì¢Œ', 'ë©”ëª¨'];
    const sample = ['2025-W03', '2025-01-20', 'í™ê¸¸ë™', 'í˜‘ë ¥ì‚¬A', '100', '500000', '15000', '10000', '5000', '30000', '470000', 'pending', 'êµ­ë¯¼ 123-456-789', ''];
    downloadExcelTemplate('ì£¼ì •ì‚°ì§€ê¸‰_ì–‘ì‹', headers, sample);
}

async function uploadWeeklyPayoutExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const riderName = row[2];
            const partnerName = row[3];
            const rider = riderList.find(r => r.name === riderName);
            const partner = partnerList.find(p => p.name === partnerName);
            const obj = {
                settlement_week: row[0] || null,
                payout_date: formatExcelDate(row[1]),
                rider_id: rider?.id || null,
                partner_id: partner?.id || null,
                delivery_count: parseInt(row[4]) || 0,
                delivery_revenue: parseFloat(row[5]) || 0,
                fee_amount: parseFloat(row[6]) || 0,
                insurance_amount: parseFloat(row[7]) || 0,
                other_deduction: parseFloat(row[8]) || 0,
                total_deduction: parseFloat(row[9]) || 0,
                net_amount: parseFloat(row[10]) || 0,
                status: row[11] || 'pending',
                bank_account: row[12] || null,
                memo: row[13] || null
            };
            const r = await supabaseCall('weekly_payouts', 'POST', obj);
            if (r && r[0]) { weeklyPayoutList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderWeeklyPayoutTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportWeeklyPayoutExcel() {
    const headers = ['ì •ì‚°ì£¼ì°¨', 'ì§€ê¸‰ì¼', 'ë¼ì´ë”ëª…', 'í˜‘ë ¥ì‚¬ëª…', 'ë°°ë‹¬ê±´ìˆ˜', 'ë°°ë‹¬ìˆ˜ìµ', 'ìˆ˜ìˆ˜ë£Œ', 'ë³´í—˜ë£Œ', 'ê¸°íƒ€ê³µì œ', 'ì´ê³µì œì•¡', 'ì‹¤ì§€ê¸‰ì•¡', 'ìƒíƒœ', 'ì§€ê¸‰ê³„ì¢Œ', 'ë©”ëª¨'];
    const rows = weeklyPayoutList.map(w => {
        const rider = riderList.find(r => r.id == w.rider_id);
        const partner = partnerList.find(p => p.id == w.partner_id);
        return [w.settlement_week || '', w.payout_date, rider?.name || '', partner?.name || '', w.delivery_count, w.delivery_revenue, w.fee_amount, w.insurance_amount, w.other_deduction, w.total_deduction, w.net_amount, w.status, w.bank_account || '', w.memo || ''];
    });
    downloadExcel('ì£¼ì •ì‚°ì§€ê¸‰_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì…ì¶œê¸ˆ ë‚´ì—­ ì—‘ì…€ ====================
function downloadCashbookTemplate() {
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„(deposit/withdrawal)', 'ê±°ë˜ì²˜', 'ê¸ˆì•¡', 'ì ìš”', 'ì—°ê²°ìœ í˜•(platform/advance/weekly)', 'ë©”ëª¨'];
    const sample = ['2025-01-20', 'deposit', 'ë°°ë¯¼', '5000000', 'W03 ì •ì‚°ê¸ˆ ì…ê¸ˆ', 'platform', ''];
    downloadExcelTemplate('í˜„ê¸ˆì¶œë‚©ì¥_ì–‘ì‹', headers, sample);
}

function downloadBankTemplate() { downloadCashbookTemplate(); }

async function uploadBankExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 4) continue;
            const obj = {
                transaction_date: formatExcelDate(row[0]),
                transaction_type: (row[1] || '').toLowerCase() === 'withdrawal' ? 'withdrawal' : 'deposit',
                counterparty: row[2] || null,
                amount: parseFloat(row[3]) || 0,
                description: row[4] || null,
                link_type: row[5] || null,
                bank_memo: row[6] || null
            };
            const r = await supabaseCall('bank_transactions', 'POST', obj);
            if (r && r[0]) { bankList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderCashbookTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportCashbookExcel() {
    // ì”ì•¡ ê³„ì‚°
    const sorted = [...bankList].sort((a, b) => (a.transaction_date || '').localeCompare(b.transaction_date || ''));
    let runningBalance = 0;
    sorted.forEach(b => {
        if (b.transaction_type === 'deposit') runningBalance += parseFloat(b.amount || 0);
        else runningBalance -= parseFloat(b.amount || 0);
        b._balance = runningBalance;
    });
    
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„', 'ê±°ë˜ì²˜', 'ì…ê¸ˆ', 'ì¶œê¸ˆ', 'ì”ì•¡', 'ì ìš”', 'ì—°ê²°ìœ í˜•', 'ë©”ëª¨'];
    const rows = sorted.map(b => [
        b.transaction_date, 
        b.transaction_type === 'deposit' ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ',
        b.counterparty || '',
        b.transaction_type === 'deposit' ? b.amount : '',
        b.transaction_type === 'withdrawal' ? b.amount : '',
        b._balance,
        b.description || '', 
        getLinkLabel(b.link_type) || '',
        b.bank_memo || ''
    ]);
    downloadExcel('í˜„ê¸ˆì¶œë‚©ì¥_' + new Date().toISOString().slice(0,10), headers, rows);
}

function exportBankExcel() { exportCashbookExcel(); }

// ==================== ì—‘ì…€ ê³µí†µ í•¨ìˆ˜ ====================
function downloadExcelTemplate(filename, headers, sample) {
    const ws = XLSX.utils.aoa_to_sheet([headers, sample]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename + '.xlsx');
}

function downloadExcel(filename, headers, rows) {
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, filename + '.xlsx');
}

function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const wb = XLSX.read(e.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                resolve(data);
            } catch (err) { reject(err); }
        };
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsBinaryString(file);
    });
}

function formatExcelDate(val) {
    if (!val) return null;
    if (typeof val === 'number') {
        const d = new Date((val - 25569) * 86400000);
        return d.toISOString().slice(0, 10);
    }
    if (typeof val === 'string' && val.includes('-')) return val.slice(0, 10);
    return null;
}

// ==================== ë§¤ì…ë§¤ì¶œì¥ ====================
function showAccSubTab(sub) {
    document.getElementById('accSubTab-salesPurchase').classList.add('hidden');
    document.getElementById('accSubTab-journal').classList.add('hidden');
    document.getElementById('accSubTab-ledger').classList.add('hidden');
    document.getElementById('accSubTab-' + sub).classList.remove('hidden');
    document.getElementById('btn-salesPurchase').classList.remove('btn-primary');
    document.getElementById('btn-journal').classList.remove('btn-primary');
    document.getElementById('btn-ledger').classList.remove('btn-primary');
    document.getElementById('btn-salesPurchase').classList.add('btn-secondary');
    document.getElementById('btn-journal').classList.add('btn-secondary');
    document.getElementById('btn-ledger').classList.add('btn-secondary');
    document.getElementById('btn-' + sub).classList.remove('btn-secondary');
    document.getElementById('btn-' + sub).classList.add('btn-primary');
    if (sub === 'ledger') renderLedgerTable();
}

function renderSalesPurchaseTable() {
    // í•„í„°
    const monthFilter = document.getElementById('spMonthFilter')?.value || '';
    const typeFilter = document.getElementById('spTypeFilter')?.value || '';
    const taxFilter = document.getElementById('spTaxFilter')?.value || '';
    const searchFilter = (document.getElementById('spSearch')?.value || '').toLowerCase();
    
    let filtered = salesPurchaseList.filter(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return false;
        if (typeFilter && sp.transaction_type !== typeFilter) return false;
        if (taxFilter && sp.tax_invoice_status !== taxFilter) return false;
        if (searchFilter && !(sp.counterparty || '').toLowerCase().includes(searchFilter) && !(sp.item_name || '').toLowerCase().includes(searchFilter)) return false;
        return true;
    });
    
    // í†µê³„ ê³„ì‚°
    const salesItems = salesPurchaseList.filter(sp => sp.transaction_type === 'sales');
    const purchaseItems = salesPurchaseList.filter(sp => sp.transaction_type === 'purchase');
    const salesTotal = salesItems.reduce((s, sp) => s + parseFloat(sp.supply_amount || 0), 0);
    const purchaseTotal = purchaseItems.reduce((s, sp) => s + parseFloat(sp.supply_amount || 0), 0);
    const salesVat = salesItems.reduce((s, sp) => s + parseFloat(sp.vat_amount || 0), 0);
    const purchaseVat = purchaseItems.reduce((s, sp) => s + parseFloat(sp.vat_amount || 0), 0);
    
    document.getElementById('acc-sales').textContent = 'â‚©' + salesTotal.toLocaleString();
    document.getElementById('acc-purchase').textContent = 'â‚©' + purchaseTotal.toLocaleString();
    document.getElementById('acc-sales-vat').textContent = 'â‚©' + salesVat.toLocaleString();
    document.getElementById('acc-purchase-vat').textContent = 'â‚©' + purchaseVat.toLocaleString();
    document.getElementById('acc-vat-pay').textContent = 'â‚©' + (salesVat - purchaseVat).toLocaleString();
    document.getElementById('acc-profit').textContent = 'â‚©' + (salesTotal - purchaseTotal).toLocaleString();
    
    const tbody = document.getElementById('salesPurchaseTableBody');
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = filtered.map(sp => {
        const isSales = sp.transaction_type === 'sales';
        const taxBadge = sp.tax_invoice_status === 'issued' ? '<span class="badge badge-active">ë°œí–‰</span>' : 
                         sp.tax_invoice_status === 'received' ? '<span class="badge badge-info">ìˆ˜ì·¨</span>' : 
                         '<span class="badge badge-pending">ë¯¸ë°œí–‰</span>';
        const linkBadge = sp.link_type ? '<span class="badge badge-active text-xs">' + getLinkLabel(sp.link_type) + '</span>' : '-';
        return '<tr>' +
            '<td>' + sp.transaction_date + '</td>' +
            '<td><span class="badge ' + (isSales ? 'badge-info' : 'badge-error') + '">' + (isSales ? 'ë§¤ì¶œ' : 'ë§¤ì…') + '</span></td>' +
            '<td class="font-bold">' + (sp.counterparty || '-') + '</td>' +
            '<td>' + (sp.item_name || '-') + '</td>' +
            '<td class="text-right">â‚©' + parseInt(sp.supply_amount || 0).toLocaleString() + '</td>' +
            '<td class="text-right">â‚©' + parseInt(sp.vat_amount || 0).toLocaleString() + '</td>' +
            '<td class="text-right font-bold ' + (isSales ? 'text-blue-400' : 'text-red-400') + '">â‚©' + parseInt(sp.total_amount || 0).toLocaleString() + '</td>' +
            '<td>' + taxBadge + '</td>' +
            '<td>' + linkBadge + '</td>' +
            '<td><button onclick="editSalesPurchase(' + sp.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td>' +
            '</tr>';
    }).join('');
}

function openSalesPurchaseModal() {
    document.getElementById('salesPurchaseForm').reset();
    document.getElementById('sp-id').value = '';
    document.getElementById('sp-link-id').innerHTML = '<option value="">ì„ íƒ</option>';
    openModal('salesPurchaseModal');
}

function calcSPTotal() {
    const supply = parseFloat(document.getElementById('sp-supply').value) || 0;
    const vat = Math.round(supply * 0.1);
    document.getElementById('sp-vat').value = vat;
    document.getElementById('sp-total').value = supply + vat;
}

function toggleSPType() {
    const type = document.getElementById('sp-type').value;
    const taxStatus = document.getElementById('sp-tax-status');
    if (type === 'sales') {
        taxStatus.innerHTML = '<option value="pending">ë¯¸ë°œí–‰</option><option value="issued">ë°œí–‰</option>';
    } else {
        taxStatus.innerHTML = '<option value="pending">ë¯¸ìˆ˜ì·¨</option><option value="received">ìˆ˜ì·¨</option>';
    }
}

function loadSPLinkOptions() {
    const linkType = document.getElementById('sp-link-type').value;
    const linkIdSelect = document.getElementById('sp-link-id');
    linkIdSelect.innerHTML = '<option value="">ì„ íƒ</option>';
    
    if (linkType === 'platform') {
        const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡', yogiyo: 'ìš”ê¸°ìš”' };
        platformList.forEach(p => {
            const label = (platforms[p.platform] || p.platform) + ' ' + p.settlement_week + ' (â‚©' + parseInt(p.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + p.id + '">' + label + '</option>';
        });
    } else if (linkType === 'advance') {
        advanceTransferList.forEach(a => {
            const partner = partnerList.find(p => p.id == a.partner_id);
            const label = (partner?.name || 'í˜‘ë ¥ì‚¬') + ' ' + (a.settlement_week || '') + ' (â‚©' + parseInt(a.total_amount || 0).toLocaleString() + ')';
            linkIdSelect.innerHTML += '<option value="' + a.id + '">' + label + '</option>';
        });
    }
}

async function submitSalesPurchase(e) {
    e.preventDefault();
    const id = document.getElementById('sp-id').value;
    const data = {
        transaction_date: document.getElementById('sp-date').value,
        transaction_type: document.getElementById('sp-type').value,
        counterparty: document.getElementById('sp-counterparty').value,
        item_name: document.getElementById('sp-item').value || null,
        supply_amount: parseFloat(document.getElementById('sp-supply').value) || 0,
        vat_amount: parseFloat(document.getElementById('sp-vat').value) || 0,
        total_amount: parseFloat(document.getElementById('sp-total').value) || 0,
        tax_invoice_status: document.getElementById('sp-tax-status').value,
        link_type: document.getElementById('sp-link-type').value || null,
        link_id: document.getElementById('sp-link-id').value || null,
        memo: document.getElementById('sp-memo').value || null
    };
    try {
        if (id) {
            await supabaseCall('sales_purchases', 'PATCH', data, '?id=eq.' + id);
            const idx = salesPurchaseList.findIndex(sp => sp.id == id);
            if (idx >= 0) salesPurchaseList[idx] = { ...salesPurchaseList[idx], ...data };
            showToast('ìˆ˜ì • ì™„ë£Œ');
        } else {
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) salesPurchaseList.unshift(r[0]);
            showToast('ë“±ë¡ ì™„ë£Œ');
        }
        closeModal('salesPurchaseModal');
        renderSalesPurchaseTable();
    } catch (err) { showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); }
}

function editSalesPurchase(id) {
    const sp = salesPurchaseList.find(x => x.id === id); if (!sp) return;
    document.getElementById('sp-id').value = sp.id;
    document.getElementById('sp-date').value = sp.transaction_date || '';
    document.getElementById('sp-type').value = sp.transaction_type || 'sales';
    toggleSPType();
    document.getElementById('sp-tax-status').value = sp.tax_invoice_status || 'pending';
    document.getElementById('sp-counterparty').value = sp.counterparty || '';
    document.getElementById('sp-item').value = sp.item_name || '';
    document.getElementById('sp-supply').value = sp.supply_amount || 0;
    document.getElementById('sp-vat').value = sp.vat_amount || 0;
    document.getElementById('sp-total').value = sp.total_amount || 0;
    document.getElementById('sp-link-type').value = sp.link_type || '';
    loadSPLinkOptions();
    document.getElementById('sp-link-id').value = sp.link_id || '';
    document.getElementById('sp-memo').value = sp.memo || '';
    openModal('salesPurchaseModal');
}

// ì •ì‚° ì—°ë™ - í”Œë«í¼ ì •ì‚° â†’ ë§¤ì¶œ, ì„ ì •ì‚° ì§€ê¸‰ â†’ ë§¤ì… ìë™ ë“±ë¡
async function syncFromSettlements() {
    let cnt = 0;
    const platforms = { baemin: 'ë°°ë¯¼', coupang: 'ì¿ íŒ¡ì´ì¸ ', yogiyo: 'ìš”ê¸°ìš”' };
    
    // í”Œë«í¼ ì •ì‚° â†’ ë§¤ì¶œ
    for (const p of platformList) {
        const exists = salesPurchaseList.find(sp => sp.link_type === 'platform' && sp.link_id == p.id);
        if (!exists && p.total_amount > 0) {
            const data = {
                transaction_date: p.expected_date || p.work_end_date,
                transaction_type: 'sales',
                counterparty: platforms[p.platform] || p.platform,
                item_name: p.settlement_week + ' ì •ì‚°ê¸ˆ',
                supply_amount: p.supply_amount || 0,
                vat_amount: p.vat_amount || 0,
                total_amount: p.total_amount || 0,
                tax_invoice_status: 'pending',
                link_type: 'platform',
                link_id: p.id
            };
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
    }
    
    // ì„ ì •ì‚° ì§€ê¸‰ â†’ ë§¤ì…
    for (const a of advanceTransferList) {
        const exists = salesPurchaseList.find(sp => sp.link_type === 'advance' && sp.link_id == a.id);
        if (!exists && a.total_amount > 0) {
            const partner = partnerList.find(pt => pt.id == a.partner_id);
            const data = {
                transaction_date: a.transfer_date,
                transaction_type: 'purchase',
                counterparty: partner?.name || 'í˜‘ë ¥ì‚¬',
                item_name: (a.settlement_week || '') + ' ì„ ì •ì‚°',
                supply_amount: a.supply_amount || 0,
                vat_amount: a.vat_amount || 0,
                total_amount: a.total_amount || 0,
                tax_invoice_status: 'pending',
                link_type: 'advance',
                link_id: a.id
            };
            const r = await supabaseCall('sales_purchases', 'POST', data);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
    }
    
    showToast(cnt + 'ê±´ ì—°ë™ ì™„ë£Œ');
    renderSalesPurchaseTable();
}

// ë§¤ì…ë§¤ì¶œì¥ ì—‘ì…€
function downloadSalesPurchaseTemplate() {
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„(sales/purchase)', 'ê±°ë˜ì²˜', 'í’ˆëª©', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ì„¸ê¸ˆê³„ì‚°ì„œìƒíƒœ', 'ë©”ëª¨'];
    const sample = ['2025-01-20', 'sales', 'ë°°ë¯¼', 'W03 ì •ì‚°ê¸ˆ', '5000000', '500000', '5500000', 'issued', ''];
    downloadExcelTemplate('ë§¤ì…ë§¤ì¶œì¥_ì–‘ì‹', headers, sample);
}

async function uploadSalesPurchaseExcel(input) {
    const file = input.files[0]; if (!file) return;
    try {
        const data = await readExcelFile(file);
        if (!data || data.length < 2) { showToast('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }
        let cnt = 0;
        for (let i = 1; i < data.length; i++) {
            const row = data[i]; if (!row || row.length < 5) continue;
            const obj = {
                transaction_date: formatExcelDate(row[0]),
                transaction_type: (row[1] || '').toLowerCase() === 'purchase' ? 'purchase' : 'sales',
                counterparty: row[2] || null,
                item_name: row[3] || null,
                supply_amount: parseFloat(row[4]) || 0,
                vat_amount: parseFloat(row[5]) || 0,
                total_amount: parseFloat(row[6]) || 0,
                tax_invoice_status: row[7] || 'pending',
                memo: row[8] || null
            };
            const r = await supabaseCall('sales_purchases', 'POST', obj);
            if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        }
        showToast(cnt + 'ê±´ ì—…ë¡œë“œ ì™„ë£Œ');
        renderSalesPurchaseTable();
    } catch (e) { showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'); }
    input.value = '';
}

function exportSalesPurchaseExcel() {
    const headers = ['ê±°ë˜ì¼ì', 'êµ¬ë¶„', 'ê±°ë˜ì²˜', 'í’ˆëª©', 'ê³µê¸‰ê°€ì•¡', 'ë¶€ê°€ì„¸', 'í•©ê³„', 'ì„¸ê¸ˆê³„ì‚°ì„œ', 'ì—°ê²°', 'ë©”ëª¨'];
    const rows = salesPurchaseList.map(sp => [
        sp.transaction_date,
        sp.transaction_type === 'sales' ? 'ë§¤ì¶œ' : 'ë§¤ì…',
        sp.counterparty || '',
        sp.item_name || '',
        sp.supply_amount,
        sp.vat_amount,
        sp.total_amount,
        sp.tax_invoice_status === 'issued' ? 'ë°œí–‰' : sp.tax_invoice_status === 'received' ? 'ìˆ˜ì·¨' : 'ë¯¸ë°œí–‰',
        getLinkLabel(sp.link_type) || '',
        sp.memo || ''
    ]);
    downloadExcel('ë§¤ì…ë§¤ì¶œì¥_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì´ê³„ì •ì›ì¥ ====================
const ACCOUNT_CODES = {
    // ìì‚°
    '101': { name: 'í˜„ê¸ˆ', category: 'asset' },
    '102': { name: 'ë³´í†µì˜ˆê¸ˆ', category: 'asset' },
    '103': { name: 'ì •ê¸°ì˜ˆê¸ˆ', category: 'asset' },
    '108': { name: 'ë§¤ì¶œì±„ê¶Œ', category: 'asset' },
    '110': { name: 'ë¯¸ìˆ˜ê¸ˆ', category: 'asset' },
    '120': { name: 'ì¬ê³ ìì‚°', category: 'asset' },
    '150': { name: 'ì°¨ëŸ‰ìš´ë°˜êµ¬', category: 'asset' },
    '160': { name: 'ë¹„í’ˆ', category: 'asset' },
    // ë¶€ì±„
    '201': { name: 'ë§¤ì…ì±„ë¬´', category: 'liability' },
    '210': { name: 'ë¯¸ì§€ê¸‰ê¸ˆ', category: 'liability' },
    '220': { name: 'ì˜ˆìˆ˜ê¸ˆ', category: 'liability' },
    '230': { name: 'ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ', category: 'liability' },
    '240': { name: 'ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ', category: 'asset' },
    // ìë³¸
    '301': { name: 'ìë³¸ê¸ˆ', category: 'equity' },
    '310': { name: 'ì´ìµì‰ì—¬ê¸ˆ', category: 'equity' },
    // ìˆ˜ìµ
    '401': { name: 'ë§¤ì¶œ', category: 'revenue' },
    '402': { name: 'ìˆ˜ìˆ˜ë£Œìˆ˜ìµ', category: 'revenue' },
    '403': { name: 'ì´ììˆ˜ìµ', category: 'revenue' },
    '410': { name: 'ê¸°íƒ€ìˆ˜ìµ', category: 'revenue' },
    // ë¹„ìš©
    '501': { name: 'ê¸‰ì—¬', category: 'expense' },
    '502': { name: 'ì„ì°¨ë£Œ', category: 'expense' },
    '503': { name: 'í†µì‹ ë¹„', category: 'expense' },
    '504': { name: 'ì†Œëª¨í’ˆë¹„', category: 'expense' },
    '505': { name: 'ì ‘ëŒ€ë¹„', category: 'expense' },
    '506': { name: 'ê´‘ê³ ì„ ì „ë¹„', category: 'expense' },
    '510': { name: 'ì°¨ëŸ‰ìœ ì§€ë¹„', category: 'expense' },
    '520': { name: 'ë³´í—˜ë£Œ', category: 'expense' },
    '530': { name: 'ìˆ˜ìˆ˜ë£Œë¹„ìš©', category: 'expense' },
    '590': { name: 'ê¸°íƒ€ë¹„ìš©', category: 'expense' }
};

const CATEGORY_NAMES = { asset: 'ìì‚°', liability: 'ë¶€ì±„', equity: 'ìë³¸', revenue: 'ìˆ˜ìµ', expense: 'ë¹„ìš©' };

function renderLedgerTable() {
    const monthFilter = document.getElementById('ledgerMonthFilter')?.value || '';
    const categoryFilter = document.getElementById('ledgerCategoryFilter')?.value || '';
    
    // ë¶„ê°œì¥ ë°ì´í„° ê¸°ë°˜ ê³„ì •ë³„ ì§‘ê³„
    const accountTotals = {};
    
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        
        // ì°¨ë³€ ì²˜ë¦¬
        if (j.debit_account && j.debit_amount > 0) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
            accountTotals[code].count++;
        }
        // ëŒ€ë³€ ì²˜ë¦¬
        if (j.credit_account && j.credit_amount > 0) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
            accountTotals[code].count++;
        }
    });
    
    // ë§¤ì…ë§¤ì¶œì¥ì—ì„œë„ ì§‘ê³„ ì¶”ê°€
    salesPurchaseList.forEach(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return;
        
        if (sp.transaction_type === 'sales') {
            // ë§¤ì¶œ â†’ 401 ëŒ€ë³€, ë§¤ì¶œì±„ê¶Œ 108 ì°¨ë³€
            if (!accountTotals['401']) accountTotals['401'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['401'].credit += parseFloat(sp.supply_amount) || 0;
            accountTotals['401'].count++;
            
            if (!accountTotals['108']) accountTotals['108'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['108'].debit += parseFloat(sp.total_amount) || 0;
            
            // ë¶€ê°€ì„¸ì˜ˆìˆ˜ê¸ˆ
            if (sp.vat_amount > 0) {
                if (!accountTotals['230']) accountTotals['230'] = { debit: 0, credit: 0, count: 0 };
                accountTotals['230'].credit += parseFloat(sp.vat_amount) || 0;
            }
        } else {
            // ë§¤ì… â†’ ë¹„ìš© ì°¨ë³€, ë§¤ì…ì±„ë¬´ 201 ëŒ€ë³€
            if (!accountTotals['530']) accountTotals['530'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['530'].debit += parseFloat(sp.supply_amount) || 0;
            accountTotals['530'].count++;
            
            if (!accountTotals['201']) accountTotals['201'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['201'].credit += parseFloat(sp.total_amount) || 0;
            
            // ë¶€ê°€ì„¸ëŒ€ê¸‰ê¸ˆ
            if (sp.vat_amount > 0) {
                if (!accountTotals['240']) accountTotals['240'] = { debit: 0, credit: 0, count: 0 };
                accountTotals['240'].debit += parseFloat(sp.vat_amount) || 0;
            }
        }
    });
    
    // ì´ê³„ ê³„ì‚°
    let assetTotal = 0, liabilityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    
    Object.keys(accountTotals).forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (!acc) return;
        const balance = accountTotals[code].debit - accountTotals[code].credit;
        
        if (acc.category === 'asset') assetTotal += balance;
        else if (acc.category === 'liability') liabilityTotal -= balance;
        else if (acc.category === 'revenue') revenueTotal -= balance;
        else if (acc.category === 'expense') expenseTotal += balance;
    });
    
    document.getElementById('ledger-asset').textContent = 'â‚©' + assetTotal.toLocaleString();
    document.getElementById('ledger-liability').textContent = 'â‚©' + liabilityTotal.toLocaleString();
    document.getElementById('ledger-revenue').textContent = 'â‚©' + revenueTotal.toLocaleString();
    document.getElementById('ledger-expense').textContent = 'â‚©' + expenseTotal.toLocaleString();
    
    // í…Œì´ë¸” ë Œë”ë§
    const tbody = document.getElementById('ledgerTableBody');
    const rows = [];
    
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (categoryFilter && acc.category !== categoryFilter) return;
        
        const totals = accountTotals[code] || { debit: 0, credit: 0, count: 0 };
        if (totals.debit === 0 && totals.credit === 0) return; // ê±°ë˜ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        
        const balance = totals.debit - totals.credit;
        const balanceClass = balance >= 0 ? 'text-blue-400' : 'text-red-400';
        const categoryClass = acc.category === 'asset' ? 'text-blue-300' : 
                              acc.category === 'liability' ? 'text-red-300' :
                              acc.category === 'revenue' ? 'text-green-300' :
                              acc.category === 'expense' ? 'text-orange-300' : 'text-gray-300';
        
        rows.push('<tr>' +
            '<td class="font-mono">' + code + '</td>' +
            '<td class="font-bold">' + acc.name + '</td>' +
            '<td><span class="' + categoryClass + '">' + CATEGORY_NAMES[acc.category] + '</span></td>' +
            '<td class="text-right text-blue-400">â‚©' + totals.debit.toLocaleString() + '</td>' +
            '<td class="text-right text-red-400">â‚©' + totals.credit.toLocaleString() + '</td>' +
            '<td class="text-right font-bold ' + balanceClass + '">â‚©' + balance.toLocaleString() + '</td>' +
            '<td class="text-center">' + totals.count + 'ê±´</td>' +
            '</tr>');
    });
    
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
    } else {
        tbody.innerHTML = rows.join('');
    }
}

function exportLedgerExcel() {
    const monthFilter = document.getElementById('ledgerMonthFilter')?.value || '';
    const headers = ['ê³„ì •ì½”ë“œ', 'ê³„ì •ê³¼ëª©', 'ë¶„ë¥˜', 'ì°¨ë³€í•©ê³„', 'ëŒ€ë³€í•©ê³„', 'ì”ì•¡'];
    const rows = [];
    
    // ìœ„ ë¡œì§ ë°˜ë³µ (ê°„ì†Œí™”)
    const accountTotals = {};
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        if (j.debit_account) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
        }
        if (j.credit_account) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
        }
    });
    
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        const totals = accountTotals[code] || { debit: 0, credit: 0 };
        if (totals.debit === 0 && totals.credit === 0) return;
        rows.push([code, acc.name, CATEGORY_NAMES[acc.category], totals.debit, totals.credit, totals.debit - totals.credit]);
    });
    
    downloadExcel('ì´ê³„ì •ì›ì¥_' + new Date().toISOString().slice(0,10), headers, rows);
}

// ==================== ì„¸ê¸ˆê³„ì‚°ì„œ â†’ ë§¤ì…ë§¤ì¶œì¥ ì—°ë™ ====================
async function syncTaxToSalesPurchase() {
    let cnt = 0;
    
    for (const inv of taxInvoiceList) {
        // ì´ë¯¸ ì—°ë™ëœ ê±´ í™•ì¸
        const exists = salesPurchaseList.find(sp => sp.link_type === 'taxinvoice' && sp.link_id == inv.id);
        if (exists) continue;
        
        const data = {
            transaction_date: inv.invoice_date,
            transaction_type: inv.invoice_type === 'sales' ? 'sales' : 'purchase',
            counterparty: inv.counterparty_name || '',
            item_name: inv.item_name || 'ì„¸ê¸ˆê³„ì‚°ì„œ',
            supply_amount: inv.supply_amount || 0,
            vat_amount: inv.vat_amount || 0,
            total_amount: inv.total_amount || 0,
            tax_invoice_status: inv.invoice_type === 'sales' ? 'issued' : 'received',
            link_type: 'taxinvoice',
            link_id: inv.id
        };
        
        const r = await supabaseCall('sales_purchases', 'POST', data);
        if (r && r[0]) { salesPurchaseList.unshift(r[0]); cnt++; }
        
        // ì„¸ê¸ˆê³„ì‚°ì„œì— ì—°ë™ í‘œì‹œ ì—…ë°ì´íŠ¸
        await supabaseCall('hq_tax_invoices', 'PATCH', { synced_to_ledger: true }, '?id=eq.' + inv.id);
        inv.synced_to_ledger = true;
    }
    
    showToast(cnt + 'ê±´ ë§¤ì…ë§¤ì¶œì¥ ì—°ë™ ì™„ë£Œ');
    renderTaxInvoiceTable();
    renderSalesPurchaseTable();
}

// ==================== ë…ë¦½ íƒ­ ë Œë” í•¨ìˆ˜ë“¤ ====================

// ì´ê³„ì •ì›ì¥ (ë…ë¦½íƒ­)
function renderLedgerTable2() {
    const monthFilter = document.getElementById('ledger2MonthFilter')?.value || '';
    const categoryFilter = document.getElementById('ledger2CategoryFilter')?.value || '';
    
    const accountTotals = {};
    journalList.forEach(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return;
        if (j.debit_account && j.debit_amount > 0) {
            const code = j.debit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].debit += parseFloat(j.debit_amount) || 0;
            accountTotals[code].count++;
        }
        if (j.credit_account && j.credit_amount > 0) {
            const code = j.credit_account.split('-')[0];
            if (!accountTotals[code]) accountTotals[code] = { debit: 0, credit: 0, count: 0 };
            accountTotals[code].credit += parseFloat(j.credit_amount) || 0;
            accountTotals[code].count++;
        }
    });
    
    salesPurchaseList.forEach(sp => {
        if (monthFilter && !sp.transaction_date?.startsWith(monthFilter)) return;
        if (sp.transaction_type === 'sales') {
            if (!accountTotals['401']) accountTotals['401'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['401'].credit += parseFloat(sp.supply_amount) || 0;
            accountTotals['401'].count++;
        } else {
            if (!accountTotals['530']) accountTotals['530'] = { debit: 0, credit: 0, count: 0 };
            accountTotals['530'].debit += parseFloat(sp.supply_amount) || 0;
            accountTotals['530'].count++;
        }
    });
    
    let assetTotal = 0, liabilityTotal = 0, revenueTotal = 0, expenseTotal = 0;
    Object.keys(accountTotals).forEach(code => {
        const acc = ACCOUNT_CODES[code]; if (!acc) return;
        const balance = accountTotals[code].debit - accountTotals[code].credit;
        if (acc.category === 'asset') assetTotal += balance;
        else if (acc.category === 'liability') liabilityTotal -= balance;
        else if (acc.category === 'revenue') revenueTotal -= balance;
        else if (acc.category === 'expense') expenseTotal += balance;
    });
    
    document.getElementById('ledger2-asset').textContent = 'â‚©' + assetTotal.toLocaleString();
    document.getElementById('ledger2-liability').textContent = 'â‚©' + liabilityTotal.toLocaleString();
    document.getElementById('ledger2-revenue').textContent = 'â‚©' + revenueTotal.toLocaleString();
    document.getElementById('ledger2-expense').textContent = 'â‚©' + expenseTotal.toLocaleString();
    
    const tbody = document.getElementById('ledger2TableBody');
    const rows = [];
    Object.keys(ACCOUNT_CODES).sort().forEach(code => {
        const acc = ACCOUNT_CODES[code];
        if (categoryFilter && acc.category !== categoryFilter) return;
        const totals = accountTotals[code] || { debit: 0, credit: 0, count: 0 };
        if (totals.debit === 0 && totals.credit === 0) return;
        const balance = totals.debit - totals.credit;
        const balanceClass = balance >= 0 ? 'text-blue-400' : 'text-red-400';
        const categoryClass = acc.category === 'asset' ? 'text-blue-300' : acc.category === 'liability' ? 'text-red-300' : acc.category === 'revenue' ? 'text-green-300' : 'text-orange-300';
        rows.push('<tr><td class="font-mono">' + code + '</td><td class="font-bold">' + acc.name + '</td><td><span class="' + categoryClass + '">' + CATEGORY_NAMES[acc.category] + '</span></td><td class="text-right text-blue-400">â‚©' + totals.debit.toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + totals.credit.toLocaleString() + '</td><td class="text-right font-bold ' + balanceClass + '">â‚©' + balance.toLocaleString() + '</td><td class="text-center">' + totals.count + 'ê±´</td></tr>');
    });
    tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>';
}

// ë¶„ê°œì¥ (ë…ë¦½íƒ­)
function renderJournalTable2() {
    const monthFilter = document.getElementById('journal2MonthFilter')?.value || '';
    const statusFilter = document.getElementById('journal2StatusFilter')?.value || '';
    const search = (document.getElementById('journal2Search')?.value || '').toLowerCase();
    
    let list = journalList.filter(j => {
        if (monthFilter && !j.journal_date?.startsWith(monthFilter)) return false;
        if (statusFilter && j.status !== statusFilter) return false;
        if (search && !(j.description || '').toLowerCase().includes(search)) return false;
        return true;
    });
    
    const tbody = document.getElementById('journal2TableBody');
    if (!list.length) { tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const getAccName = (code) => { if (!code) return '-'; const c = code.split('-')[0]; return ACCOUNT_CODES[c]?.name || code; };
    tbody.innerHTML = list.map(j => '<tr><td>' + j.journal_date + '</td><td class="font-mono text-xs">' + (j.journal_no || '-') + '</td><td>' + getAccName(j.debit_account) + '</td><td class="text-right text-blue-400">â‚©' + parseInt(j.debit_amount || 0).toLocaleString() + '</td><td>' + getAccName(j.credit_account) + '</td><td class="text-right text-red-400">â‚©' + parseInt(j.credit_amount || 0).toLocaleString() + '</td><td class="text-xs">' + (j.description || '-') + '</td><td><span class="badge ' + (j.status === 'confirmed' ? 'badge-active' : 'badge-pending') + '">' + (j.status === 'confirmed' ? 'í™•ì •' : 'ìƒì„±') + '</span></td><td><button onclick="editJournal(' + j.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

// ì¹´ë“œ ì‚¬ìš©ë‚´ì—­
function renderCardUsageTable() {
    const thisMonth = new Date().toISOString().slice(0,7);
    const monthlyUsage = cardTransList.filter(t => t.transaction_date?.startsWith(thisMonth)).reduce((s, t) => s + parseFloat(t.amount || 0), 0);
    
    document.getElementById('card-usage-monthly').textContent = 'â‚©' + monthlyUsage.toLocaleString();
    document.getElementById('card-usage-count').textContent = cardTransList.length + 'ê±´';
    document.getElementById('card-usage-noreceipt').textContent = cardTransList.filter(t => !t.receipt_status || t.receipt_status === 'none').length + 'ê±´';
    document.getElementById('card-usage-pending').textContent = cardTransList.filter(t => !t.accounting_status || t.accounting_status === 'pending').length + 'ê±´';
    
    const tbody = document.getElementById('cardUsageTableBody');
    if (!cardTransList.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = cardTransList.map(t => {
        const card = cardList.find(c => c.id == t.card_id);
        return '<tr><td>' + t.transaction_date + '</td><td>' + (card?.card_alias || '-') + '</td><td>' + (t.merchant_name || '-') + '</td><td class="text-right text-red-400">â‚©' + parseInt(t.amount || 0).toLocaleString() + '</td><td><span class="badge ' + (t.receipt_status === 'received' ? 'badge-active' : 'badge-pending') + '">' + (t.receipt_status === 'received' ? 'ìˆ˜ì·¨' : 'ë¯¸ìˆ˜ì·¨') + '</span></td><td><span class="badge ' + (t.accounting_status === 'processed' ? 'badge-active' : 'badge-pending') + '">' + (t.accounting_status === 'processed' ? 'ì²˜ë¦¬' : 'ë¯¸ì²˜ë¦¬') + '</span></td><td><button class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

// ì§ì› ê´€ë¦¬ (ë…ë¦½íƒ­)
function renderEmployeeTable2() {
    document.getElementById('emp2-total').textContent = employeeList.length;
    document.getElementById('emp2-regular').textContent = employeeList.filter(e => e.employee_type === 'regular').length;
    document.getElementById('emp2-contract').textContent = employeeList.filter(e => e.employee_type === 'contract').length;
    document.getElementById('emp2-insured').textContent = employeeList.filter(e => e.has_insurance).length;
    
    const tbody = document.getElementById('employees2TableBody');
    if (!employeeList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const types = { regular: 'ì •ê·œì§', contract: 'ê³„ì•½ì§', parttime: 'íŒŒíŠ¸íƒ€ì„' };
    tbody.innerHTML = employeeList.map(e => '<tr><td class="font-mono">' + (e.employee_no || '-') + '</td><td class="font-bold">' + e.name + '</td><td><span class="badge badge-info">' + (types[e.employee_type] || e.employee_type) + '</span></td><td>' + (e.department || '-') + '</td><td class="text-right">â‚©' + parseInt(e.base_salary || 0).toLocaleString() + '</td><td>' + (e.has_insurance ? 'âœ…' : 'âŒ') + '</td><td><span class="badge ' + (e.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (e.status === 'active' ? 'ì¬ì§' : 'í‡´ì§') + '</span></td><td><button onclick="editEmployee(' + e.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>').join('');
}

// ê¸‰ì—¬ ê´€ë¦¬ (ë…ë¦½íƒ­)
function renderPayrollTable2() {
    const thisMonth = new Date().toISOString().slice(0,7);
    const thisMonthPay = payrollList.filter(p => (p.pay_year + '-' + String(p.pay_month).padStart(2, '0')) === thisMonth);
    
    document.getElementById('pay2-count').textContent = thisMonthPay.length + 'ê±´';
    document.getElementById('pay2-gross').textContent = 'â‚©' + thisMonthPay.reduce((s, p) => s + parseFloat(p.gross_salary || 0), 0).toLocaleString();
    document.getElementById('pay2-deduct').textContent = 'â‚©' + thisMonthPay.reduce((s, p) => s + parseFloat(p.total_deduction || 0), 0).toLocaleString();
    document.getElementById('pay2-net').textContent = 'â‚©' + thisMonthPay.reduce((s, p) => s + parseFloat(p.net_salary || 0), 0).toLocaleString();
    
    const tbody = document.getElementById('payroll2TableBody');
    if (!payrollList.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    tbody.innerHTML = payrollList.map(p => {
        const emp = employeeList.find(e => e.id == p.employee_id);
        return '<tr><td>' + p.pay_year + '-' + String(p.pay_month).padStart(2, '0') + '</td><td class="font-bold">' + (emp?.name || '-') + '</td><td class="text-right">â‚©' + parseInt(p.base_salary || 0).toLocaleString() + '</td><td class="text-right text-blue-400">â‚©' + parseInt(p.total_allowance || 0).toLocaleString() + '</td><td class="text-right text-red-400">â‚©' + parseInt(p.total_deduction || 0).toLocaleString() + '</td><td class="text-right font-bold text-purple-400">â‚©' + parseInt(p.net_salary || 0).toLocaleString() + '</td><td><span class="badge ' + (p.status === 'paid' ? 'badge-active' : 'badge-pending') + '">' + (p.status === 'paid' ? 'ì§€ê¸‰ì™„ë£Œ' : 'ëŒ€ê¸°') + '</span></td><td><button onclick="editPayroll(' + p.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

// ê·¼ë¡œê³„ì•½ (ë…ë¦½íƒ­)
function renderContractTable2() {
    const today = new Date().toISOString().slice(0, 10);
    const contracts = contractList || [];
    
    document.getElementById('contract-total').textContent = contracts.length;
    document.getElementById('contract-active').textContent = contracts.filter(c => c.status === 'active').length;
    document.getElementById('contract-expiring').textContent = contracts.filter(c => { 
        if (!c.end_date) return false;
        const daysLeft = Math.floor((new Date(c.end_date) - new Date()) / 86400000);
        return daysLeft > 0 && daysLeft <= 30;
    }).length;
    document.getElementById('contract-expired').textContent = contracts.filter(c => c.end_date && c.end_date < today).length;
    
    const tbody = document.getElementById('contracts2TableBody');
    if (!contracts.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    
    const types = { full_time: 'ì •ê·œì§', contract: 'ê³„ì•½ì§', part_time: 'íŒŒíŠ¸íƒ€ì„' };
    tbody.innerHTML = contracts.map(c => {
        const emp = employeeList.find(e => e.id == c.employee_id);
        return '<tr><td class="font-bold">' + (emp?.name || '-') + '</td><td><span class="badge badge-info">' + (types[c.contract_type] || c.contract_type) + '</span></td><td>' + (c.start_date || '-') + '</td><td>' + (c.end_date || 'ë¬´ê¸°í•œ') + '</td><td class="text-right">â‚©' + parseInt(c.base_salary || 0).toLocaleString() + '</td><td><span class="badge ' + (c.status === 'active' ? 'badge-active' : 'badge-inactive') + '">' + (c.status === 'active' ? 'ìœ íš¨' : 'ë§Œë£Œ') + '</span></td><td><button onclick="editContract(' + c.id + ')" class="btn-secondary btn-sm">ìˆ˜ì •</button></td></tr>';
    }).join('');
}

// ë…ë¦½íƒ­ìš© wrapper
function renderLedgerTable() { 
    // íšŒê³„ê´€ë¦¬ ì„œë¸Œíƒ­ìš©
    const el = document.getElementById('ledgerTableBody');
    if (el) {
        const origFunc = renderLedgerTable.toString();
        // ê¸°ì¡´ í•¨ìˆ˜ ì‹¤í–‰
    }
    // ë…ë¦½íƒ­ìš©
    renderLedgerTable2();
}

// ==================== ì„¸ë¬´ì„œë¥˜ ë³´ê´€í•¨ ====================

let taxDocList = [];
let currentTaxFilter = 'all';

// ==================== ë²•ì¸ì„œë¥˜ ë³´ê´€í•¨ ====================

let corpDocList = [];
let currentCorpFilter = 'all';

// ==================== ë²•ì¸ ê´€ë¦¬ ====================

let entityList = [];
let currentEntityId = null;

// ==================== ìê¸ˆ ì§‘í–‰/íšŒìˆ˜ ê´€ë¦¬ ====================

let fundList = [];

// ìê¸ˆ ë°ì´í„° ë¡œë“œ
async function loadFunds() {
    // ê¸°ì¡´ ìˆ˜ë™ ë“±ë¡ ìê¸ˆ ë‚´ì—­
    const manualData = await supabaseCall('fund_transfers', 'GET', null, '?order=transfer_date.desc');
    if (manualData) fundList = manualData;
    
    // ë¸Œë¡œì»´í¼ë‹ˆ í˜„ê¸ˆì¶œë‚©ì¥ì—ì„œ ìë™ ê°€ì ¸ì˜¤ê¸°
    const bcCashbook = await supabaseCall('cashbook', 'GET', null, '?order=trans_date.desc&limit=50');
    
    // ë¸Œë¡œëª¨í„°ìŠ¤ í˜„ê¸ˆì¶œë‚©ì¥ì—ì„œ ìë™ ê°€ì ¸ì˜¤ê¸°
    const bmCashbook = await supabaseCall('bm_cashbook', 'GET', null, '?order=trans_date.desc&limit=50');
    
    // ìë™ ì—°ë™ ë°ì´í„°ë¥¼ fundList í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì„œ í•©ì¹˜ê¸°
    const autoFunds = [];
    
    // ë¸Œë¡œì»´í¼ë‹ˆ ë°ì´í„° ë³€í™˜
    if (bcCashbook && bcCashbook.length) {
        bcCashbook.forEach(c => {
            autoFunds.push({
                id: 'bc_' + c.id,
                transfer_date: c.trans_date,
                subsidiary: 'brocompany',
                transfer_type: parseFloat(c.deposit || 0) > 0 ? 'in' : 'out',
                amount: parseFloat(c.deposit || 0) > 0 ? c.deposit : c.withdrawal,
                purpose: c.description || c.counterparty || '-',
                status: 'completed',
                auto_sync: true
            });
        });
    }
    
    // ë¸Œë¡œëª¨í„°ìŠ¤ ë°ì´í„° ë³€í™˜
    if (bmCashbook && bmCashbook.length) {
        bmCashbook.forEach(c => {
            autoFunds.push({
                id: 'bm_' + c.id,
                transfer_date: c.trans_date,
                subsidiary: 'bromotors',
                transfer_type: parseFloat(c.deposit || 0) > 0 ? 'in' : 'out',
                amount: parseFloat(c.deposit || 0) > 0 ? c.deposit : c.withdrawal,
                purpose: c.description || c.counterparty || '-',
                status: 'completed',
                auto_sync: true
            });
        });
    }
    
    // ìˆ˜ë™ + ìë™ í•©ì¹˜ê¸° (ë‚ ì§œìˆœ ì •ë ¬)
    fundList = [...fundList, ...autoFunds].sort((a, b) => {
        const dateA = a.transfer_date || '';
        const dateB = b.transfer_date || '';
        return dateB.localeCompare(dateA);
    });
    
    renderFundTable();
    updateFundStats();
    updateSubsidiaryStats();
}

// ìê¸ˆ í†µê³„ ì—…ë°ì´íŠ¸
function updateFundStats() {
    const totalOut = fundList.filter(f => f.transfer_type === 'out' && f.status === 'completed').reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const totalIn = fundList.filter(f => f.transfer_type === 'in' && f.status === 'completed').reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const outstanding = totalOut - totalIn;
    
    // ì´ë²ˆë‹¬
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthlyOut = fundList.filter(f => f.transfer_type === 'out' && f.status === 'completed' && f.transfer_date?.startsWith(thisMonth)).reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const monthlyIn = fundList.filter(f => f.transfer_type === 'in' && f.status === 'completed' && f.transfer_date?.startsWith(thisMonth)).reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    const monthlyNet = monthlyIn - monthlyOut;
    
    document.getElementById('fund-total-out').textContent = 'â‚©' + totalOut.toLocaleString();
    document.getElementById('fund-total-in').textContent = 'â‚©' + totalIn.toLocaleString();
    document.getElementById('fund-outstanding').textContent = 'â‚©' + outstanding.toLocaleString();
    document.getElementById('fund-monthly-net').textContent = (monthlyNet >= 0 ? 'â‚©' : '-â‚©') + Math.abs(monthlyNet).toLocaleString();
    document.getElementById('fund-monthly-net').className = 'text-xl font-bold ' + (monthlyNet >= 0 ? 'text-purple-400' : 'text-red-400');
    
    // ê·¸ë£¹ ì”ì•¡
    document.getElementById('group-balance').textContent = 'â‚©' + outstanding.toLocaleString();
}

// ìíšŒì‚¬ í˜„í™© ì—…ë°ì´íŠ¸ (ì‹¤ì œ í˜„ê¸ˆì¶œë‚©ì¥ ë°ì´í„° ì—°ë™)
async function updateSubsidiaryStats() {
    const thisMonth = new Date().toISOString().slice(0, 7);
    
    // ë¸Œë¡œì»´í¼ë‹ˆ - í˜„ê¸ˆì¶œë‚©ì¥ì—ì„œ ì´ë²ˆë‹¬ ë°ì´í„°
    const bcCashbook = await supabaseCall('cashbook', 'GET', null, '?trans_date=gte.' + thisMonth + '-01&trans_date=lte.' + thisMonth + '-31');
    let bcDeposit = 0, bcWithdraw = 0;
    if (bcCashbook && bcCashbook.length) {
        bcDeposit = bcCashbook.reduce((s, c) => s + parseFloat(c.deposit || 0), 0);
        bcWithdraw = bcCashbook.reduce((s, c) => s + parseFloat(c.withdrawal || 0), 0);
    }
    
    // ë¸Œë¡œì»´í¼ë‹ˆ ì •ì‚° ë°ì´í„°
    const bcSettlement = settlementList.filter(s => s.settlement_date?.startsWith(thisMonth)).reduce((sum, s) => sum + parseFloat(s.total_amount || 0), 0);
    const bcFee = settlementList.filter(s => s.settlement_date?.startsWith(thisMonth)).reduce((sum, s) => sum + parseFloat(s.fee_amount || 0), 0);
    
    document.getElementById('bc-revenue').textContent = 'â‚©' + (bcDeposit || bcSettlement).toLocaleString();
    document.getElementById('bc-settlement').textContent = 'â‚©' + bcWithdraw.toLocaleString();
    document.getElementById('bc-profit').textContent = 'â‚©' + (bcDeposit - bcWithdraw).toLocaleString();
    
    // ë¸Œë¡œëª¨í„°ìŠ¤ - í˜„ê¸ˆì¶œë‚©ì¥ì—ì„œ ì´ë²ˆë‹¬ ë°ì´í„°
    const bmCashbook = await supabaseCall('bm_cashbook', 'GET', null, '?trans_date=gte.' + thisMonth + '-01&trans_date=lte.' + thisMonth + '-31');
    let bmDeposit = 0, bmWithdraw = 0;
    if (bmCashbook && bmCashbook.length) {
        bmDeposit = bmCashbook.reduce((s, c) => s + parseFloat(c.deposit || 0), 0);
        bmWithdraw = bmCashbook.reduce((s, c) => s + parseFloat(c.withdrawal || 0), 0);
    }
    
    // ë¸Œë¡œëª¨í„°ìŠ¤ ë¯¸ìˆ˜ê¸ˆ (ë Œíƒˆ ì—°ì²´)
    const bmArrears = await supabaseCall('bm_contracts', 'GET', null, '?status=eq.active');
    let totalArrears = 0;
    if (bmArrears && bmArrears.length) {
        totalArrears = bmArrears.reduce((s, c) => s + parseFloat(c.arrears_amount || 0), 0);
    }
    
    document.getElementById('bm-revenue').textContent = 'â‚©' + bmDeposit.toLocaleString();
    document.getElementById('bm-arrears').textContent = 'â‚©' + totalArrears.toLocaleString();
    document.getElementById('bm-profit').textContent = 'â‚©' + (bmDeposit - bmWithdraw).toLocaleString();
    
    // ê·¸ë£¹ í•©ê³„
    const totalRevenue = (bcDeposit || bcSettlement) + bmDeposit;
    const totalProfit = (bcDeposit - bcWithdraw) + (bmDeposit - bmWithdraw);
    document.getElementById('group-revenue').textContent = 'â‚©' + totalRevenue.toLocaleString();
    document.getElementById('group-profit').textContent = 'â‚©' + totalProfit.toLocaleString();
    document.getElementById('group-balance').textContent = 'â‚©' + totalProfit.toLocaleString();
}

// ìê¸ˆ í…Œì´ë¸” ë Œë”
function renderFundTable() {
    const tbody = document.getElementById('fundTableBody');
    
    if (!fundList.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ìê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const subsidiaryNames = { brocompany: 'ë¸Œë¡œì»´í¼ë‹ˆ', bromotors: 'ë¸Œë¡œëª¨í„°ìŠ¤' };
    const typeNames = { out: 'ì¶œê¸ˆ', in: 'ì…ê¸ˆ' };
    const typeColors = { out: 'text-red-400', in: 'text-green-400' };
    const statusBadges = { completed: 'badge-active', pending: 'badge-pending', cancelled: 'badge-error' };
    const statusNames = { completed: 'ì™„ë£Œ', pending: 'ëŒ€ê¸°', cancelled: 'ì·¨ì†Œ' };
    
    tbody.innerHTML = fundList.slice(0, 20).map(f => {
        const isAuto = f.auto_sync === true;
        return '<tr class="' + (isAuto ? 'opacity-80' : '') + '">' +
        '<td>' + (f.transfer_date || '-') + '</td>' +
        '<td class="font-bold">' + (subsidiaryNames[f.subsidiary] || f.subsidiary || '-') + (isAuto ? ' <span class="text-xs text-blue-400">ğŸ”„</span>' : '') + '</td>' +
        '<td><span class="' + (typeColors[f.transfer_type] || '') + ' font-bold">' + (typeNames[f.transfer_type] || f.transfer_type) + '</span></td>' +
        '<td class="text-right font-bold ' + (typeColors[f.transfer_type] || '') + '">' + (f.transfer_type === 'out' ? '-' : '+') + 'â‚©' + parseInt(f.amount || 0).toLocaleString() + '</td>' +
        '<td class="text-sm">' + (f.purpose || '-') + '</td>' +
        '<td><span class="badge ' + (statusBadges[f.status] || 'badge-pending') + '">' + (statusNames[f.status] || f.status) + '</span></td>' +
        '<td>' +
        (isAuto ? '<span class="text-xs text-gray-500">ìë™ì—°ë™</span>' : 
        '<button onclick="editFund(' + f.id + ')" class="btn-secondary btn-sm mr-1">âœï¸</button>' +
        '<button onclick="deleteFund(' + f.id + ')" class="btn-danger btn-sm">ğŸ—‘ï¸</button>') +
        '</td>' +
        '</tr>';
    }).join('');
}

// ìê¸ˆ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openFundModal() {
    document.getElementById('fundForm').reset();
    document.getElementById('fund-id').value = '';
    document.getElementById('fund-date').value = new Date().toISOString().slice(0, 10);
    openModal('fundModal');
}

// ìê¸ˆ ì €ì¥
async function submitFund(e) {
    e.preventDefault();
    
    const id = document.getElementById('fund-id').value;
    const data = {
        transfer_date: document.getElementById('fund-date').value,
        transfer_type: document.getElementById('fund-type').value,
        subsidiary: document.getElementById('fund-subsidiary').value,
        amount: parseFloat(document.getElementById('fund-amount').value) || 0,
        purpose: document.getElementById('fund-purpose').value || null,
        status: document.getElementById('fund-status').value,
        memo: document.getElementById('fund-memo').value || null
    };
    
    let result;
    if (id) {
        result = await supabaseCall('fund_transfers', 'PATCH', data, '?id=eq.' + id);
        if (result) {
            const idx = fundList.findIndex(f => f.id == id);
            if (idx >= 0) fundList[idx] = { ...fundList[idx], ...data };
            showToast('ìê¸ˆ ë‚´ì—­ ìˆ˜ì • ì™„ë£Œ');
        }
    } else {
        result = await supabaseCall('fund_transfers', 'POST', data);
        if (result && result[0]) {
            fundList.unshift(result[0]);
            showToast('ìê¸ˆ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    closeModal('fundModal');
    renderFundTable();
    updateFundStats();
}

// ìê¸ˆ ìˆ˜ì •
function editFund(id) {
    const fund = fundList.find(f => f.id === id);
    if (!fund) return;
    
    document.getElementById('fund-id').value = fund.id;
    document.getElementById('fund-date').value = fund.transfer_date || '';
    document.getElementById('fund-type').value = fund.transfer_type || '';
    document.getElementById('fund-subsidiary').value = fund.subsidiary || '';
    document.getElementById('fund-amount').value = fund.amount || '';
    document.getElementById('fund-purpose').value = fund.purpose || '';
    document.getElementById('fund-status').value = fund.status || 'completed';
    document.getElementById('fund-memo').value = fund.memo || '';
    
    openModal('fundModal');
}

// ìê¸ˆ ì‚­ì œ
async function deleteFund(id) {
    if (!confirm('ì´ ìê¸ˆ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await supabaseCall('fund_transfers', 'DELETE', null, '?id=eq.' + id);
    fundList = fundList.filter(f => f.id !== id);
    
    showToast('ìê¸ˆ ë‚´ì—­ ì‚­ì œ ì™„ë£Œ');
    renderFundTable();
    updateFundStats();
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ë²•ì¸)
async function loadEntities() {
    const data = await supabaseCall('entities', 'GET', null, '?order=created_at.desc');
    if (data) entityList = data;
    renderEntityCards();
}

// ë²•ì¸ ì¹´ë“œ ë Œë”
function renderEntityCards() {
    const totalDocs = corpDocList.length;
    
    document.getElementById('entity-total').textContent = entityList.length + 'ê°œ';
    document.getElementById('entity-active').textContent = entityList.filter(e => e.status === 'active').length + 'ê°œ';
    document.getElementById('entity-inactive').textContent = entityList.filter(e => e.status !== 'active').length + 'ê°œ';
    document.getElementById('entity-docs').textContent = totalDocs + 'ê°œ';
    
    const container = document.getElementById('entityCardList');
    
    if (!entityList.length) {
        container.innerHTML = '<div class="glass-card rounded-xl p-8 text-center col-span-full"><p class="text-gray-500">ë“±ë¡ëœ ë²•ì¸ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
    }
    
    container.innerHTML = entityList.map(e => {
        const docCount = corpDocList.filter(d => d.entity_name === e.name).length;
        const statusBadge = e.status === 'active' ? '<span class="badge badge-active">í™œì„±</span>' : '<span class="badge badge-pending">ë¹„í™œì„±</span>';
        
        return '<div class="glass-card rounded-xl p-4 cursor-pointer hover:border-purple-400/50 transition-all" onclick="openEntityDetail(' + e.id + ')">' +
            '<div class="flex justify-between items-start mb-3">' +
            '<h3 class="text-lg font-bold text-purple-400">' + e.name + '</h3>' +
            statusBadge +
            '</div>' +
            '<div class="space-y-2 text-sm">' +
            '<div class="flex justify-between"><span class="text-gray-400">ì‚¬ì—…ìë²ˆí˜¸</span><span>' + (e.business_no || '-') + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-400">ëŒ€í‘œì</span><span>' + (e.ceo_name || '-') + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-400">ëŒ€í‘œ ì—°ë½ì²˜</span><span>' + (e.ceo_phone || '-') + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-400">ì²¨ë¶€ì„œë¥˜</span><span class="text-blue-400">' + docCount + 'ê°œ</span></div>' +
            '</div>' +
            '</div>';
    }).join('');
}

// ë²•ì¸ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openEntityModal() {
    document.getElementById('entityForm').reset();
    document.getElementById('entity-id').value = '';
    document.getElementById('entityModalTitle').textContent = 'ğŸ¢ ë²•ì¸ ë“±ë¡';
    openModal('entityModal');
}

// ë²•ì¸ ì €ì¥
async function submitEntity(e) {
    e.preventDefault();
    
    const id = document.getElementById('entity-id').value;
    const data = {
        name: document.getElementById('entity-name').value,
        status: document.getElementById('entity-status').value,
        business_no: document.getElementById('entity-bizno').value || null,
        corporate_no: document.getElementById('entity-corpno').value || null,
        business_type: document.getElementById('entity-biztype').value || null,
        business_category: document.getElementById('entity-bizcategory').value || null,
        address: document.getElementById('entity-address').value || null,
        phone: document.getElementById('entity-phone').value || null,
        founded_date: document.getElementById('entity-founddate').value || null,
        ceo_name: document.getElementById('entity-ceoname').value || null,
        ceo_phone: document.getElementById('entity-ceophone').value || null,
        ceo_resident_no: document.getElementById('entity-ceoresidentno').value || null,
        ceo_email: document.getElementById('entity-ceoemail').value || null,
        ceo_address: document.getElementById('entity-ceoaddress').value || null,
        memo: document.getElementById('entity-memo').value || null
    };
    
    let result;
    if (id) {
        result = await supabaseCall('entities', 'PATCH', data, '?id=eq.' + id);
        if (result) {
            const idx = entityList.findIndex(e => e.id == id);
            if (idx >= 0) entityList[idx] = { ...entityList[idx], ...data };
            showToast('ë²•ì¸ ì •ë³´ ìˆ˜ì • ì™„ë£Œ');
        }
    } else {
        result = await supabaseCall('entities', 'POST', data);
        if (result && result[0]) {
            entityList.unshift(result[0]);
            showToast('ë²•ì¸ ë“±ë¡ ì™„ë£Œ');
        }
    }
    
    closeModal('entityModal');
    renderEntityCards();
}

// ë²•ì¸ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
function openEntityDetail(id) {
    const entity = entityList.find(e => e.id === id);
    if (!entity) return;
    
    currentEntityId = id;
    document.getElementById('entityDetailName').textContent = entity.name;
    
    // ê¸°ë³¸ì •ë³´ í‘œì‹œ
    const infoHtml = `
        <div class="grid grid-cols-2 gap-4">
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</p>
                <p class="font-bold">${entity.business_no || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ë²•ì¸ë“±ë¡ë²ˆí˜¸</p>
                <p class="font-bold">${entity.corporate_no || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì—…íƒœ</p>
                <p class="font-bold">${entity.business_type || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì—…ì¢…</p>
                <p class="font-bold">${entity.business_category || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3 col-span-2">
                <p class="text-gray-400 text-xs">ì‚¬ì—…ì¥ ì£¼ì†Œ</p>
                <p class="font-bold">${entity.address || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ëŒ€í‘œ ì „í™”</p>
                <p class="font-bold">${entity.phone || '-'}</p>
            </div>
            <div class="glass-card rounded-lg p-3">
                <p class="text-gray-400 text-xs">ì„¤ë¦½ì¼</p>
                <p class="font-bold">${entity.founded_date || '-'}</p>
            </div>
        </div>
        <div class="border-t border-white/10 pt-4 mt-4">
            <h4 class="text-blue-400 font-bold mb-3">ğŸ‘¤ ëŒ€í‘œì ì •ë³´</h4>
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ëŒ€í‘œìëª…</p>
                    <p class="font-bold">${entity.ceo_name || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ì—°ë½ì²˜</p>
                    <p class="font-bold">${entity.ceo_phone || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</p>
                    <p class="font-bold">${entity.ceo_resident_no || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3">
                    <p class="text-gray-400 text-xs">ì´ë©”ì¼</p>
                    <p class="font-bold">${entity.ceo_email || '-'}</p>
                </div>
                <div class="glass-card rounded-lg p-3 col-span-2">
                    <p class="text-gray-400 text-xs">ëŒ€í‘œì ì£¼ì†Œ</p>
                    <p class="font-bold">${entity.ceo_address || '-'}</p>
                </div>
            </div>
        </div>
        ${entity.memo ? '<div class="border-t border-white/10 pt-4 mt-4"><p class="text-gray-400 text-xs">ë©”ëª¨</p><p>' + entity.memo + '</p></div>' : ''}
    `;
    
    document.getElementById('entityDetailInfo').innerHTML = infoHtml;
    
    // ì²¨ë¶€ì„œë¥˜ ë¡œë“œ
    renderEntityDocs(entity.name);
    
    showEntityDetailTab('info');
    openModal('entityDetailModal');
}

// ë²•ì¸ ìƒì„¸ íƒ­ ì „í™˜
function showEntityDetailTab(tab) {
    ['info', 'docs'].forEach(t => {
        document.getElementById('entityDetailContent-' + t).classList.add('hidden');
        document.getElementById('entityDetailTab-' + t).classList.remove('bg-purple-500/20', 'text-purple-400');
        document.getElementById('entityDetailTab-' + t).classList.add('text-gray-400');
    });
    document.getElementById('entityDetailContent-' + tab).classList.remove('hidden');
    document.getElementById('entityDetailTab-' + tab).classList.add('bg-purple-500/20', 'text-purple-400');
    document.getElementById('entityDetailTab-' + tab).classList.remove('text-gray-400');
}

// ë²•ì¸ë³„ ì²¨ë¶€ì„œë¥˜ ë Œë”
function renderEntityDocs(entityName) {
    const docs = corpDocList.filter(d => d.entity_name === entityName);
    const tbody = document.getElementById('entityDocTableBody');
    
    if (!docs.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">ì²¨ë¶€ëœ ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const categoryNames = { business: 'ì‚¬ì—…ìë“±ë¡ì¦', corporate: 'ë“±ê¸°ë¶€ë“±ë³¸', contract: 'ê³„ì•½ì„œ', license: 'ì¸í—ˆê°€', other: 'ê¸°íƒ€' };
    
    tbody.innerHTML = docs.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge badge-info">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td><button onclick="downloadCorpDoc(' + d.id + ')" class="btn-secondary btn-sm">ğŸ“¥</button></td>' +
            '</tr>';
    }).join('');
}

// í˜„ì¬ ë²•ì¸ ìˆ˜ì •
function editCurrentEntity() {
    const entity = entityList.find(e => e.id === currentEntityId);
    if (!entity) return;
    
    closeModal('entityDetailModal');
    
    document.getElementById('entity-id').value = entity.id;
    document.getElementById('entity-name').value = entity.name || '';
    document.getElementById('entity-status').value = entity.status || 'active';
    document.getElementById('entity-bizno').value = entity.business_no || '';
    document.getElementById('entity-corpno').value = entity.corporate_no || '';
    document.getElementById('entity-biztype').value = entity.business_type || '';
    document.getElementById('entity-bizcategory').value = entity.business_category || '';
    document.getElementById('entity-address').value = entity.address || '';
    document.getElementById('entity-phone').value = entity.phone || '';
    document.getElementById('entity-founddate').value = entity.founded_date || '';
    document.getElementById('entity-ceoname').value = entity.ceo_name || '';
    document.getElementById('entity-ceophone').value = entity.ceo_phone || '';
    document.getElementById('entity-ceoresidentno').value = entity.ceo_resident_no || '';
    document.getElementById('entity-ceoemail').value = entity.ceo_email || '';
    document.getElementById('entity-ceoaddress').value = entity.ceo_address || '';
    document.getElementById('entity-memo').value = entity.memo || '';
    
    document.getElementById('entityModalTitle').textContent = 'ğŸ¢ ë²•ì¸ ìˆ˜ì •';
    openModal('entityModal');
}

// í˜„ì¬ ë²•ì¸ ì‚­ì œ
async function deleteCurrentEntity() {
    if (!confirm('ì´ ë²•ì¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await supabaseCall('entities', 'DELETE', null, '?id=eq.' + currentEntityId);
    entityList = entityList.filter(e => e.id !== currentEntityId);
    
    closeModal('entityDetailModal');
    showToast('ë²•ì¸ ì‚­ì œ ì™„ë£Œ');
    renderEntityCards();
}

// ë²•ì¸ ì„œë¥˜ ì²¨ë¶€ (í˜„ì¬ ë²•ì¸ì—)
function openEntityDocUpload() {
    const entity = entityList.find(e => e.id === currentEntityId);
    if (!entity) return;
    
    closeModal('entityDetailModal');
    document.getElementById('corpdoc-entity').value = entity.name;
    openDocUploadModal();
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ë²•ì¸ì„œë¥˜)
async function loadCorpDocuments() {
    const data = await supabaseCall('corp_documents', 'GET', null, '?order=created_at.desc');
    if (data) corpDocList = data;
    renderCorpDocTable();
}

// ì¹´í…Œê³ ë¦¬ í•„í„° (ë²•ì¸ì„œë¥˜)
function filterCorpDocs(category) {
    currentCorpFilter = category;
    ['all', 'business', 'corporate', 'contract', 'license', 'other'].forEach(c => {
        const tab = document.getElementById('corpDocTab-' + c);
        if (tab) {
            tab.classList.remove('bg-purple-500/20', 'text-purple-400');
            tab.classList.add('text-gray-400');
        }
    });
    const activeTab = document.getElementById('corpDocTab-' + category);
    if (activeTab) {
        activeTab.classList.add('bg-purple-500/20', 'text-purple-400');
        activeTab.classList.remove('text-gray-400');
    }
    renderCorpDocTable();
}

// í…Œì´ë¸” ë Œë” (ë²•ì¸ì„œë¥˜)
function renderCorpDocTable() {
    const searchFilter = (document.getElementById('corpDocSearch')?.value || '').toLowerCase();
    const entityFilter = document.getElementById('corpDocEntity')?.value || '';
    
    let filtered = corpDocList.filter(d => {
        if (currentCorpFilter !== 'all' && d.category !== currentCorpFilter) return false;
        if (searchFilter && !(d.file_name || '').toLowerCase().includes(searchFilter) && !(d.description || '').toLowerCase().includes(searchFilter)) return false;
        if (entityFilter && d.entity_name !== entityFilter) return false;
        return true;
    });
    
    // í†µê³„
    document.getElementById('corpdoc-total').textContent = corpDocList.length + 'ê°œ';
    document.getElementById('corpdoc-business').textContent = corpDocList.filter(d => d.category === 'business').length + 'ê°œ';
    document.getElementById('corpdoc-corporate').textContent = corpDocList.filter(d => d.category === 'corporate').length + 'ê°œ';
    document.getElementById('corpdoc-contract').textContent = corpDocList.filter(d => d.category === 'contract').length + 'ê°œ';
    document.getElementById('corpdoc-license').textContent = corpDocList.filter(d => d.category === 'license').length + 'ê°œ';
    document.getElementById('corpdoc-other').textContent = corpDocList.filter(d => d.category === 'other').length + 'ê°œ';
    
    // ë²•ì¸ í•„í„° ì˜µì…˜ ë¡œë“œ
    const entityFilterEl = document.getElementById('corpDocEntity');
    if (entityFilterEl && entityFilterEl.options.length <= 1) {
        const entities = [...new Set(corpDocList.map(d => d.entity_name).filter(Boolean))];
        entities.forEach(e => { entityFilterEl.add(new Option(e, e)); });
    }
    
    const tbody = document.getElementById('corpDocTableBody');
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const categoryNames = { business: 'ì‚¬ì—…ìë“±ë¡ì¦', corporate: 'ë“±ê¸°ë¶€ë“±ë³¸', contract: 'ê³„ì•½ì„œ', license: 'ì¸í—ˆê°€', other: 'ê¸°íƒ€' };
    const categoryColors = { business: 'badge-info', corporate: 'badge-active', contract: 'badge-pending', license: 'badge-success', other: 'badge-error' };
    
    tbody.innerHTML = filtered.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge ' + (categoryColors[d.category] || 'badge-pending') + '">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td>' + (d.entity_name || '-') + '</td>' +
            '<td class="text-sm text-gray-400">' + (d.description || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td>' +
            '<button onclick="downloadCorpDoc(' + d.id + ')" class="btn-secondary btn-sm mr-1">ğŸ“¥</button>' +
            '<button onclick="deleteCorpDoc(' + d.id + ')" class="btn-danger btn-sm">ğŸ—‘ï¸</button>' +
            '</td>' +
            '</tr>';
    }).join('');
}

// ì—…ë¡œë“œ ëª¨ë‹¬ ì—´ê¸° (ë²•ì¸ì„œë¥˜)
function openDocUploadModal() {
    document.getElementById('docUploadForm').reset();
    document.getElementById('docUploadProgress').classList.add('hidden');
    document.getElementById('selectedDocFileList').innerHTML = '';
    openModal('docUploadModal');
}

// íŒŒì¼ ê°œìˆ˜ ì²´í¬ (ë²•ì¸ì„œë¥˜)
function checkDocFileLimit(input) {
    const files = input.files;
    const listEl = document.getElementById('selectedDocFileList');
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        input.value = '';
        listEl.innerHTML = '';
        return;
    }
    
    if (files.length > 0) {
        let html = '<div class="mt-2 p-2 bg-black/30 rounded-lg"><p class="text-purple-400 text-xs mb-1">ì„ íƒëœ íŒŒì¼ (' + files.length + 'ê°œ):</p>';
        for (let i = 0; i < files.length; i++) {
            const size = (files[i].size / 1024).toFixed(1);
            html += '<div class="text-xs text-gray-400">â€¢ ' + files[i].name + ' (' + size + ' KB)</div>';
        }
        html += '</div>';
        listEl.innerHTML = html;
    } else {
        listEl.innerHTML = '';
    }
}

// íŒŒì¼ ì—…ë¡œë“œ (ë²•ì¸ì„œë¥˜)
async function submitDocUpload(e) {
    e.preventDefault();
    
    const category = document.getElementById('corpdoc-category').value;
    const entityName = document.getElementById('corpdoc-entity').value;
    const description = document.getElementById('corpdoc-desc').value;
    const fileInput = document.getElementById('corpdoc-file');
    const files = fileInput.files;
    
    if (!files.length) {
        showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    document.getElementById('docUploadProgress').classList.remove('hidden');
    const progressBar = document.getElementById('docUploadProgressBar');
    const progressText = document.getElementById('docUploadProgressText');
    
    let successCount = 0;
    let failCount = 0;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = Math.round(((i + 1) / files.length) * 100);
        progressBar.style.width = progress + '%';
        progressText.textContent = 'ì—…ë¡œë“œ ì¤‘... (' + (i + 1) + '/' + files.length + ')';
        
        try {
            const timestamp = Date.now();
            const safeName = file.name.replace(/[^a-zA-Z0-9ê°€-í£._-]/g, '_');
            const filePath = category + '/' + timestamp + '_' + safeName;
            
            const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                .from('corp-documents')
                .upload(filePath, file);
            
            if (uploadError) throw uploadError;
            
            const docData = {
                category: category,
                file_name: file.name,
                file_path: filePath,
                file_size: file.size,
                file_type: file.type,
                entity_name: entityName || null,
                description: description || null,
                uploaded_by: currentUser?.username || 'system'
            };
            
            const result = await supabaseCall('corp_documents', 'POST', docData);
            
            if (result && result[0]) {
                corpDocList.unshift(result[0]);
                successCount++;
            }
        } catch (err) {
            console.error('Upload error:', file.name, err);
            failCount++;
        }
    }
    
    progressBar.style.width = '100%';
    
    if (failCount === 0) {
        showToast(successCount + 'ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    } else {
        showToast(successCount + 'ê°œ ì„±ê³µ, ' + failCount + 'ê°œ ì‹¤íŒ¨', 'error');
    }
    
    closeModal('docUploadModal');
    renderCorpDocTable();
    document.getElementById('docUploadProgress').classList.add('hidden');
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ë²•ì¸ì„œë¥˜)
async function downloadCorpDoc(id) {
    const doc = corpDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        const { data, error } = await window.supabaseClient.storage
            .from('corp-documents')
            .download(doc.file_path);
        
        if (error) throw error;
        
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = doc.file_name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    } catch (err) {
        console.error('Download error:', err);
        showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
    }
}

// íŒŒì¼ ì‚­ì œ (ë²•ì¸ì„œë¥˜)
async function deleteCorpDoc(id) {
    if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const doc = corpDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        await window.supabaseClient.storage
            .from('corp-documents')
            .remove([doc.file_path]);
        
        await supabaseCall('corp_documents', 'DELETE', null, '?id=eq.' + id);
        
        corpDocList = corpDocList.filter(d => d.id !== id);
        showToast('íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
        renderCorpDocTable();
    } catch (err) {
        console.error('Delete error:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ì„¸ë¬´ì„œë¥˜)
async function loadTaxDocuments() {
    const data = await supabaseCall('tax_documents', 'GET', null, '?order=created_at.desc');
    if (data) taxDocList = data;
    renderTaxDocTable();
}

// ì¹´í…Œê³ ë¦¬ í•„í„°
function filterTaxDocs(category) {
    currentTaxFilter = category;
    ['all', 'withholding', 'statement', 'other'].forEach(c => {
        const tab = document.getElementById('taxDocTab-' + c);
        if (tab) {
            tab.classList.remove('bg-purple-500/20', 'text-purple-400');
            tab.classList.add('text-gray-400');
        }
    });
    const activeTab = document.getElementById('taxDocTab-' + category);
    if (activeTab) {
        activeTab.classList.add('bg-purple-500/20', 'text-purple-400');
        activeTab.classList.remove('text-gray-400');
    }
    renderTaxDocTable();
}

// í…Œì´ë¸” ë Œë”
function renderTaxDocTable() {
    const searchFilter = (document.getElementById('taxDocSearch')?.value || '').toLowerCase();
    const monthFilter = document.getElementById('taxDocMonth')?.value || '';
    
    let filtered = taxDocList.filter(d => {
        if (currentTaxFilter !== 'all' && d.category !== currentTaxFilter) return false;
        if (searchFilter && !(d.file_name || '').toLowerCase().includes(searchFilter) && !(d.description || '').toLowerCase().includes(searchFilter)) return false;
        if (monthFilter && !d.document_date?.startsWith(monthFilter)) return false;
        return true;
    });
    
    // í†µê³„
    document.getElementById('taxdoc-total').textContent = taxDocList.length + 'ê°œ';
    document.getElementById('taxdoc-withholding').textContent = taxDocList.filter(d => d.category === 'withholding').length + 'ê°œ';
    document.getElementById('taxdoc-statement').textContent = taxDocList.filter(d => d.category === 'statement').length + 'ê°œ';
    document.getElementById('taxdoc-other').textContent = taxDocList.filter(d => d.category === 'other').length + 'ê°œ';
    
    const tbody = document.getElementById('taxDocTableBody');
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    const categoryNames = { withholding: 'ì›ì²œì„¸ ì‹ ê³ ', statement: 'ì§€ê¸‰ëª…ì„¸ì„œ', other: 'ê¸°íƒ€ ì„œë¥˜' };
    const categoryColors = { withholding: 'badge-info', statement: 'badge-active', other: 'badge-pending' };
    
    tbody.innerHTML = filtered.map(d => {
        const fileSize = d.file_size ? (d.file_size / 1024).toFixed(1) + ' KB' : '-';
        const uploadDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '-';
        return '<tr>' +
            '<td><span class="badge ' + (categoryColors[d.category] || 'badge-pending') + '">' + (categoryNames[d.category] || d.category) + '</span></td>' +
            '<td class="font-bold">' + (d.file_name || '-') + '</td>' +
            '<td>' + (d.document_date || '-') + '</td>' +
            '<td class="text-sm text-gray-400">' + (d.description || '-') + '</td>' +
            '<td class="text-sm">' + fileSize + '</td>' +
            '<td class="text-sm">' + uploadDate + '</td>' +
            '<td>' +
            '<button onclick="downloadTaxDoc(' + d.id + ')" class="btn-secondary btn-sm mr-1">ğŸ“¥</button>' +
            '<button onclick="deleteTaxDoc(' + d.id + ')" class="btn-danger btn-sm">ğŸ—‘ï¸</button>' +
            '</td>' +
            '</tr>';
    }).join('');
}

// ì—…ë¡œë“œ ëª¨ë‹¬ ì—´ê¸°
function openTaxUploadModal() {
    document.getElementById('taxUploadForm').reset();
    document.getElementById('uploadProgress').classList.add('hidden');
    document.getElementById('selectedFileList').innerHTML = '';
    openModal('taxUploadModal');
}

// íŒŒì¼ ê°œìˆ˜ ì²´í¬ (ìµœëŒ€ 10ê°œ)
function checkFileLimit(input) {
    const files = input.files;
    const listEl = document.getElementById('selectedFileList');
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        input.value = '';
        listEl.innerHTML = '';
        return;
    }
    
    // ì„ íƒëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ
    if (files.length > 0) {
        let html = '<div class="mt-2 p-2 bg-black/30 rounded-lg"><p class="text-purple-400 text-xs mb-1">ì„ íƒëœ íŒŒì¼ (' + files.length + 'ê°œ):</p>';
        for (let i = 0; i < files.length; i++) {
            const size = (files[i].size / 1024).toFixed(1);
            html += '<div class="text-xs text-gray-400">â€¢ ' + files[i].name + ' (' + size + ' KB)</div>';
        }
        html += '</div>';
        listEl.innerHTML = html;
    } else {
        listEl.innerHTML = '';
    }
}

// íŒŒì¼ ì—…ë¡œë“œ (ë‹¤ì¤‘)
async function submitTaxUpload(e) {
    e.preventDefault();
    
    const category = document.getElementById('taxdoc-category').value;
    const docDate = document.getElementById('taxdoc-date').value;
    const description = document.getElementById('taxdoc-desc').value;
    const fileInput = document.getElementById('taxdoc-file');
    const files = fileInput.files;
    
    if (!files.length) {
        showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    if (files.length > 10) {
        showToast('ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ í‘œì‹œ
    document.getElementById('uploadProgress').classList.remove('hidden');
    const progressBar = document.getElementById('uploadProgressBar');
    const progressText = document.getElementById('uploadProgressText');
    
    let successCount = 0;
    let failCount = 0;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = Math.round(((i + 1) / files.length) * 100);
        progressBar.style.width = progress + '%';
        progressText.textContent = 'ì—…ë¡œë“œ ì¤‘... (' + (i + 1) + '/' + files.length + ')';
        
        try {
            // íŒŒì¼ ê²½ë¡œ ìƒì„±
            const timestamp = Date.now();
            const safeName = file.name.replace(/[^a-zA-Z0-9ê°€-í£._-]/g, '_');
            const filePath = category + '/' + timestamp + '_' + safeName;
            
            // Supabase Storageì— ì—…ë¡œë“œ
            const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                .from('tax-documents')
                .upload(filePath, file);
            
            if (uploadError) {
                throw uploadError;
            }
            
            // ë©”íƒ€ë°ì´í„° ì €ì¥
            const docData = {
                category: category,
                file_name: file.name,
                file_path: filePath,
                file_size: file.size,
                file_type: file.type,
                description: description || null,
                document_date: docDate || null,
                uploaded_by: currentUser?.username || 'system'
            };
            
            const result = await supabaseCall('tax_documents', 'POST', docData);
            
            if (result && result[0]) {
                taxDocList.unshift(result[0]);
                successCount++;
            }
        } catch (err) {
            console.error('Upload error:', file.name, err);
            failCount++;
        }
    }
    
    progressBar.style.width = '100%';
    
    if (failCount === 0) {
        showToast(successCount + 'ê°œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    } else {
        showToast(successCount + 'ê°œ ì„±ê³µ, ' + failCount + 'ê°œ ì‹¤íŒ¨', 'error');
    }
    
    closeModal('taxUploadModal');
    renderTaxDocTable();
    document.getElementById('uploadProgress').classList.add('hidden');
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ
async function downloadTaxDoc(id) {
    const doc = taxDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        const { data, error } = await window.supabaseClient.storage
            .from('tax-documents')
            .download(doc.file_path);
        
        if (error) throw error;
        
        // ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = doc.file_name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    } catch (err) {
        console.error('Download error:', err);
        showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨', 'error');
    }
}

// íŒŒì¼ ì‚­ì œ
async function deleteTaxDoc(id) {
    if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const doc = taxDocList.find(d => d.id === id);
    if (!doc) return;
    
    try {
        // Storageì—ì„œ ì‚­ì œ
        await window.supabaseClient.storage
            .from('tax-documents')
            .remove([doc.file_path]);
        
        // DBì—ì„œ ì‚­ì œ
        await supabaseCall('tax_documents', 'DELETE', null, '?id=eq.' + id);
        
        taxDocList = taxDocList.filter(d => d.id !== id);
        showToast('íŒŒì¼ ì‚­ì œ ì™„ë£Œ');
        renderTaxDocTable();
    } catch (err) {
        console.error('Delete error:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}
</script>
</body>
</html>
